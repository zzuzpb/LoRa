; generated by Component: ARM Compiler 5.06 update 1 (build 61) Tool: ArmCC [4d35ad]
; commandline ArmCC [--c99 --list --split_sections --debug -c --asm --interleave -o.\objects\loramac.o --asm_dir=.\Listings\ --list_dir=.\Listings\ --depend=.\objects\loramac.d --cpu=Cortex-M0 --apcs=interwork -O0 --diag_suppress=9931 -I..\CMSIS\Device\ST\STM32F0xx\Include -I..\CMSIS\Include -I..\stm32f03xx_HAL\Inc -I..\USER -I..\HAL\inc -I..\HAL\system -I..\Lib\LoRawan-node\misc -I..\Lib\LoRawan-node\crypto -I..\Lib\LoRawan-node\mac -I..\Lib\LoRawan-node\radio -I..\Lib\LoRawan-node\radio\sx1276 -I..\Lib -IE:\NBI项目\NBI_LoRa\LoRa版本备份\NB_LoRawan-V2.0.2：control-F030CC\MDK_5.12\RTE -ID:\mysaftware\keil_5.12\ARM\PACK\Keil\STM32F0xx_DFP\1.5.0\Device\Include -ID:\mysaftware\keil_5.12\ARM\CMSIS\Include -D__MICROLIB -D__UVISION_VERSION=518 -DSTM32F030xC -DUSE_HAL_DRIVER -DSTM32F030xC -DUSE_MODEM_LORA -DUSE_BAND_433 --omf_browse=.\objects\loramac.crf ..\Lib\LoRawan-node\mac\LoRaMac.c]
                          THUMB

                          AREA ||i.AddMacCommand||, CODE, READONLY, ALIGN=2

                  AddMacCommand PROC
;;;2004   
;;;2005   static LoRaMacStatus_t AddMacCommand( uint8_t cmd, uint8_t p1, uint8_t p2 )
000000  b570              PUSH     {r4-r6,lr}
;;;2006   {
000002  4604              MOV      r4,r0
;;;2007       LoRaMacStatus_t status = LORAMAC_STATUS_BUSY;
000004  2501              MOVS     r5,#1
;;;2008   
;;;2009       switch( cmd )
000006  1ea0              SUBS     r0,r4,#2
000008  0003              MOVS     r3,r0
00000a  f7fffffe          BL       __ARM_common_switch8
00000e  0705              DCB      0x07,0x05
000010  1328364b          DCB      0x13,0x28,0x36,0x4b
000014  677c8a00          DCB      0x67,0x7c,0x8a,0x00
;;;2010       {
;;;2011           case MOTE_MAC_LINK_CHECK_REQ:
;;;2012               if( MacCommandsBufferIndex < LORA_MAC_COMMAND_MAX_LENGTH )
000018  4847              LDR      r0,|L1.312|
00001a  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
00001c  280f              CMP      r0,#0xf
00001e  da08              BGE      |L1.50|
;;;2013               {
;;;2014                   MacCommandsBuffer[MacCommandsBufferIndex++] = cmd;
000020  4845              LDR      r0,|L1.312|
000022  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
000024  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
000026  1c40              ADDS     r0,r0,#1
000028  4e43              LDR      r6,|L1.312|
00002a  7030              STRB     r0,[r6,#0]
00002c  4843              LDR      r0,|L1.316|
00002e  54c4              STRB     r4,[r0,r3]
;;;2015                   // No payload for this command
;;;2016                   status = LORAMAC_STATUS_OK;
000030  2500              MOVS     r5,#0
                  |L1.50|
;;;2017               }
;;;2018               break;
000032  e078              B        |L1.294|
;;;2019           case MOTE_MAC_LINK_ADR_ANS:
;;;2020               if( MacCommandsBufferIndex < ( LORA_MAC_COMMAND_MAX_LENGTH - 1 ) )
000034  4840              LDR      r0,|L1.312|
000036  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
000038  280e              CMP      r0,#0xe
00003a  da0f              BGE      |L1.92|
;;;2021               {
;;;2022                   MacCommandsBuffer[MacCommandsBufferIndex++] = cmd;
00003c  483e              LDR      r0,|L1.312|
00003e  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
000040  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
000042  1c40              ADDS     r0,r0,#1
000044  4e3c              LDR      r6,|L1.312|
000046  7030              STRB     r0,[r6,#0]
000048  483c              LDR      r0,|L1.316|
00004a  54c4              STRB     r4,[r0,r3]
;;;2023                   // Margin
;;;2024                   MacCommandsBuffer[MacCommandsBufferIndex++] = p1;
00004c  4630              MOV      r0,r6
00004e  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
000050  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
000052  1c40              ADDS     r0,r0,#1
000054  7030              STRB     r0,[r6,#0]
000056  4839              LDR      r0,|L1.316|
000058  54c1              STRB     r1,[r0,r3]
;;;2025                   status = LORAMAC_STATUS_OK;
00005a  2500              MOVS     r5,#0
                  |L1.92|
;;;2026               }
;;;2027               break;
00005c  e063              B        |L1.294|
;;;2028           case MOTE_MAC_DUTY_CYCLE_ANS:
;;;2029               if( MacCommandsBufferIndex < LORA_MAC_COMMAND_MAX_LENGTH )
00005e  4836              LDR      r0,|L1.312|
000060  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
000062  280f              CMP      r0,#0xf
000064  da08              BGE      |L1.120|
;;;2030               {
;;;2031                   MacCommandsBuffer[MacCommandsBufferIndex++] = cmd;
000066  4834              LDR      r0,|L1.312|
000068  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
00006a  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
00006c  1c40              ADDS     r0,r0,#1
00006e  4e32              LDR      r6,|L1.312|
000070  7030              STRB     r0,[r6,#0]
000072  4832              LDR      r0,|L1.316|
000074  54c4              STRB     r4,[r0,r3]
;;;2032                   // No payload for this answer
;;;2033                   status = LORAMAC_STATUS_OK;
000076  2500              MOVS     r5,#0
                  |L1.120|
;;;2034               }
;;;2035               break;
000078  e055              B        |L1.294|
;;;2036           case MOTE_MAC_RX_PARAM_SETUP_ANS:
;;;2037               if( MacCommandsBufferIndex < ( LORA_MAC_COMMAND_MAX_LENGTH - 1 ) )
00007a  482f              LDR      r0,|L1.312|
00007c  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
00007e  280e              CMP      r0,#0xe
000080  da0f              BGE      |L1.162|
;;;2038               {
;;;2039                   MacCommandsBuffer[MacCommandsBufferIndex++] = cmd;
000082  482d              LDR      r0,|L1.312|
000084  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
000086  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
000088  1c40              ADDS     r0,r0,#1
00008a  4e2b              LDR      r6,|L1.312|
00008c  7030              STRB     r0,[r6,#0]
00008e  482b              LDR      r0,|L1.316|
000090  54c4              STRB     r4,[r0,r3]
;;;2040                   // Status: Datarate ACK, Channel ACK
;;;2041                   MacCommandsBuffer[MacCommandsBufferIndex++] = p1;
000092  4630              MOV      r0,r6
000094  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
000096  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
000098  1c40              ADDS     r0,r0,#1
00009a  7030              STRB     r0,[r6,#0]
00009c  4827              LDR      r0,|L1.316|
00009e  54c1              STRB     r1,[r0,r3]
;;;2042                   status = LORAMAC_STATUS_OK;
0000a0  2500              MOVS     r5,#0
                  |L1.162|
;;;2043               }
;;;2044               break;
0000a2  e040              B        |L1.294|
;;;2045           case MOTE_MAC_DEV_STATUS_ANS:
;;;2046               if( MacCommandsBufferIndex < ( LORA_MAC_COMMAND_MAX_LENGTH - 2 ) )
0000a4  4824              LDR      r0,|L1.312|
0000a6  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
0000a8  280d              CMP      r0,#0xd
0000aa  da16              BGE      |L1.218|
;;;2047               {
;;;2048                   MacCommandsBuffer[MacCommandsBufferIndex++] = cmd;
0000ac  4822              LDR      r0,|L1.312|
0000ae  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
0000b0  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
0000b2  1c40              ADDS     r0,r0,#1
0000b4  4e20              LDR      r6,|L1.312|
0000b6  7030              STRB     r0,[r6,#0]
0000b8  4820              LDR      r0,|L1.316|
0000ba  54c4              STRB     r4,[r0,r3]
;;;2049                   // 1st byte Battery
;;;2050                   // 2nd byte Margin
;;;2051                   MacCommandsBuffer[MacCommandsBufferIndex++] = p1;
0000bc  4630              MOV      r0,r6
0000be  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
0000c0  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
0000c2  1c40              ADDS     r0,r0,#1
0000c4  7030              STRB     r0,[r6,#0]
0000c6  481d              LDR      r0,|L1.316|
0000c8  54c1              STRB     r1,[r0,r3]
;;;2052                   MacCommandsBuffer[MacCommandsBufferIndex++] = p2;
0000ca  4630              MOV      r0,r6
0000cc  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
0000ce  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
0000d0  1c40              ADDS     r0,r0,#1
0000d2  7030              STRB     r0,[r6,#0]
0000d4  4819              LDR      r0,|L1.316|
0000d6  54c2              STRB     r2,[r0,r3]
;;;2053                   status = LORAMAC_STATUS_OK;
0000d8  2500              MOVS     r5,#0
                  |L1.218|
;;;2054               }
;;;2055               break;
0000da  e024              B        |L1.294|
;;;2056           case MOTE_MAC_NEW_CHANNEL_ANS:
;;;2057               if( MacCommandsBufferIndex < ( LORA_MAC_COMMAND_MAX_LENGTH - 1 ) )
0000dc  4816              LDR      r0,|L1.312|
0000de  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
0000e0  280e              CMP      r0,#0xe
0000e2  da0f              BGE      |L1.260|
;;;2058               {
;;;2059                   MacCommandsBuffer[MacCommandsBufferIndex++] = cmd;
0000e4  4814              LDR      r0,|L1.312|
0000e6  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
0000e8  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
0000ea  1c40              ADDS     r0,r0,#1
0000ec  4e12              LDR      r6,|L1.312|
0000ee  7030              STRB     r0,[r6,#0]
0000f0  4812              LDR      r0,|L1.316|
0000f2  54c4              STRB     r4,[r0,r3]
;;;2060                   // Status: Datarate range OK, Channel frequency OK
;;;2061                   MacCommandsBuffer[MacCommandsBufferIndex++] = p1;
0000f4  4630              MOV      r0,r6
0000f6  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
0000f8  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
0000fa  1c40              ADDS     r0,r0,#1
0000fc  7030              STRB     r0,[r6,#0]
0000fe  480f              LDR      r0,|L1.316|
000100  54c1              STRB     r1,[r0,r3]
;;;2062                   status = LORAMAC_STATUS_OK;
000102  2500              MOVS     r5,#0
                  |L1.260|
;;;2063               }
;;;2064               break;
000104  e00f              B        |L1.294|
;;;2065           case MOTE_MAC_RX_TIMING_SETUP_ANS:
;;;2066               if( MacCommandsBufferIndex < LORA_MAC_COMMAND_MAX_LENGTH )
000106  480c              LDR      r0,|L1.312|
000108  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
00010a  280f              CMP      r0,#0xf
00010c  da08              BGE      |L1.288|
;;;2067               {
;;;2068                   MacCommandsBuffer[MacCommandsBufferIndex++] = cmd;
00010e  480a              LDR      r0,|L1.312|
000110  7803              LDRB     r3,[r0,#0]  ; MacCommandsBufferIndex
000112  7800              LDRB     r0,[r0,#0]  ; MacCommandsBufferIndex
000114  1c40              ADDS     r0,r0,#1
000116  4e08              LDR      r6,|L1.312|
000118  7030              STRB     r0,[r6,#0]
00011a  4808              LDR      r0,|L1.316|
00011c  54c4              STRB     r4,[r0,r3]
;;;2069                   // No payload for this answer
;;;2070                   status = LORAMAC_STATUS_OK;
00011e  2500              MOVS     r5,#0
                  |L1.288|
;;;2071               }
;;;2072               break;
000120  e001              B        |L1.294|
;;;2073           default:
;;;2074               return LORAMAC_STATUS_SERVICE_UNKNOWN;
000122  2002              MOVS     r0,#2
                  |L1.292|
;;;2075       }
;;;2076       if( status == LORAMAC_STATUS_OK )
;;;2077       {
;;;2078           MacCommandsInNextTx = true;
;;;2079       }
;;;2080       return status;
;;;2081   }
000124  bd70              POP      {r4-r6,pc}
                  |L1.294|
000126  bf00              NOP                            ;2018
000128  2d00              CMP      r5,#0                 ;2076
00012a  d102              BNE      |L1.306|
00012c  2001              MOVS     r0,#1                 ;2078
00012e  4b04              LDR      r3,|L1.320|
000130  7018              STRB     r0,[r3,#0]            ;2078
                  |L1.306|
000132  4628              MOV      r0,r5                 ;2080
000134  e7f6              B        |L1.292|
;;;2082   
                          ENDP

000136  0000              DCW      0x0000
                  |L1.312|
                          DCD      MacCommandsBufferIndex
                  |L1.316|
                          DCD      MacCommandsBuffer
                  |L1.320|
                          DCD      MacCommandsInNextTx

                          AREA ||i.AdrNextDr||, CODE, READONLY, ALIGN=2

                  AdrNextDr PROC
;;;1919   
;;;1920   static bool AdrNextDr( bool adrEnabled, bool updateChannelMask, int8_t* datarateOut )
000000  b570              PUSH     {r4-r6,lr}
;;;1921   {
000002  4603              MOV      r3,r0
000004  460c              MOV      r4,r1
;;;1922       bool adrAckReq = false;
000006  2000              MOVS     r0,#0
;;;1923       int8_t datarate = ChannelsDatarate;
000008  4d15              LDR      r5,|L2.96|
00000a  5629              LDRSB    r1,[r5,r0]  ; ChannelsDatarate
;;;1924   
;;;1925       if( adrEnabled == true )
00000c  2b01              CMP      r3,#1
00000e  d125              BNE      |L2.92|
;;;1926       {
;;;1927           if( datarate == LORAMAC_MIN_DATARATE )
000010  2905              CMP      r1,#5
000012  d103              BNE      |L2.28|
;;;1928           {
;;;1929               AdrAckCounter = 0;
000014  2500              MOVS     r5,#0
000016  4e13              LDR      r6,|L2.100|
000018  6035              STR      r5,[r6,#0]  ; AdrAckCounter
;;;1930               adrAckReq = false;
00001a  e01f              B        |L2.92|
                  |L2.28|
;;;1931           }
;;;1932           else
;;;1933           {
;;;1934               if( AdrAckCounter >= ADR_ACK_LIMIT )
00001c  4d11              LDR      r5,|L2.100|
00001e  682d              LDR      r5,[r5,#0]  ; AdrAckCounter
000020  2d40              CMP      r5,#0x40
000022  d301              BCC      |L2.40|
;;;1935               {
;;;1936                   adrAckReq = true;
000024  2001              MOVS     r0,#1
000026  e000              B        |L2.42|
                  |L2.40|
;;;1937               }
;;;1938               else
;;;1939               {
;;;1940                   adrAckReq = false;
000028  2000              MOVS     r0,#0
                  |L2.42|
;;;1941               }
;;;1942               if( AdrAckCounter >= ( ADR_ACK_LIMIT + ADR_ACK_DELAY ) )
00002a  4d0e              LDR      r5,|L2.100|
00002c  682d              LDR      r5,[r5,#0]  ; AdrAckCounter
00002e  2d60              CMP      r5,#0x60
000030  d314              BCC      |L2.92|
;;;1943               {
;;;1944                   if( ( ( AdrAckCounter - ADR_ACK_DELAY ) % ADR_ACK_LIMIT ) == 0 )
000032  4d0c              LDR      r5,|L2.100|
000034  782d              LDRB     r5,[r5,#0]  ; AdrAckCounter
000036  3d20              SUBS     r5,r5,#0x20
000038  06ad              LSLS     r5,r5,#26
00003a  0ead              LSRS     r5,r5,#26
00003c  2d00              CMP      r5,#0
00003e  d10d              BNE      |L2.92|
;;;1945                   {
;;;1946   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;1947                       if( datarate > LORAMAC_MIN_DATARATE )
000040  2905              CMP      r1,#5
000042  dd01              BLE      |L2.72|
;;;1948                       {
;;;1949                           datarate--;
000044  1e4d              SUBS     r5,r1,#1
000046  b269              SXTB     r1,r5
                  |L2.72|
;;;1950                       }
;;;1951                       if( datarate == LORAMAC_MIN_DATARATE )
000048  2905              CMP      r1,#5
00004a  d107              BNE      |L2.92|
;;;1952                       {
;;;1953                           if( updateChannelMask == true )
00004c  2c01              CMP      r4,#1
00004e  d105              BNE      |L2.92|
;;;1954                           {
;;;1955   
;;;1956                               // Re-enable default channels LC1, LC2, LC3
;;;1957                               ChannelsMask[0] = ChannelsMask[0] | (LC( 1 ) + LC( 2 ) + LC( 3 ) );
000050  4d05              LDR      r5,|L2.104|
000052  882d              LDRH     r5,[r5,#0]  ; ChannelsMask
000054  2607              MOVS     r6,#7
000056  4335              ORRS     r5,r5,r6
000058  4e03              LDR      r6,|L2.104|
00005a  8035              STRH     r5,[r6,#0]
                  |L2.92|
;;;1958                           }
;;;1959                       }
;;;1960   #elif defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;1961                       if( ( datarate > LORAMAC_MIN_DATARATE ) && ( datarate == DR_8 ) )
;;;1962                       {
;;;1963                           datarate = DR_4;
;;;1964                       }
;;;1965                       else if( datarate > LORAMAC_MIN_DATARATE )
;;;1966                       {
;;;1967                           datarate--;
;;;1968                       }
;;;1969                       if( datarate == LORAMAC_MIN_DATARATE )
;;;1970                       {
;;;1971                           if( updateChannelMask == true )
;;;1972                           {
;;;1973   #if defined( USE_BAND_915 )
;;;1974                               // Re-enable default channels
;;;1975                               ChannelsMask[0] = 0xFFFF;
;;;1976                               ChannelsMask[1] = 0xFFFF;
;;;1977                               ChannelsMask[2] = 0xFFFF;
;;;1978                               ChannelsMask[3] = 0xFFFF;
;;;1979                               ChannelsMask[4] = 0x00FF;
;;;1980                               ChannelsMask[5] = 0x0000;
;;;1981   #else // defined( USE_BAND_915_HYBRID )
;;;1982                               // Re-enable default channels
;;;1983                               ChannelsMask[0] = 0x00FF;
;;;1984                               ChannelsMask[1] = 0x0000;
;;;1985                               ChannelsMask[2] = 0x0000;
;;;1986                               ChannelsMask[3] = 0x0000;
;;;1987                               ChannelsMask[4] = 0x0001;
;;;1988                               ChannelsMask[5] = 0x0000;
;;;1989   #endif
;;;1990                           }
;;;1991                       }
;;;1992   #else
;;;1993   #error "Please define a frequency band in the compiler options."
;;;1994   #endif
;;;1995                   }
;;;1996               }
;;;1997           }
;;;1998       }
;;;1999   
;;;2000       *datarateOut = datarate;
00005c  7011              STRB     r1,[r2,#0]
;;;2001   
;;;2002       return adrAckReq;
;;;2003   }
00005e  bd70              POP      {r4-r6,pc}
;;;2004   
                          ENDP

                  |L2.96|
                          DCD      ChannelsDatarate
                  |L2.100|
                          DCD      AdrAckCounter
                  |L2.104|
                          DCD      ChannelsMask

                          AREA ||i.DisableChannelInMask||, CODE, READONLY, ALIGN=1

                  DisableChannelInMask PROC
;;;1903   
;;;1904   static bool DisableChannelInMask( uint8_t id, uint16_t* mask )
000000  b530              PUSH     {r4,r5,lr}
;;;1905   {
000002  4602              MOV      r2,r0
;;;1906       uint8_t index = 0;
000004  2300              MOVS     r3,#0
;;;1907       index = id / 16;
000006  4610              MOV      r0,r2
000008  17d4              ASRS     r4,r2,#31
00000a  0f24              LSRS     r4,r4,#28
00000c  1824              ADDS     r4,r4,r0
00000e  0524              LSLS     r4,r4,#20
000010  0e23              LSRS     r3,r4,#24
;;;1908   
;;;1909       if( ( index > 4 ) || ( id >= LORA_MAX_NB_CHANNELS ) )
000012  2b04              CMP      r3,#4
000014  dc01              BGT      |L3.26|
000016  2a08              CMP      r2,#8
000018  db01              BLT      |L3.30|
                  |L3.26|
;;;1910       {
;;;1911           return false;
00001a  2000              MOVS     r0,#0
                  |L3.28|
;;;1912       }
;;;1913   
;;;1914       // Deactivate channel
;;;1915       mask[index] &= ~( 1 << ( id % 16 ) );
;;;1916   
;;;1917       return true;
;;;1918   }
00001c  bd30              POP      {r4,r5,pc}
                  |L3.30|
00001e  4610              MOV      r0,r2                 ;1915
000020  17d4              ASRS     r4,r2,#31             ;1915
000022  0f24              LSRS     r4,r4,#28             ;1915
000024  1824              ADDS     r4,r4,r0              ;1915
000026  1124              ASRS     r4,r4,#4              ;1915
000028  0124              LSLS     r4,r4,#4              ;1915
00002a  1b15              SUBS     r5,r2,r4              ;1915
00002c  2401              MOVS     r4,#1                 ;1915
00002e  40ac              LSLS     r4,r4,r5              ;1915
000030  005d              LSLS     r5,r3,#1              ;1915
000032  5b4d              LDRH     r5,[r1,r5]            ;1915
000034  43a5              BICS     r5,r5,r4              ;1915
000036  005c              LSLS     r4,r3,#1              ;1915
000038  530d              STRH     r5,[r1,r4]            ;1915
00003a  2001              MOVS     r0,#1                 ;1917
00003c  e7ee              B        |L3.28|
;;;1919   
                          ENDP


                          AREA ||i.LimitTxPower||, CODE, READONLY, ALIGN=1

                  LimitTxPower PROC
;;;1874   
;;;1875   static int8_t LimitTxPower( int8_t txPower )
000000  4601              MOV      r1,r0
;;;1876   {
;;;1877       int8_t resultTxPower = txPower;
;;;1878   #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;1879       if( ( ChannelsDatarate == DR_4 ) ||
;;;1880           ( ( ChannelsDatarate >= DR_8 ) && ( ChannelsDatarate <= DR_13 ) ) )
;;;1881       {// Limit tx power to max 26dBm
;;;1882           resultTxPower =  MAX( txPower, TX_POWER_26_DBM );
;;;1883       }
;;;1884       else
;;;1885       {
;;;1886           if( CountNbEnabled125kHzChannels( ChannelsMask ) < 50 )
;;;1887           {// Limit tx power to max 21dBm
;;;1888               resultTxPower = MAX( txPower, TX_POWER_20_DBM );
;;;1889           }
;;;1890       }
;;;1891   #endif
;;;1892       return resultTxPower;
000002  4608              MOV      r0,r1
;;;1893   }
000004  4770              BX       lr
;;;1894   
                          ENDP


                          AREA ||i.LoRaMacChannelAdd||, CODE, READONLY, ALIGN=2

                  LoRaMacChannelAdd PROC
;;;3214   
;;;3215   LoRaMacStatus_t LoRaMacChannelAdd( uint8_t id, ChannelParams_t params )
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;3216   {
000002  4604              MOV      r4,r0
;;;3217   #if ( defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID ) )
;;;3218       return LORAMAC_STATUS_PARAMETER_INVALID;
;;;3219   #else
;;;3220       bool datarateInvalid = false;
000004  2600              MOVS     r6,#0
;;;3221       bool frequencyInvalid = false;
000006  2500              MOVS     r5,#0
;;;3222       uint8_t band = 0;
000008  2700              MOVS     r7,#0
;;;3223   
;;;3224       // The id must not exceed LORA_MAX_NB_CHANNELS
;;;3225       if( id >= LORA_MAX_NB_CHANNELS )
00000a  2c08              CMP      r4,#8
00000c  db01              BLT      |L5.18|
;;;3226       {
;;;3227           return LORAMAC_STATUS_PARAMETER_INVALID;
00000e  2003              MOVS     r0,#3
                  |L5.16|
;;;3228       }
;;;3229       // Validate if the MAC is in a correct state
;;;3230       if( ( LoRaMacState & MAC_TX_RUNNING ) == MAC_TX_RUNNING )
;;;3231       {
;;;3232           if( ( LoRaMacState & MAC_TX_CONFIG ) != MAC_TX_CONFIG )
;;;3233           {
;;;3234               return LORAMAC_STATUS_BUSY;
;;;3235           }
;;;3236       }
;;;3237       // Validate the datarate
;;;3238       if( ( params.DrRange.Fields.Min > params.DrRange.Fields.Max ) ||
;;;3239           ( ValueInRange( params.DrRange.Fields.Min, LORAMAC_MIN_DATARATE,
;;;3240                           LORAMAC_MAX_DATARATE ) == false ) ||
;;;3241           ( ValueInRange( params.DrRange.Fields.Max, LORAMAC_MIN_DATARATE,
;;;3242                           LORAMAC_MAX_DATARATE ) == false ) )
;;;3243       {
;;;3244           datarateInvalid = true;
;;;3245       }
;;;3246   
;;;3247   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;3248       if( id < 3 )
;;;3249       {
;;;3250           if( params.Frequency != Channels[id].Frequency )
;;;3251           {
;;;3252               frequencyInvalid = true;
;;;3253           }
;;;3254   
;;;3255           if( params.DrRange.Fields.Min > LORAMAC_DEFAULT_DATARATE )
;;;3256           {
;;;3257               datarateInvalid = true;
;;;3258           }
;;;3259           if( ValueInRange( params.DrRange.Fields.Max, DR_5, LORAMAC_MAX_DATARATE ) == false )
;;;3260           {
;;;3261               datarateInvalid = true;
;;;3262           }
;;;3263       }
;;;3264   #endif
;;;3265   
;;;3266       // Validate the frequency
;;;3267       if( ( Radio.CheckRfFrequency( params.Frequency ) == true ) && ( params.Frequency > 0 ) && ( frequencyInvalid == false ) )
;;;3268       {
;;;3269   #if defined( USE_BAND_868 )
;;;3270           if( ( params.Frequency >= 865000000 ) && ( params.Frequency <= 868000000 ) )
;;;3271           {
;;;3272               band = BAND_G1_0;
;;;3273           }
;;;3274           else if( ( params.Frequency > 868000000 ) && ( params.Frequency <= 868600000 ) )
;;;3275           {
;;;3276               band = BAND_G1_1;
;;;3277           }
;;;3278           else if( ( params.Frequency >= 868700000 ) && ( params.Frequency <= 869200000 ) )
;;;3279           {
;;;3280               band = BAND_G1_2;
;;;3281           }
;;;3282           else if( ( params.Frequency >= 869400000 ) && ( params.Frequency <= 869650000 ) )
;;;3283           {
;;;3284               band = BAND_G1_3;
;;;3285           }
;;;3286           else if( ( params.Frequency >= 869700000 ) && ( params.Frequency <= 870000000 ) )
;;;3287           {
;;;3288               band = BAND_G1_4;
;;;3289           }
;;;3290           else
;;;3291           {
;;;3292               frequencyInvalid = true;
;;;3293           }
;;;3294   #endif
;;;3295       }
;;;3296       else
;;;3297       {
;;;3298           frequencyInvalid = true;
;;;3299       }
;;;3300   
;;;3301       if( ( datarateInvalid == true ) && ( frequencyInvalid == true ) )
;;;3302       {
;;;3303           return LORAMAC_STATUS_FREQ_AND_DR_INVALID;
;;;3304       }
;;;3305       if( datarateInvalid == true )
;;;3306       {
;;;3307           return LORAMAC_STATUS_DATARATE_INVALID;
;;;3308       }
;;;3309       if( frequencyInvalid == true )
;;;3310       {
;;;3311           return LORAMAC_STATUS_FREQUENCY_INVALID;
;;;3312       }
;;;3313   
;;;3314       // Every parameter is valid, activate the channel
;;;3315       Channels[id] = params;
;;;3316       Channels[id].Band = band;
;;;3317       ChannelsMask[0] |= ( 1 << id );
;;;3318   
;;;3319       return LORAMAC_STATUS_OK;
;;;3320   #endif
;;;3321   }
000010  bdfe              POP      {r1-r7,pc}
                  |L5.18|
000012  483a              LDR      r0,|L5.252|
000014  7800              LDRB     r0,[r0,#0]            ;3230  ; LoRaMacState
000016  07c0              LSLS     r0,r0,#31             ;3230
000018  0fc0              LSRS     r0,r0,#31             ;3230
00001a  2800              CMP      r0,#0                 ;3230
00001c  d007              BEQ      |L5.46|
00001e  4837              LDR      r0,|L5.252|
000020  6800              LDR      r0,[r0,#0]            ;3232  ; LoRaMacState
000022  2120              MOVS     r1,#0x20              ;3232
000024  4008              ANDS     r0,r0,r1              ;3232
000026  2820              CMP      r0,#0x20              ;3232
000028  d001              BEQ      |L5.46|
00002a  2001              MOVS     r0,#1                 ;3234
00002c  e7f0              B        |L5.16|
                  |L5.46|
00002e  4668              MOV      r0,sp                 ;3238
000030  7a00              LDRB     r0,[r0,#8]            ;3238
000032  0700              LSLS     r0,r0,#28             ;3238
000034  1701              ASRS     r1,r0,#28             ;3238
000036  4668              MOV      r0,sp                 ;3238
000038  2208              MOVS     r2,#8                 ;3238
00003a  5682              LDRSB    r2,[r0,r2]            ;3238
00003c  1110              ASRS     r0,r2,#4              ;3238
00003e  4281              CMP      r1,r0                 ;3238
000040  dc13              BGT      |L5.106|
000042  4669              MOV      r1,sp                 ;3239
000044  7a09              LDRB     r1,[r1,#8]            ;3239
000046  0709              LSLS     r1,r1,#28             ;3239
000048  1708              ASRS     r0,r1,#28             ;3239
00004a  2200              MOVS     r2,#0                 ;3239
00004c  2105              MOVS     r1,#5                 ;3239
00004e  f7fffffe          BL       ValueInRange
000052  2800              CMP      r0,#0                 ;3239
000054  d009              BEQ      |L5.106|
000056  466a              MOV      r2,sp                 ;3241
000058  2108              MOVS     r1,#8                 ;3241
00005a  5651              LDRSB    r1,[r2,r1]            ;3241
00005c  1108              ASRS     r0,r1,#4              ;3241
00005e  2200              MOVS     r2,#0                 ;3241
000060  2105              MOVS     r1,#5                 ;3241
000062  f7fffffe          BL       ValueInRange
000066  2800              CMP      r0,#0                 ;3241
000068  d100              BNE      |L5.108|
                  |L5.106|
00006a  2601              MOVS     r6,#1                 ;3244
                  |L5.108|
00006c  2c03              CMP      r4,#3                 ;3248
00006e  da18              BGE      |L5.162|
000070  00e1              LSLS     r1,r4,#3              ;3250
000072  4a23              LDR      r2,|L5.256|
000074  5851              LDR      r1,[r2,r1]            ;3250
000076  9801              LDR      r0,[sp,#4]            ;3250
000078  4288              CMP      r0,r1                 ;3250
00007a  d000              BEQ      |L5.126|
00007c  2501              MOVS     r5,#1                 ;3252
                  |L5.126|
00007e  4668              MOV      r0,sp                 ;3255
000080  7a00              LDRB     r0,[r0,#8]            ;3255
000082  0700              LSLS     r0,r0,#28             ;3255
000084  1700              ASRS     r0,r0,#28             ;3255
000086  2800              CMP      r0,#0                 ;3255
000088  dd00              BLE      |L5.140|
00008a  2601              MOVS     r6,#1                 ;3257
                  |L5.140|
00008c  466a              MOV      r2,sp                 ;3259
00008e  2108              MOVS     r1,#8                 ;3259
000090  5651              LDRSB    r1,[r2,r1]            ;3259
000092  1108              ASRS     r0,r1,#4              ;3259
000094  2200              MOVS     r2,#0                 ;3259
000096  2105              MOVS     r1,#5                 ;3259
000098  f7fffffe          BL       ValueInRange
00009c  2800              CMP      r0,#0                 ;3259
00009e  d100              BNE      |L5.162|
0000a0  2601              MOVS     r6,#1                 ;3261
                  |L5.162|
0000a2  4a18              LDR      r2,|L5.260|
0000a4  9801              LDR      r0,[sp,#4]            ;3267
0000a6  6a11              LDR      r1,[r2,#0x20]         ;3267  ; Radio
0000a8  4788              BLX      r1                    ;3267
0000aa  2801              CMP      r0,#1                 ;3267
0000ac  d104              BNE      |L5.184|
0000ae  9801              LDR      r0,[sp,#4]            ;3267
0000b0  2800              CMP      r0,#0                 ;3267
0000b2  d001              BEQ      |L5.184|
0000b4  2d00              CMP      r5,#0                 ;3267
0000b6  d000              BEQ      |L5.186|
                  |L5.184|
0000b8  2501              MOVS     r5,#1                 ;3298
                  |L5.186|
0000ba  2e01              CMP      r6,#1                 ;3301
0000bc  d103              BNE      |L5.198|
0000be  2d01              CMP      r5,#1                 ;3301
0000c0  d101              BNE      |L5.198|
0000c2  2006              MOVS     r0,#6                 ;3303
0000c4  e7a4              B        |L5.16|
                  |L5.198|
0000c6  2e01              CMP      r6,#1                 ;3305
0000c8  d101              BNE      |L5.206|
0000ca  2005              MOVS     r0,#5                 ;3307
0000cc  e7a0              B        |L5.16|
                  |L5.206|
0000ce  2d01              CMP      r5,#1                 ;3309
0000d0  d101              BNE      |L5.214|
0000d2  2004              MOVS     r0,#4                 ;3311
0000d4  e79c              B        |L5.16|
                  |L5.214|
0000d6  00e0              LSLS     r0,r4,#3              ;3315
0000d8  4909              LDR      r1,|L5.256|
0000da  1840              ADDS     r0,r0,r1              ;3315
0000dc  9a02              LDR      r2,[sp,#8]            ;3315
0000de  9901              LDR      r1,[sp,#4]            ;3315
0000e0  c006              STM      r0!,{r1,r2}           ;3315
0000e2  00e0              LSLS     r0,r4,#3              ;3316
0000e4  4906              LDR      r1,|L5.256|
0000e6  1840              ADDS     r0,r0,r1              ;3316
0000e8  7147              STRB     r7,[r0,#5]            ;3316
0000ea  4807              LDR      r0,|L5.264|
0000ec  8800              LDRH     r0,[r0,#0]            ;3317  ; ChannelsMask
0000ee  2101              MOVS     r1,#1                 ;3317
0000f0  40a1              LSLS     r1,r1,r4              ;3317
0000f2  4308              ORRS     r0,r0,r1              ;3317
0000f4  4904              LDR      r1,|L5.264|
0000f6  8008              STRH     r0,[r1,#0]            ;3317
0000f8  2000              MOVS     r0,#0                 ;3319
0000fa  e789              B        |L5.16|
;;;3322   
                          ENDP

                  |L5.252|
                          DCD      LoRaMacState
                  |L5.256|
                          DCD      Channels
                  |L5.260|
                          DCD      Radio
                  |L5.264|
                          DCD      ChannelsMask

                          AREA ||i.LoRaMacChannelRemove||, CODE, READONLY, ALIGN=2

                  LoRaMacChannelRemove PROC
;;;3322   
;;;3323   LoRaMacStatus_t LoRaMacChannelRemove( uint8_t id )
000000  b51c              PUSH     {r2-r4,lr}
;;;3324   {
000002  4604              MOV      r4,r0
;;;3325   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;3326       if( ( LoRaMacState & MAC_TX_RUNNING ) == MAC_TX_RUNNING )
000004  4812              LDR      r0,|L6.80|
000006  7800              LDRB     r0,[r0,#0]  ; LoRaMacState
000008  07c0              LSLS     r0,r0,#31
00000a  0fc0              LSRS     r0,r0,#31
00000c  2800              CMP      r0,#0
00000e  d007              BEQ      |L6.32|
;;;3327       {
;;;3328           if( ( LoRaMacState & MAC_TX_CONFIG ) != MAC_TX_CONFIG )
000010  480f              LDR      r0,|L6.80|
000012  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000014  2120              MOVS     r1,#0x20
000016  4008              ANDS     r0,r0,r1
000018  2820              CMP      r0,#0x20
00001a  d001              BEQ      |L6.32|
;;;3329           {
;;;3330               return LORAMAC_STATUS_BUSY;
00001c  2001              MOVS     r0,#1
                  |L6.30|
;;;3331           }
;;;3332       }
;;;3333   
;;;3334       if( id < 3 )
;;;3335       {
;;;3336           return LORAMAC_STATUS_PARAMETER_INVALID;
;;;3337       }
;;;3338       else
;;;3339       {
;;;3340           // Remove the channel from the list of channels
;;;3341           Channels[id] = ( ChannelParams_t ){ 0, { 0 }, 0 };
;;;3342           
;;;3343           // Disable the channel as it doesn't exist anymore
;;;3344           if( DisableChannelInMask( id, ChannelsMask ) == false )
;;;3345           {
;;;3346               return LORAMAC_STATUS_PARAMETER_INVALID;
;;;3347           }
;;;3348       }
;;;3349       return LORAMAC_STATUS_OK;
;;;3350   #elif ( defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID ) )
;;;3351       return LORAMAC_STATUS_PARAMETER_INVALID;
;;;3352   #endif
;;;3353   }
00001e  bd1c              POP      {r2-r4,pc}
                  |L6.32|
000020  2c03              CMP      r4,#3                 ;3334
000022  da01              BGE      |L6.40|
000024  2003              MOVS     r0,#3                 ;3336
000026  e7fa              B        |L6.30|
                  |L6.40|
000028  2000              MOVS     r0,#0                 ;3341
00002a  9000              STR      r0,[sp,#0]            ;3341
00002c  9001              STR      r0,[sp,#4]            ;3341
00002e  00e0              LSLS     r0,r4,#3              ;3341
000030  4908              LDR      r1,|L6.84|
000032  1840              ADDS     r0,r0,r1              ;3341
000034  9a01              LDR      r2,[sp,#4]            ;3341
000036  9900              LDR      r1,[sp,#0]            ;3341
000038  c006              STM      r0!,{r1,r2}           ;3341
00003a  4907              LDR      r1,|L6.88|
00003c  4620              MOV      r0,r4                 ;3344
00003e  f7fffffe          BL       DisableChannelInMask
000042  2800              CMP      r0,#0                 ;3344
000044  d101              BNE      |L6.74|
000046  2003              MOVS     r0,#3                 ;3346
000048  e7e9              B        |L6.30|
                  |L6.74|
00004a  bf00              NOP                            ;3348
00004c  2000              MOVS     r0,#0                 ;3349
00004e  e7e6              B        |L6.30|
;;;3354   
                          ENDP

                  |L6.80|
                          DCD      LoRaMacState
                  |L6.84|
                          DCD      Channels
                  |L6.88|
                          DCD      ChannelsMask

                          AREA ||i.LoRaMacInitialization||, CODE, READONLY, ALIGN=2

                  LoRaMacInitialization PROC
;;;2691   
;;;2692   LoRaMacStatus_t LoRaMacInitialization( LoRaMacPrimitives_t *primitives, LoRaMacCallback_t *callbacks )
000000  b570              PUSH     {r4-r6,lr}
;;;2693   {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;2694       if( primitives == NULL )
000006  2c00              CMP      r4,#0
000008  d101              BNE      |L7.14|
;;;2695       {
;;;2696           return LORAMAC_STATUS_PARAMETER_INVALID;
00000a  2003              MOVS     r0,#3
                  |L7.12|
;;;2697       }
;;;2698   
;;;2699       if( ( primitives->MacMcpsConfirm == NULL ) ||
;;;2700           ( primitives->MacMcpsIndication == NULL ) ||
;;;2701           ( primitives->MacMlmeConfirm == NULL ))
;;;2702       {
;;;2703           return LORAMAC_STATUS_PARAMETER_INVALID;
;;;2704       }
;;;2705   
;;;2706       LoRaMacPrimitives = primitives;
;;;2707       LoRaMacCallbacks = callbacks;
;;;2708   
;;;2709       LoRaMacFlags.Value = 0;
;;;2710   
;;;2711       LoRaMacDeviceClass = CLASS_A;
;;;2712   
;;;2713       UpLinkCounter = 1;
;;;2714       DownLinkCounter = 0;
;;;2715       AdrAckCounter = 0;
;;;2716   
;;;2717       RepeaterSupport = false;
;;;2718       IsRxWindowsEnabled = true;
;;;2719       IsLoRaMacNetworkJoined = false;
;;;2720       LoRaMacState = MAC_IDLE;
;;;2721   
;;;2722   #if defined( USE_BAND_433 )
;;;2723       ChannelsMask[0] = LC( 1 ) + LC( 2 ) + LC( 3 );
;;;2724   #elif defined( USE_BAND_780 )
;;;2725       ChannelsMask[0] = LC( 1 ) + LC( 2 ) + LC( 3 );
;;;2726   #elif defined( USE_BAND_868 )
;;;2727       ChannelsMask[0] = LC( 1 ) + LC( 2 ) + LC( 3 );
;;;2728   #elif defined( USE_BAND_915 )
;;;2729       ChannelsMask[0] = 0xFFFF;
;;;2730       ChannelsMask[1] = 0xFFFF;
;;;2731       ChannelsMask[2] = 0xFFFF;
;;;2732       ChannelsMask[3] = 0xFFFF;
;;;2733       ChannelsMask[4] = 0x00FF;
;;;2734       ChannelsMask[5] = 0x0000;
;;;2735   
;;;2736       memcpy1( ( uint8_t* ) ChannelsMaskRemaining, ( uint8_t* ) ChannelsMask, sizeof( ChannelsMask ) );
;;;2737   #elif defined( USE_BAND_915_HYBRID )
;;;2738       ChannelsMask[0] = 0x00FF;
;;;2739       ChannelsMask[1] = 0x0000;
;;;2740       ChannelsMask[2] = 0x0000;
;;;2741       ChannelsMask[3] = 0x0000;
;;;2742       ChannelsMask[4] = 0x0001;
;;;2743       ChannelsMask[5] = 0x0000;
;;;2744   
;;;2745       memcpy1( ( uint8_t* ) ChannelsMaskRemaining, ( uint8_t* ) ChannelsMask, sizeof( ChannelsMask ) );
;;;2746   #else
;;;2747       #error "Please define a frequency band in the compiler options."
;;;2748   #endif
;;;2749   
;;;2750   #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;2751       // 125 kHz channels
;;;2752       for( uint8_t i = 0; i < LORA_MAX_NB_CHANNELS - 8; i++ )
;;;2753       {
;;;2754           Channels[i].Frequency = 902.3e6 + i * 200e3;
;;;2755           Channels[i].DrRange.Value = ( DR_3 << 4 ) | DR_0;
;;;2756           Channels[i].Band = 0;
;;;2757       }
;;;2758       // 500 kHz channels
;;;2759       for( uint8_t i = LORA_MAX_NB_CHANNELS - 8; i < LORA_MAX_NB_CHANNELS; i++ )
;;;2760       {
;;;2761           Channels[i].Frequency = 903.0e6 + ( i - ( LORA_MAX_NB_CHANNELS - 8 ) ) * 1.6e6;
;;;2762           Channels[i].DrRange.Value = ( DR_4 << 4 ) | DR_4;
;;;2763           Channels[i].Band = 0;
;;;2764       }
;;;2765   #endif
;;;2766   
;;;2767       ChannelsTxPower = LORAMAC_DEFAULT_TX_POWER;
;;;2768       ChannelsDefaultDatarate = ChannelsDatarate = LORAMAC_DEFAULT_DATARATE;
;;;2769       ChannelsNbRep = 1;
;;;2770       ChannelsNbRepCounter = 0;
;;;2771   
;;;2772       MaxDCycle = 0;
;;;2773       AggregatedDCycle = 1;
;;;2774       AggregatedLastTxDoneTime = 0;
;;;2775       AggregatedTimeOff = 0;
;;;2776   
;;;2777   #if defined( USE_BAND_433 )
;;;2778       DutyCycleOn = false;
;;;2779   #elif defined( USE_BAND_780 )
;;;2780       DutyCycleOn = false;
;;;2781   #elif defined( USE_BAND_868 )
;;;2782       DutyCycleOn = true;
;;;2783   #elif defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;2784       DutyCycleOn = false;
;;;2785   #else
;;;2786       #error "Please define a frequency band in the compiler options."
;;;2787   #endif
;;;2788   
;;;2789       MaxRxWindow = MAX_RX_WINDOW;
;;;2790       ReceiveDelay1 = RECEIVE_DELAY1;
;;;2791       ReceiveDelay2 = RECEIVE_DELAY2;
;;;2792       JoinAcceptDelay1 = JOIN_ACCEPT_DELAY1;
;;;2793       JoinAcceptDelay2 = JOIN_ACCEPT_DELAY2;
;;;2794   
;;;2795       TimerInit( &MacStateCheckTimer, OnMacStateCheckTimerEvent );
;;;2796       TimerSetValue( &MacStateCheckTimer, MAC_STATE_CHECK_TIMEOUT );
;;;2797   
;;;2798       TimerInit( &TxDelayedTimer, OnTxDelayedTimerEvent );
;;;2799       TimerInit( &RxWindowTimer1, OnRxWindow1TimerEvent );
;;;2800       TimerInit( &RxWindowTimer2, OnRxWindow2TimerEvent );
;;;2801       TimerInit( &AckTimeoutTimer, OnAckTimeoutTimerEvent );
;;;2802   
;;;2803       // Initialize Radio driver
;;;2804       RadioEvents.TxDone = OnRadioTxDone;
;;;2805       RadioEvents.RxDone = OnRadioRxDone;
;;;2806       RadioEvents.RxError = OnRadioRxError;
;;;2807       RadioEvents.TxTimeout = OnRadioTxTimeout;
;;;2808       RadioEvents.RxTimeout = OnRadioRxTimeout;
;;;2809       Radio.Init( &RadioEvents );
;;;2810   
;;;2811       // Random seed initialization
;;;2812       srand1( Radio.Random( ) );
;;;2813   
;;;2814       // Initialize channel index.
;;;2815       Channel = LORA_MAX_NB_CHANNELS;
;;;2816   
;;;2817       PublicNetwork = true;
;;;2818       SetPublicNetwork( PublicNetwork );
;;;2819       Radio.Sleep( );
;;;2820   
;;;2821       return LORAMAC_STATUS_OK;
;;;2822   }
00000c  bd70              POP      {r4-r6,pc}
                  |L7.14|
00000e  6820              LDR      r0,[r4,#0]            ;2699
000010  2800              CMP      r0,#0                 ;2699
000012  d005              BEQ      |L7.32|
000014  6860              LDR      r0,[r4,#4]            ;2700
000016  2800              CMP      r0,#0                 ;2700
000018  d002              BEQ      |L7.32|
00001a  68a0              LDR      r0,[r4,#8]            ;2701
00001c  2800              CMP      r0,#0                 ;2701
00001e  d101              BNE      |L7.36|
                  |L7.32|
000020  2003              MOVS     r0,#3                 ;2703
000022  e7f3              B        |L7.12|
                  |L7.36|
000024  4842              LDR      r0,|L7.304|
000026  6004              STR      r4,[r0,#0]            ;2706  ; LoRaMacPrimitives
000028  4842              LDR      r0,|L7.308|
00002a  6005              STR      r5,[r0,#0]            ;2707  ; LoRaMacCallbacks
00002c  2000              MOVS     r0,#0                 ;2709
00002e  4942              LDR      r1,|L7.312|
000030  7008              STRB     r0,[r1,#0]            ;2709
000032  4942              LDR      r1,|L7.316|
000034  7008              STRB     r0,[r1,#0]            ;2711
000036  2001              MOVS     r0,#1                 ;2713
000038  4941              LDR      r1,|L7.320|
00003a  6008              STR      r0,[r1,#0]            ;2713  ; UpLinkCounter
00003c  2000              MOVS     r0,#0                 ;2714
00003e  4941              LDR      r1,|L7.324|
000040  6008              STR      r0,[r1,#0]            ;2714  ; DownLinkCounter
000042  4941              LDR      r1,|L7.328|
000044  6008              STR      r0,[r1,#0]            ;2715  ; AdrAckCounter
000046  4941              LDR      r1,|L7.332|
000048  7008              STRB     r0,[r1,#0]            ;2717
00004a  2001              MOVS     r0,#1                 ;2718
00004c  4940              LDR      r1,|L7.336|
00004e  7008              STRB     r0,[r1,#0]            ;2718
000050  2000              MOVS     r0,#0                 ;2719
000052  4940              LDR      r1,|L7.340|
000054  7008              STRB     r0,[r1,#0]            ;2719
000056  4940              LDR      r1,|L7.344|
000058  6008              STR      r0,[r1,#0]            ;2720  ; LoRaMacState
00005a  2007              MOVS     r0,#7                 ;2723
00005c  493f              LDR      r1,|L7.348|
00005e  8008              STRH     r0,[r1,#0]            ;2723
000060  2000              MOVS     r0,#0                 ;2767
000062  493f              LDR      r1,|L7.352|
000064  7008              STRB     r0,[r1,#0]            ;2767
000066  493f              LDR      r1,|L7.356|
000068  7008              STRB     r0,[r1,#0]            ;2768
00006a  493f              LDR      r1,|L7.360|
00006c  7008              STRB     r0,[r1,#0]            ;2768
00006e  2001              MOVS     r0,#1                 ;2769
000070  493e              LDR      r1,|L7.364|
000072  7008              STRB     r0,[r1,#0]            ;2769
000074  2000              MOVS     r0,#0                 ;2770
000076  493e              LDR      r1,|L7.368|
000078  7008              STRB     r0,[r1,#0]            ;2770
00007a  493e              LDR      r1,|L7.372|
00007c  7008              STRB     r0,[r1,#0]            ;2772
00007e  2001              MOVS     r0,#1                 ;2773
000080  493d              LDR      r1,|L7.376|
000082  8008              STRH     r0,[r1,#0]            ;2773
000084  2100              MOVS     r1,#0                 ;2774
000086  4a3d              LDR      r2,|L7.380|
000088  6011              STR      r1,[r2,#0]            ;2774  ; AggregatedLastTxDoneTime
00008a  6051              STR      r1,[r2,#4]            ;2774  ; AggregatedLastTxDoneTime
00008c  4a3c              LDR      r2,|L7.384|
00008e  6011              STR      r1,[r2,#0]            ;2775  ; AggregatedTimeOff
000090  6051              STR      r1,[r2,#4]            ;2775  ; AggregatedTimeOff
000092  2000              MOVS     r0,#0                 ;2778
000094  493b              LDR      r1,|L7.388|
000096  7008              STRB     r0,[r1,#0]            ;2778
000098  483b              LDR      r0,|L7.392|
00009a  493c              LDR      r1,|L7.396|
00009c  6008              STR      r0,[r1,#0]            ;2789  ; MaxRxWindow
00009e  483c              LDR      r0,|L7.400|
0000a0  493c              LDR      r1,|L7.404|
0000a2  6008              STR      r0,[r1,#0]            ;2790  ; ReceiveDelay1
0000a4  0040              LSLS     r0,r0,#1              ;2791
0000a6  493c              LDR      r1,|L7.408|
0000a8  6008              STR      r0,[r1,#0]            ;2791  ; ReceiveDelay2
0000aa  483c              LDR      r0,|L7.412|
0000ac  493c              LDR      r1,|L7.416|
0000ae  6008              STR      r0,[r1,#0]            ;2792  ; JoinAcceptDelay1
0000b0  483c              LDR      r0,|L7.420|
0000b2  493d              LDR      r1,|L7.424|
0000b4  6008              STR      r0,[r1,#0]            ;2793  ; JoinAcceptDelay2
0000b6  493d              LDR      r1,|L7.428|
0000b8  483d              LDR      r0,|L7.432|
0000ba  f7fffffe          BL       TimerInit
0000be  4934              LDR      r1,|L7.400|
0000c0  483b              LDR      r0,|L7.432|
0000c2  f7fffffe          BL       TimerSetValue
0000c6  493b              LDR      r1,|L7.436|
0000c8  483b              LDR      r0,|L7.440|
0000ca  f7fffffe          BL       TimerInit
0000ce  493b              LDR      r1,|L7.444|
0000d0  483b              LDR      r0,|L7.448|
0000d2  f7fffffe          BL       TimerInit
0000d6  493b              LDR      r1,|L7.452|
0000d8  483b              LDR      r0,|L7.456|
0000da  f7fffffe          BL       TimerInit
0000de  493b              LDR      r1,|L7.460|
0000e0  483b              LDR      r0,|L7.464|
0000e2  f7fffffe          BL       TimerInit
0000e6  483b              LDR      r0,|L7.468|
0000e8  493b              LDR      r1,|L7.472|
0000ea  6008              STR      r0,[r1,#0]            ;2804  ; RadioEvents
0000ec  483b              LDR      r0,|L7.476|
0000ee  6088              STR      r0,[r1,#8]            ;2805  ; RadioEvents
0000f0  483b              LDR      r0,|L7.480|
0000f2  6108              STR      r0,[r1,#0x10]         ;2806  ; RadioEvents
0000f4  483b              LDR      r0,|L7.484|
0000f6  6048              STR      r0,[r1,#4]            ;2807  ; RadioEvents
0000f8  483b              LDR      r0,|L7.488|
0000fa  60c8              STR      r0,[r1,#0xc]          ;2808  ; RadioEvents
0000fc  483b              LDR      r0,|L7.492|
0000fe  6801              LDR      r1,[r0,#0]            ;2809  ; Radio
000100  4835              LDR      r0,|L7.472|
000102  4788              BLX      r1                    ;2809
000104  4939              LDR      r1,|L7.492|
000106  6948              LDR      r0,[r1,#0x14]         ;2812  ; Radio
000108  4780              BLX      r0                    ;2812
00010a  4606              MOV      r6,r0                 ;2812
00010c  f7fffffe          BL       srand1
000110  2008              MOVS     r0,#8                 ;2815
000112  4937              LDR      r1,|L7.496|
000114  7008              STRB     r0,[r1,#0]            ;2815
000116  2001              MOVS     r0,#1                 ;2817
000118  4936              LDR      r1,|L7.500|
00011a  7008              STRB     r0,[r1,#0]            ;2817
00011c  4608              MOV      r0,r1                 ;2818
00011e  7800              LDRB     r0,[r0,#0]            ;2818  ; PublicNetwork
000120  f7fffffe          BL       SetPublicNetwork
000124  4931              LDR      r1,|L7.492|
000126  6ac8              LDR      r0,[r1,#0x2c]         ;2819  ; Radio
000128  4780              BLX      r0                    ;2819
00012a  2000              MOVS     r0,#0                 ;2821
00012c  e76e              B        |L7.12|
;;;2823   
                          ENDP

00012e  0000              DCW      0x0000
                  |L7.304|
                          DCD      LoRaMacPrimitives
                  |L7.308|
                          DCD      LoRaMacCallbacks
                  |L7.312|
                          DCD      LoRaMacFlags
                  |L7.316|
                          DCD      LoRaMacDeviceClass
                  |L7.320|
                          DCD      UpLinkCounter
                  |L7.324|
                          DCD      DownLinkCounter
                  |L7.328|
                          DCD      AdrAckCounter
                  |L7.332|
                          DCD      RepeaterSupport
                  |L7.336|
                          DCD      IsRxWindowsEnabled
                  |L7.340|
                          DCD      IsLoRaMacNetworkJoined
                  |L7.344|
                          DCD      LoRaMacState
                  |L7.348|
                          DCD      ChannelsMask
                  |L7.352|
                          DCD      ChannelsTxPower
                  |L7.356|
                          DCD      ChannelsDatarate
                  |L7.360|
                          DCD      ChannelsDefaultDatarate
                  |L7.364|
                          DCD      ChannelsNbRep
                  |L7.368|
                          DCD      ChannelsNbRepCounter
                  |L7.372|
                          DCD      MaxDCycle
                  |L7.376|
                          DCD      AggregatedDCycle
                  |L7.380|
                          DCD      AggregatedLastTxDoneTime
                  |L7.384|
                          DCD      AggregatedTimeOff
                  |L7.388|
                          DCD      DutyCycleOn
                  |L7.392|
                          DCD      0x002dc6c0
                  |L7.396|
                          DCD      MaxRxWindow
                  |L7.400|
                          DCD      0x000f4240
                  |L7.404|
                          DCD      ReceiveDelay1
                  |L7.408|
                          DCD      ReceiveDelay2
                  |L7.412|
                          DCD      0x004c4b40
                  |L7.416|
                          DCD      JoinAcceptDelay1
                  |L7.420|
                          DCD      0x005b8d80
                  |L7.424|
                          DCD      JoinAcceptDelay2
                  |L7.428|
                          DCD      OnMacStateCheckTimerEvent
                  |L7.432|
                          DCD      MacStateCheckTimer
                  |L7.436|
                          DCD      OnTxDelayedTimerEvent
                  |L7.440|
                          DCD      TxDelayedTimer
                  |L7.444|
                          DCD      OnRxWindow1TimerEvent
                  |L7.448|
                          DCD      RxWindowTimer1
                  |L7.452|
                          DCD      OnRxWindow2TimerEvent
                  |L7.456|
                          DCD      RxWindowTimer2
                  |L7.460|
                          DCD      OnAckTimeoutTimerEvent
                  |L7.464|
                          DCD      AckTimeoutTimer
                  |L7.468|
                          DCD      OnRadioTxDone
                  |L7.472|
                          DCD      RadioEvents
                  |L7.476|
                          DCD      OnRadioRxDone
                  |L7.480|
                          DCD      OnRadioRxError
                  |L7.484|
                          DCD      OnRadioTxTimeout
                  |L7.488|
                          DCD      OnRadioRxTimeout
                  |L7.492|
                          DCD      Radio
                  |L7.496|
                          DCD      Channel
                  |L7.500|
                          DCD      PublicNetwork

                          AREA ||i.LoRaMacMcpsRequest||, CODE, READONLY, ALIGN=2

                  LoRaMacMcpsRequest PROC
;;;3521   
;;;3522   LoRaMacStatus_t LoRaMacMcpsRequest( McpsReq_t *mcpsRequest )
000000  b5f0              PUSH     {r4-r7,lr}
;;;3523   {
000002  b085              SUB      sp,sp,#0x14
000004  4604              MOV      r4,r0
;;;3524       LoRaMacStatus_t status = LORAMAC_STATUS_SERVICE_UNKNOWN;
000006  2002              MOVS     r0,#2
000008  9003              STR      r0,[sp,#0xc]
;;;3525       LoRaMacHeader_t macHdr;
;;;3526       uint8_t fPort = 0;
00000a  2000              MOVS     r0,#0
00000c  9001              STR      r0,[sp,#4]
;;;3527       void *fBuffer;
;;;3528       uint16_t fBufferSize;
;;;3529       int8_t datarate;
;;;3530       bool readyToSend = false;
00000e  9000              STR      r0,[sp,#0]
;;;3531   
;;;3532       if( mcpsRequest == NULL )
000010  2c00              CMP      r4,#0
000012  d102              BNE      |L8.26|
;;;3533       {
;;;3534           return LORAMAC_STATUS_PARAMETER_INVALID;
000014  2003              MOVS     r0,#3
                  |L8.22|
;;;3535       }
;;;3536       if( ( ( LoRaMacState & MAC_TX_RUNNING ) == MAC_TX_RUNNING ) ||
;;;3537           ( ( LoRaMacState & MAC_TX_DELAYED ) == MAC_TX_DELAYED ) )
;;;3538       {
;;;3539           return LORAMAC_STATUS_BUSY;
;;;3540       }
;;;3541   
;;;3542       macHdr.Value = 0;
;;;3543       memset1 ( ( uint8_t* ) &McpsConfirm, 0, sizeof( McpsConfirm ) );
;;;3544       McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
;;;3545   
;;;3546       switch( mcpsRequest->Type )
;;;3547       {
;;;3548           case MCPS_UNCONFIRMED:
;;;3549           {
;;;3550               readyToSend = true;
;;;3551               AckTimeoutRetries = 1;
;;;3552   
;;;3553               macHdr.Bits.MType = FRAME_TYPE_DATA_UNCONFIRMED_UP;
;;;3554               fPort = mcpsRequest->Req.Unconfirmed.fPort;
;;;3555               fBuffer = mcpsRequest->Req.Unconfirmed.fBuffer;
;;;3556               fBufferSize = mcpsRequest->Req.Unconfirmed.fBufferSize;
;;;3557               datarate = mcpsRequest->Req.Unconfirmed.Datarate;
;;;3558               break;
;;;3559           }
;;;3560           case MCPS_CONFIRMED:
;;;3561           {
;;;3562               readyToSend = true;
;;;3563               AckTimeoutRetriesCounter = 1;
;;;3564               AckTimeoutRetries = mcpsRequest->Req.Confirmed.NbTrials;
;;;3565   
;;;3566               macHdr.Bits.MType = FRAME_TYPE_DATA_CONFIRMED_UP;
;;;3567               fPort = mcpsRequest->Req.Confirmed.fPort;
;;;3568               fBuffer = mcpsRequest->Req.Confirmed.fBuffer;
;;;3569               fBufferSize = mcpsRequest->Req.Confirmed.fBufferSize;
;;;3570               datarate = mcpsRequest->Req.Confirmed.Datarate;
;;;3571               break;
;;;3572           }
;;;3573           case MCPS_PROPRIETARY:
;;;3574           {
;;;3575               readyToSend = true;
;;;3576               AckTimeoutRetries = 1;
;;;3577   
;;;3578               macHdr.Bits.MType = FRAME_TYPE_PROPRIETARY;
;;;3579               fBuffer = mcpsRequest->Req.Proprietary.fBuffer;
;;;3580               fBufferSize = mcpsRequest->Req.Proprietary.fBufferSize;
;;;3581               datarate = mcpsRequest->Req.Proprietary.Datarate;
;;;3582               break;
;;;3583           }
;;;3584           default:
;;;3585               break;
;;;3586       }
;;;3587   
;;;3588       if( readyToSend == true )
;;;3589       {
;;;3590           if( AdrCtrlOn == false )
;;;3591           {
;;;3592               if( ValueInRange( datarate, LORAMAC_MIN_DATARATE, LORAMAC_MAX_DATARATE ) == true )
;;;3593               {
;;;3594                   ChannelsDatarate = datarate;
;;;3595               }
;;;3596               else
;;;3597               {
;;;3598                   return LORAMAC_STATUS_PARAMETER_INVALID;
;;;3599               }
;;;3600           }
;;;3601   
;;;3602           status = Send( &macHdr, fPort, fBuffer, fBufferSize );
;;;3603           if( status == LORAMAC_STATUS_OK )
;;;3604           {
;;;3605               McpsConfirm.McpsRequest = mcpsRequest->Type;
;;;3606               LoRaMacFlags.Bits.McpsReq = 1;
;;;3607           }
;;;3608           else
;;;3609           {
;;;3610               NodeAckRequested = false;
;;;3611           }
;;;3612       }
;;;3613   
;;;3614       return status;
;;;3615   }
000016  b005              ADD      sp,sp,#0x14
000018  bdf0              POP      {r4-r7,pc}
                  |L8.26|
00001a  4841              LDR      r0,|L8.288|
00001c  7800              LDRB     r0,[r0,#0]            ;3536  ; LoRaMacState
00001e  07c0              LSLS     r0,r0,#31             ;3536
000020  0fc0              LSRS     r0,r0,#31             ;3536
000022  2800              CMP      r0,#0                 ;3536
000024  d105              BNE      |L8.50|
000026  483e              LDR      r0,|L8.288|
000028  6800              LDR      r0,[r0,#0]            ;3537  ; LoRaMacState
00002a  2110              MOVS     r1,#0x10              ;3537
00002c  4008              ANDS     r0,r0,r1              ;3537
00002e  2810              CMP      r0,#0x10              ;3537
000030  d101              BNE      |L8.54|
                  |L8.50|
000032  2001              MOVS     r0,#1                 ;3539
000034  e7ef              B        |L8.22|
                  |L8.54|
000036  2000              MOVS     r0,#0                 ;3542
000038  9002              STR      r0,[sp,#8]            ;3542
00003a  2218              MOVS     r2,#0x18              ;3543
00003c  2100              MOVS     r1,#0                 ;3543
00003e  4839              LDR      r0,|L8.292|
000040  f7fffffe          BL       memset1
000044  2001              MOVS     r0,#1                 ;3544
000046  4937              LDR      r1,|L8.292|
000048  7048              STRB     r0,[r1,#1]            ;3544
00004a  7820              LDRB     r0,[r4,#0]            ;3546
00004c  2800              CMP      r0,#0                 ;3546
00004e  d004              BEQ      |L8.90|
000050  2801              CMP      r0,#1                 ;3546
000052  d013              BEQ      |L8.124|
000054  2803              CMP      r0,#3                 ;3546
000056  d134              BNE      |L8.194|
000058  e024              B        |L8.164|
                  |L8.90|
00005a  2001              MOVS     r0,#1                 ;3550
00005c  9000              STR      r0,[sp,#0]            ;3550
00005e  4932              LDR      r1,|L8.296|
000060  7008              STRB     r0,[r1,#0]            ;3551
000062  4669              MOV      r1,sp                 ;3553
000064  7a08              LDRB     r0,[r1,#8]            ;3553
000066  21e0              MOVS     r1,#0xe0              ;3553
000068  4388              BICS     r0,r0,r1              ;3553
00006a  3040              ADDS     r0,r0,#0x40           ;3553
00006c  9002              STR      r0,[sp,#8]            ;3553
00006e  7920              LDRB     r0,[r4,#4]            ;3554
000070  9001              STR      r0,[sp,#4]            ;3554
000072  68a6              LDR      r6,[r4,#8]            ;3555
000074  89a7              LDRH     r7,[r4,#0xc]          ;3556
000076  250e              MOVS     r5,#0xe               ;3557
000078  5765              LDRSB    r5,[r4,r5]            ;3557
00007a  e023              B        |L8.196|
                  |L8.124|
00007c  2001              MOVS     r0,#1                 ;3562
00007e  9000              STR      r0,[sp,#0]            ;3562
000080  492a              LDR      r1,|L8.300|
000082  7008              STRB     r0,[r1,#0]            ;3563
000084  7be0              LDRB     r0,[r4,#0xf]          ;3564
000086  4928              LDR      r1,|L8.296|
000088  7008              STRB     r0,[r1,#0]            ;3564
00008a  4669              MOV      r1,sp                 ;3566
00008c  7a08              LDRB     r0,[r1,#8]            ;3566
00008e  21e0              MOVS     r1,#0xe0              ;3566
000090  4388              BICS     r0,r0,r1              ;3566
000092  3080              ADDS     r0,r0,#0x80           ;3566
000094  9002              STR      r0,[sp,#8]            ;3566
000096  7920              LDRB     r0,[r4,#4]            ;3567
000098  9001              STR      r0,[sp,#4]            ;3567
00009a  68a6              LDR      r6,[r4,#8]            ;3568
00009c  89a7              LDRH     r7,[r4,#0xc]          ;3569
00009e  250e              MOVS     r5,#0xe               ;3570
0000a0  5765              LDRSB    r5,[r4,r5]            ;3570
0000a2  e00f              B        |L8.196|
                  |L8.164|
0000a4  2001              MOVS     r0,#1                 ;3575
0000a6  9000              STR      r0,[sp,#0]            ;3575
0000a8  491f              LDR      r1,|L8.296|
0000aa  7008              STRB     r0,[r1,#0]            ;3576
0000ac  4669              MOV      r1,sp                 ;3578
0000ae  7a08              LDRB     r0,[r1,#8]            ;3578
0000b0  21e0              MOVS     r1,#0xe0              ;3578
0000b2  4388              BICS     r0,r0,r1              ;3578
0000b4  30e0              ADDS     r0,r0,#0xe0           ;3578
0000b6  9002              STR      r0,[sp,#8]            ;3578
0000b8  6866              LDR      r6,[r4,#4]            ;3579
0000ba  8927              LDRH     r7,[r4,#8]            ;3580
0000bc  250a              MOVS     r5,#0xa               ;3581
0000be  5765              LDRSB    r5,[r4,r5]            ;3581
0000c0  e000              B        |L8.196|
                  |L8.194|
0000c2  bf00              NOP                            ;3585
                  |L8.196|
0000c4  bf00              NOP                            ;3558
0000c6  9800              LDR      r0,[sp,#0]            ;3588
0000c8  2801              CMP      r0,#1                 ;3588
0000ca  d127              BNE      |L8.284|
0000cc  4818              LDR      r0,|L8.304|
0000ce  7800              LDRB     r0,[r0,#0]            ;3590  ; AdrCtrlOn
0000d0  2800              CMP      r0,#0                 ;3590
0000d2  d10b              BNE      |L8.236|
0000d4  2200              MOVS     r2,#0                 ;3592
0000d6  2105              MOVS     r1,#5                 ;3592
0000d8  4628              MOV      r0,r5                 ;3592
0000da  f7fffffe          BL       ValueInRange
0000de  2800              CMP      r0,#0                 ;3592
0000e0  d002              BEQ      |L8.232|
0000e2  4814              LDR      r0,|L8.308|
0000e4  7005              STRB     r5,[r0,#0]            ;3594
0000e6  e001              B        |L8.236|
                  |L8.232|
0000e8  2003              MOVS     r0,#3                 ;3598
0000ea  e794              B        |L8.22|
                  |L8.236|
0000ec  463b              MOV      r3,r7                 ;3602
0000ee  4632              MOV      r2,r6                 ;3602
0000f0  a802              ADD      r0,sp,#8              ;3602
0000f2  9901              LDR      r1,[sp,#4]            ;3602
0000f4  f7fffffe          BL       Send
0000f8  9003              STR      r0,[sp,#0xc]          ;3602
0000fa  9803              LDR      r0,[sp,#0xc]          ;3603
0000fc  2800              CMP      r0,#0                 ;3603
0000fe  d10a              BNE      |L8.278|
000100  7820              LDRB     r0,[r4,#0]            ;3605
000102  4908              LDR      r1,|L8.292|
000104  7008              STRB     r0,[r1,#0]            ;3605
000106  480c              LDR      r0,|L8.312|
000108  7800              LDRB     r0,[r0,#0]            ;3606  ; LoRaMacFlags
00010a  0840              LSRS     r0,r0,#1              ;3606
00010c  0040              LSLS     r0,r0,#1              ;3606
00010e  1c40              ADDS     r0,r0,#1              ;3606
000110  4909              LDR      r1,|L8.312|
000112  7008              STRB     r0,[r1,#0]            ;3606
000114  e002              B        |L8.284|
                  |L8.278|
000116  2000              MOVS     r0,#0                 ;3610
000118  4908              LDR      r1,|L8.316|
00011a  7008              STRB     r0,[r1,#0]            ;3610
                  |L8.284|
00011c  9803              LDR      r0,[sp,#0xc]          ;3614
00011e  e77a              B        |L8.22|
;;;3616   
                          ENDP

                  |L8.288|
                          DCD      LoRaMacState
                  |L8.292|
                          DCD      McpsConfirm
                  |L8.296|
                          DCD      AckTimeoutRetries
                  |L8.300|
                          DCD      AckTimeoutRetriesCounter
                  |L8.304|
                          DCD      AdrCtrlOn
                  |L8.308|
                          DCD      ChannelsDatarate
                  |L8.312|
                          DCD      LoRaMacFlags
                  |L8.316|
                          DCD      NodeAckRequested

                          AREA ||i.LoRaMacMibGetRequestConfirm||, CODE, READONLY, ALIGN=2

                  LoRaMacMibGetRequestConfirm PROC
;;;2865   
;;;2866   LoRaMacStatus_t LoRaMacMibGetRequestConfirm( MibRequestConfirm_t *mibGet )
000000  b500              PUSH     {lr}
;;;2867   {
000002  4601              MOV      r1,r0
;;;2868       LoRaMacStatus_t status = LORAMAC_STATUS_OK;
000004  2200              MOVS     r2,#0
;;;2869   
;;;2870       if( mibGet == NULL )
000006  2900              CMP      r1,#0
000008  d101              BNE      |L9.14|
;;;2871       {
;;;2872           return LORAMAC_STATUS_PARAMETER_INVALID;
00000a  2003              MOVS     r0,#3
                  |L9.12|
;;;2873       }
;;;2874   
;;;2875       switch( mibGet->Type )
;;;2876       {
;;;2877           case MIB_DEVICE_CLASS:
;;;2878           {
;;;2879               mibGet->Param.Class = LoRaMacDeviceClass;
;;;2880               break;
;;;2881           }
;;;2882           case MIB_NETWORK_JOINED:
;;;2883           {
;;;2884               mibGet->Param.IsNetworkJoined = IsLoRaMacNetworkJoined;
;;;2885               break;
;;;2886           }
;;;2887           case MIB_ADR:
;;;2888           {
;;;2889               mibGet->Param.AdrEnable = AdrCtrlOn;
;;;2890               break;
;;;2891           }
;;;2892           case MIB_NET_ID:
;;;2893           {
;;;2894               mibGet->Param.NetID = LoRaMacNetID;
;;;2895               break;
;;;2896           }
;;;2897           case MIB_DEV_ADDR:
;;;2898           {
;;;2899               mibGet->Param.DevAddr = LoRaMacDevAddr;
;;;2900               break;
;;;2901           }
;;;2902           case MIB_NWK_SKEY:
;;;2903           {
;;;2904               mibGet->Param.NwkSKey = LoRaMacNwkSKey;
;;;2905               break;
;;;2906           }
;;;2907           case MIB_APP_SKEY:
;;;2908           {
;;;2909               mibGet->Param.AppSKey = LoRaMacAppSKey;
;;;2910               break;
;;;2911           }
;;;2912           case MIB_PUBLIC_NETWORK:
;;;2913           {
;;;2914               mibGet->Param.EnablePublicNetwork = PublicNetwork;
;;;2915               break;
;;;2916           }
;;;2917           case MIB_REPEATER_SUPPORT:
;;;2918           {
;;;2919               mibGet->Param.EnableRepeaterSupport = RepeaterSupport;
;;;2920               break;
;;;2921           }
;;;2922           case MIB_CHANNELS:
;;;2923           {
;;;2924               mibGet->Param.ChannelList = Channels;
;;;2925               break;
;;;2926           }
;;;2927           case MIB_RX2_CHANNEL:
;;;2928           {
;;;2929               mibGet->Param.Rx2Channel = Rx2Channel;
;;;2930               break;
;;;2931           }
;;;2932           case MIB_CHANNELS_MASK:
;;;2933           {
;;;2934               mibGet->Param.ChannelsMask = ChannelsMask;
;;;2935               break;
;;;2936           }
;;;2937           case MIB_CHANNELS_NB_REP:
;;;2938           {
;;;2939               mibGet->Param.ChannelNbRep = ChannelsNbRep;
;;;2940               break;
;;;2941           }
;;;2942           case MIB_MAX_RX_WINDOW_DURATION:
;;;2943           {
;;;2944               mibGet->Param.MaxRxWindow = MaxRxWindow;
;;;2945               break;
;;;2946           }
;;;2947           case MIB_RECEIVE_DELAY_1:
;;;2948           {
;;;2949               mibGet->Param.ReceiveDelay1 = ReceiveDelay1;
;;;2950               break;
;;;2951           }
;;;2952           case MIB_RECEIVE_DELAY_2:
;;;2953           {
;;;2954               mibGet->Param.ReceiveDelay2 = ReceiveDelay2;
;;;2955               break;
;;;2956           }
;;;2957           case MIB_JOIN_ACCEPT_DELAY_1:
;;;2958           {
;;;2959               mibGet->Param.JoinAcceptDelay1 = JoinAcceptDelay1;
;;;2960               break;
;;;2961           }
;;;2962           case MIB_JOIN_ACCEPT_DELAY_2:
;;;2963           {
;;;2964               mibGet->Param.JoinAcceptDelay2 = JoinAcceptDelay2;
;;;2965               break;
;;;2966           }
;;;2967           case MIB_CHANNELS_DATARATE:
;;;2968           {
;;;2969               mibGet->Param.ChannelsDatarate = ChannelsDatarate;
;;;2970               break;
;;;2971           }
;;;2972           case MIB_CHANNELS_TX_POWER:
;;;2973           {
;;;2974               mibGet->Param.ChannelsTxPower = ChannelsTxPower;
;;;2975               break;
;;;2976           }
;;;2977           case MIB_UPLINK_COUNTER:
;;;2978           {
;;;2979               mibGet->Param.UpLinkCounter = UpLinkCounter;
;;;2980               break;
;;;2981           }
;;;2982           case MIB_DOWNLINK_COUNTER:
;;;2983           {
;;;2984               mibGet->Param.DownLinkCounter = DownLinkCounter;
;;;2985               break;
;;;2986           }
;;;2987           case MIB_MULTICAST_CHANNEL:
;;;2988           {
;;;2989               mibGet->Param.MulticastList = MulticastChannels;
;;;2990               break;
;;;2991           }
;;;2992           default:
;;;2993               status = LORAMAC_STATUS_SERVICE_UNKNOWN;
;;;2994               break;
;;;2995       }
;;;2996   
;;;2997       return status;
;;;2998   }
00000c  bd00              POP      {pc}
                  |L9.14|
00000e  7808              LDRB     r0,[r1,#0]            ;2875
000010  0003              MOVS     r3,r0                 ;2875
000012  f7fffffe          BL       __ARM_common_switch8
000016  170d              DCB      0x17,0x0d
000018  1115191d          DCB      0x11,0x15,0x19,0x1d
00001c  2124272b          DCB      0x21,0x24,0x27,0x2b
000020  2f32373a          DCB      0x2f,0x32,0x37,0x3a
000024  3e42464a          DCB      0x3e,0x42,0x46,0x4a
000028  4e52575c          DCB      0x4e,0x52,0x57,0x5c
00002c  60646800          DCB      0x60,0x64,0x68,0x00
000030  482f              LDR      r0,|L9.240|
000032  7800              LDRB     r0,[r0,#0]            ;2879  ; LoRaMacDeviceClass
000034  7108              STRB     r0,[r1,#4]            ;2879
000036  e058              B        |L9.234|
000038  482e              LDR      r0,|L9.244|
00003a  7800              LDRB     r0,[r0,#0]            ;2884  ; IsLoRaMacNetworkJoined
00003c  7108              STRB     r0,[r1,#4]            ;2884
00003e  e054              B        |L9.234|
000040  482d              LDR      r0,|L9.248|
000042  7800              LDRB     r0,[r0,#0]            ;2889  ; AdrCtrlOn
000044  7108              STRB     r0,[r1,#4]            ;2889
000046  e050              B        |L9.234|
000048  482c              LDR      r0,|L9.252|
00004a  6800              LDR      r0,[r0,#0]            ;2894  ; LoRaMacNetID
00004c  6048              STR      r0,[r1,#4]            ;2894
00004e  e04c              B        |L9.234|
000050  482b              LDR      r0,|L9.256|
000052  6800              LDR      r0,[r0,#0]            ;2899  ; LoRaMacDevAddr
000054  6048              STR      r0,[r1,#4]            ;2899
000056  e048              B        |L9.234|
000058  482a              LDR      r0,|L9.260|
00005a  6048              STR      r0,[r1,#4]            ;2904
00005c  e045              B        |L9.234|
00005e  482a              LDR      r0,|L9.264|
000060  6048              STR      r0,[r1,#4]            ;2909
000062  e042              B        |L9.234|
000064  4829              LDR      r0,|L9.268|
000066  7800              LDRB     r0,[r0,#0]            ;2914  ; PublicNetwork
000068  7108              STRB     r0,[r1,#4]            ;2914
00006a  e03e              B        |L9.234|
00006c  4828              LDR      r0,|L9.272|
00006e  7800              LDRB     r0,[r0,#0]            ;2919  ; RepeaterSupport
000070  7108              STRB     r0,[r1,#4]            ;2919
000072  e03a              B        |L9.234|
000074  4827              LDR      r0,|L9.276|
000076  6048              STR      r0,[r1,#4]            ;2924
000078  e037              B        |L9.234|
00007a  4b27              LDR      r3,|L9.280|
00007c  cb09              LDM      r3,{r0,r3}            ;2929
00007e  608b              STR      r3,[r1,#8]            ;2929
000080  6048              STR      r0,[r1,#4]            ;2929
000082  e032              B        |L9.234|
000084  4825              LDR      r0,|L9.284|
000086  6048              STR      r0,[r1,#4]            ;2934
000088  e02f              B        |L9.234|
00008a  4825              LDR      r0,|L9.288|
00008c  7800              LDRB     r0,[r0,#0]            ;2939  ; ChannelsNbRep
00008e  7108              STRB     r0,[r1,#4]            ;2939
000090  e02b              B        |L9.234|
000092  4824              LDR      r0,|L9.292|
000094  6800              LDR      r0,[r0,#0]            ;2944  ; MaxRxWindow
000096  6048              STR      r0,[r1,#4]            ;2944
000098  e027              B        |L9.234|
00009a  4823              LDR      r0,|L9.296|
00009c  6800              LDR      r0,[r0,#0]            ;2949  ; ReceiveDelay1
00009e  6048              STR      r0,[r1,#4]            ;2949
0000a0  e023              B        |L9.234|
0000a2  4822              LDR      r0,|L9.300|
0000a4  6800              LDR      r0,[r0,#0]            ;2954  ; ReceiveDelay2
0000a6  6048              STR      r0,[r1,#4]            ;2954
0000a8  e01f              B        |L9.234|
0000aa  4821              LDR      r0,|L9.304|
0000ac  6800              LDR      r0,[r0,#0]            ;2959  ; JoinAcceptDelay1
0000ae  6048              STR      r0,[r1,#4]            ;2959
0000b0  e01b              B        |L9.234|
0000b2  4820              LDR      r0,|L9.308|
0000b4  6800              LDR      r0,[r0,#0]            ;2964  ; JoinAcceptDelay2
0000b6  6048              STR      r0,[r1,#4]            ;2964
0000b8  e017              B        |L9.234|
0000ba  4b1f              LDR      r3,|L9.312|
0000bc  2000              MOVS     r0,#0                 ;2969
0000be  5618              LDRSB    r0,[r3,r0]            ;2969  ; ChannelsDatarate
0000c0  7108              STRB     r0,[r1,#4]            ;2969
0000c2  e012              B        |L9.234|
0000c4  4b1d              LDR      r3,|L9.316|
0000c6  2000              MOVS     r0,#0                 ;2974
0000c8  5618              LDRSB    r0,[r3,r0]            ;2974  ; ChannelsTxPower
0000ca  7108              STRB     r0,[r1,#4]            ;2974
0000cc  e00d              B        |L9.234|
0000ce  481c              LDR      r0,|L9.320|
0000d0  6800              LDR      r0,[r0,#0]            ;2979  ; UpLinkCounter
0000d2  6048              STR      r0,[r1,#4]            ;2979
0000d4  e009              B        |L9.234|
0000d6  481b              LDR      r0,|L9.324|
0000d8  6800              LDR      r0,[r0,#0]            ;2984  ; DownLinkCounter
0000da  6048              STR      r0,[r1,#4]            ;2984
0000dc  e005              B        |L9.234|
0000de  481a              LDR      r0,|L9.328|
0000e0  6800              LDR      r0,[r0,#0]            ;2989  ; MulticastChannels
0000e2  6048              STR      r0,[r1,#4]            ;2989
0000e4  e001              B        |L9.234|
0000e6  2202              MOVS     r2,#2                 ;2993
0000e8  bf00              NOP                            ;2994
                  |L9.234|
0000ea  bf00              NOP                            ;2880
0000ec  4610              MOV      r0,r2                 ;2997
0000ee  e78d              B        |L9.12|
;;;2999   
                          ENDP

                  |L9.240|
                          DCD      LoRaMacDeviceClass
                  |L9.244|
                          DCD      IsLoRaMacNetworkJoined
                  |L9.248|
                          DCD      AdrCtrlOn
                  |L9.252|
                          DCD      LoRaMacNetID
                  |L9.256|
                          DCD      LoRaMacDevAddr
                  |L9.260|
                          DCD      LoRaMacNwkSKey
                  |L9.264|
                          DCD      LoRaMacAppSKey
                  |L9.268|
                          DCD      PublicNetwork
                  |L9.272|
                          DCD      RepeaterSupport
                  |L9.276|
                          DCD      Channels
                  |L9.280|
                          DCD      Rx2Channel
                  |L9.284|
                          DCD      ChannelsMask
                  |L9.288|
                          DCD      ChannelsNbRep
                  |L9.292|
                          DCD      MaxRxWindow
                  |L9.296|
                          DCD      ReceiveDelay1
                  |L9.300|
                          DCD      ReceiveDelay2
                  |L9.304|
                          DCD      JoinAcceptDelay1
                  |L9.308|
                          DCD      JoinAcceptDelay2
                  |L9.312|
                          DCD      ChannelsDatarate
                  |L9.316|
                          DCD      ChannelsTxPower
                  |L9.320|
                          DCD      UpLinkCounter
                  |L9.324|
                          DCD      DownLinkCounter
                  |L9.328|
                          DCD      MulticastChannels

                          AREA ||i.LoRaMacMibSetRequestConfirm||, CODE, READONLY, ALIGN=2

                  LoRaMacMibSetRequestConfirm PROC
;;;2999   
;;;3000   LoRaMacStatus_t LoRaMacMibSetRequestConfirm( MibRequestConfirm_t *mibSet )
000000  b570              PUSH     {r4-r6,lr}
;;;3001   {
000002  4604              MOV      r4,r0
;;;3002       LoRaMacStatus_t status = LORAMAC_STATUS_OK;
000004  2500              MOVS     r5,#0
;;;3003   
;;;3004       if( mibSet == NULL )
000006  2c00              CMP      r4,#0
000008  d101              BNE      |L10.14|
;;;3005       {
;;;3006           return LORAMAC_STATUS_PARAMETER_INVALID;
00000a  2003              MOVS     r0,#3
                  |L10.12|
;;;3007       }
;;;3008       if( ( LoRaMacState & MAC_TX_RUNNING ) == MAC_TX_RUNNING )
;;;3009       {
;;;3010           return LORAMAC_STATUS_BUSY;
;;;3011       }
;;;3012   
;;;3013       switch( mibSet->Type )
;;;3014       {
;;;3015           case MIB_DEVICE_CLASS:
;;;3016           {
;;;3017               LoRaMacDeviceClass = mibSet->Param.Class;
;;;3018               switch( LoRaMacDeviceClass )
;;;3019               {
;;;3020                   case CLASS_A:
;;;3021                   {
;;;3022                       // Set the radio into sleep to setup a defined state
;;;3023                       Radio.Sleep( );
;;;3024                       break;
;;;3025                   }
;;;3026                   case CLASS_B:
;;;3027                   {
;;;3028                       break;
;;;3029                   }
;;;3030                   case CLASS_C:
;;;3031                   {
;;;3032                       // Set the NodeAckRequested indicator to default
;;;3033                       NodeAckRequested = false;
;;;3034                       OnRxWindow2TimerEvent( );
;;;3035                       break;
;;;3036                   }
;;;3037               }
;;;3038               break;
;;;3039           }
;;;3040           case MIB_NETWORK_JOINED:
;;;3041           {
;;;3042               IsLoRaMacNetworkJoined = mibSet->Param.IsNetworkJoined;
;;;3043               break;
;;;3044           }
;;;3045           case MIB_ADR:
;;;3046           {
;;;3047               AdrCtrlOn = mibSet->Param.AdrEnable;
;;;3048               break;
;;;3049           }
;;;3050           case MIB_NET_ID:
;;;3051           {
;;;3052               LoRaMacNetID = mibSet->Param.NetID;
;;;3053               break;
;;;3054           }
;;;3055           case MIB_DEV_ADDR:
;;;3056           {
;;;3057               LoRaMacDevAddr = mibSet->Param.DevAddr;
;;;3058               break;
;;;3059           }
;;;3060           case MIB_NWK_SKEY:
;;;3061           {
;;;3062               if( mibSet->Param.NwkSKey != NULL )
;;;3063               {
;;;3064                   memcpy1( LoRaMacNwkSKey, mibSet->Param.NwkSKey,
;;;3065                                  sizeof( LoRaMacNwkSKey ) );
;;;3066               }
;;;3067               else
;;;3068               {
;;;3069                   status = LORAMAC_STATUS_PARAMETER_INVALID;
;;;3070               }
;;;3071               break;
;;;3072           }
;;;3073           case MIB_APP_SKEY:
;;;3074           {
;;;3075               if( mibSet->Param.AppSKey != NULL )
;;;3076               {
;;;3077                   memcpy1( LoRaMacAppSKey, mibSet->Param.AppSKey,
;;;3078                                  sizeof( LoRaMacAppSKey ) );
;;;3079               }
;;;3080               else
;;;3081               {
;;;3082                   status = LORAMAC_STATUS_PARAMETER_INVALID;
;;;3083               }
;;;3084               break;
;;;3085           }
;;;3086           case MIB_PUBLIC_NETWORK:
;;;3087           {
;;;3088               SetPublicNetwork( mibSet->Param.EnablePublicNetwork );
;;;3089               break;
;;;3090           }
;;;3091           case MIB_REPEATER_SUPPORT:
;;;3092           {
;;;3093                RepeaterSupport = mibSet->Param.EnableRepeaterSupport;
;;;3094               break;
;;;3095           }
;;;3096           case MIB_RX2_CHANNEL:
;;;3097           {
;;;3098               Rx2Channel = mibSet->Param.Rx2Channel;
;;;3099               break;
;;;3100           }
;;;3101           case MIB_CHANNELS_MASK:
;;;3102           {
;;;3103               if( mibSet->Param.ChannelsMask )
;;;3104               {
;;;3105   #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;3106                   if( ( CountNbEnabled125kHzChannels( mibSet->Param.ChannelsMask ) < 6 ) &&
;;;3107                       ( CountNbEnabled125kHzChannels( mibSet->Param.ChannelsMask ) > 0 ) )
;;;3108                   {
;;;3109                       status = LORAMAC_STATUS_PARAMETER_INVALID;
;;;3110                   }
;;;3111                   else
;;;3112                   {
;;;3113                       memcpy1( ( uint8_t* ) ChannelsMask,
;;;3114                                ( uint8_t* ) mibSet->Param.ChannelsMask, sizeof( ChannelsMask ) );
;;;3115                       for ( uint8_t i = 0; i < sizeof( ChannelsMask ) / 2; i++ )
;;;3116                       {
;;;3117                           ChannelsMaskRemaining[i] &= ChannelsMask[i];
;;;3118                       }
;;;3119                   }
;;;3120   #else
;;;3121                   memcpy1( ( uint8_t* ) ChannelsMask,
;;;3122                            ( uint8_t* ) mibSet->Param.ChannelsMask, 2 );
;;;3123   #endif
;;;3124               }
;;;3125               else
;;;3126               {
;;;3127                   status = LORAMAC_STATUS_PARAMETER_INVALID;
;;;3128               }
;;;3129               break;
;;;3130           }
;;;3131           case MIB_CHANNELS_NB_REP:
;;;3132           {
;;;3133               if( ( mibSet->Param.ChannelNbRep >= 1 ) &&
;;;3134                   ( mibSet->Param.ChannelNbRep <= 15 ) )
;;;3135               {
;;;3136                   ChannelsNbRep = mibSet->Param.ChannelNbRep;
;;;3137               }
;;;3138               else
;;;3139               {
;;;3140                   status = LORAMAC_STATUS_PARAMETER_INVALID;
;;;3141               }
;;;3142               break;
;;;3143           }
;;;3144           case MIB_MAX_RX_WINDOW_DURATION:
;;;3145           {
;;;3146               MaxRxWindow = mibSet->Param.MaxRxWindow;
;;;3147               break;
;;;3148           }
;;;3149           case MIB_RECEIVE_DELAY_1:
;;;3150           {
;;;3151               ReceiveDelay1 = mibSet->Param.ReceiveDelay1;
;;;3152               break;
;;;3153           }
;;;3154           case MIB_RECEIVE_DELAY_2:
;;;3155           {
;;;3156               ReceiveDelay2 = mibSet->Param.ReceiveDelay2;
;;;3157               break;
;;;3158           }
;;;3159           case MIB_JOIN_ACCEPT_DELAY_1:
;;;3160           {
;;;3161               JoinAcceptDelay1 = mibSet->Param.JoinAcceptDelay1;
;;;3162               break;
;;;3163           }
;;;3164           case MIB_JOIN_ACCEPT_DELAY_2:
;;;3165           {
;;;3166               JoinAcceptDelay2 = mibSet->Param.JoinAcceptDelay2;
;;;3167               break;
;;;3168           }
;;;3169           case MIB_CHANNELS_DATARATE:
;;;3170           {
;;;3171               if( ValueInRange( mibSet->Param.ChannelsDatarate,
;;;3172                                 LORAMAC_MIN_DATARATE, LORAMAC_MAX_DATARATE ) )
;;;3173               {
;;;3174                   ChannelsDatarate = mibSet->Param.ChannelsDatarate;
;;;3175               }
;;;3176               else
;;;3177               {
;;;3178                   status = LORAMAC_STATUS_PARAMETER_INVALID;
;;;3179               }
;;;3180               break;
;;;3181           }
;;;3182           case MIB_CHANNELS_TX_POWER:
;;;3183           {
;;;3184               if( ValueInRange( mibSet->Param.ChannelsTxPower,
;;;3185                                 LORAMAC_MAX_TX_POWER, LORAMAC_MIN_TX_POWER ) )
;;;3186               {
;;;3187   #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;3188                   int8_t txPower = LimitTxPower( mibSet->Param.ChannelsTxPower );
;;;3189                   if( txPower == mibSet->Param.ChannelsTxPower )
;;;3190                   {
;;;3191                       ChannelsTxPower = mibSet->Param.ChannelsTxPower;
;;;3192                   }
;;;3193                   else
;;;3194                   {
;;;3195                       status = LORAMAC_STATUS_PARAMETER_INVALID;
;;;3196                   }
;;;3197   #else
;;;3198                   ChannelsTxPower = mibSet->Param.ChannelsTxPower;
;;;3199   #endif
;;;3200               }
;;;3201               else
;;;3202               {
;;;3203                   status = LORAMAC_STATUS_PARAMETER_INVALID;
;;;3204               }
;;;3205               break;
;;;3206           }
;;;3207           default:
;;;3208               status = LORAMAC_STATUS_SERVICE_UNKNOWN;
;;;3209               break;
;;;3210       }
;;;3211   
;;;3212       return status;
;;;3213   }
00000c  bd70              POP      {r4-r6,pc}
                  |L10.14|
00000e  4857              LDR      r0,|L10.364|
000010  7800              LDRB     r0,[r0,#0]            ;3008  ; LoRaMacState
000012  07c0              LSLS     r0,r0,#31             ;3008
000014  0fc0              LSRS     r0,r0,#31             ;3008
000016  2800              CMP      r0,#0                 ;3008
000018  d001              BEQ      |L10.30|
00001a  2001              MOVS     r0,#1                 ;3010
00001c  e7f6              B        |L10.12|
                  |L10.30|
00001e  7820              LDRB     r0,[r4,#0]            ;3013
000020  0003              MOVS     r3,r0                 ;3013
000022  f7fffffe          BL       __ARM_common_switch8
000026  140b              DCB      0x14,0x0b
000028  24282c30          DCB      0x24,0x28,0x2c,0x30
00002c  343f4a4e          DCB      0x34,0x3f,0x4a,0x4e
000030  9e525762          DCB      0x9e,0x52,0x57,0x62
000034  6e72767a          DCB      0x6e,0x72,0x76,0x7a
000038  7e82909e          DCB      0x7e,0x82,0x90,0x9e
00003c  7920              LDRB     r0,[r4,#4]            ;3017
00003e  494c              LDR      r1,|L10.368|
000040  7008              STRB     r0,[r1,#0]            ;3017
000042  4608              MOV      r0,r1                 ;3018
000044  7800              LDRB     r0,[r0,#0]            ;3018  ; LoRaMacDeviceClass
000046  2800              CMP      r0,#0                 ;3018
000048  d004              BEQ      |L10.84|
00004a  2801              CMP      r0,#1                 ;3018
00004c  d006              BEQ      |L10.92|
00004e  2802              CMP      r0,#2                 ;3018
000050  d10b              BNE      |L10.106|
000052  e004              B        |L10.94|
                  |L10.84|
000054  4947              LDR      r1,|L10.372|
000056  6ac8              LDR      r0,[r1,#0x2c]         ;3023  ; Radio
000058  4780              BLX      r0                    ;3023
00005a  e006              B        |L10.106|
                  |L10.92|
00005c  e005              B        |L10.106|
                  |L10.94|
00005e  2000              MOVS     r0,#0                 ;3033
000060  4945              LDR      r1,|L10.376|
000062  7008              STRB     r0,[r1,#0]            ;3033
000064  f7fffffe          BL       OnRxWindow2TimerEvent
000068  bf00              NOP                            ;3035
                  |L10.106|
00006a  bf00              NOP                            ;3024
00006c  e07b              B        |L10.358|
00006e  7920              LDRB     r0,[r4,#4]            ;3042
000070  4942              LDR      r1,|L10.380|
000072  7008              STRB     r0,[r1,#0]            ;3042
000074  e077              B        |L10.358|
000076  7920              LDRB     r0,[r4,#4]            ;3047
000078  4941              LDR      r1,|L10.384|
00007a  7008              STRB     r0,[r1,#0]            ;3047
00007c  e073              B        |L10.358|
00007e  4941              LDR      r1,|L10.388|
000080  6860              LDR      r0,[r4,#4]            ;3052
000082  6008              STR      r0,[r1,#0]            ;3052  ; LoRaMacNetID
000084  e06f              B        |L10.358|
000086  4940              LDR      r1,|L10.392|
000088  6860              LDR      r0,[r4,#4]            ;3057
00008a  6008              STR      r0,[r1,#0]            ;3057  ; LoRaMacDevAddr
00008c  e06b              B        |L10.358|
00008e  6860              LDR      r0,[r4,#4]            ;3062
000090  2800              CMP      r0,#0                 ;3062
000092  d005              BEQ      |L10.160|
000094  2210              MOVS     r2,#0x10              ;3064
000096  483d              LDR      r0,|L10.396|
000098  6861              LDR      r1,[r4,#4]            ;3064
00009a  f7fffffe          BL       memcpy1
00009e  e000              B        |L10.162|
                  |L10.160|
0000a0  2503              MOVS     r5,#3                 ;3069
                  |L10.162|
0000a2  e060              B        |L10.358|
0000a4  6860              LDR      r0,[r4,#4]            ;3075
0000a6  2800              CMP      r0,#0                 ;3075
0000a8  d005              BEQ      |L10.182|
0000aa  2210              MOVS     r2,#0x10              ;3077
0000ac  4838              LDR      r0,|L10.400|
0000ae  6861              LDR      r1,[r4,#4]            ;3077
0000b0  f7fffffe          BL       memcpy1
0000b4  e000              B        |L10.184|
                  |L10.182|
0000b6  2503              MOVS     r5,#3                 ;3082
                  |L10.184|
0000b8  e055              B        |L10.358|
0000ba  7920              LDRB     r0,[r4,#4]            ;3088
0000bc  f7fffffe          BL       SetPublicNetwork
0000c0  e051              B        |L10.358|
0000c2  7920              LDRB     r0,[r4,#4]            ;3093
0000c4  4933              LDR      r1,|L10.404|
0000c6  7008              STRB     r0,[r1,#0]            ;3093
0000c8  e04d              B        |L10.358|
0000ca  4833              LDR      r0,|L10.408|
0000cc  68a2              LDR      r2,[r4,#8]            ;3098
0000ce  6861              LDR      r1,[r4,#4]            ;3098
0000d0  c006              STM      r0!,{r1,r2}           ;3098
0000d2  e048              B        |L10.358|
0000d4  6860              LDR      r0,[r4,#4]            ;3103
0000d6  2800              CMP      r0,#0                 ;3103
0000d8  d005              BEQ      |L10.230|
0000da  2202              MOVS     r2,#2                 ;3121
0000dc  482f              LDR      r0,|L10.412|
0000de  6861              LDR      r1,[r4,#4]            ;3121
0000e0  f7fffffe          BL       memcpy1
0000e4  e000              B        |L10.232|
                  |L10.230|
0000e6  2503              MOVS     r5,#3                 ;3127
                  |L10.232|
0000e8  e03d              B        |L10.358|
0000ea  7920              LDRB     r0,[r4,#4]            ;3133
0000ec  2801              CMP      r0,#1                 ;3133
0000ee  db06              BLT      |L10.254|
0000f0  7920              LDRB     r0,[r4,#4]            ;3134
0000f2  280f              CMP      r0,#0xf               ;3134
0000f4  dc03              BGT      |L10.254|
0000f6  7920              LDRB     r0,[r4,#4]            ;3136
0000f8  4929              LDR      r1,|L10.416|
0000fa  7008              STRB     r0,[r1,#0]            ;3136
0000fc  e000              B        |L10.256|
                  |L10.254|
0000fe  2503              MOVS     r5,#3                 ;3140
                  |L10.256|
000100  e031              B        |L10.358|
000102  4928              LDR      r1,|L10.420|
000104  6860              LDR      r0,[r4,#4]            ;3146
000106  6008              STR      r0,[r1,#0]            ;3146  ; MaxRxWindow
000108  e02d              B        |L10.358|
00010a  4927              LDR      r1,|L10.424|
00010c  6860              LDR      r0,[r4,#4]            ;3151
00010e  6008              STR      r0,[r1,#0]            ;3151  ; ReceiveDelay1
000110  e029              B        |L10.358|
000112  4926              LDR      r1,|L10.428|
000114  6860              LDR      r0,[r4,#4]            ;3156
000116  6008              STR      r0,[r1,#0]            ;3156  ; ReceiveDelay2
000118  e025              B        |L10.358|
00011a  4925              LDR      r1,|L10.432|
00011c  6860              LDR      r0,[r4,#4]            ;3161
00011e  6008              STR      r0,[r1,#0]            ;3161  ; JoinAcceptDelay1
000120  e021              B        |L10.358|
000122  4924              LDR      r1,|L10.436|
000124  6860              LDR      r0,[r4,#4]            ;3166
000126  6008              STR      r0,[r1,#0]            ;3166  ; JoinAcceptDelay2
000128  e01d              B        |L10.358|
00012a  2004              MOVS     r0,#4                 ;3171
00012c  5620              LDRSB    r0,[r4,r0]            ;3171
00012e  2200              MOVS     r2,#0                 ;3171
000130  2105              MOVS     r1,#5                 ;3171
000132  f7fffffe          BL       ValueInRange
000136  2800              CMP      r0,#0                 ;3171
000138  d003              BEQ      |L10.322|
00013a  7920              LDRB     r0,[r4,#4]            ;3174
00013c  491e              LDR      r1,|L10.440|
00013e  7008              STRB     r0,[r1,#0]            ;3174
000140  e000              B        |L10.324|
                  |L10.322|
000142  2503              MOVS     r5,#3                 ;3178
                  |L10.324|
000144  e00f              B        |L10.358|
000146  2004              MOVS     r0,#4                 ;3184
000148  5620              LDRSB    r0,[r4,r0]            ;3184
00014a  2205              MOVS     r2,#5                 ;3184
00014c  2100              MOVS     r1,#0                 ;3184
00014e  f7fffffe          BL       ValueInRange
000152  2800              CMP      r0,#0                 ;3184
000154  d003              BEQ      |L10.350|
000156  7920              LDRB     r0,[r4,#4]            ;3198
000158  4918              LDR      r1,|L10.444|
00015a  7008              STRB     r0,[r1,#0]            ;3198
00015c  e000              B        |L10.352|
                  |L10.350|
00015e  2503              MOVS     r5,#3                 ;3203
                  |L10.352|
000160  e001              B        |L10.358|
000162  2502              MOVS     r5,#2                 ;3208
000164  bf00              NOP                            ;3209
                  |L10.358|
000166  bf00              NOP                            ;3038
000168  4628              MOV      r0,r5                 ;3212
00016a  e74f              B        |L10.12|
;;;3214   
                          ENDP

                  |L10.364|
                          DCD      LoRaMacState
                  |L10.368|
                          DCD      LoRaMacDeviceClass
                  |L10.372|
                          DCD      Radio
                  |L10.376|
                          DCD      NodeAckRequested
                  |L10.380|
                          DCD      IsLoRaMacNetworkJoined
                  |L10.384|
                          DCD      AdrCtrlOn
                  |L10.388|
                          DCD      LoRaMacNetID
                  |L10.392|
                          DCD      LoRaMacDevAddr
                  |L10.396|
                          DCD      LoRaMacNwkSKey
                  |L10.400|
                          DCD      LoRaMacAppSKey
                  |L10.404|
                          DCD      RepeaterSupport
                  |L10.408|
                          DCD      Rx2Channel
                  |L10.412|
                          DCD      ChannelsMask
                  |L10.416|
                          DCD      ChannelsNbRep
                  |L10.420|
                          DCD      MaxRxWindow
                  |L10.424|
                          DCD      ReceiveDelay1
                  |L10.428|
                          DCD      ReceiveDelay2
                  |L10.432|
                          DCD      JoinAcceptDelay1
                  |L10.436|
                          DCD      JoinAcceptDelay2
                  |L10.440|
                          DCD      ChannelsDatarate
                  |L10.444|
                          DCD      ChannelsTxPower

                          AREA ||i.LoRaMacMlmeRequest||, CODE, READONLY, ALIGN=2

                  LoRaMacMlmeRequest PROC
;;;3428   
;;;3429   LoRaMacStatus_t LoRaMacMlmeRequest( MlmeReq_t *mlmeRequest )
000000  b538              PUSH     {r3-r5,lr}
;;;3430   {
000002  4604              MOV      r4,r0
;;;3431       LoRaMacStatus_t status = LORAMAC_STATUS_SERVICE_UNKNOWN;
000004  2502              MOVS     r5,#2
;;;3432       LoRaMacHeader_t macHdr;
;;;3433   
;;;3434       if( mlmeRequest == NULL )
000006  2c00              CMP      r4,#0
000008  d101              BNE      |L11.14|
;;;3435       {
;;;3436           return LORAMAC_STATUS_PARAMETER_INVALID;
00000a  2003              MOVS     r0,#3
                  |L11.12|
;;;3437       }
;;;3438       if( ( LoRaMacState & MAC_TX_RUNNING ) == MAC_TX_RUNNING )
;;;3439       {
;;;3440           return LORAMAC_STATUS_BUSY;
;;;3441       }
;;;3442   
;;;3443       memset1( ( uint8_t* ) &MlmeConfirm, 0, sizeof( MlmeConfirm ) );
;;;3444   
;;;3445       MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
;;;3446   
;;;3447       switch( mlmeRequest->Type )
;;;3448       {
;;;3449           case MLME_JOIN:
;;;3450           {
;;;3451               if( ( LoRaMacState & MAC_TX_DELAYED ) == MAC_TX_DELAYED )
;;;3452               {
;;;3453                   status = LORAMAC_STATUS_BUSY;
;;;3454               }
;;;3455   
;;;3456               MlmeConfirm.MlmeRequest = mlmeRequest->Type;
;;;3457   
;;;3458               if( ( mlmeRequest->Req.Join.DevEui == NULL ) ||
;;;3459                   ( mlmeRequest->Req.Join.AppEui == NULL ) ||
;;;3460                   ( mlmeRequest->Req.Join.AppKey == NULL ) )
;;;3461               {
;;;3462                   return LORAMAC_STATUS_PARAMETER_INVALID;
;;;3463               }
;;;3464   
;;;3465               LoRaMacFlags.Bits.MlmeReq = 1;
;;;3466   
;;;3467               LoRaMacDevEui = mlmeRequest->Req.Join.DevEui;
;;;3468               LoRaMacAppEui = mlmeRequest->Req.Join.AppEui;
;;;3469               LoRaMacAppKey = mlmeRequest->Req.Join.AppKey;
;;;3470   
;;;3471               macHdr.Value = 0;
;;;3472               macHdr.Bits.MType  = FRAME_TYPE_JOIN_REQ;
;;;3473   
;;;3474               IsLoRaMacNetworkJoined = false;
;;;3475   
;;;3476   #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;3477   #if defined( USE_BAND_915 )
;;;3478               // Re-enable 500 kHz default channels
;;;3479               ChannelsMask[4] = 0x00FF;
;;;3480   #else // defined( USE_BAND_915_HYBRID )
;;;3481               // Re-enable 500 kHz default channels
;;;3482               ChannelsMask[4] = 0x0001;
;;;3483   #endif
;;;3484   
;;;3485               static uint8_t drSwitch = 0;
;;;3486   
;;;3487               if( ( ++drSwitch & 0x01 ) == 0x01 )
;;;3488               {
;;;3489                   ChannelsDatarate = DR_0;
;;;3490               }
;;;3491               else
;;;3492               {
;;;3493                   ChannelsDatarate = DR_4;
;;;3494               }
;;;3495   #endif
;;;3496   
;;;3497               status = Send( &macHdr, 0, NULL, 0 );
;;;3498               break;
;;;3499           }
;;;3500           case MLME_LINK_CHECK:
;;;3501           {
;;;3502               LoRaMacFlags.Bits.MlmeReq = 1;
;;;3503               // LoRaMac will send this command piggy-pack
;;;3504               MlmeConfirm.MlmeRequest = mlmeRequest->Type;
;;;3505   
;;;3506               status = AddMacCommand( MOTE_MAC_LINK_CHECK_REQ, 0, 0 );
;;;3507               break;
;;;3508           }
;;;3509           default:
;;;3510               break;
;;;3511       }
;;;3512   
;;;3513       if( status != LORAMAC_STATUS_OK )
;;;3514       {
;;;3515           NodeAckRequested = false;
;;;3516           LoRaMacFlags.Bits.MlmeReq = 0;
;;;3517       }
;;;3518   
;;;3519       return status;
;;;3520   }
00000c  bd38              POP      {r3-r5,pc}
                  |L11.14|
00000e  4836              LDR      r0,|L11.232|
000010  7800              LDRB     r0,[r0,#0]            ;3438  ; LoRaMacState
000012  07c0              LSLS     r0,r0,#31             ;3438
000014  0fc0              LSRS     r0,r0,#31             ;3438
000016  2800              CMP      r0,#0                 ;3438
000018  d001              BEQ      |L11.30|
00001a  2001              MOVS     r0,#1                 ;3440
00001c  e7f6              B        |L11.12|
                  |L11.30|
00001e  2218              MOVS     r2,#0x18              ;3443
000020  2100              MOVS     r1,#0                 ;3443
000022  4832              LDR      r0,|L11.236|
000024  f7fffffe          BL       memset1
000028  2001              MOVS     r0,#1                 ;3445
00002a  4930              LDR      r1,|L11.236|
00002c  7048              STRB     r0,[r1,#1]            ;3445
00002e  7820              LDRB     r0,[r4,#0]            ;3447
000030  2800              CMP      r0,#0                 ;3447
000032  d002              BEQ      |L11.58|
000034  2801              CMP      r0,#1                 ;3447
000036  d148              BNE      |L11.202|
000038  e036              B        |L11.168|
                  |L11.58|
00003a  482b              LDR      r0,|L11.232|
00003c  6800              LDR      r0,[r0,#0]            ;3451  ; LoRaMacState
00003e  2110              MOVS     r1,#0x10              ;3451
000040  4008              ANDS     r0,r0,r1              ;3451
000042  2810              CMP      r0,#0x10              ;3451
000044  d100              BNE      |L11.72|
000046  2501              MOVS     r5,#1                 ;3453
                  |L11.72|
000048  7820              LDRB     r0,[r4,#0]            ;3456
00004a  4928              LDR      r1,|L11.236|
00004c  7008              STRB     r0,[r1,#0]            ;3456
00004e  6860              LDR      r0,[r4,#4]            ;3458
000050  2800              CMP      r0,#0                 ;3458
000052  d005              BEQ      |L11.96|
000054  68a0              LDR      r0,[r4,#8]            ;3459
000056  2800              CMP      r0,#0                 ;3459
000058  d002              BEQ      |L11.96|
00005a  68e0              LDR      r0,[r4,#0xc]          ;3460
00005c  2800              CMP      r0,#0                 ;3460
00005e  d101              BNE      |L11.100|
                  |L11.96|
000060  2003              MOVS     r0,#3                 ;3462
000062  e7d3              B        |L11.12|
                  |L11.100|
000064  4822              LDR      r0,|L11.240|
000066  7800              LDRB     r0,[r0,#0]            ;3465  ; LoRaMacFlags
000068  2104              MOVS     r1,#4                 ;3465
00006a  4388              BICS     r0,r0,r1              ;3465
00006c  1d00              ADDS     r0,r0,#4              ;3465
00006e  4920              LDR      r1,|L11.240|
000070  7008              STRB     r0,[r1,#0]            ;3465
000072  4920              LDR      r1,|L11.244|
000074  6860              LDR      r0,[r4,#4]            ;3467
000076  6008              STR      r0,[r1,#0]            ;3467  ; LoRaMacDevEui
000078  491f              LDR      r1,|L11.248|
00007a  68a0              LDR      r0,[r4,#8]            ;3468
00007c  6008              STR      r0,[r1,#0]            ;3468  ; LoRaMacAppEui
00007e  491f              LDR      r1,|L11.252|
000080  68e0              LDR      r0,[r4,#0xc]          ;3469
000082  6008              STR      r0,[r1,#0]            ;3469  ; LoRaMacAppKey
000084  2100              MOVS     r1,#0                 ;3471
000086  9100              STR      r1,[sp,#0]            ;3471
000088  4668              MOV      r0,sp                 ;3472
00008a  7800              LDRB     r0,[r0,#0]            ;3472
00008c  21e0              MOVS     r1,#0xe0              ;3472
00008e  4388              BICS     r0,r0,r1              ;3472
000090  9000              STR      r0,[sp,#0]            ;3472
000092  2000              MOVS     r0,#0                 ;3474
000094  491a              LDR      r1,|L11.256|
000096  7008              STRB     r0,[r1,#0]            ;3474
000098  2300              MOVS     r3,#0                 ;3497
00009a  461a              MOV      r2,r3                 ;3497
00009c  4619              MOV      r1,r3                 ;3497
00009e  4668              MOV      r0,sp                 ;3497
0000a0  f7fffffe          BL       Send
0000a4  4605              MOV      r5,r0                 ;3497
0000a6  e011              B        |L11.204|
                  |L11.168|
0000a8  4811              LDR      r0,|L11.240|
0000aa  7800              LDRB     r0,[r0,#0]            ;3502  ; LoRaMacFlags
0000ac  2104              MOVS     r1,#4                 ;3502
0000ae  4388              BICS     r0,r0,r1              ;3502
0000b0  1d00              ADDS     r0,r0,#4              ;3502
0000b2  490f              LDR      r1,|L11.240|
0000b4  7008              STRB     r0,[r1,#0]            ;3502
0000b6  7820              LDRB     r0,[r4,#0]            ;3504
0000b8  490c              LDR      r1,|L11.236|
0000ba  7008              STRB     r0,[r1,#0]            ;3504
0000bc  2200              MOVS     r2,#0                 ;3506
0000be  4611              MOV      r1,r2                 ;3506
0000c0  2002              MOVS     r0,#2                 ;3506
0000c2  f7fffffe          BL       AddMacCommand
0000c6  4605              MOV      r5,r0                 ;3506
0000c8  e000              B        |L11.204|
                  |L11.202|
0000ca  bf00              NOP                            ;3510
                  |L11.204|
0000cc  bf00              NOP                            ;3498
0000ce  2d00              CMP      r5,#0                 ;3513
0000d0  d008              BEQ      |L11.228|
0000d2  2000              MOVS     r0,#0                 ;3515
0000d4  490b              LDR      r1,|L11.260|
0000d6  7008              STRB     r0,[r1,#0]            ;3515
0000d8  4805              LDR      r0,|L11.240|
0000da  7800              LDRB     r0,[r0,#0]            ;3516  ; LoRaMacFlags
0000dc  2104              MOVS     r1,#4                 ;3516
0000de  4388              BICS     r0,r0,r1              ;3516
0000e0  4903              LDR      r1,|L11.240|
0000e2  7008              STRB     r0,[r1,#0]            ;3516
                  |L11.228|
0000e4  4628              MOV      r0,r5                 ;3519
0000e6  e791              B        |L11.12|
;;;3521   
                          ENDP

                  |L11.232|
                          DCD      LoRaMacState
                  |L11.236|
                          DCD      MlmeConfirm
                  |L11.240|
                          DCD      LoRaMacFlags
                  |L11.244|
                          DCD      LoRaMacDevEui
                  |L11.248|
                          DCD      LoRaMacAppEui
                  |L11.252|
                          DCD      LoRaMacAppKey
                  |L11.256|
                          DCD      IsLoRaMacNetworkJoined
                  |L11.260|
                          DCD      NodeAckRequested

                          AREA ||i.LoRaMacMulticastChannelLink||, CODE, READONLY, ALIGN=2

                  LoRaMacMulticastChannelLink PROC
;;;3354   
;;;3355   LoRaMacStatus_t LoRaMacMulticastChannelLink( MulticastParams_t *channelParam )
000000  4601              MOV      r1,r0
;;;3356   {
;;;3357       if( channelParam == NULL )
000002  2900              CMP      r1,#0
000004  d101              BNE      |L12.10|
;;;3358       {
;;;3359           return LORAMAC_STATUS_PARAMETER_INVALID;
000006  2003              MOVS     r0,#3
                  |L12.8|
;;;3360       }
;;;3361       if( ( LoRaMacState & MAC_TX_RUNNING ) == MAC_TX_RUNNING )
;;;3362       {
;;;3363           return LORAMAC_STATUS_BUSY;
;;;3364       }
;;;3365   
;;;3366       // Reset downlink counter
;;;3367       channelParam->DownLinkCounter = 0;
;;;3368   
;;;3369       if( MulticastChannels == NULL )
;;;3370       {
;;;3371           // New node is the fist element
;;;3372           MulticastChannels = channelParam;
;;;3373       }
;;;3374       else
;;;3375       {
;;;3376           MulticastParams_t *cur = MulticastChannels;
;;;3377   
;;;3378           // Search the last node in the list
;;;3379           while( cur->Next != NULL )
;;;3380           {
;;;3381               cur = cur->Next;
;;;3382           }
;;;3383           // This function always finds the last node
;;;3384           cur->Next = channelParam;
;;;3385       }
;;;3386   
;;;3387       return LORAMAC_STATUS_OK;
;;;3388   }
000008  4770              BX       lr
                  |L12.10|
00000a  480e              LDR      r0,|L12.68|
00000c  7800              LDRB     r0,[r0,#0]            ;3361  ; LoRaMacState
00000e  07c0              LSLS     r0,r0,#31             ;3361
000010  0fc0              LSRS     r0,r0,#31             ;3361
000012  2800              CMP      r0,#0                 ;3361
000014  d001              BEQ      |L12.26|
000016  2001              MOVS     r0,#1                 ;3363
000018  e7f6              B        |L12.8|
                  |L12.26|
00001a  2000              MOVS     r0,#0                 ;3367
00001c  6248              STR      r0,[r1,#0x24]         ;3367
00001e  480a              LDR      r0,|L12.72|
000020  6800              LDR      r0,[r0,#0]            ;3369  ; MulticastChannels
000022  2800              CMP      r0,#0                 ;3369
000024  d102              BNE      |L12.44|
000026  4808              LDR      r0,|L12.72|
000028  6001              STR      r1,[r0,#0]            ;3372  ; MulticastChannels
00002a  e008              B        |L12.62|
                  |L12.44|
00002c  4a06              LDR      r2,|L12.72|
00002e  6810              LDR      r0,[r2,#0]            ;3376  ; MulticastChannels
000030  e000              B        |L12.52|
                  |L12.50|
000032  6a80              LDR      r0,[r0,#0x28]         ;3381
                  |L12.52|
000034  6a82              LDR      r2,[r0,#0x28]         ;3379
000036  2a00              CMP      r2,#0                 ;3379
000038  d1fb              BNE      |L12.50|
00003a  6281              STR      r1,[r0,#0x28]         ;3384
00003c  bf00              NOP                            ;3385
                  |L12.62|
00003e  2000              MOVS     r0,#0                 ;3387
000040  e7e2              B        |L12.8|
;;;3389   
                          ENDP

000042  0000              DCW      0x0000
                  |L12.68|
                          DCD      LoRaMacState
                  |L12.72|
                          DCD      MulticastChannels

                          AREA ||i.LoRaMacMulticastChannelUnlink||, CODE, READONLY, ALIGN=2

                  LoRaMacMulticastChannelUnlink PROC
;;;3389   
;;;3390   LoRaMacStatus_t LoRaMacMulticastChannelUnlink( MulticastParams_t *channelParam )
000000  4601              MOV      r1,r0
;;;3391   {
;;;3392       if( channelParam == NULL )
000002  2900              CMP      r1,#0
000004  d101              BNE      |L13.10|
;;;3393       {
;;;3394           return LORAMAC_STATUS_PARAMETER_INVALID;
000006  2003              MOVS     r0,#3
                  |L13.8|
;;;3395       }
;;;3396       if( ( LoRaMacState & MAC_TX_RUNNING ) == MAC_TX_RUNNING )
;;;3397       {
;;;3398           return LORAMAC_STATUS_BUSY;
;;;3399       }
;;;3400   
;;;3401       if( MulticastChannels != NULL )
;;;3402       {
;;;3403           if( MulticastChannels == channelParam )
;;;3404           {
;;;3405             // First element
;;;3406             MulticastChannels = channelParam->Next;
;;;3407           }
;;;3408           else
;;;3409           {
;;;3410               MulticastParams_t *cur = MulticastChannels;
;;;3411   
;;;3412               // Search the node in the list
;;;3413               while( cur->Next && cur->Next != channelParam )
;;;3414               {
;;;3415                   cur = cur->Next;
;;;3416               }
;;;3417               // If we found the node, remove it
;;;3418               if( cur->Next )
;;;3419               {
;;;3420                   cur->Next = channelParam->Next;
;;;3421               }
;;;3422           }
;;;3423           channelParam->Next = NULL;
;;;3424       }
;;;3425   
;;;3426       return LORAMAC_STATUS_OK;
;;;3427   }
000008  4770              BX       lr
                  |L13.10|
00000a  4814              LDR      r0,|L13.92|
00000c  7800              LDRB     r0,[r0,#0]            ;3396  ; LoRaMacState
00000e  07c0              LSLS     r0,r0,#31             ;3396
000010  0fc0              LSRS     r0,r0,#31             ;3396
000012  2800              CMP      r0,#0                 ;3396
000014  d001              BEQ      |L13.26|
000016  2001              MOVS     r0,#1                 ;3398
000018  e7f6              B        |L13.8|
                  |L13.26|
00001a  4811              LDR      r0,|L13.96|
00001c  6800              LDR      r0,[r0,#0]            ;3401  ; MulticastChannels
00001e  2800              CMP      r0,#0                 ;3401
000020  d019              BEQ      |L13.86|
000022  480f              LDR      r0,|L13.96|
000024  6800              LDR      r0,[r0,#0]            ;3403  ; MulticastChannels
000026  4288              CMP      r0,r1                 ;3403
000028  d103              BNE      |L13.50|
00002a  4a0d              LDR      r2,|L13.96|
00002c  6a88              LDR      r0,[r1,#0x28]         ;3406
00002e  6010              STR      r0,[r2,#0]            ;3406  ; MulticastChannels
000030  e00f              B        |L13.82|
                  |L13.50|
000032  4a0b              LDR      r2,|L13.96|
000034  6810              LDR      r0,[r2,#0]            ;3410  ; MulticastChannels
000036  e000              B        |L13.58|
                  |L13.56|
000038  6a80              LDR      r0,[r0,#0x28]         ;3415
                  |L13.58|
00003a  6a82              LDR      r2,[r0,#0x28]         ;3413
00003c  2a00              CMP      r2,#0                 ;3413
00003e  d002              BEQ      |L13.70|
000040  6a82              LDR      r2,[r0,#0x28]         ;3413
000042  428a              CMP      r2,r1                 ;3413
000044  d1f8              BNE      |L13.56|
                  |L13.70|
000046  6a82              LDR      r2,[r0,#0x28]         ;3418
000048  2a00              CMP      r2,#0                 ;3418
00004a  d001              BEQ      |L13.80|
00004c  6a8a              LDR      r2,[r1,#0x28]         ;3420
00004e  6282              STR      r2,[r0,#0x28]         ;3420
                  |L13.80|
000050  bf00              NOP                            ;3422
                  |L13.82|
000052  2000              MOVS     r0,#0                 ;3423
000054  6288              STR      r0,[r1,#0x28]         ;3423
                  |L13.86|
000056  2000              MOVS     r0,#0                 ;3426
000058  e7d6              B        |L13.8|
;;;3428   
                          ENDP

00005a  0000              DCW      0x0000
                  |L13.92|
                          DCD      LoRaMacState
                  |L13.96|
                          DCD      MulticastChannels

                          AREA ||i.LoRaMacQueryTxPossible||, CODE, READONLY, ALIGN=2

                  LoRaMacQueryTxPossible PROC
;;;2823   
;;;2824   LoRaMacStatus_t LoRaMacQueryTxPossible( uint8_t size, LoRaMacTxInfo_t* txInfo )
000000  b538              PUSH     {r3-r5,lr}
;;;2825   {
000002  4605              MOV      r5,r0
000004  460c              MOV      r4,r1
;;;2826       int8_t datarate = ChannelsDefaultDatarate;
000006  4822              LDR      r0,|L14.144|
000008  2100              MOVS     r1,#0
00000a  5641              LDRSB    r1,[r0,r1]  ; ChannelsDefaultDatarate
00000c  9100              STR      r1,[sp,#0]
;;;2827   
;;;2828       if( txInfo == NULL )
00000e  2c00              CMP      r4,#0
000010  d101              BNE      |L14.22|
;;;2829       {
;;;2830           return LORAMAC_STATUS_PARAMETER_INVALID;
000012  2003              MOVS     r0,#3
                  |L14.20|
;;;2831       }
;;;2832   
;;;2833       AdrNextDr( AdrCtrlOn, false, &datarate );
;;;2834   
;;;2835       if( RepeaterSupport == true )
;;;2836       {
;;;2837           txInfo->CurrentPayloadSize = MaxPayloadOfDatarateRepeater[datarate];
;;;2838       }
;;;2839       else
;;;2840       {
;;;2841           txInfo->CurrentPayloadSize = MaxPayloadOfDatarate[datarate];
;;;2842       }
;;;2843   
;;;2844       if( txInfo->CurrentPayloadSize >= MacCommandsBufferIndex )
;;;2845       {
;;;2846           txInfo->MaxPossiblePayload = txInfo->CurrentPayloadSize - MacCommandsBufferIndex;
;;;2847       }
;;;2848       else
;;;2849       {
;;;2850           return LORAMAC_STATUS_MAC_CMD_LENGTH_ERROR;
;;;2851       }
;;;2852   
;;;2853       if( ValidatePayloadLength( size, datarate, 0 ) == false )
;;;2854       {
;;;2855           return LORAMAC_STATUS_LENGTH_ERROR;
;;;2856       }
;;;2857   
;;;2858       if( ValidatePayloadLength( size, datarate, MacCommandsBufferIndex ) == false )
;;;2859       {
;;;2860           return LORAMAC_STATUS_MAC_CMD_LENGTH_ERROR;
;;;2861       }
;;;2862   
;;;2863       return LORAMAC_STATUS_OK;
;;;2864   }
000014  bd38              POP      {r3-r5,pc}
                  |L14.22|
000016  466a              MOV      r2,sp                 ;2833
000018  2100              MOVS     r1,#0                 ;2833
00001a  481e              LDR      r0,|L14.148|
00001c  7800              LDRB     r0,[r0,#0]            ;2833  ; AdrCtrlOn
00001e  f7fffffe          BL       AdrNextDr
000022  481d              LDR      r0,|L14.152|
000024  7800              LDRB     r0,[r0,#0]            ;2835  ; RepeaterSupport
000026  2801              CMP      r0,#1                 ;2835
000028  d106              BNE      |L14.56|
00002a  481c              LDR      r0,|L14.156|
00002c  466a              MOV      r2,sp                 ;2837
00002e  2100              MOVS     r1,#0                 ;2837
000030  5651              LDRSB    r1,[r2,r1]            ;2837
000032  5c40              LDRB     r0,[r0,r1]            ;2837
000034  7060              STRB     r0,[r4,#1]            ;2837
000036  e005              B        |L14.68|
                  |L14.56|
000038  4819              LDR      r0,|L14.160|
00003a  466a              MOV      r2,sp                 ;2841
00003c  2100              MOVS     r1,#0                 ;2841
00003e  5651              LDRSB    r1,[r2,r1]            ;2841
000040  5c40              LDRB     r0,[r0,r1]            ;2841
000042  7060              STRB     r0,[r4,#1]            ;2841
                  |L14.68|
000044  7860              LDRB     r0,[r4,#1]            ;2844
000046  4917              LDR      r1,|L14.164|
000048  7809              LDRB     r1,[r1,#0]            ;2844  ; MacCommandsBufferIndex
00004a  4288              CMP      r0,r1                 ;2844
00004c  db05              BLT      |L14.90|
00004e  7860              LDRB     r0,[r4,#1]            ;2846
000050  4914              LDR      r1,|L14.164|
000052  7809              LDRB     r1,[r1,#0]            ;2846  ; MacCommandsBufferIndex
000054  1a40              SUBS     r0,r0,r1              ;2846
000056  7020              STRB     r0,[r4,#0]            ;2846
000058  e001              B        |L14.94|
                  |L14.90|
00005a  2009              MOVS     r0,#9                 ;2850
00005c  e7da              B        |L14.20|
                  |L14.94|
00005e  2200              MOVS     r2,#0                 ;2853
000060  4668              MOV      r0,sp                 ;2853
000062  5681              LDRSB    r1,[r0,r2]            ;2853
000064  4628              MOV      r0,r5                 ;2853
000066  f7fffffe          BL       ValidatePayloadLength
00006a  2800              CMP      r0,#0                 ;2853
00006c  d101              BNE      |L14.114|
00006e  2008              MOVS     r0,#8                 ;2855
000070  e7d0              B        |L14.20|
                  |L14.114|
000072  480c              LDR      r0,|L14.164|
000074  7802              LDRB     r2,[r0,#0]            ;2858  ; MacCommandsBufferIndex
000076  4668              MOV      r0,sp                 ;2858
000078  2100              MOVS     r1,#0                 ;2858
00007a  5641              LDRSB    r1,[r0,r1]            ;2858
00007c  4628              MOV      r0,r5                 ;2858
00007e  f7fffffe          BL       ValidatePayloadLength
000082  2800              CMP      r0,#0                 ;2858
000084  d101              BNE      |L14.138|
000086  2009              MOVS     r0,#9                 ;2860
000088  e7c4              B        |L14.20|
                  |L14.138|
00008a  2000              MOVS     r0,#0                 ;2863
00008c  e7c2              B        |L14.20|
;;;2865   
                          ENDP

00008e  0000              DCW      0x0000
                  |L14.144|
                          DCD      ChannelsDefaultDatarate
                  |L14.148|
                          DCD      AdrCtrlOn
                  |L14.152|
                          DCD      RepeaterSupport
                  |L14.156|
                          DCD      MaxPayloadOfDatarateRepeater
                  |L14.160|
                          DCD      MaxPayloadOfDatarate
                  |L14.164|
                          DCD      MacCommandsBufferIndex

                          AREA ||i.LoRaMacTestRxWindowsOn||, CODE, READONLY, ALIGN=2

                  LoRaMacTestRxWindowsOn PROC
;;;3616   
;;;3617   void LoRaMacTestRxWindowsOn( bool enable )
000000  4901              LDR      r1,|L15.8|
;;;3618   {
;;;3619       IsRxWindowsEnabled = enable;
000002  7008              STRB     r0,[r1,#0]
;;;3620   }
000004  4770              BX       lr
;;;3621   
                          ENDP

000006  0000              DCW      0x0000
                  |L15.8|
                          DCD      IsRxWindowsEnabled

                          AREA ||i.LoRaMacTestSetDutyCycleOn||, CODE, READONLY, ALIGN=2

                  LoRaMacTestSetDutyCycleOn PROC
;;;3627   
;;;3628   void LoRaMacTestSetDutyCycleOn( bool enable )
000000  4901              LDR      r1,|L16.8|
;;;3629   {
;;;3630       DutyCycleOn = enable;
000002  7008              STRB     r0,[r1,#0]
;;;3631   }
000004  4770              BX       lr
                          ENDP

000006  0000              DCW      0x0000
                  |L16.8|
                          DCD      DutyCycleOn

                          AREA ||i.LoRaMacTestSetMic||, CODE, READONLY, ALIGN=2

                  LoRaMacTestSetMic PROC
;;;3621   
;;;3622   void LoRaMacTestSetMic( uint16_t txPacketCounter )
000000  4902              LDR      r1,|L17.12|
;;;3623   {
;;;3624       UpLinkCounter = txPacketCounter;
000002  6008              STR      r0,[r1,#0]  ; UpLinkCounter
;;;3625       IsUpLinkCounterFixed = true;
000004  2101              MOVS     r1,#1
000006  4a02              LDR      r2,|L17.16|
000008  7011              STRB     r1,[r2,#0]
;;;3626   }
00000a  4770              BX       lr
;;;3627   
                          ENDP

                  |L17.12|
                          DCD      UpLinkCounter
                  |L17.16|
                          DCD      IsUpLinkCounterFixed

                          AREA ||i.OnAckTimeoutTimerEvent||, CODE, READONLY, ALIGN=2

                  OnAckTimeoutTimerEvent PROC
;;;1612   
;;;1613   static void OnAckTimeoutTimerEvent( void )
000000  b510              PUSH     {r4,lr}
;;;1614   {
;;;1615       TimerStop( &AckTimeoutTimer );
000002  480d              LDR      r0,|L18.56|
000004  f7fffffe          BL       TimerStop
;;;1616   		DEBUG(3,"%s\r\n",__func__);
;;;1617       if( NodeAckRequested == true )
000008  480c              LDR      r0,|L18.60|
00000a  7800              LDRB     r0,[r0,#0]  ; NodeAckRequested
00000c  2801              CMP      r0,#1
00000e  d107              BNE      |L18.32|
;;;1618       {
;;;1619           AckTimeoutRetry = true;
000010  490b              LDR      r1,|L18.64|
000012  7008              STRB     r0,[r1,#0]
;;;1620           LoRaMacState &= ~MAC_ACK_REQ;
000014  480b              LDR      r0,|L18.68|
000016  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000018  2104              MOVS     r1,#4
00001a  4388              BICS     r0,r0,r1
00001c  4909              LDR      r1,|L18.68|
00001e  6008              STR      r0,[r1,#0]  ; LoRaMacState
                  |L18.32|
;;;1621       }
;;;1622       if( LoRaMacDeviceClass == CLASS_C )
000020  4809              LDR      r0,|L18.72|
000022  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
000024  2802              CMP      r0,#2
000026  d106              BNE      |L18.54|
;;;1623       {
;;;1624           LoRaMacFlags.Bits.MacDone = 1;
000028  4808              LDR      r0,|L18.76|
00002a  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
00002c  2108              MOVS     r1,#8
00002e  4388              BICS     r0,r0,r1
000030  3008              ADDS     r0,r0,#8
000032  4906              LDR      r1,|L18.76|
000034  7008              STRB     r0,[r1,#0]
                  |L18.54|
;;;1625       }
;;;1626   }
000036  bd10              POP      {r4,pc}
;;;1627   
                          ENDP

                  |L18.56|
                          DCD      AckTimeoutTimer
                  |L18.60|
                          DCD      NodeAckRequested
                  |L18.64|
                          DCD      AckTimeoutRetry
                  |L18.68|
                          DCD      LoRaMacState
                  |L18.72|
                          DCD      LoRaMacDeviceClass
                  |L18.76|
                          DCD      LoRaMacFlags

                          AREA ||i.OnMacStateCheckTimerEvent||, CODE, READONLY, ALIGN=2

                  OnMacStateCheckTimerEvent PROC
;;;1326   
;;;1327   static void OnMacStateCheckTimerEvent( void ) ///LoRaMacPrimitives->MacMcpsIndication( &McpsIndication );瀹舵mac灞
000000  b510              PUSH     {r4,lr}
;;;1328   {
;;;1329       TimerStop( &MacStateCheckTimer );
000002  48ac              LDR      r0,|L19.692|
000004  f7fffffe          BL       TimerStop
;;;1330       bool txTimeout = false;
000008  2400              MOVS     r4,#0
;;;1331   	
;;;1332   		DEBUG(3, "%s\r\n",__func__);
;;;1333   
;;;1334       if( LoRaMacFlags.Bits.MacDone == 1 )
00000a  48ab              LDR      r0,|L19.696|
00000c  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
00000e  0700              LSLS     r0,r0,#28
000010  0fc0              LSRS     r0,r0,#31
000012  2800              CMP      r0,#0
000014  d07e              BEQ      |L19.276|
;;;1335       {
;;;1336           if( ( LoRaMacFlags.Bits.MlmeReq == 1 ) || ( ( LoRaMacFlags.Bits.McpsReq == 1 ) ) )
000016  48a8              LDR      r0,|L19.696|
000018  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
00001a  0740              LSLS     r0,r0,#29
00001c  0fc0              LSRS     r0,r0,#31
00001e  2800              CMP      r0,#0
000020  d105              BNE      |L19.46|
000022  48a5              LDR      r0,|L19.696|
000024  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000026  07c0              LSLS     r0,r0,#31
000028  0fc0              LSRS     r0,r0,#31
00002a  2800              CMP      r0,#0
00002c  d018              BEQ      |L19.96|
                  |L19.46|
;;;1337           {
;;;1338               if( ( McpsConfirm.Status == LORAMAC_EVENT_INFO_STATUS_TX_TIMEOUT ) ||
00002e  48a3              LDR      r0,|L19.700|
000030  7840              LDRB     r0,[r0,#1]  ; McpsConfirm
000032  2802              CMP      r0,#2
000034  d003              BEQ      |L19.62|
;;;1339                   ( MlmeConfirm.Status == LORAMAC_EVENT_INFO_STATUS_TX_TIMEOUT ) )
000036  48a2              LDR      r0,|L19.704|
000038  7840              LDRB     r0,[r0,#1]  ; MlmeConfirm
00003a  2802              CMP      r0,#2
00003c  d110              BNE      |L19.96|
                  |L19.62|
;;;1340               {
;;;1341                   // Stop transmit cycle due to tx timeout.
;;;1342                   LoRaMacState &= ~MAC_TX_RUNNING;
00003e  48a1              LDR      r0,|L19.708|
000040  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000042  0840              LSRS     r0,r0,#1
000044  0040              LSLS     r0,r0,#1
000046  499f              LDR      r1,|L19.708|
000048  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;1343                   McpsConfirm.NbRetries = AckTimeoutRetriesCounter;
00004a  489f              LDR      r0,|L19.712|
00004c  7800              LDRB     r0,[r0,#0]  ; AckTimeoutRetriesCounter
00004e  499b              LDR      r1,|L19.700|
000050  7148              STRB     r0,[r1,#5]
;;;1344                   McpsConfirm.AckReceived = false;
000052  2000              MOVS     r0,#0
000054  7108              STRB     r0,[r1,#4]
;;;1345                   McpsConfirm.TxTimeOnAir = 0;
000056  2100              MOVS     r1,#0
000058  4a98              LDR      r2,|L19.700|
00005a  6091              STR      r1,[r2,#8]  ; McpsConfirm
00005c  60d1              STR      r1,[r2,#0xc]  ; McpsConfirm
;;;1346                   txTimeout = true;
00005e  2401              MOVS     r4,#1
                  |L19.96|
;;;1347               }
;;;1348           }
;;;1349   
;;;1350           if( ( NodeAckRequested == false ) && ( txTimeout == false ) )
000060  489a              LDR      r0,|L19.716|
000062  7800              LDRB     r0,[r0,#0]  ; NodeAckRequested
000064  2800              CMP      r0,#0
000066  d14d              BNE      |L19.260|
000068  2c00              CMP      r4,#0
00006a  d14b              BNE      |L19.260|
;;;1351           {
;;;1352               if( LoRaMacFlags.Bits.MlmeReq == 1 )
00006c  4892              LDR      r0,|L19.696|
00006e  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000070  0740              LSLS     r0,r0,#29
000072  0fc0              LSRS     r0,r0,#31
000074  2800              CMP      r0,#0
000076  d00d              BEQ      |L19.148|
;;;1353               {
;;;1354                   if( MlmeConfirm.MlmeRequest == MLME_JOIN )
000078  4891              LDR      r0,|L19.704|
00007a  7800              LDRB     r0,[r0,#0]  ; MlmeConfirm
00007c  2800              CMP      r0,#0
00007e  d109              BNE      |L19.148|
;;;1355                   {
;;;1356                       if( MlmeConfirm.Status == LORAMAC_EVENT_INFO_STATUS_OK )
000080  488f              LDR      r0,|L19.704|
000082  7840              LDRB     r0,[r0,#1]  ; MlmeConfirm
000084  2800              CMP      r0,#0
000086  d101              BNE      |L19.140|
;;;1357                       {
;;;1358                           UpLinkCounter = 0;
000088  4991              LDR      r1,|L19.720|
00008a  6008              STR      r0,[r1,#0]  ; UpLinkCounter
                  |L19.140|
;;;1359                       }
;;;1360                       // Join messages aren't repeated automatically
;;;1361                       ChannelsNbRepCounter = ChannelsNbRep;
00008c  4891              LDR      r0,|L19.724|
00008e  7800              LDRB     r0,[r0,#0]  ; ChannelsNbRep
000090  4991              LDR      r1,|L19.728|
000092  7008              STRB     r0,[r1,#0]
                  |L19.148|
;;;1362                   }
;;;1363               }
;;;1364               if( ( LoRaMacFlags.Bits.MlmeReq == 1 ) || ( ( LoRaMacFlags.Bits.McpsReq == 1 ) ) )
000094  4888              LDR      r0,|L19.696|
000096  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000098  0740              LSLS     r0,r0,#29
00009a  0fc0              LSRS     r0,r0,#31
00009c  2800              CMP      r0,#0
00009e  d105              BNE      |L19.172|
0000a0  4885              LDR      r0,|L19.696|
0000a2  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
0000a4  07c0              LSLS     r0,r0,#31
0000a6  0fc0              LSRS     r0,r0,#31
0000a8  2800              CMP      r0,#0
0000aa  d02b              BEQ      |L19.260|
                  |L19.172|
;;;1365               {
;;;1366                   if( ( ChannelsNbRepCounter >= ChannelsNbRep ) || ( LoRaMacFlags.Bits.McpsInd == 1 ) )
0000ac  488a              LDR      r0,|L19.728|
0000ae  7800              LDRB     r0,[r0,#0]  ; ChannelsNbRepCounter
0000b0  4988              LDR      r1,|L19.724|
0000b2  7809              LDRB     r1,[r1,#0]  ; ChannelsNbRep
0000b4  4288              CMP      r0,r1
0000b6  da05              BGE      |L19.196|
0000b8  487f              LDR      r0,|L19.696|
0000ba  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
0000bc  0780              LSLS     r0,r0,#30
0000be  0fc0              LSRS     r0,r0,#31
0000c0  2800              CMP      r0,#0
0000c2  d017              BEQ      |L19.244|
                  |L19.196|
;;;1367                   {
;;;1368                       ChannelsNbRepCounter = 0;
0000c4  2000              MOVS     r0,#0
0000c6  4984              LDR      r1,|L19.728|
0000c8  7008              STRB     r0,[r1,#0]
;;;1369   
;;;1370                       AdrAckCounter++;
0000ca  4884              LDR      r0,|L19.732|
0000cc  6800              LDR      r0,[r0,#0]  ; AdrAckCounter
0000ce  1c40              ADDS     r0,r0,#1
0000d0  4982              LDR      r1,|L19.732|
0000d2  6008              STR      r0,[r1,#0]  ; AdrAckCounter
;;;1371                       if( IsUpLinkCounterFixed == false )
0000d4  4882              LDR      r0,|L19.736|
0000d6  7800              LDRB     r0,[r0,#0]  ; IsUpLinkCounterFixed
0000d8  2800              CMP      r0,#0
0000da  d104              BNE      |L19.230|
;;;1372                       {
;;;1373                           UpLinkCounter++;
0000dc  487c              LDR      r0,|L19.720|
0000de  6800              LDR      r0,[r0,#0]  ; UpLinkCounter
0000e0  1c40              ADDS     r0,r0,#1
0000e2  497b              LDR      r1,|L19.720|
0000e4  6008              STR      r0,[r1,#0]  ; UpLinkCounter
                  |L19.230|
;;;1374                       }
;;;1375   
;;;1376                       LoRaMacState &= ~MAC_TX_RUNNING;
0000e6  4877              LDR      r0,|L19.708|
0000e8  6800              LDR      r0,[r0,#0]  ; LoRaMacState
0000ea  0840              LSRS     r0,r0,#1
0000ec  0040              LSLS     r0,r0,#1
0000ee  4975              LDR      r1,|L19.708|
0000f0  6008              STR      r0,[r1,#0]  ; LoRaMacState
0000f2  e007              B        |L19.260|
                  |L19.244|
;;;1377                   }
;;;1378                   else
;;;1379                   {
;;;1380                       LoRaMacFlags.Bits.MacDone = 0;
0000f4  4870              LDR      r0,|L19.696|
0000f6  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
0000f8  2108              MOVS     r1,#8
0000fa  4388              BICS     r0,r0,r1
0000fc  496e              LDR      r1,|L19.696|
0000fe  7008              STRB     r0,[r1,#0]
;;;1381                       // Sends the same frame again
;;;1382                       ScheduleTx( );
000100  f7fffffe          BL       ScheduleTx
                  |L19.260|
;;;1383                   }
;;;1384               }
;;;1385           }
;;;1386   
;;;1387           if( LoRaMacFlags.Bits.McpsInd == 1 )
000104  486c              LDR      r0,|L19.696|
000106  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000108  0780              LSLS     r0,r0,#30
00010a  0fc0              LSRS     r0,r0,#31
00010c  2800              CMP      r0,#0
00010e  d023              BEQ      |L19.344|
;;;1388           {
;;;1389               if( ( McpsConfirm.AckReceived == true ) || ( AckTimeoutRetriesCounter > AckTimeoutRetries ) )
000110  486a              LDR      r0,|L19.700|
000112  e000              B        |L19.278|
                  |L19.276|
000114  e05e              B        |L19.468|
                  |L19.278|
000116  7900              LDRB     r0,[r0,#4]  ; McpsConfirm
000118  2801              CMP      r0,#1
00011a  d005              BEQ      |L19.296|
00011c  486a              LDR      r0,|L19.712|
00011e  7800              LDRB     r0,[r0,#0]  ; AckTimeoutRetriesCounter
000120  4970              LDR      r1,|L19.740|
000122  7809              LDRB     r1,[r1,#0]  ; AckTimeoutRetries
000124  4288              CMP      r0,r1
000126  dd17              BLE      |L19.344|
                  |L19.296|
;;;1390               {
;;;1391                   AckTimeoutRetry = false;
000128  2000              MOVS     r0,#0
00012a  496f              LDR      r1,|L19.744|
00012c  7008              STRB     r0,[r1,#0]
;;;1392                   NodeAckRequested = false;
00012e  4967              LDR      r1,|L19.716|
000130  7008              STRB     r0,[r1,#0]
;;;1393                   if( IsUpLinkCounterFixed == false )
000132  486b              LDR      r0,|L19.736|
000134  7800              LDRB     r0,[r0,#0]  ; IsUpLinkCounterFixed
000136  2800              CMP      r0,#0
000138  d104              BNE      |L19.324|
;;;1394                   {
;;;1395                       UpLinkCounter++;
00013a  4865              LDR      r0,|L19.720|
00013c  6800              LDR      r0,[r0,#0]  ; UpLinkCounter
00013e  1c40              ADDS     r0,r0,#1
000140  4963              LDR      r1,|L19.720|
000142  6008              STR      r0,[r1,#0]  ; UpLinkCounter
                  |L19.324|
;;;1396                   }
;;;1397                   McpsConfirm.NbRetries = AckTimeoutRetriesCounter;
000144  4860              LDR      r0,|L19.712|
000146  7800              LDRB     r0,[r0,#0]  ; AckTimeoutRetriesCounter
000148  495c              LDR      r1,|L19.700|
00014a  7148              STRB     r0,[r1,#5]
;;;1398   
;;;1399                   LoRaMacState &= ~MAC_TX_RUNNING;
00014c  485d              LDR      r0,|L19.708|
00014e  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000150  0840              LSRS     r0,r0,#1
000152  0040              LSLS     r0,r0,#1
000154  495b              LDR      r1,|L19.708|
000156  6008              STR      r0,[r1,#0]  ; LoRaMacState
                  |L19.344|
;;;1400               }
;;;1401           }
;;;1402   
;;;1403           if( ( AckTimeoutRetry == true ) && ( ( LoRaMacState & MAC_TX_DELAYED ) == 0 ) )
000158  4863              LDR      r0,|L19.744|
00015a  7800              LDRB     r0,[r0,#0]  ; AckTimeoutRetry
00015c  2801              CMP      r0,#1
00015e  d157              BNE      |L19.528|
000160  4858              LDR      r0,|L19.708|
000162  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000164  2110              MOVS     r1,#0x10
000166  4008              ANDS     r0,r0,r1
000168  2800              CMP      r0,#0
00016a  d151              BNE      |L19.528|
;;;1404           {
;;;1405               AckTimeoutRetry = false;
00016c  495e              LDR      r1,|L19.744|
00016e  7008              STRB     r0,[r1,#0]
;;;1406               if( ( AckTimeoutRetriesCounter < AckTimeoutRetries ) && ( AckTimeoutRetriesCounter <= MAX_ACK_RETRIES ) )
000170  4855              LDR      r0,|L19.712|
000172  7800              LDRB     r0,[r0,#0]  ; AckTimeoutRetriesCounter
000174  495b              LDR      r1,|L19.740|
000176  7809              LDRB     r1,[r1,#0]  ; AckTimeoutRetries
000178  4288              CMP      r0,r1
00017a  da2c              BGE      |L19.470|
00017c  4852              LDR      r0,|L19.712|
00017e  7800              LDRB     r0,[r0,#0]  ; AckTimeoutRetriesCounter
000180  2808              CMP      r0,#8
000182  dc28              BGT      |L19.470|
;;;1407               {
;;;1408                   AckTimeoutRetriesCounter++;
000184  4850              LDR      r0,|L19.712|
000186  7800              LDRB     r0,[r0,#0]  ; AckTimeoutRetriesCounter
000188  1c40              ADDS     r0,r0,#1
00018a  494f              LDR      r1,|L19.712|
00018c  7008              STRB     r0,[r1,#0]
;;;1409   
;;;1410                   if( (( AckTimeoutRetriesCounter % 2 ) == 1 ) )
00018e  7808              LDRB     r0,[r1,#0]  ; AckTimeoutRetriesCounter
000190  0fc1              LSRS     r1,r0,#31
000192  1809              ADDS     r1,r1,r0
000194  1049              ASRS     r1,r1,#1
000196  0049              LSLS     r1,r1,#1
000198  1a41              SUBS     r1,r0,r1
00019a  2901              CMP      r1,#1
00019c  d10d              BNE      |L19.442|
;;;1411                   {
;;;1412                       ChannelsDatarate = MAX( ChannelsDatarate - 1, LORAMAC_MIN_DATARATE );
00019e  4953              LDR      r1,|L19.748|
0001a0  2000              MOVS     r0,#0
0001a2  5608              LDRSB    r0,[r1,r0]  ; ChannelsDatarate
0001a4  1e40              SUBS     r0,r0,#1
0001a6  2805              CMP      r0,#5
0001a8  dd03              BLE      |L19.434|
0001aa  2000              MOVS     r0,#0
0001ac  5608              LDRSB    r0,[r1,r0]  ; ChannelsDatarate
0001ae  1e40              SUBS     r0,r0,#1
0001b0  e000              B        |L19.436|
                  |L19.434|
0001b2  2005              MOVS     r0,#5
                  |L19.436|
0001b4  b240              SXTB     r0,r0
0001b6  494d              LDR      r1,|L19.748|
0001b8  7008              STRB     r0,[r1,#0]
                  |L19.442|
;;;1413   										DEBUG(3," MAX( ChannelsDatarate - 1, LORAMAC_MIN_DATARATE ) = %d\r\n", MAX( ChannelsDatarate - 1, LORAMAC_MIN_DATARATE ));
;;;1414                   }
;;;1415                   LoRaMacFlags.Bits.MacDone = 0;
0001ba  483f              LDR      r0,|L19.696|
0001bc  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
0001be  2108              MOVS     r1,#8
0001c0  4388              BICS     r0,r0,r1
0001c2  493d              LDR      r1,|L19.696|
0001c4  7008              STRB     r0,[r1,#0]
;;;1416                   // Sends the same frame again
;;;1417                   DEBUG(2,"ScheduleTx\r\n");
0001c6  a04a              ADR      r0,|L19.752|
0001c8  f7fffffe          BL       __2printf
;;;1418                   ScheduleTx( );
0001cc  f7fffffe          BL       ScheduleTx
;;;1419                   Send_Led( ); ///发送完成闪烁
0001d0  f7fffffe          BL       Send_Led
                  |L19.468|
0001d4  e01c              B        |L19.528|
                  |L19.470|
;;;1420            
;;;1421               }
;;;1422               else
;;;1423               {
;;;1424   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;1425                   // Re-enable default channels LC1, LC2, LC3
;;;1426                   ChannelsMask[0] = ChannelsMask[0] | ( LC( 1 ) + LC( 2 ) + LC( 3 ) );
0001d6  484a              LDR      r0,|L19.768|
0001d8  8800              LDRH     r0,[r0,#0]  ; ChannelsMask
0001da  2107              MOVS     r1,#7
0001dc  4308              ORRS     r0,r0,r1
0001de  4948              LDR      r1,|L19.768|
0001e0  8008              STRH     r0,[r1,#0]
;;;1427   #elif defined( USE_BAND_915 )
;;;1428                   // Re-enable default channels
;;;1429                   ChannelsMask[0] = 0xFFFF;
;;;1430                   ChannelsMask[1] = 0xFFFF;
;;;1431                   ChannelsMask[2] = 0xFFFF;
;;;1432                   ChannelsMask[3] = 0xFFFF;
;;;1433                   ChannelsMask[4] = 0x00FF;
;;;1434                   ChannelsMask[5] = 0x0000;
;;;1435   #elif defined( USE_BAND_915_HYBRID )
;;;1436                   // Re-enable default channels
;;;1437                   ChannelsMask[0] = 0x00FF;
;;;1438                   ChannelsMask[1] = 0x0000;
;;;1439                   ChannelsMask[2] = 0x0000;
;;;1440                   ChannelsMask[3] = 0x0000;
;;;1441                   ChannelsMask[4] = 0x0001;
;;;1442                   ChannelsMask[5] = 0x0000;
;;;1443   #else
;;;1444       #error "Please define a frequency band in the compiler options."
;;;1445   #endif
;;;1446                   LoRaMacState &= ~MAC_TX_RUNNING;
0001e2  4838              LDR      r0,|L19.708|
0001e4  6800              LDR      r0,[r0,#0]  ; LoRaMacState
0001e6  0840              LSRS     r0,r0,#1
0001e8  0040              LSLS     r0,r0,#1
0001ea  4936              LDR      r1,|L19.708|
0001ec  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;1447   
;;;1448                   NodeAckRequested = false;
0001ee  2000              MOVS     r0,#0
0001f0  4936              LDR      r1,|L19.716|
0001f2  7008              STRB     r0,[r1,#0]
;;;1449                   McpsConfirm.AckReceived = false;
0001f4  4931              LDR      r1,|L19.700|
0001f6  7108              STRB     r0,[r1,#4]
;;;1450                   McpsConfirm.NbRetries = AckTimeoutRetriesCounter;
0001f8  4833              LDR      r0,|L19.712|
0001fa  7800              LDRB     r0,[r0,#0]  ; AckTimeoutRetriesCounter
0001fc  7148              STRB     r0,[r1,#5]
;;;1451                   if( IsUpLinkCounterFixed == false )
0001fe  4838              LDR      r0,|L19.736|
000200  7800              LDRB     r0,[r0,#0]  ; IsUpLinkCounterFixed
000202  2800              CMP      r0,#0
000204  d104              BNE      |L19.528|
;;;1452                   {
;;;1453                       UpLinkCounter++;
000206  4832              LDR      r0,|L19.720|
000208  6800              LDR      r0,[r0,#0]  ; UpLinkCounter
00020a  1c40              ADDS     r0,r0,#1
00020c  4930              LDR      r1,|L19.720|
00020e  6008              STR      r0,[r1,#0]  ; UpLinkCounter
                  |L19.528|
;;;1454                   }
;;;1455               }
;;;1456           }
;;;1457       }
;;;1458       // Handle reception for Class B and Class C
;;;1459       if( ( LoRaMacState & MAC_RX ) == MAC_RX )
000210  482c              LDR      r0,|L19.708|
000212  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000214  2102              MOVS     r1,#2
000216  4008              ANDS     r0,r0,r1
000218  2802              CMP      r0,#2
00021a  d104              BNE      |L19.550|
;;;1460       {
;;;1461           LoRaMacState &= ~MAC_RX;
00021c  4829              LDR      r0,|L19.708|
00021e  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000220  4388              BICS     r0,r0,r1
000222  4928              LDR      r1,|L19.708|
000224  6008              STR      r0,[r1,#0]  ; LoRaMacState
                  |L19.550|
;;;1462       }
;;;1463       if( LoRaMacState == MAC_IDLE )
000226  4827              LDR      r0,|L19.708|
000228  6800              LDR      r0,[r0,#0]  ; LoRaMacState
00022a  2800              CMP      r0,#0
00022c  d128              BNE      |L19.640|
;;;1464       {
;;;1465           if( LoRaMacFlags.Bits.McpsReq == 1 )
00022e  4822              LDR      r0,|L19.696|
000230  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000232  07c0              LSLS     r0,r0,#31
000234  0fc0              LSRS     r0,r0,#31
000236  2800              CMP      r0,#0
000238  d00a              BEQ      |L19.592|
;;;1466           {
;;;1467               LoRaMacPrimitives->MacMcpsConfirm( &McpsConfirm );
00023a  4832              LDR      r0,|L19.772|
00023c  6800              LDR      r0,[r0,#0]  ; LoRaMacPrimitives
00023e  6801              LDR      r1,[r0,#0]
000240  481e              LDR      r0,|L19.700|
000242  4788              BLX      r1
;;;1468               LoRaMacFlags.Bits.McpsReq = 0;
000244  481c              LDR      r0,|L19.696|
000246  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000248  0840              LSRS     r0,r0,#1
00024a  0040              LSLS     r0,r0,#1
00024c  491a              LDR      r1,|L19.696|
00024e  7008              STRB     r0,[r1,#0]
                  |L19.592|
;;;1469           }
;;;1470   
;;;1471           if( LoRaMacFlags.Bits.MlmeReq == 1 )
000250  4819              LDR      r0,|L19.696|
000252  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000254  0740              LSLS     r0,r0,#29
000256  0fc0              LSRS     r0,r0,#31
000258  2800              CMP      r0,#0
00025a  d00a              BEQ      |L19.626|
;;;1472           {
;;;1473               LoRaMacPrimitives->MacMlmeConfirm( &MlmeConfirm );
00025c  4829              LDR      r0,|L19.772|
00025e  6800              LDR      r0,[r0,#0]  ; LoRaMacPrimitives
000260  6881              LDR      r1,[r0,#8]
000262  4817              LDR      r0,|L19.704|
000264  4788              BLX      r1
;;;1474               LoRaMacFlags.Bits.MlmeReq = 0;
000266  4814              LDR      r0,|L19.696|
000268  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
00026a  2104              MOVS     r1,#4
00026c  4388              BICS     r0,r0,r1
00026e  4912              LDR      r1,|L19.696|
000270  7008              STRB     r0,[r1,#0]
                  |L19.626|
;;;1475           }
;;;1476   
;;;1477           LoRaMacFlags.Bits.MacDone = 0;
000272  4811              LDR      r0,|L19.696|
000274  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000276  2108              MOVS     r1,#8
000278  4388              BICS     r0,r0,r1
00027a  490f              LDR      r1,|L19.696|
00027c  7008              STRB     r0,[r1,#0]
00027e  e006              B        |L19.654|
                  |L19.640|
;;;1478       }
;;;1479       else
;;;1480       {
;;;1481           // Operation not finished restart timer
;;;1482           TimerSetValue( &MacStateCheckTimer, MAC_STATE_CHECK_TIMEOUT );
000280  4921              LDR      r1,|L19.776|
000282  480c              LDR      r0,|L19.692|
000284  f7fffffe          BL       TimerSetValue
;;;1483           TimerStart( &MacStateCheckTimer );
000288  480a              LDR      r0,|L19.692|
00028a  f7fffffe          BL       TimerStart
                  |L19.654|
;;;1484       }
;;;1485   
;;;1486       if( LoRaMacFlags.Bits.McpsInd == 1 )
00028e  480a              LDR      r0,|L19.696|
000290  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000292  0780              LSLS     r0,r0,#30
000294  0fc0              LSRS     r0,r0,#31
000296  2800              CMP      r0,#0
000298  d00a              BEQ      |L19.688|
;;;1487       {
;;;1488           LoRaMacPrimitives->MacMcpsIndication( &McpsIndication );
00029a  481a              LDR      r0,|L19.772|
00029c  6800              LDR      r0,[r0,#0]  ; LoRaMacPrimitives
00029e  6841              LDR      r1,[r0,#4]
0002a0  481a              LDR      r0,|L19.780|
0002a2  4788              BLX      r1
;;;1489           LoRaMacFlags.Bits.McpsInd = 0;
0002a4  4804              LDR      r0,|L19.696|
0002a6  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
0002a8  2102              MOVS     r1,#2
0002aa  4388              BICS     r0,r0,r1
0002ac  4902              LDR      r1,|L19.696|
0002ae  7008              STRB     r0,[r1,#0]
                  |L19.688|
;;;1490       }
;;;1491   }
0002b0  bd10              POP      {r4,pc}
;;;1492   
                          ENDP

0002b2  0000              DCW      0x0000
                  |L19.692|
                          DCD      MacStateCheckTimer
                  |L19.696|
                          DCD      LoRaMacFlags
                  |L19.700|
                          DCD      McpsConfirm
                  |L19.704|
                          DCD      MlmeConfirm
                  |L19.708|
                          DCD      LoRaMacState
                  |L19.712|
                          DCD      AckTimeoutRetriesCounter
                  |L19.716|
                          DCD      NodeAckRequested
                  |L19.720|
                          DCD      UpLinkCounter
                  |L19.724|
                          DCD      ChannelsNbRep
                  |L19.728|
                          DCD      ChannelsNbRepCounter
                  |L19.732|
                          DCD      AdrAckCounter
                  |L19.736|
                          DCD      IsUpLinkCounterFixed
                  |L19.740|
                          DCD      AckTimeoutRetries
                  |L19.744|
                          DCD      AckTimeoutRetry
                  |L19.748|
                          DCD      ChannelsDatarate
                  |L19.752|
0002f0  53636865          DCB      "ScheduleTx\r\n",0
0002f4  64756c65
0002f8  54780d0a
0002fc  00      
0002fd  00                DCB      0
0002fe  00                DCB      0
0002ff  00                DCB      0
                  |L19.768|
                          DCD      ChannelsMask
                  |L19.772|
                          DCD      LoRaMacPrimitives
                  |L19.776|
                          DCD      0x000f4240
                  |L19.780|
                          DCD      McpsIndication

                          AREA ||i.OnRadioCadDone||, CODE, READONLY, ALIGN=1

                  OnRadioCadDone PROC
;;;787    
;;;788    static void OnRadioCadDone( bool channelActivityDetected )
000000  4770              BX       lr
;;;789    {
;;;790    	
;;;791    }
;;;792    
                          ENDP


                          AREA ||i.OnRadioRxDone||, CODE, READONLY, ALIGN=2

                          REQUIRE _printf_percent
                          REQUIRE _printf_s
                          REQUIRE _printf_str
                          REQUIRE _printf_d
                          REQUIRE _printf_int_dec
                  OnRadioRxDone PROC
;;;878    
;;;879    static void OnRadioRxDone( uint8_t *payload, uint16_t size, int16_t rssi, int8_t snr )
000000  b5ff              PUSH     {r0-r7,lr}
;;;880    {
000002  b095              SUB      sp,sp,#0x54
000004  4605              MOV      r5,r0
000006  460c              MOV      r4,r1
;;;881        LoRaMacHeader_t macHdr;
;;;882        LoRaMacFrameCtrl_t fCtrl;
;;;883        DEBUG(2,"%s\r\n",__func__);
000008  49f6              LDR      r1,|L21.996|
00000a  a0f7              ADR      r0,|L21.1000|
00000c  f7fffffe          BL       __2printf
;;;884    
;;;885        uint8_t pktHeaderLen = 0;
000010  2000              MOVS     r0,#0
000012  9011              STR      r0,[sp,#0x44]
;;;886        uint32_t address = 0;
000014  9010              STR      r0,[sp,#0x40]
;;;887        uint8_t appPayloadStartIndex = 0;
000016  900f              STR      r0,[sp,#0x3c]
;;;888        uint8_t port = 0xFF;
000018  20ff              MOVS     r0,#0xff
00001a  900e              STR      r0,[sp,#0x38]
;;;889        uint8_t frameLen = 0;
00001c  2000              MOVS     r0,#0
00001e  900d              STR      r0,[sp,#0x34]
;;;890        uint32_t mic = 0;
000020  900c              STR      r0,[sp,#0x30]
;;;891        uint32_t micRx = 0;
000022  2700              MOVS     r7,#0
;;;892    
;;;893        uint16_t sequenceCounter = 0;
000024  900b              STR      r0,[sp,#0x2c]
;;;894        uint16_t sequenceCounterPrev = 0;
000026  900a              STR      r0,[sp,#0x28]
;;;895        uint16_t sequenceCounterDiff = 0;
000028  9009              STR      r0,[sp,#0x24]
;;;896        uint32_t downLinkCounter = 0;
00002a  2600              MOVS     r6,#0
;;;897    
;;;898        MulticastParams_t *curMulticastParams = NULL;
00002c  9008              STR      r0,[sp,#0x20]
;;;899        uint8_t *nwkSKey = LoRaMacNwkSKey;
00002e  48f0              LDR      r0,|L21.1008|
000030  9007              STR      r0,[sp,#0x1c]
;;;900        uint8_t *appSKey = LoRaMacAppSKey;
000032  48f0              LDR      r0,|L21.1012|
000034  9006              STR      r0,[sp,#0x18]
;;;901    
;;;902        uint8_t multicast = 0;
000036  2000              MOVS     r0,#0
000038  9005              STR      r0,[sp,#0x14]
;;;903    
;;;904        bool isMicOk = false;
00003a  9004              STR      r0,[sp,#0x10]
;;;905    
;;;906        McpsConfirm.AckReceived = false;
00003c  49ee              LDR      r1,|L21.1016|
00003e  7108              STRB     r0,[r1,#4]
;;;907        McpsIndication.Rssi = rssi;
000040  49ee              LDR      r1,|L21.1020|
000042  9817              LDR      r0,[sp,#0x5c]
000044  81c8              STRH     r0,[r1,#0xe]
;;;908        McpsIndication.Snr = snr;
000046  9818              LDR      r0,[sp,#0x60]
000048  7408              STRB     r0,[r1,#0x10]
;;;909        McpsIndication.RxSlot = RxSlot;
00004a  48ed              LDR      r0,|L21.1024|
00004c  7800              LDRB     r0,[r0,#0]  ; RxSlot
00004e  7448              STRB     r0,[r1,#0x11]
;;;910        McpsIndication.Port = 0;
000050  2000              MOVS     r0,#0
000052  70c8              STRB     r0,[r1,#3]
;;;911        McpsIndication.Multicast = 0;
000054  7088              STRB     r0,[r1,#2]
;;;912        McpsIndication.FramePending = 0;
000056  7148              STRB     r0,[r1,#5]
;;;913        McpsIndication.Buffer = NULL;
000058  6088              STR      r0,[r1,#8]  ; McpsIndication
;;;914        McpsIndication.BufferSize = 0;
00005a  7308              STRB     r0,[r1,#0xc]
;;;915        McpsIndication.RxData = false;
00005c  7348              STRB     r0,[r1,#0xd]
;;;916        McpsIndication.AckReceived = false;
00005e  7488              STRB     r0,[r1,#0x12]
;;;917        McpsIndication.DownLinkCounter = 0;
000060  6148              STR      r0,[r1,#0x14]  ; McpsIndication
;;;918        McpsIndication.McpsIndication = MCPS_UNCONFIRMED;
000062  7008              STRB     r0,[r1,#0]
;;;919    
;;;920        if( LoRaMacDeviceClass != CLASS_C )
000064  48e7              LDR      r0,|L21.1028|
000066  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
000068  2802              CMP      r0,#2
00006a  d002              BEQ      |L21.114|
;;;921        {
;;;922            Radio.Sleep( );
00006c  49e6              LDR      r1,|L21.1032|
00006e  6ac8              LDR      r0,[r1,#0x2c]  ; Radio
000070  4780              BLX      r0
                  |L21.114|
;;;923        }
;;;924        TimerStop( &RxWindowTimer2 );
000072  48e6              LDR      r0,|L21.1036|
000074  f7fffffe          BL       TimerStop
;;;925    
;;;926        macHdr.Value = payload[pktHeaderLen++];
000078  9811              LDR      r0,[sp,#0x44]
00007a  1c41              ADDS     r1,r0,#1
00007c  b2c9              UXTB     r1,r1
00007e  9111              STR      r1,[sp,#0x44]
000080  5c28              LDRB     r0,[r5,r0]
000082  9013              STR      r0,[sp,#0x4c]
;;;927    		
;;;928    		if(LoRaCad.Iq_Invert)
000084  48e2              LDR      r0,|L21.1040|
000086  78c0              LDRB     r0,[r0,#3]  ; LoRaCad
000088  2800              CMP      r0,#0
00008a  d005              BEQ      |L21.152|
;;;929    		macHdr.Bits.MType = FRAME_TYPE_DATA_CONFIRMED_UP;
00008c  a910              ADD      r1,sp,#0x40
00008e  7b08              LDRB     r0,[r1,#0xc]
000090  21e0              MOVS     r1,#0xe0
000092  4388              BICS     r0,r0,r1
000094  3080              ADDS     r0,r0,#0x80
000096  9013              STR      r0,[sp,#0x4c]
                  |L21.152|
;;;930    
;;;931        switch( macHdr.Bits.MType )
000098  a810              ADD      r0,sp,#0x40
00009a  7b00              LDRB     r0,[r0,#0xc]
00009c  0940              LSRS     r0,r0,#5
00009e  0003              MOVS     r3,r0
0000a0  f7fffffe          BL       __ARM_common_switch8
0000a4  08fb05fb          DCB      0x08,0xfb,0x05,0xfb
0000a8  faf9f8fb          DCB      0xfa,0xf9,0xf8,0xfb
0000ac  f7fb              DCB      0xf7,0xfb
;;;932        {
;;;933            case FRAME_TYPE_JOIN_ACCEPT:
;;;934                if( IsLoRaMacNetworkJoined == true )
0000ae  48d9              LDR      r0,|L21.1044|
0000b0  7800              LDRB     r0,[r0,#0]  ; IsLoRaMacNetworkJoined
0000b2  2801              CMP      r0,#1
0000b4  d100              BNE      |L21.184|
;;;935                {
;;;936                    break;
0000b6  e2e3              B        |L21.1664|
                  |L21.184|
;;;937                }
;;;938                DEBUG(2,"join accept \r\n");
0000b8  a0d7              ADR      r0,|L21.1048|
0000ba  f7fffffe          BL       __2printf
;;;939                LoRaMacJoinDecrypt( payload + 1, size - 1, LoRaMacAppKey, LoRaMacRxPayload + 1 );
0000be  1e60              SUBS     r0,r4,#1
0000c0  b281              UXTH     r1,r0
0000c2  4bd9              LDR      r3,|L21.1064|
0000c4  48d9              LDR      r0,|L21.1068|
0000c6  6802              LDR      r2,[r0,#0]  ; LoRaMacAppKey
0000c8  1c68              ADDS     r0,r5,#1
0000ca  f7fffffe          BL       LoRaMacJoinDecrypt
;;;940    
;;;941                LoRaMacRxPayload[0] = macHdr.Value;
0000ce  a810              ADD      r0,sp,#0x40
0000d0  7b00              LDRB     r0,[r0,#0xc]
0000d2  49d5              LDR      r1,|L21.1064|
0000d4  1e49              SUBS     r1,r1,#1
0000d6  7008              STRB     r0,[r1,#0]
;;;942    
;;;943                LoRaMacJoinComputeMic( LoRaMacRxPayload, size - LORAMAC_MFR_LEN, LoRaMacAppKey, &mic );
0000d8  1f20              SUBS     r0,r4,#4
0000da  b281              UXTH     r1,r0
0000dc  ab0c              ADD      r3,sp,#0x30
0000de  48d3              LDR      r0,|L21.1068|
0000e0  6802              LDR      r2,[r0,#0]  ; LoRaMacAppKey
0000e2  48d1              LDR      r0,|L21.1064|
0000e4  1e40              SUBS     r0,r0,#1
0000e6  f7fffffe          BL       LoRaMacJoinComputeMic
;;;944    
;;;945                micRx |= ( uint32_t )LoRaMacRxPayload[size - LORAMAC_MFR_LEN];
0000ea  1f20              SUBS     r0,r4,#4
0000ec  49ce              LDR      r1,|L21.1064|
0000ee  1e49              SUBS     r1,r1,#1
0000f0  5c08              LDRB     r0,[r1,r0]
0000f2  4307              ORRS     r7,r7,r0
;;;946                micRx |= ( ( uint32_t )LoRaMacRxPayload[size - LORAMAC_MFR_LEN + 1] << 8 );
0000f4  1ee0              SUBS     r0,r4,#3
0000f6  5c08              LDRB     r0,[r1,r0]
0000f8  0200              LSLS     r0,r0,#8
0000fa  4307              ORRS     r7,r7,r0
;;;947                micRx |= ( ( uint32_t )LoRaMacRxPayload[size - LORAMAC_MFR_LEN + 2] << 16 );
0000fc  1ea0              SUBS     r0,r4,#2
0000fe  5c08              LDRB     r0,[r1,r0]
000100  0400              LSLS     r0,r0,#16
000102  4307              ORRS     r7,r7,r0
;;;948                micRx |= ( ( uint32_t )LoRaMacRxPayload[size - LORAMAC_MFR_LEN + 3] << 24 );
000104  1e60              SUBS     r0,r4,#1
000106  5c08              LDRB     r0,[r1,r0]
000108  0600              LSLS     r0,r0,#24
00010a  4307              ORRS     r7,r7,r0
;;;949    
;;;950                if( micRx == mic )
00010c  980c              LDR      r0,[sp,#0x30]
00010e  4287              CMP      r7,r0
000110  d17e              BNE      |L21.528|
;;;951                {
;;;952                    LoRaMacJoinComputeSKeys( LoRaMacAppKey, LoRaMacRxPayload + 1, LoRaMacDevNonce, LoRaMacNwkSKey, LoRaMacAppSKey );
000112  48b8              LDR      r0,|L21.1012|
000114  4bb6              LDR      r3,|L21.1008|
000116  9000              STR      r0,[sp,#0]
000118  48c5              LDR      r0,|L21.1072|
00011a  8802              LDRH     r2,[r0,#0]  ; LoRaMacDevNonce
00011c  1c49              ADDS     r1,r1,#1
00011e  48c3              LDR      r0,|L21.1068|
000120  6800              LDR      r0,[r0,#0]  ; LoRaMacAppKey
000122  f7fffffe          BL       LoRaMacJoinComputeSKeys
;;;953    
;;;954                    LoRaMacNetID = ( uint32_t )LoRaMacRxPayload[4];
000126  48c0              LDR      r0,|L21.1064|
000128  1e40              SUBS     r0,r0,#1
00012a  7900              LDRB     r0,[r0,#4]  ; LoRaMacRxPayload
00012c  49c1              LDR      r1,|L21.1076|
00012e  6008              STR      r0,[r1,#0]  ; LoRaMacNetID
;;;955                    LoRaMacNetID |= ( ( uint32_t )LoRaMacRxPayload[5] << 8 );
000130  48bd              LDR      r0,|L21.1064|
000132  1e40              SUBS     r0,r0,#1
000134  7940              LDRB     r0,[r0,#5]  ; LoRaMacRxPayload
000136  0200              LSLS     r0,r0,#8
000138  6809              LDR      r1,[r1,#0]  ; LoRaMacNetID
00013a  4308              ORRS     r0,r0,r1
00013c  49bd              LDR      r1,|L21.1076|
00013e  6008              STR      r0,[r1,#0]  ; LoRaMacNetID
;;;956                    LoRaMacNetID |= ( ( uint32_t )LoRaMacRxPayload[6] << 16 );
000140  48b9              LDR      r0,|L21.1064|
000142  1e40              SUBS     r0,r0,#1
000144  7980              LDRB     r0,[r0,#6]  ; LoRaMacRxPayload
000146  0400              LSLS     r0,r0,#16
000148  6809              LDR      r1,[r1,#0]  ; LoRaMacNetID
00014a  4308              ORRS     r0,r0,r1
00014c  49b9              LDR      r1,|L21.1076|
00014e  6008              STR      r0,[r1,#0]  ; LoRaMacNetID
;;;957    
;;;958                    LoRaMacDevAddr = ( uint32_t )LoRaMacRxPayload[7];
000150  48b5              LDR      r0,|L21.1064|
000152  1e40              SUBS     r0,r0,#1
000154  79c0              LDRB     r0,[r0,#7]  ; LoRaMacRxPayload
000156  49b8              LDR      r1,|L21.1080|
000158  6008              STR      r0,[r1,#0]  ; LoRaMacDevAddr
;;;959                    LoRaMacDevAddr |= ( ( uint32_t )LoRaMacRxPayload[8] << 8 );
00015a  48b3              LDR      r0,|L21.1064|
00015c  1e40              SUBS     r0,r0,#1
00015e  7a00              LDRB     r0,[r0,#8]  ; LoRaMacRxPayload
000160  0200              LSLS     r0,r0,#8
000162  6809              LDR      r1,[r1,#0]  ; LoRaMacDevAddr
000164  4308              ORRS     r0,r0,r1
000166  49b4              LDR      r1,|L21.1080|
000168  6008              STR      r0,[r1,#0]  ; LoRaMacDevAddr
;;;960                    LoRaMacDevAddr |= ( ( uint32_t )LoRaMacRxPayload[9] << 16 );
00016a  48af              LDR      r0,|L21.1064|
00016c  1e40              SUBS     r0,r0,#1
00016e  7a40              LDRB     r0,[r0,#9]  ; LoRaMacRxPayload
000170  0400              LSLS     r0,r0,#16
000172  6809              LDR      r1,[r1,#0]  ; LoRaMacDevAddr
000174  4308              ORRS     r0,r0,r1
000176  49b0              LDR      r1,|L21.1080|
000178  6008              STR      r0,[r1,#0]  ; LoRaMacDevAddr
;;;961                    LoRaMacDevAddr |= ( ( uint32_t )LoRaMacRxPayload[10] << 24 );
00017a  48ab              LDR      r0,|L21.1064|
00017c  1e40              SUBS     r0,r0,#1
00017e  7a80              LDRB     r0,[r0,#0xa]  ; LoRaMacRxPayload
000180  0600              LSLS     r0,r0,#24
000182  6809              LDR      r1,[r1,#0]  ; LoRaMacDevAddr
000184  4308              ORRS     r0,r0,r1
000186  49ac              LDR      r1,|L21.1080|
000188  6008              STR      r0,[r1,#0]  ; LoRaMacDevAddr
;;;962    
;;;963                    // DLSettings
;;;964                    Rx1DrOffset = ( LoRaMacRxPayload[11] >> 4 ) & 0x07;
00018a  48a7              LDR      r0,|L21.1064|
00018c  1e40              SUBS     r0,r0,#1
00018e  7ac0              LDRB     r0,[r0,#0xb]  ; LoRaMacRxPayload
000190  0640              LSLS     r0,r0,#25
000192  0f40              LSRS     r0,r0,#29
000194  49a9              LDR      r1,|L21.1084|
000196  7008              STRB     r0,[r1,#0]
;;;965                    Rx2Channel.Datarate = LoRaMacRxPayload[11] & 0x0F;
000198  48a3              LDR      r0,|L21.1064|
00019a  1e40              SUBS     r0,r0,#1
00019c  7ac0              LDRB     r0,[r0,#0xb]  ; LoRaMacRxPayload
00019e  0700              LSLS     r0,r0,#28
0001a0  0f00              LSRS     r0,r0,#28
0001a2  49a7              LDR      r1,|L21.1088|
0001a4  7108              STRB     r0,[r1,#4]
;;;966    #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;967                    /*
;;;968                     * WARNING: To be removed once Semtech server implementation
;;;969                     *          is corrected.
;;;970                     */
;;;971                    if( Rx2Channel.Datarate == DR_3 )
;;;972                    {
;;;973                        Rx2Channel.Datarate = DR_8;
;;;974                    }
;;;975    #endif
;;;976                    // RxDelay
;;;977                    ReceiveDelay1 = ( LoRaMacRxPayload[12] & 0x0F );
0001a6  48a0              LDR      r0,|L21.1064|
0001a8  1e40              SUBS     r0,r0,#1
0001aa  7b00              LDRB     r0,[r0,#0xc]  ; LoRaMacRxPayload
0001ac  0700              LSLS     r0,r0,#28
0001ae  0f00              LSRS     r0,r0,#28
0001b0  49a4              LDR      r1,|L21.1092|
0001b2  6008              STR      r0,[r1,#0]  ; ReceiveDelay1
;;;978                    if( ReceiveDelay1 == 0 )
0001b4  4608              MOV      r0,r1
0001b6  6800              LDR      r0,[r0,#0]  ; ReceiveDelay1
0001b8  2800              CMP      r0,#0
0001ba  d101              BNE      |L21.448|
;;;979                    {
;;;980                        ReceiveDelay1 = 1;
0001bc  2001              MOVS     r0,#1
0001be  6008              STR      r0,[r1,#0]  ; ReceiveDelay1
                  |L21.448|
;;;981                    }
;;;982                    ReceiveDelay1 *= 1e6;
0001c0  48a0              LDR      r0,|L21.1092|
0001c2  6800              LDR      r0,[r0,#0]  ; ReceiveDelay1
0001c4  f7fffffe          BL       __aeabi_ui2d
0001c8  2200              MOVS     r2,#0
0001ca  4b9f              LDR      r3,|L21.1096|
0001cc  9101              STR      r1,[sp,#4]
0001ce  9000              STR      r0,[sp,#0]
0001d0  f7fffffe          BL       __aeabi_dmul
0001d4  9103              STR      r1,[sp,#0xc]
0001d6  9002              STR      r0,[sp,#8]
0001d8  f7fffffe          BL       __aeabi_d2uiz
0001dc  4999              LDR      r1,|L21.1092|
0001de  6008              STR      r0,[r1,#0]  ; ReceiveDelay1
;;;983                    ReceiveDelay2 = ReceiveDelay1 + 1e6;
0001e0  4608              MOV      r0,r1
0001e2  6800              LDR      r0,[r0,#0]  ; ReceiveDelay1
0001e4  f7fffffe          BL       __aeabi_ui2d
0001e8  2200              MOVS     r2,#0
0001ea  4b97              LDR      r3,|L21.1096|
0001ec  9101              STR      r1,[sp,#4]
0001ee  9000              STR      r0,[sp,#0]
0001f0  f7fffffe          BL       __aeabi_dadd
0001f4  9103              STR      r1,[sp,#0xc]
0001f6  9002              STR      r0,[sp,#8]
0001f8  f7fffffe          BL       __aeabi_d2uiz
0001fc  4993              LDR      r1,|L21.1100|
0001fe  6008              STR      r0,[r1,#0]  ; ReceiveDelay2
;;;984    
;;;985    #if !( defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID ) )
;;;986                    //CFList
;;;987                    if( ( size - 1 ) > 16 )
000200  1e60              SUBS     r0,r4,#1
000202  2810              CMP      r0,#0x10
000204  dd39              BLE      |L21.634|
;;;988                    {
;;;989                        ChannelParams_t param;
;;;990                        param.DrRange.Value = ( DR_5 << 4 ) | DR_0;
000206  2050              MOVS     r0,#0x50
000208  4669              MOV      r1,sp
00020a  7308              STRB     r0,[r1,#0xc]
;;;991    
;;;992                        LoRaMacState |= MAC_TX_CONFIG;
00020c  4890              LDR      r0,|L21.1104|
00020e  e000              B        |L21.530|
                  |L21.528|
000210  e044              B        |L21.668|
                  |L21.530|
000212  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000214  2120              MOVS     r1,#0x20
000216  4308              ORRS     r0,r0,r1
000218  498d              LDR      r1,|L21.1104|
00021a  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;993                        for( uint8_t i = 3, j = 0; i < ( 5 + 3 ); i++, j += 3 )
00021c  2003              MOVS     r0,#3
00021e  9001              STR      r0,[sp,#4]
000220  2000              MOVS     r0,#0
000222  9000              STR      r0,[sp,#0]
000224  e01f              B        |L21.614|
                  |L21.550|
;;;994                        {
;;;995                            param.Frequency = ( ( uint32_t )LoRaMacRxPayload[13 + j] | ( ( uint32_t )LoRaMacRxPayload[14 + j] << 8 ) | ( ( uint32_t )LoRaMacRxPayload[15 + j] << 16 ) ) * 100;
000226  9800              LDR      r0,[sp,#0]
000228  300d              ADDS     r0,r0,#0xd
00022a  497f              LDR      r1,|L21.1064|
00022c  1e49              SUBS     r1,r1,#1
00022e  5c09              LDRB     r1,[r1,r0]
000230  9800              LDR      r0,[sp,#0]
000232  300e              ADDS     r0,r0,#0xe
000234  4a7c              LDR      r2,|L21.1064|
000236  1e52              SUBS     r2,r2,#1
000238  5c10              LDRB     r0,[r2,r0]
00023a  0200              LSLS     r0,r0,#8
00023c  4308              ORRS     r0,r0,r1
00023e  9900              LDR      r1,[sp,#0]
000240  310f              ADDS     r1,r1,#0xf
000242  5c51              LDRB     r1,[r2,r1]
000244  0409              LSLS     r1,r1,#16
000246  4308              ORRS     r0,r0,r1
000248  2164              MOVS     r1,#0x64
00024a  4348              MULS     r0,r1,r0
00024c  9002              STR      r0,[sp,#8]
;;;996                            LoRaMacChannelAdd( i, param );
00024e  a801              ADD      r0,sp,#4
000250  c807              LDM      r0,{r0-r2}
000252  f7fffffe          BL       LoRaMacChannelAdd
000256  9801              LDR      r0,[sp,#4]            ;993
000258  1c40              ADDS     r0,r0,#1              ;993
00025a  b2c0              UXTB     r0,r0                 ;993
00025c  9001              STR      r0,[sp,#4]            ;993
00025e  9800              LDR      r0,[sp,#0]            ;993
000260  1cc0              ADDS     r0,r0,#3              ;993
000262  b2c0              UXTB     r0,r0                 ;993
000264  9000              STR      r0,[sp,#0]            ;993
                  |L21.614|
000266  9801              LDR      r0,[sp,#4]            ;993
000268  2808              CMP      r0,#8                 ;993
00026a  dbdc              BLT      |L21.550|
;;;997                        }
;;;998                        LoRaMacState &= ~MAC_TX_CONFIG;
00026c  4878              LDR      r0,|L21.1104|
00026e  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000270  2120              MOVS     r1,#0x20
000272  4388              BICS     r0,r0,r1
000274  4976              LDR      r1,|L21.1104|
000276  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;999                    }
000278  bf00              NOP      
                  |L21.634|
;;;1000   #endif
;;;1001                   MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_OK;
00027a  2000              MOVS     r0,#0
00027c  4975              LDR      r1,|L21.1108|
00027e  7048              STRB     r0,[r1,#1]
;;;1002                   IsLoRaMacNetworkJoined = true;
000280  2001              MOVS     r0,#1
000282  4964              LDR      r1,|L21.1044|
000284  7008              STRB     r0,[r1,#0]
;;;1003                   ChannelsDatarate = ChannelsDefaultDatarate;
000286  4974              LDR      r1,|L21.1112|
000288  2000              MOVS     r0,#0
00028a  5608              LDRSB    r0,[r1,r0]  ; ChannelsDefaultDatarate
00028c  4973              LDR      r1,|L21.1116|
00028e  7008              STRB     r0,[r1,#0]
000290  e007              B        |L21.674|
000292  e1d7              B        |L21.1604|
000294  e007              B        |L21.678|
000296  e005              B        |L21.676|
000298  e006              B        |L21.680|
00029a  e1eb              B        |L21.1652|
                  |L21.668|
;;;1004               }
;;;1005               else
;;;1006               {
;;;1007                   MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_JOIN_FAIL;
00029c  2005              MOVS     r0,#5
00029e  496d              LDR      r1,|L21.1108|
0002a0  7048              STRB     r0,[r1,#1]
                  |L21.674|
;;;1008               }
;;;1009               break;
0002a2  e1ed              B        |L21.1664|
                  |L21.676|
;;;1010   						
;;;1011   				case FRAME_TYPE_DATA_CONFIRMED_UP:  ///增加节点间通信数据接收处理		
;;;1012           case FRAME_TYPE_DATA_CONFIRMED_DOWN:
0002a4  bf00              NOP      
                  |L21.678|
;;;1013           case FRAME_TYPE_DATA_UNCONFIRMED_DOWN:
0002a6  bf00              NOP      
                  |L21.680|
;;;1014               {		
;;;1015   								DEBUG(3,"FRAME_TYPE_DATA_UNCONFIRMED_DOWN \r\n");
;;;1016                   address = payload[pktHeaderLen++];
0002a8  9811              LDR      r0,[sp,#0x44]
0002aa  1c41              ADDS     r1,r0,#1
0002ac  b2c9              UXTB     r1,r1
0002ae  9111              STR      r1,[sp,#0x44]
0002b0  5c28              LDRB     r0,[r5,r0]
0002b2  9010              STR      r0,[sp,#0x40]
;;;1017                   address |= ( (uint32_t)payload[pktHeaderLen++] << 8 );
0002b4  9811              LDR      r0,[sp,#0x44]
0002b6  1c41              ADDS     r1,r0,#1
0002b8  b2c9              UXTB     r1,r1
0002ba  9111              STR      r1,[sp,#0x44]
0002bc  5c28              LDRB     r0,[r5,r0]
0002be  0200              LSLS     r0,r0,#8
0002c0  9910              LDR      r1,[sp,#0x40]
0002c2  4308              ORRS     r0,r0,r1
0002c4  9010              STR      r0,[sp,#0x40]
;;;1018                   address |= ( (uint32_t)payload[pktHeaderLen++] << 16 );
0002c6  9811              LDR      r0,[sp,#0x44]
0002c8  1c41              ADDS     r1,r0,#1
0002ca  b2c9              UXTB     r1,r1
0002cc  9111              STR      r1,[sp,#0x44]
0002ce  5c28              LDRB     r0,[r5,r0]
0002d0  0400              LSLS     r0,r0,#16
0002d2  9910              LDR      r1,[sp,#0x40]
0002d4  4308              ORRS     r0,r0,r1
0002d6  9010              STR      r0,[sp,#0x40]
;;;1019                   address |= ( (uint32_t)payload[pktHeaderLen++] << 24 );
0002d8  9811              LDR      r0,[sp,#0x44]
0002da  1c41              ADDS     r1,r0,#1
0002dc  b2c9              UXTB     r1,r1
0002de  9111              STR      r1,[sp,#0x44]
0002e0  5c28              LDRB     r0,[r5,r0]
0002e2  0600              LSLS     r0,r0,#24
0002e4  9910              LDR      r1,[sp,#0x40]
0002e6  4308              ORRS     r0,r0,r1
0002e8  9010              STR      r0,[sp,#0x40]
;;;1020   
;;;1021                   if( address != LoRaMacDevAddr )
0002ea  4953              LDR      r1,|L21.1080|
0002ec  9810              LDR      r0,[sp,#0x40]
0002ee  6809              LDR      r1,[r1,#0]  ; LoRaMacDevAddr
0002f0  4288              CMP      r0,r1
0002f2  d024              BEQ      |L21.830|
;;;1022                   {
;;;1023                       curMulticastParams = MulticastChannels;
0002f4  485a              LDR      r0,|L21.1120|
0002f6  6800              LDR      r0,[r0,#0]  ; MulticastChannels
0002f8  9008              STR      r0,[sp,#0x20]
;;;1024                       while( curMulticastParams != NULL )
0002fa  e012              B        |L21.802|
                  |L21.764|
;;;1025                       {
;;;1026                           if( address == curMulticastParams->Address )
0002fc  9808              LDR      r0,[sp,#0x20]
0002fe  6801              LDR      r1,[r0,#0]
000300  9810              LDR      r0,[sp,#0x40]
000302  4281              CMP      r1,r0
000304  d10a              BNE      |L21.796|
;;;1027                           {
;;;1028                               multicast = 1;
000306  2001              MOVS     r0,#1
000308  9005              STR      r0,[sp,#0x14]
;;;1029                               nwkSKey = curMulticastParams->NwkSKey;
00030a  9808              LDR      r0,[sp,#0x20]
00030c  1d00              ADDS     r0,r0,#4
00030e  9007              STR      r0,[sp,#0x1c]
;;;1030                               appSKey = curMulticastParams->AppSKey;
000310  9808              LDR      r0,[sp,#0x20]
000312  3014              ADDS     r0,r0,#0x14
000314  9006              STR      r0,[sp,#0x18]
;;;1031                               downLinkCounter = curMulticastParams->DownLinkCounter;
000316  9808              LDR      r0,[sp,#0x20]
000318  6a46              LDR      r6,[r0,#0x24]
;;;1032                               break;
00031a  e005              B        |L21.808|
                  |L21.796|
;;;1033                           }
;;;1034                           curMulticastParams = curMulticastParams->Next;
00031c  9808              LDR      r0,[sp,#0x20]
00031e  6a80              LDR      r0,[r0,#0x28]
000320  9008              STR      r0,[sp,#0x20]
                  |L21.802|
000322  9808              LDR      r0,[sp,#0x20]         ;1024
000324  2800              CMP      r0,#0                 ;1024
000326  d1e9              BNE      |L21.764|
                  |L21.808|
000328  bf00              NOP                            ;1032
;;;1035                       }
;;;1036                       if( multicast == 0 )
00032a  9805              LDR      r0,[sp,#0x14]
00032c  2800              CMP      r0,#0
00032e  d10e              BNE      |L21.846|
;;;1037                       {
;;;1038                           // We are not the destination of this frame.
;;;1039                           McpsIndication.Status = LORAMAC_EVENT_INFO_STATUS_ADDRESS_FAIL;
000330  2007              MOVS     r0,#7
000332  4932              LDR      r1,|L21.1020|
000334  7048              STRB     r0,[r1,#1]
;;;1040                           PrepareRxDoneAbort( );
000336  f7fffffe          BL       PrepareRxDoneAbort
                  |L21.826|
;;;1041                           return;
;;;1042                       }
;;;1043                   }
;;;1044                   else
;;;1045                   {
;;;1046                       multicast = 0;
;;;1047                       nwkSKey = LoRaMacNwkSKey;
;;;1048                       appSKey = LoRaMacAppSKey;
;;;1049                       downLinkCounter = DownLinkCounter;
;;;1050                   }
;;;1051   
;;;1052                   fCtrl.Value = payload[pktHeaderLen++];
;;;1053   
;;;1054   								DEBUG(3,"pktHeaderLen = %d \r\n",pktHeaderLen);
;;;1055   
;;;1056                   sequenceCounter = ( uint16_t )payload[pktHeaderLen++];
;;;1057                   sequenceCounter |= ( uint16_t )payload[pktHeaderLen++] << 8;									
;;;1058   
;;;1059                   appPayloadStartIndex = 8 + fCtrl.Bits.FOptsLen;
;;;1060   								DEBUG(3,"sequenceCounter = %d downLinkCounter = %d appPayloadStartIndex = %d\r\n ", sequenceCounter,downLinkCounter,appPayloadStartIndex);
;;;1061   
;;;1062                   micRx |= payload[size - LORAMAC_MFR_LEN];
;;;1063                   micRx |= ( ( uint32_t )payload[size - LORAMAC_MFR_LEN + 1] << 8 );
;;;1064                   micRx |= ( ( uint32_t )payload[size - LORAMAC_MFR_LEN + 2] << 16 );
;;;1065                   micRx |= ( ( uint32_t )payload[size - LORAMAC_MFR_LEN + 3] << 24 );
;;;1066   
;;;1067   								DEBUG(3,"payload[ %d] = %02x \r\n",size - LORAMAC_MFR_LEN,payload[size - LORAMAC_MFR_LEN]);
;;;1068   								DEBUG(3,"payload[ %d] = %02x \r\n",size - LORAMAC_MFR_LEN + 1,payload[size - LORAMAC_MFR_LEN + 1]);
;;;1069   								DEBUG(3,"payload[ %d] = %02x \r\n",size - LORAMAC_MFR_LEN + 2,payload[size - LORAMAC_MFR_LEN + 2]);
;;;1070   								DEBUG(3,"payload[ %d] = %02x \r\n",size - LORAMAC_MFR_LEN + 3,payload[size - LORAMAC_MFR_LEN + 3]);
;;;1071   								DEBUG(3,"micRx = %d mic = %d\r\n",( uint32_t )micRx, mic);
;;;1072   								DEBUG(3,"size = %d LORAMAC_MFR_LEN = %d size - LORAMAC_MFR_LEN = %d\r\n",size, LORAMAC_MFR_LEN, size - LORAMAC_MFR_LEN);
;;;1073   
;;;1074                   sequenceCounterPrev = ( uint16_t )downLinkCounter;
;;;1075                   sequenceCounterDiff = ( sequenceCounter - sequenceCounterPrev );
;;;1076   
;;;1077   								DEBUG(3,"sequenceCounterPrev = %d sequenceCounter = %d sequenceCounterDiff = %d\r\n",sequenceCounterPrev,sequenceCounter,sequenceCounter - sequenceCounterPrev);
;;;1078   
;;;1079                   if( sequenceCounterDiff < ( 1 << 15 ) ) ///:16位
;;;1080                   {
;;;1081                       downLinkCounter += sequenceCounterDiff; ///++1
;;;1082                       DEBUG(3,"DOWN_LINK = %d downLinkCounter = %d \r\n",DOWN_LINK,downLinkCounter);
;;;1083                       LoRaMacComputeMic( payload, size - LORAMAC_MFR_LEN, nwkSKey, address, DOWN_LINK, downLinkCounter, &mic );///MIC校验: 校验mac+paload----MIC之前数据
;;;1084                       if( micRx == mic )
;;;1085                       {
;;;1086                           isMicOk = true;
;;;1087   												DEBUG(3,"isMicOk mic = %d\r\n",mic);
;;;1088                       }
;;;1089                   }
;;;1090                   else ///32位
;;;1091                   {
;;;1092                       // check for sequence roll-over
;;;1093                       uint32_t  downLinkCounterTmp = downLinkCounter + 0x10000 + ( int16_t )sequenceCounterDiff;
;;;1094                       LoRaMacComputeMic( payload, size - LORAMAC_MFR_LEN, nwkSKey, address, DOWN_LINK, downLinkCounterTmp, &mic );
;;;1095                       if( micRx == mic )
;;;1096                       {
;;;1097                           isMicOk = true;
;;;1098                           downLinkCounter = downLinkCounterTmp;
;;;1099                       }
;;;1100                   }
;;;1101   
;;;1102                   if( isMicOk == true )
;;;1103                   {
;;;1104                       McpsIndication.Status = LORAMAC_EVENT_INFO_STATUS_OK;
;;;1105                       McpsIndication.Multicast = multicast;
;;;1106                       McpsIndication.FramePending = fCtrl.Bits.FPending;
;;;1107                       McpsIndication.Buffer = NULL;
;;;1108                       McpsIndication.BufferSize = 0;
;;;1109                       McpsIndication.DownLinkCounter = downLinkCounter;
;;;1110   
;;;1111                       McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_OK;
;;;1112   
;;;1113                       AdrAckCounter = 0;
;;;1114   
;;;1115                       // Update 32 bits downlink counter
;;;1116                       if( multicast == 1 )
;;;1117                       {
;;;1118                           McpsIndication.McpsIndication = MCPS_MULTICAST;
;;;1119   
;;;1120                           if( ( curMulticastParams->DownLinkCounter == downLinkCounter ) &&
;;;1121                               ( curMulticastParams->DownLinkCounter != 0 ) )
;;;1122                           {
;;;1123                               McpsIndication.Status = LORAMAC_EVENT_INFO_STATUS_DOWNLINK_REPEATED;
;;;1124                               McpsIndication.DownLinkCounter = downLinkCounter;
;;;1125                               PrepareRxDoneAbort( );
;;;1126                               return;
;;;1127                           }
;;;1128                           curMulticastParams->DownLinkCounter = downLinkCounter;
;;;1129                       }
;;;1130                       else
;;;1131                       {
;;;1132                           if( macHdr.Bits.MType == FRAME_TYPE_DATA_CONFIRMED_DOWN )
;;;1133                           {
;;;1134                               SrvAckRequested = true;
;;;1135                               McpsIndication.McpsIndication = MCPS_CONFIRMED;
;;;1136                           }
;;;1137                           else
;;;1138                           {
;;;1139                               SrvAckRequested = false;
;;;1140                               McpsIndication.McpsIndication = MCPS_UNCONFIRMED;
;;;1141                           }
;;;1142                           if( ( DownLinkCounter == downLinkCounter ) &&
;;;1143                               ( DownLinkCounter != 0 ) )
;;;1144                           {
;;;1145                               McpsIndication.Status = LORAMAC_EVENT_INFO_STATUS_DOWNLINK_REPEATED;
;;;1146                               McpsIndication.DownLinkCounter = downLinkCounter;
;;;1147                               PrepareRxDoneAbort( );
;;;1148                               return;
;;;1149                           }
;;;1150                           DownLinkCounter = downLinkCounter;
;;;1151                       }
;;;1152   
;;;1153                       // Check if the frame is an acknowledgement
;;;1154                       if( fCtrl.Bits.Ack == 1 )
;;;1155                       {
;;;1156                           McpsConfirm.AckReceived = true;
;;;1157                           McpsIndication.AckReceived = true;
;;;1158   
;;;1159                           /********************************接收到数据后上报电量************************************/
;;;1160   //                        uint8_t batteryLevel = BAT_LEVEL_NO_MEASURE;
;;;1161   //                        if( ( LoRaMacCallbacks != NULL ) && ( LoRaMacCallbacks->GetBatteryLevel != NULL ) )
;;;1162   //                        {
;;;1163   //                            batteryLevel = LoRaMacCallbacks->GetBatteryLevel( );
;;;1164   //                        }                   
;;;1165   //                        AddMacCommand( MOTE_MAC_DEV_STATUS_ANS, batteryLevel, snr );
;;;1166                           // Stop the AckTimeout timer as no more retransmissions
;;;1167                           // are needed.
;;;1168                           TimerStop( &AckTimeoutTimer );
;;;1169                       }
;;;1170                       else
;;;1171                       {
;;;1172                           McpsConfirm.AckReceived = false;
;;;1173   
;;;1174                           if( AckTimeoutRetriesCounter > AckTimeoutRetries )
;;;1175                           {
;;;1176                               // Stop the AckTimeout timer as no more retransmissions
;;;1177                               // are needed.
;;;1178                               TimerStop( &AckTimeoutTimer );
;;;1179                           }
;;;1180                       }
;;;1181   
;;;1182                       if( fCtrl.Bits.FOptsLen > 0 )
;;;1183                       {
;;;1184                           // Decode Options field MAC commands
;;;1185                           ProcessMacCommands( payload, 8, appPayloadStartIndex, snr );
;;;1186                       }
;;;1187                       if( ( ( size - 4 ) - appPayloadStartIndex ) > 0 )
;;;1188                       {
;;;1189   												DEBUG(2,"appPayloadStartIndex = %d\r\n",( ( size - 4 ) - appPayloadStartIndex ));
;;;1190                           port = payload[appPayloadStartIndex++];
;;;1191                           frameLen = ( size - 4 ) - appPayloadStartIndex;
;;;1192   
;;;1193                           McpsIndication.Port = port;
;;;1194   
;;;1195                           if( port == 0 )
;;;1196                           {
;;;1197                               LoRaMacPayloadDecrypt( payload + appPayloadStartIndex,
;;;1198                                                      frameLen,
;;;1199                                                      nwkSKey,
;;;1200                                                      address,
;;;1201                                                      DOWN_LINK,
;;;1202                                                      downLinkCounter,
;;;1203                                                      LoRaMacRxPayload );
;;;1204   
;;;1205                               // Decode frame payload MAC commands
;;;1206                               ProcessMacCommands( LoRaMacRxPayload, 0, frameLen, snr );
;;;1207                           }
;;;1208                           else
;;;1209                           {
;;;1210                               LoRaMacPayloadDecrypt( payload + appPayloadStartIndex,
;;;1211                                                      frameLen,
;;;1212                                                      appSKey,
;;;1213                                                      address,
;;;1214                                                      DOWN_LINK,
;;;1215                                                      downLinkCounter,
;;;1216                                                      LoRaMacRxPayload );
;;;1217   
;;;1218                               McpsIndication.Buffer = LoRaMacRxPayload;
;;;1219                               McpsIndication.BufferSize = frameLen;
;;;1220                               McpsIndication.RxData = true;                        
;;;1221                           }
;;;1222                       }
;;;1223                       LoRaMacFlags.Bits.McpsInd = 1;
;;;1224                   }
;;;1225                   else
;;;1226                   {
;;;1227                       McpsIndication.Status = LORAMAC_EVENT_INFO_STATUS_MIC_FAIL;
;;;1228   				
;;;1229                       DEBUG(2,"INFO_STATUS_MIC_FAIL mic = %d\r\n",mic);
;;;1230   				//	AddMacCommand( MOTE_MAC_LINK_ADR_ANS, 0x07, snr ); ///做假设如果网关发送ADR_req,节点没上发ADR_ANS则会导致网关不断下发数据，假设成立
;;;1231   					//当MIC正确后，服务器则不再显示终端ANS错误
;;;1232   										PrepareRxDoneAbort( );
;;;1233                       return;
;;;1234                   }
;;;1235               }
;;;1236               break;
;;;1237           case FRAME_TYPE_PROPRIETARY:
;;;1238               {
;;;1239                   memcpy1( LoRaMacRxPayload, &payload[pktHeaderLen], size );
;;;1240   
;;;1241                   McpsIndication.McpsIndication = MCPS_PROPRIETARY;
;;;1242                   McpsIndication.Status = LORAMAC_EVENT_INFO_STATUS_OK;
;;;1243                   McpsIndication.Buffer = LoRaMacRxPayload;
;;;1244                   McpsIndication.BufferSize = size - pktHeaderLen;
;;;1245   
;;;1246                   LoRaMacFlags.Bits.McpsInd = 1;
;;;1247                   break;
;;;1248               }
;;;1249           default:
;;;1250               McpsIndication.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
;;;1251               PrepareRxDoneAbort( );
;;;1252               break;
;;;1253       }
;;;1254   
;;;1255       if( ( RxSlot == 0 ) && ( LoRaMacDeviceClass == CLASS_C ) )
;;;1256       {
;;;1257           OnRxWindow2TimerEvent( );
;;;1258       }
;;;1259       LoRaMacFlags.Bits.MacDone = 1;
;;;1260   
;;;1261       // Trig OnMacCheckTimerEvent call as soon as possible
;;;1262       TimerSetValue( &MacStateCheckTimer, 1000 ); //10ms
;;;1263       TimerStart( &MacStateCheckTimer );
;;;1264   }
00033a  b019              ADD      sp,sp,#0x64
00033c  bdf0              POP      {r4-r7,pc}
                  |L21.830|
00033e  2000              MOVS     r0,#0                 ;1046
000340  9005              STR      r0,[sp,#0x14]         ;1046
000342  482b              LDR      r0,|L21.1008|
000344  9007              STR      r0,[sp,#0x1c]         ;1047
000346  482b              LDR      r0,|L21.1012|
000348  9006              STR      r0,[sp,#0x18]         ;1048
00034a  4846              LDR      r0,|L21.1124|
00034c  6806              LDR      r6,[r0,#0]            ;1049  ; DownLinkCounter
                  |L21.846|
00034e  9811              LDR      r0,[sp,#0x44]         ;1052
000350  1c41              ADDS     r1,r0,#1              ;1052
000352  b2c9              UXTB     r1,r1                 ;1052
000354  9111              STR      r1,[sp,#0x44]         ;1052
000356  5c29              LDRB     r1,[r5,r0]            ;1052
000358  9112              STR      r1,[sp,#0x48]         ;1052
00035a  9811              LDR      r0,[sp,#0x44]         ;1056
00035c  1c41              ADDS     r1,r0,#1              ;1056
00035e  b2c9              UXTB     r1,r1                 ;1056
000360  9111              STR      r1,[sp,#0x44]         ;1056
000362  5c28              LDRB     r0,[r5,r0]            ;1056
000364  900b              STR      r0,[sp,#0x2c]         ;1056
000366  9811              LDR      r0,[sp,#0x44]         ;1057
000368  1c41              ADDS     r1,r0,#1              ;1057
00036a  b2c9              UXTB     r1,r1                 ;1057
00036c  9111              STR      r1,[sp,#0x44]         ;1057
00036e  5c28              LDRB     r0,[r5,r0]            ;1057
000370  0200              LSLS     r0,r0,#8              ;1057
000372  990b              LDR      r1,[sp,#0x2c]         ;1057
000374  4308              ORRS     r0,r0,r1              ;1057
000376  900b              STR      r0,[sp,#0x2c]         ;1057
000378  a810              ADD      r0,sp,#0x40           ;1059
00037a  7a00              LDRB     r0,[r0,#8]            ;1059
00037c  0700              LSLS     r0,r0,#28             ;1059
00037e  0f00              LSRS     r0,r0,#28             ;1059
000380  3008              ADDS     r0,r0,#8              ;1059
000382  900f              STR      r0,[sp,#0x3c]         ;1059
000384  1f20              SUBS     r0,r4,#4              ;1062
000386  5c28              LDRB     r0,[r5,r0]            ;1062
000388  4307              ORRS     r7,r7,r0              ;1062
00038a  1ee0              SUBS     r0,r4,#3              ;1063
00038c  5c28              LDRB     r0,[r5,r0]            ;1063
00038e  0200              LSLS     r0,r0,#8              ;1063
000390  4307              ORRS     r7,r7,r0              ;1063
000392  1ea0              SUBS     r0,r4,#2              ;1064
000394  5c28              LDRB     r0,[r5,r0]            ;1064
000396  0400              LSLS     r0,r0,#16             ;1064
000398  4307              ORRS     r7,r7,r0              ;1064
00039a  1e60              SUBS     r0,r4,#1              ;1065
00039c  5c28              LDRB     r0,[r5,r0]            ;1065
00039e  0600              LSLS     r0,r0,#24             ;1065
0003a0  4307              ORRS     r7,r7,r0              ;1065
0003a2  b2b0              UXTH     r0,r6                 ;1074
0003a4  900a              STR      r0,[sp,#0x28]         ;1074
0003a6  990a              LDR      r1,[sp,#0x28]         ;1075
0003a8  980b              LDR      r0,[sp,#0x2c]         ;1075
0003aa  1a40              SUBS     r0,r0,r1              ;1075
0003ac  b280              UXTH     r0,r0                 ;1075
0003ae  9009              STR      r0,[sp,#0x24]         ;1075
0003b0  2101              MOVS     r1,#1                 ;1079
0003b2  03c9              LSLS     r1,r1,#15             ;1079
0003b4  9809              LDR      r0,[sp,#0x24]         ;1079
0003b6  4288              CMP      r0,r1                 ;1079
0003b8  da56              BGE      |L21.1128|
0003ba  9809              LDR      r0,[sp,#0x24]         ;1081
0003bc  1836              ADDS     r6,r6,r0              ;1081
0003be  a80c              ADD      r0,sp,#0x30           ;1083
0003c0  2101              MOVS     r1,#1                 ;1083
0003c2  9601              STR      r6,[sp,#4]            ;1083
0003c4  9100              STR      r1,[sp,#0]            ;1083
0003c6  9002              STR      r0,[sp,#8]            ;1083
0003c8  1f20              SUBS     r0,r4,#4              ;1083
0003ca  b281              UXTH     r1,r0                 ;1083
0003cc  4628              MOV      r0,r5                 ;1083
0003ce  9b10              LDR      r3,[sp,#0x40]         ;1083
0003d0  9a07              LDR      r2,[sp,#0x1c]         ;1083
0003d2  f7fffffe          BL       LoRaMacComputeMic
0003d6  980c              LDR      r0,[sp,#0x30]         ;1084
0003d8  4287              CMP      r7,r0                 ;1084
0003da  d160              BNE      |L21.1182|
0003dc  2001              MOVS     r0,#1                 ;1086
0003de  9004              STR      r0,[sp,#0x10]         ;1086
0003e0  e05d              B        |L21.1182|
0003e2  0000              DCW      0x0000
                  |L21.996|
                          DCD      __func__
                  |L21.1000|
0003e8  25730d0a          DCB      "%s\r\n",0
0003ec  00      
0003ed  00                DCB      0
0003ee  00                DCB      0
0003ef  00                DCB      0
                  |L21.1008|
                          DCD      LoRaMacNwkSKey
                  |L21.1012|
                          DCD      LoRaMacAppSKey
                  |L21.1016|
                          DCD      McpsConfirm
                  |L21.1020|
                          DCD      McpsIndication
                  |L21.1024|
                          DCD      RxSlot
                  |L21.1028|
                          DCD      LoRaMacDeviceClass
                  |L21.1032|
                          DCD      Radio
                  |L21.1036|
                          DCD      RxWindowTimer2
                  |L21.1040|
                          DCD      LoRaCad
                  |L21.1044|
                          DCD      IsLoRaMacNetworkJoined
                  |L21.1048|
000418  6a6f696e          DCB      "join accept \r\n",0
00041c  20616363
000420  65707420
000424  0d0a00  
000427  00                DCB      0
                  |L21.1064|
                          DCD      LoRaMacRxPayload+0x1
                  |L21.1068|
                          DCD      LoRaMacAppKey
                  |L21.1072|
                          DCD      LoRaMacDevNonce
                  |L21.1076|
                          DCD      LoRaMacNetID
                  |L21.1080|
                          DCD      LoRaMacDevAddr
                  |L21.1084|
                          DCD      Rx1DrOffset
                  |L21.1088|
                          DCD      Rx2Channel
                  |L21.1092|
                          DCD      ReceiveDelay1
                  |L21.1096|
                          DCD      0x412e8480
                  |L21.1100|
                          DCD      ReceiveDelay2
                  |L21.1104|
                          DCD      LoRaMacState
                  |L21.1108|
                          DCD      MlmeConfirm
                  |L21.1112|
                          DCD      ChannelsDefaultDatarate
                  |L21.1116|
                          DCD      ChannelsDatarate
                  |L21.1120|
                          DCD      MulticastChannels
                  |L21.1124|
                          DCD      DownLinkCounter
                  |L21.1128|
000468  2001              MOVS     r0,#1                 ;1093
00046a  0400              LSLS     r0,r0,#16             ;1093
00046c  1831              ADDS     r1,r6,r0              ;1093
00046e  9809              LDR      r0,[sp,#0x24]         ;1093
000470  b200              SXTH     r0,r0                 ;1093
000472  1808              ADDS     r0,r1,r0              ;1093
000474  9003              STR      r0,[sp,#0xc]          ;1093
000476  a90c              ADD      r1,sp,#0x30           ;1094
000478  2201              MOVS     r2,#1                 ;1094
00047a  9803              LDR      r0,[sp,#0xc]          ;1094
00047c  9200              STR      r2,[sp,#0]            ;1094
00047e  9102              STR      r1,[sp,#8]            ;1094
000480  9001              STR      r0,[sp,#4]            ;1094
000482  1f20              SUBS     r0,r4,#4              ;1094
000484  b281              UXTH     r1,r0                 ;1094
000486  4628              MOV      r0,r5                 ;1094
000488  9b10              LDR      r3,[sp,#0x40]         ;1094
00048a  9a07              LDR      r2,[sp,#0x1c]         ;1094
00048c  f7fffffe          BL       LoRaMacComputeMic
000490  980c              LDR      r0,[sp,#0x30]         ;1095
000492  4287              CMP      r7,r0                 ;1095
000494  d102              BNE      |L21.1180|
000496  2001              MOVS     r0,#1                 ;1097
000498  9004              STR      r0,[sp,#0x10]         ;1097
00049a  9e03              LDR      r6,[sp,#0xc]          ;1098
                  |L21.1180|
00049c  bf00              NOP                            ;1100
                  |L21.1182|
00049e  9804              LDR      r0,[sp,#0x10]         ;1102
0004a0  2801              CMP      r0,#1                 ;1102
0004a2  d17d              BNE      |L21.1440|
0004a4  2000              MOVS     r0,#0                 ;1104
0004a6  4984              LDR      r1,|L21.1720|
0004a8  7048              STRB     r0,[r1,#1]            ;1104
0004aa  9805              LDR      r0,[sp,#0x14]         ;1105
0004ac  7088              STRB     r0,[r1,#2]            ;1105
0004ae  a810              ADD      r0,sp,#0x40           ;1106
0004b0  7a00              LDRB     r0,[r0,#8]            ;1106
0004b2  06c0              LSLS     r0,r0,#27             ;1106
0004b4  0fc0              LSRS     r0,r0,#31             ;1106
0004b6  7148              STRB     r0,[r1,#5]            ;1106
0004b8  2000              MOVS     r0,#0                 ;1107
0004ba  6088              STR      r0,[r1,#8]            ;1107  ; McpsIndication
0004bc  7308              STRB     r0,[r1,#0xc]          ;1108
0004be  4608              MOV      r0,r1                 ;1109
0004c0  6146              STR      r6,[r0,#0x14]         ;1109  ; McpsIndication
0004c2  2000              MOVS     r0,#0                 ;1111
0004c4  497d              LDR      r1,|L21.1724|
0004c6  7048              STRB     r0,[r1,#1]            ;1111
0004c8  497d              LDR      r1,|L21.1728|
0004ca  6008              STR      r0,[r1,#0]            ;1113  ; AdrAckCounter
0004cc  9805              LDR      r0,[sp,#0x14]         ;1116
0004ce  2801              CMP      r0,#1                 ;1116
0004d0  d114              BNE      |L21.1276|
0004d2  2002              MOVS     r0,#2                 ;1118
0004d4  4978              LDR      r1,|L21.1720|
0004d6  7008              STRB     r0,[r1,#0]            ;1118
0004d8  9808              LDR      r0,[sp,#0x20]         ;1120
0004da  6a40              LDR      r0,[r0,#0x24]         ;1120
0004dc  42b0              CMP      r0,r6                 ;1120
0004de  d10a              BNE      |L21.1270|
0004e0  9808              LDR      r0,[sp,#0x20]         ;1121
0004e2  6a40              LDR      r0,[r0,#0x24]         ;1121
0004e4  2800              CMP      r0,#0                 ;1121
0004e6  d006              BEQ      |L21.1270|
0004e8  2006              MOVS     r0,#6                 ;1123
0004ea  7048              STRB     r0,[r1,#1]            ;1123
0004ec  4608              MOV      r0,r1                 ;1124
0004ee  6146              STR      r6,[r0,#0x14]         ;1124  ; McpsIndication
0004f0  f7fffffe          BL       PrepareRxDoneAbort
0004f4  e721              B        |L21.826|
                  |L21.1270|
0004f6  9808              LDR      r0,[sp,#0x20]         ;1128
0004f8  6246              STR      r6,[r0,#0x24]         ;1128
0004fa  e021              B        |L21.1344|
                  |L21.1276|
0004fc  a810              ADD      r0,sp,#0x40           ;1132
0004fe  7b00              LDRB     r0,[r0,#0xc]          ;1132
000500  0940              LSRS     r0,r0,#5              ;1132
000502  2805              CMP      r0,#5                 ;1132
000504  d105              BNE      |L21.1298|
000506  2001              MOVS     r0,#1                 ;1134
000508  496e              LDR      r1,|L21.1732|
00050a  7008              STRB     r0,[r1,#0]            ;1134
00050c  496a              LDR      r1,|L21.1720|
00050e  7008              STRB     r0,[r1,#0]            ;1135
000510  e004              B        |L21.1308|
                  |L21.1298|
000512  2000              MOVS     r0,#0                 ;1139
000514  496b              LDR      r1,|L21.1732|
000516  7008              STRB     r0,[r1,#0]            ;1139
000518  4967              LDR      r1,|L21.1720|
00051a  7008              STRB     r0,[r1,#0]            ;1140
                  |L21.1308|
00051c  486a              LDR      r0,|L21.1736|
00051e  6800              LDR      r0,[r0,#0]            ;1142  ; DownLinkCounter
000520  42b0              CMP      r0,r6                 ;1142
000522  d10b              BNE      |L21.1340|
000524  4868              LDR      r0,|L21.1736|
000526  6800              LDR      r0,[r0,#0]            ;1143  ; DownLinkCounter
000528  2800              CMP      r0,#0                 ;1143
00052a  d007              BEQ      |L21.1340|
00052c  2006              MOVS     r0,#6                 ;1145
00052e  4962              LDR      r1,|L21.1720|
000530  7048              STRB     r0,[r1,#1]            ;1145
000532  4608              MOV      r0,r1                 ;1146
000534  6146              STR      r6,[r0,#0x14]         ;1146  ; McpsIndication
000536  f7fffffe          BL       PrepareRxDoneAbort
00053a  e6fe              B        |L21.826|
                  |L21.1340|
00053c  4862              LDR      r0,|L21.1736|
00053e  6006              STR      r6,[r0,#0]            ;1150  ; DownLinkCounter
                  |L21.1344|
000540  a810              ADD      r0,sp,#0x40           ;1154
000542  7a00              LDRB     r0,[r0,#8]            ;1154
000544  0680              LSLS     r0,r0,#26             ;1154
000546  0fc0              LSRS     r0,r0,#31             ;1154
000548  2800              CMP      r0,#0                 ;1154
00054a  d008              BEQ      |L21.1374|
00054c  2001              MOVS     r0,#1                 ;1156
00054e  495b              LDR      r1,|L21.1724|
000550  7108              STRB     r0,[r1,#4]            ;1156
000552  4959              LDR      r1,|L21.1720|
000554  7488              STRB     r0,[r1,#0x12]         ;1157
000556  485d              LDR      r0,|L21.1740|
000558  f7fffffe          BL       TimerStop
00055c  e00b              B        |L21.1398|
                  |L21.1374|
00055e  2000              MOVS     r0,#0                 ;1172
000560  4956              LDR      r1,|L21.1724|
000562  7108              STRB     r0,[r1,#4]            ;1172
000564  485a              LDR      r0,|L21.1744|
000566  7800              LDRB     r0,[r0,#0]            ;1174  ; AckTimeoutRetriesCounter
000568  495a              LDR      r1,|L21.1748|
00056a  7809              LDRB     r1,[r1,#0]            ;1174  ; AckTimeoutRetries
00056c  4288              CMP      r0,r1                 ;1174
00056e  dd02              BLE      |L21.1398|
000570  4856              LDR      r0,|L21.1740|
000572  f7fffffe          BL       TimerStop
                  |L21.1398|
000576  a810              ADD      r0,sp,#0x40           ;1182
000578  7a00              LDRB     r0,[r0,#8]            ;1182
00057a  0700              LSLS     r0,r0,#28             ;1182
00057c  0f00              LSRS     r0,r0,#28             ;1182
00057e  2800              CMP      r0,#0                 ;1182
000580  dd06              BLE      |L21.1424|
000582  9818              LDR      r0,[sp,#0x60]         ;1185
000584  b2c3              UXTB     r3,r0                 ;1185
000586  2108              MOVS     r1,#8                 ;1185
000588  4628              MOV      r0,r5                 ;1185
00058a  9a0f              LDR      r2,[sp,#0x3c]         ;1185
00058c  f7fffffe          BL       ProcessMacCommands
                  |L21.1424|
000590  1f20              SUBS     r0,r4,#4              ;1187
000592  990f              LDR      r1,[sp,#0x3c]         ;1187
000594  1a40              SUBS     r0,r0,r1              ;1187
000596  2800              CMP      r0,#0                 ;1187
000598  dd41              BLE      |L21.1566|
00059a  1f20              SUBS     r0,r4,#4              ;1189
00059c  9a0f              LDR      r2,[sp,#0x3c]         ;1189
00059e  e000              B        |L21.1442|
                  |L21.1440|
0005a0  e045              B        |L21.1582|
                  |L21.1442|
0005a2  1a81              SUBS     r1,r0,r2              ;1189
0005a4  a04c              ADR      r0,|L21.1752|
0005a6  f7fffffe          BL       __2printf
0005aa  980f              LDR      r0,[sp,#0x3c]         ;1190
0005ac  1c41              ADDS     r1,r0,#1              ;1190
0005ae  b2c9              UXTB     r1,r1                 ;1190
0005b0  910f              STR      r1,[sp,#0x3c]         ;1190
0005b2  5c28              LDRB     r0,[r5,r0]            ;1190
0005b4  900e              STR      r0,[sp,#0x38]         ;1190
0005b6  1f20              SUBS     r0,r4,#4              ;1191
0005b8  990f              LDR      r1,[sp,#0x3c]         ;1191
0005ba  1a40              SUBS     r0,r0,r1              ;1191
0005bc  b2c0              UXTB     r0,r0                 ;1191
0005be  900d              STR      r0,[sp,#0x34]         ;1191
0005c0  493d              LDR      r1,|L21.1720|
0005c2  980e              LDR      r0,[sp,#0x38]         ;1193
0005c4  70c8              STRB     r0,[r1,#3]            ;1193
0005c6  980e              LDR      r0,[sp,#0x38]         ;1195
0005c8  2800              CMP      r0,#0                 ;1195
0005ca  d114              BNE      |L21.1526|
0005cc  4849              LDR      r0,|L21.1780|
0005ce  2101              MOVS     r1,#1                 ;1197
0005d0  9601              STR      r6,[sp,#4]            ;1197
0005d2  9100              STR      r1,[sp,#0]            ;1197
0005d4  9002              STR      r0,[sp,#8]            ;1197
0005d6  980f              LDR      r0,[sp,#0x3c]         ;1197
0005d8  1828              ADDS     r0,r5,r0              ;1197
0005da  9003              STR      r0,[sp,#0xc]          ;1197
0005dc  9b10              LDR      r3,[sp,#0x40]         ;1197
0005de  9a07              LDR      r2,[sp,#0x1c]         ;1197
0005e0  990d              LDR      r1,[sp,#0x34]         ;1197
0005e2  f7fffffe          BL       LoRaMacPayloadDecrypt
0005e6  9818              LDR      r0,[sp,#0x60]         ;1206
0005e8  b2c3              UXTB     r3,r0                 ;1206
0005ea  2100              MOVS     r1,#0                 ;1206
0005ec  4841              LDR      r0,|L21.1780|
0005ee  9a0d              LDR      r2,[sp,#0x34]         ;1206
0005f0  f7fffffe          BL       ProcessMacCommands
0005f4  e013              B        |L21.1566|
                  |L21.1526|
0005f6  483f              LDR      r0,|L21.1780|
0005f8  2101              MOVS     r1,#1                 ;1210
0005fa  9601              STR      r6,[sp,#4]            ;1210
0005fc  9100              STR      r1,[sp,#0]            ;1210
0005fe  9002              STR      r0,[sp,#8]            ;1210
000600  980f              LDR      r0,[sp,#0x3c]         ;1210
000602  1828              ADDS     r0,r5,r0              ;1210
000604  9003              STR      r0,[sp,#0xc]          ;1210
000606  9b10              LDR      r3,[sp,#0x40]         ;1210
000608  9a06              LDR      r2,[sp,#0x18]         ;1210
00060a  990d              LDR      r1,[sp,#0x34]         ;1210
00060c  f7fffffe          BL       LoRaMacPayloadDecrypt
000610  4838              LDR      r0,|L21.1780|
000612  4929              LDR      r1,|L21.1720|
000614  6088              STR      r0,[r1,#8]            ;1218  ; McpsIndication
000616  980d              LDR      r0,[sp,#0x34]         ;1219
000618  7308              STRB     r0,[r1,#0xc]          ;1219
00061a  2001              MOVS     r0,#1                 ;1220
00061c  7348              STRB     r0,[r1,#0xd]          ;1220
                  |L21.1566|
00061e  4836              LDR      r0,|L21.1784|
000620  7800              LDRB     r0,[r0,#0]            ;1223  ; LoRaMacFlags
000622  2102              MOVS     r1,#2                 ;1223
000624  4388              BICS     r0,r0,r1              ;1223
000626  1c80              ADDS     r0,r0,#2              ;1223
000628  4933              LDR      r1,|L21.1784|
00062a  7008              STRB     r0,[r1,#0]            ;1223
00062c  e009              B        |L21.1602|
                  |L21.1582|
00062e  2008              MOVS     r0,#8                 ;1227
000630  4921              LDR      r1,|L21.1720|
000632  7048              STRB     r0,[r1,#1]            ;1227
000634  a031              ADR      r0,|L21.1788|
000636  990c              LDR      r1,[sp,#0x30]         ;1229
000638  f7fffffe          BL       __2printf
00063c  f7fffffe          BL       PrepareRxDoneAbort
000640  e67b              B        |L21.826|
                  |L21.1602|
000642  e01d              B        |L21.1664|
                  |L21.1604|
000644  9811              LDR      r0,[sp,#0x44]         ;1239
000646  1829              ADDS     r1,r5,r0              ;1239
000648  4622              MOV      r2,r4                 ;1239
00064a  482a              LDR      r0,|L21.1780|
00064c  f7fffffe          BL       memcpy1
000650  2003              MOVS     r0,#3                 ;1241
000652  4919              LDR      r1,|L21.1720|
000654  7008              STRB     r0,[r1,#0]            ;1241
000656  2000              MOVS     r0,#0                 ;1242
000658  7048              STRB     r0,[r1,#1]            ;1242
00065a  4826              LDR      r0,|L21.1780|
00065c  6088              STR      r0,[r1,#8]            ;1243  ; McpsIndication
00065e  9811              LDR      r0,[sp,#0x44]         ;1244
000660  1a20              SUBS     r0,r4,r0              ;1244
000662  7308              STRB     r0,[r1,#0xc]          ;1244
000664  4824              LDR      r0,|L21.1784|
000666  7800              LDRB     r0,[r0,#0]            ;1246  ; LoRaMacFlags
000668  2102              MOVS     r1,#2                 ;1246
00066a  4388              BICS     r0,r0,r1              ;1246
00066c  1c80              ADDS     r0,r0,#2              ;1246
00066e  4922              LDR      r1,|L21.1784|
000670  7008              STRB     r0,[r1,#0]            ;1246
000672  e005              B        |L21.1664|
                  |L21.1652|
000674  2001              MOVS     r0,#1                 ;1250
000676  4910              LDR      r1,|L21.1720|
000678  7048              STRB     r0,[r1,#1]            ;1250
00067a  f7fffffe          BL       PrepareRxDoneAbort
00067e  bf00              NOP                            ;1252
                  |L21.1664|
000680  bf00              NOP                            ;936
000682  4826              LDR      r0,|L21.1820|
000684  7800              LDRB     r0,[r0,#0]            ;1255  ; RxSlot
000686  2800              CMP      r0,#0                 ;1255
000688  d105              BNE      |L21.1686|
00068a  4825              LDR      r0,|L21.1824|
00068c  7800              LDRB     r0,[r0,#0]            ;1255  ; LoRaMacDeviceClass
00068e  2802              CMP      r0,#2                 ;1255
000690  d101              BNE      |L21.1686|
000692  f7fffffe          BL       OnRxWindow2TimerEvent
                  |L21.1686|
000696  4818              LDR      r0,|L21.1784|
000698  7800              LDRB     r0,[r0,#0]            ;1259  ; LoRaMacFlags
00069a  2108              MOVS     r1,#8                 ;1259
00069c  4388              BICS     r0,r0,r1              ;1259
00069e  3008              ADDS     r0,r0,#8              ;1259
0006a0  4915              LDR      r1,|L21.1784|
0006a2  7008              STRB     r0,[r1,#0]            ;1259
0006a4  217d              MOVS     r1,#0x7d              ;1262
0006a6  00c9              LSLS     r1,r1,#3              ;1262
0006a8  481e              LDR      r0,|L21.1828|
0006aa  f7fffffe          BL       TimerSetValue
0006ae  481d              LDR      r0,|L21.1828|
0006b0  f7fffffe          BL       TimerStart
0006b4  bf00              NOP      
0006b6  e640              B        |L21.826|
;;;1265   
                          ENDP

                  |L21.1720|
                          DCD      McpsIndication
                  |L21.1724|
                          DCD      McpsConfirm
                  |L21.1728|
                          DCD      AdrAckCounter
                  |L21.1732|
                          DCD      SrvAckRequested
                  |L21.1736|
                          DCD      DownLinkCounter
                  |L21.1740|
                          DCD      AckTimeoutTimer
                  |L21.1744|
                          DCD      AckTimeoutRetriesCounter
                  |L21.1748|
                          DCD      AckTimeoutRetries
                  |L21.1752|
0006d8  61707050          DCB      "appPayloadStartIndex = %d\r\n",0
0006dc  61796c6f
0006e0  61645374
0006e4  61727449
0006e8  6e646578
0006ec  203d2025
0006f0  640d0a00
                  |L21.1780|
                          DCD      LoRaMacRxPayload
                  |L21.1784|
                          DCD      LoRaMacFlags
                  |L21.1788|
0006fc  494e464f          DCB      "INFO_STATUS_MIC_FAIL mic = %d\r\n",0
000700  5f535441
000704  5455535f
000708  4d49435f
00070c  4641494c
000710  206d6963
000714  203d2025
000718  640d0a00
                  |L21.1820|
                          DCD      RxSlot
                  |L21.1824|
                          DCD      LoRaMacDeviceClass
                  |L21.1828|
                          DCD      MacStateCheckTimer

                          AREA ||i.OnRadioRxError||, CODE, READONLY, ALIGN=2

                  OnRadioRxError PROC
;;;1282   
;;;1283   static void OnRadioRxError( void )
000000  b510              PUSH     {r4,lr}
;;;1284   {
;;;1285       if( LoRaMacDeviceClass != CLASS_C )
000002  4810              LDR      r0,|L22.68|
000004  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
000006  2802              CMP      r0,#2
000008  d003              BEQ      |L22.18|
;;;1286       {
;;;1287           Radio.Sleep( );
00000a  490f              LDR      r1,|L22.72|
00000c  6ac8              LDR      r0,[r1,#0x2c]  ; Radio
00000e  4780              BLX      r0
000010  e001              B        |L22.22|
                  |L22.18|
;;;1288       }
;;;1289       else
;;;1290       {
;;;1291           OnRxWindow2TimerEvent( );
000012  f7fffffe          BL       OnRxWindow2TimerEvent
                  |L22.22|
;;;1292       }
;;;1293   
;;;1294       if( RxSlot == 1 )
000016  480d              LDR      r0,|L22.76|
000018  7800              LDRB     r0,[r0,#0]  ; RxSlot
00001a  2801              CMP      r0,#1
00001c  d110              BNE      |L22.64|
;;;1295       {
;;;1296           if( NodeAckRequested == true )
00001e  480c              LDR      r0,|L22.80|
000020  7800              LDRB     r0,[r0,#0]  ; NodeAckRequested
000022  2801              CMP      r0,#1
000024  d102              BNE      |L22.44|
;;;1297           {
;;;1298               McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_RX2_ERROR;
000026  2004              MOVS     r0,#4
000028  490a              LDR      r1,|L22.84|
00002a  7048              STRB     r0,[r1,#1]
                  |L22.44|
;;;1299           }
;;;1300           MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_RX2_ERROR;
00002c  2004              MOVS     r0,#4
00002e  490a              LDR      r1,|L22.88|
000030  7048              STRB     r0,[r1,#1]
;;;1301           LoRaMacFlags.Bits.MacDone = 1;
000032  480a              LDR      r0,|L22.92|
000034  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000036  2108              MOVS     r1,#8
000038  4388              BICS     r0,r0,r1
00003a  3008              ADDS     r0,r0,#8
00003c  4907              LDR      r1,|L22.92|
00003e  7008              STRB     r0,[r1,#0]
                  |L22.64|
;;;1302       }
;;;1303   }
000040  bd10              POP      {r4,pc}
;;;1304   
                          ENDP

000042  0000              DCW      0x0000
                  |L22.68|
                          DCD      LoRaMacDeviceClass
                  |L22.72|
                          DCD      Radio
                  |L22.76|
                          DCD      RxSlot
                  |L22.80|
                          DCD      NodeAckRequested
                  |L22.84|
                          DCD      McpsConfirm
                  |L22.88|
                          DCD      MlmeConfirm
                  |L22.92|
                          DCD      LoRaMacFlags

                          AREA ||i.OnRadioRxTimeout||, CODE, READONLY, ALIGN=2

                  OnRadioRxTimeout PROC
;;;1304   
;;;1305   static void OnRadioRxTimeout( void )
000000  b510              PUSH     {r4,lr}
;;;1306   {
;;;1307       if( LoRaMacDeviceClass != CLASS_C )
000002  4810              LDR      r0,|L23.68|
000004  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
000006  2802              CMP      r0,#2
000008  d003              BEQ      |L23.18|
;;;1308       {
;;;1309           Radio.Sleep( );
00000a  490f              LDR      r1,|L23.72|
00000c  6ac8              LDR      r0,[r1,#0x2c]  ; Radio
00000e  4780              BLX      r0
000010  e001              B        |L23.22|
                  |L23.18|
;;;1310       }
;;;1311       else
;;;1312       {
;;;1313           OnRxWindow2TimerEvent( );
000012  f7fffffe          BL       OnRxWindow2TimerEvent
                  |L23.22|
;;;1314       }
;;;1315   
;;;1316       if( RxSlot == 1 )
000016  480d              LDR      r0,|L23.76|
000018  7800              LDRB     r0,[r0,#0]  ; RxSlot
00001a  2801              CMP      r0,#1
00001c  d110              BNE      |L23.64|
;;;1317       {
;;;1318           if( NodeAckRequested == true )
00001e  480c              LDR      r0,|L23.80|
000020  7800              LDRB     r0,[r0,#0]  ; NodeAckRequested
000022  2801              CMP      r0,#1
000024  d102              BNE      |L23.44|
;;;1319           {
;;;1320               McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_RX2_TIMEOUT;
000026  2003              MOVS     r0,#3
000028  490a              LDR      r1,|L23.84|
00002a  7048              STRB     r0,[r1,#1]
                  |L23.44|
;;;1321           }
;;;1322           MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_RX2_TIMEOUT;
00002c  2003              MOVS     r0,#3
00002e  490a              LDR      r1,|L23.88|
000030  7048              STRB     r0,[r1,#1]
;;;1323           LoRaMacFlags.Bits.MacDone = 1;
000032  480a              LDR      r0,|L23.92|
000034  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000036  2108              MOVS     r1,#8
000038  4388              BICS     r0,r0,r1
00003a  3008              ADDS     r0,r0,#8
00003c  4907              LDR      r1,|L23.92|
00003e  7008              STRB     r0,[r1,#0]
                  |L23.64|
;;;1324       }
;;;1325   }
000040  bd10              POP      {r4,pc}
;;;1326   
                          ENDP

000042  0000              DCW      0x0000
                  |L23.68|
                          DCD      LoRaMacDeviceClass
                  |L23.72|
                          DCD      Radio
                  |L23.76|
                          DCD      RxSlot
                  |L23.80|
                          DCD      NodeAckRequested
                  |L23.84|
                          DCD      McpsConfirm
                  |L23.88|
                          DCD      MlmeConfirm
                  |L23.92|
                          DCD      LoRaMacFlags

                          AREA ||i.OnRadioTxDone||, CODE, READONLY, ALIGN=2

                  OnRadioTxDone PROC
;;;794    
;;;795    static void OnRadioTxDone( void )
000000  b5f0              PUSH     {r4-r7,lr}
;;;796    {
000002  b087              SUB      sp,sp,#0x1c
;;;797        TimerTime_t curTime = TimerGetCurrentTime( );
000004  f7fffffe          BL       TimerGetCurrentTime
000008  4605              MOV      r5,r0
00000a  460e              MOV      r6,r1
;;;798        if( LoRaMacDeviceClass != CLASS_C )
00000c  485e              LDR      r0,|L24.392|
00000e  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
000010  2802              CMP      r0,#2
000012  d003              BEQ      |L24.28|
;;;799        {
;;;800            Radio.Sleep( );
000014  495d              LDR      r1,|L24.396|
000016  6ac8              LDR      r0,[r1,#0x2c]  ; Radio
000018  4780              BLX      r0
00001a  e001              B        |L24.32|
                  |L24.28|
;;;801        }
;;;802        else
;;;803        {
;;;804            OnRxWindow2TimerEvent( );
00001c  f7fffffe          BL       OnRxWindow2TimerEvent
                  |L24.32|
;;;805        }
;;;806    
;;;807        // Update Band Time OFF
;;;808        Bands[Channels[Channel].Band].LastTxDoneTime = curTime;
000020  485b              LDR      r0,|L24.400|
000022  7800              LDRB     r0,[r0,#0]  ; Channel
000024  00c0              LSLS     r0,r0,#3
000026  495b              LDR      r1,|L24.404|
000028  1840              ADDS     r0,r0,r1
00002a  7940              LDRB     r0,[r0,#5]
00002c  2118              MOVS     r1,#0x18
00002e  4348              MULS     r0,r1,r0
000030  4959              LDR      r1,|L24.408|
000032  1840              ADDS     r0,r0,r1
000034  60c6              STR      r6,[r0,#0xc]
000036  6085              STR      r5,[r0,#8]
;;;809        if( DutyCycleOn == true )
000038  4858              LDR      r0,|L24.412|
00003a  7800              LDRB     r0,[r0,#0]  ; DutyCycleOn
00003c  2801              CMP      r0,#1
00003e  d126              BNE      |L24.142|
;;;810        {
;;;811            Bands[Channels[Channel].Band].TimeOff = TxTimeOnAir * Bands[Channels[Channel].Band].DCycle - TxTimeOnAir;
000040  4853              LDR      r0,|L24.400|
000042  7800              LDRB     r0,[r0,#0]  ; Channel
000044  00c0              LSLS     r0,r0,#3
000046  4953              LDR      r1,|L24.404|
000048  1840              ADDS     r0,r0,r1
00004a  7940              LDRB     r0,[r0,#5]
00004c  2118              MOVS     r1,#0x18
00004e  4348              MULS     r0,r1,r0
000050  4951              LDR      r1,|L24.408|
000052  5a0c              LDRH     r4,[r1,r0]
000054  2000              MOVS     r0,#0
000056  4a52              LDR      r2,|L24.416|
000058  ca06              LDM      r2,{r1,r2}
00005a  9201              STR      r2,[sp,#4]
00005c  9102              STR      r1,[sp,#8]
00005e  9003              STR      r0,[sp,#0xc]
000060  4620              MOV      r0,r4
000062  9b01              LDR      r3,[sp,#4]
000064  9a02              LDR      r2,[sp,#8]
000066  9903              LDR      r1,[sp,#0xc]
000068  f7fffffe          BL       __aeabi_lmul
00006c  4b4c              LDR      r3,|L24.416|
00006e  cb0c              LDM      r3,{r2,r3}
000070  1a80              SUBS     r0,r0,r2
000072  4199              SBCS     r1,r1,r3
000074  4a46              LDR      r2,|L24.400|
000076  7812              LDRB     r2,[r2,#0]  ; Channel
000078  00d2              LSLS     r2,r2,#3
00007a  4b46              LDR      r3,|L24.404|
00007c  18d2              ADDS     r2,r2,r3
00007e  7952              LDRB     r2,[r2,#5]
000080  2318              MOVS     r3,#0x18
000082  435a              MULS     r2,r3,r2
000084  4b44              LDR      r3,|L24.408|
000086  18d2              ADDS     r2,r2,r3
000088  6151              STR      r1,[r2,#0x14]
00008a  6110              STR      r0,[r2,#0x10]
00008c  e00c              B        |L24.168|
                  |L24.142|
;;;812        }
;;;813        else
;;;814        {
;;;815            Bands[Channels[Channel].Band].TimeOff = 0;
00008e  2100              MOVS     r1,#0
000090  4a3f              LDR      r2,|L24.400|
000092  7812              LDRB     r2,[r2,#0]  ; Channel
000094  00d2              LSLS     r2,r2,#3
000096  4b3f              LDR      r3,|L24.404|
000098  18d2              ADDS     r2,r2,r3
00009a  7952              LDRB     r2,[r2,#5]
00009c  2318              MOVS     r3,#0x18
00009e  435a              MULS     r2,r3,r2
0000a0  4b3d              LDR      r3,|L24.408|
0000a2  18d2              ADDS     r2,r2,r3
0000a4  6111              STR      r1,[r2,#0x10]
0000a6  6151              STR      r1,[r2,#0x14]
                  |L24.168|
;;;816        }
;;;817        // Update Aggregated Time OFF
;;;818        AggregatedLastTxDoneTime = curTime;
0000a8  483e              LDR      r0,|L24.420|
0000aa  c060              STM      r0!,{r5,r6}
;;;819        AggregatedTimeOff = AggregatedTimeOff + ( TxTimeOnAir * AggregatedDCycle - TxTimeOnAir );
0000ac  493c              LDR      r1,|L24.416|
0000ae  c903              LDM      r1,{r0,r1}
0000b0  4a3d              LDR      r2,|L24.424|
0000b2  8817              LDRH     r7,[r2,#0]  ; AggregatedDCycle
0000b4  2200              MOVS     r2,#0
0000b6  9204              STR      r2,[sp,#0x10]
0000b8  9105              STR      r1,[sp,#0x14]
0000ba  9006              STR      r0,[sp,#0x18]
0000bc  463a              MOV      r2,r7
0000be  9b04              LDR      r3,[sp,#0x10]
0000c0  f7fffffe          BL       __aeabi_lmul
0000c4  4b36              LDR      r3,|L24.416|
0000c6  cb0c              LDM      r3,{r2,r3}
0000c8  1a80              SUBS     r0,r0,r2
0000ca  4199              SBCS     r1,r1,r3
0000cc  4b37              LDR      r3,|L24.428|
0000ce  cb0c              LDM      r3,{r2,r3}
0000d0  1880              ADDS     r0,r0,r2
0000d2  4159              ADCS     r1,r1,r3
0000d4  4a35              LDR      r2,|L24.428|
0000d6  c203              STM      r2!,{r0,r1}
;;;820    
;;;821        if( IsRxWindowsEnabled == true )
0000d8  4835              LDR      r0,|L24.432|
0000da  7800              LDRB     r0,[r0,#0]  ; IsRxWindowsEnabled
0000dc  2801              CMP      r0,#1
0000de  d12d              BNE      |L24.316|
;;;822        {
;;;823            TimerSetValue( &RxWindowTimer1, RxWindow1Delay );
0000e0  4834              LDR      r0,|L24.436|
0000e2  6801              LDR      r1,[r0,#0]  ; RxWindow1Delay
0000e4  4834              LDR      r0,|L24.440|
0000e6  f7fffffe          BL       TimerSetValue
;;;824            TimerStart( &RxWindowTimer1 );
0000ea  4833              LDR      r0,|L24.440|
0000ec  f7fffffe          BL       TimerStart
;;;825            
;;;826            if( LoRaMacDeviceClass != CLASS_C )
0000f0  4825              LDR      r0,|L24.392|
0000f2  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
0000f4  2802              CMP      r0,#2
0000f6  d007              BEQ      |L24.264|
;;;827            {
;;;828                TimerSetValue( &RxWindowTimer2, RxWindow2Delay );
0000f8  4830              LDR      r0,|L24.444|
0000fa  6801              LDR      r1,[r0,#0]  ; RxWindow2Delay
0000fc  4830              LDR      r0,|L24.448|
0000fe  f7fffffe          BL       TimerSetValue
;;;829                TimerStart( &RxWindowTimer2 );
000102  482f              LDR      r0,|L24.448|
000104  f7fffffe          BL       TimerStart
                  |L24.264|
;;;830            }
;;;831            if( ( LoRaMacDeviceClass == CLASS_C ) || ( NodeAckRequested == true ) )
000108  481f              LDR      r0,|L24.392|
00010a  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
00010c  2802              CMP      r0,#2
00010e  d003              BEQ      |L24.280|
000110  482c              LDR      r0,|L24.452|
000112  7800              LDRB     r0,[r0,#0]  ; NodeAckRequested
000114  2801              CMP      r0,#1
000116  d129              BNE      |L24.364|
                  |L24.280|
;;;832            {
;;;833                TimerSetValue( &AckTimeoutTimer, RxWindow2Delay + ACK_TIMEOUT +
000118  492b              LDR      r1,|L24.456|
00011a  4248              RSBS     r0,r1,#0
00011c  f7fffffe          BL       randr
000120  4926              LDR      r1,|L24.444|
000122  6809              LDR      r1,[r1,#0]  ; RxWindow2Delay
000124  4a29              LDR      r2,|L24.460|
000126  1889              ADDS     r1,r1,r2
000128  1840              ADDS     r0,r0,r1
00012a  4601              MOV      r1,r0
00012c  9000              STR      r0,[sp,#0]
00012e  4828              LDR      r0,|L24.464|
000130  f7fffffe          BL       TimerSetValue
;;;834                                                 randr( -ACK_TIMEOUT_RND, ACK_TIMEOUT_RND ) );
;;;835                TimerStart( &AckTimeoutTimer );
000134  4826              LDR      r0,|L24.464|
000136  f7fffffe          BL       TimerStart
00013a  e017              B        |L24.364|
                  |L24.316|
;;;836            }
;;;837        }
;;;838        else
;;;839        {
;;;840            McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_OK;
00013c  2000              MOVS     r0,#0
00013e  4925              LDR      r1,|L24.468|
000140  7048              STRB     r0,[r1,#1]
;;;841            MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_RX2_TIMEOUT;
000142  2003              MOVS     r0,#3
000144  4924              LDR      r1,|L24.472|
000146  7048              STRB     r0,[r1,#1]
;;;842    
;;;843            if( LoRaMacFlags.Value == 0 )
000148  4824              LDR      r0,|L24.476|
00014a  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
00014c  2800              CMP      r0,#0
00014e  d106              BNE      |L24.350|
;;;844            {
;;;845                LoRaMacFlags.Bits.McpsReq = 1;
000150  4822              LDR      r0,|L24.476|
000152  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000154  0840              LSRS     r0,r0,#1
000156  0040              LSLS     r0,r0,#1
000158  1c40              ADDS     r0,r0,#1
00015a  4920              LDR      r1,|L24.476|
00015c  7008              STRB     r0,[r1,#0]
                  |L24.350|
;;;846            }
;;;847            LoRaMacFlags.Bits.MacDone = 1;
00015e  481f              LDR      r0,|L24.476|
000160  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000162  2108              MOVS     r1,#8
000164  4388              BICS     r0,r0,r1
000166  3008              ADDS     r0,r0,#8
000168  491c              LDR      r1,|L24.476|
00016a  7008              STRB     r0,[r1,#0]
                  |L24.364|
;;;848        }
;;;849    
;;;850        if( NodeAckRequested == false )
00016c  4815              LDR      r0,|L24.452|
00016e  7800              LDRB     r0,[r0,#0]  ; NodeAckRequested
000170  2800              CMP      r0,#0
000172  d106              BNE      |L24.386|
;;;851        {
;;;852            McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_OK;
000174  4917              LDR      r1,|L24.468|
000176  7048              STRB     r0,[r1,#1]
;;;853            ChannelsNbRepCounter++;
000178  4819              LDR      r0,|L24.480|
00017a  7800              LDRB     r0,[r0,#0]  ; ChannelsNbRepCounter
00017c  1c40              ADDS     r0,r0,#1
00017e  4918              LDR      r1,|L24.480|
000180  7008              STRB     r0,[r1,#0]
                  |L24.386|
;;;854        }
;;;855    }
000182  b007              ADD      sp,sp,#0x1c
000184  bdf0              POP      {r4-r7,pc}
;;;856    
                          ENDP

000186  0000              DCW      0x0000
                  |L24.392|
                          DCD      LoRaMacDeviceClass
                  |L24.396|
                          DCD      Radio
                  |L24.400|
                          DCD      Channel
                  |L24.404|
                          DCD      Channels
                  |L24.408|
                          DCD      Bands
                  |L24.412|
                          DCD      DutyCycleOn
                  |L24.416|
                          DCD      TxTimeOnAir
                  |L24.420|
                          DCD      AggregatedLastTxDoneTime
                  |L24.424|
                          DCD      AggregatedDCycle
                  |L24.428|
                          DCD      AggregatedTimeOff
                  |L24.432|
                          DCD      IsRxWindowsEnabled
                  |L24.436|
                          DCD      RxWindow1Delay
                  |L24.440|
                          DCD      RxWindowTimer1
                  |L24.444|
                          DCD      RxWindow2Delay
                  |L24.448|
                          DCD      RxWindowTimer2
                  |L24.452|
                          DCD      NodeAckRequested
                  |L24.456|
                          DCD      0x000f4240
                  |L24.460|
                          DCD      0x001e8480
                  |L24.464|
                          DCD      AckTimeoutTimer
                  |L24.468|
                          DCD      McpsConfirm
                  |L24.472|
                          DCD      MlmeConfirm
                  |L24.476|
                          DCD      LoRaMacFlags
                  |L24.480|
                          DCD      ChannelsNbRepCounter

                          AREA ||i.OnRadioTxTimeout||, CODE, READONLY, ALIGN=2

                  OnRadioTxTimeout PROC
;;;1265   
;;;1266   static void OnRadioTxTimeout( void )
000000  b510              PUSH     {r4,lr}
;;;1267   {
;;;1268       if( LoRaMacDeviceClass != CLASS_C )
000002  480b              LDR      r0,|L25.48|
000004  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
000006  2802              CMP      r0,#2
000008  d003              BEQ      |L25.18|
;;;1269       {
;;;1270           Radio.Sleep( );
00000a  490a              LDR      r1,|L25.52|
00000c  6ac8              LDR      r0,[r1,#0x2c]  ; Radio
00000e  4780              BLX      r0
000010  e001              B        |L25.22|
                  |L25.18|
;;;1271       }
;;;1272       else
;;;1273       {
;;;1274           OnRxWindow2TimerEvent( );
000012  f7fffffe          BL       OnRxWindow2TimerEvent
                  |L25.22|
;;;1275       }
;;;1276   
;;;1277       McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_TX_TIMEOUT;
000016  2002              MOVS     r0,#2
000018  4907              LDR      r1,|L25.56|
00001a  7048              STRB     r0,[r1,#1]
;;;1278       MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_TX_TIMEOUT;
00001c  4907              LDR      r1,|L25.60|
00001e  7048              STRB     r0,[r1,#1]
;;;1279       LoRaMacFlags.Bits.MacDone = 1;
000020  4807              LDR      r0,|L25.64|
000022  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000024  2108              MOVS     r1,#8
000026  4388              BICS     r0,r0,r1
000028  3008              ADDS     r0,r0,#8
00002a  4905              LDR      r1,|L25.64|
00002c  7008              STRB     r0,[r1,#0]
;;;1280   }
00002e  bd10              POP      {r4,pc}
;;;1281   
                          ENDP

                  |L25.48|
                          DCD      LoRaMacDeviceClass
                  |L25.52|
                          DCD      Radio
                  |L25.56|
                          DCD      McpsConfirm
                  |L25.60|
                          DCD      MlmeConfirm
                  |L25.64|
                          DCD      LoRaMacFlags

                          AREA ||i.OnRxWindow1TimerEvent||, CODE, READONLY, ALIGN=2

                  OnRxWindow1TimerEvent PROC
;;;1517   
;;;1518   void OnRxWindow1TimerEvent( void )
000000  b5f8              PUSH     {r3-r7,lr}
;;;1519   {
;;;1520       uint16_t symbTimeout = 5; // DR_2, DR_1, DR_0
000002  2505              MOVS     r5,#5
;;;1521       int8_t datarate = 0;
000004  2400              MOVS     r4,#0
;;;1522       uint32_t bandwidth = 0; // LoRa 125 kHz
000006  2600              MOVS     r6,#0
;;;1523   
;;;1524       TimerStop( &RxWindowTimer1 );
000008  4814              LDR      r0,|L26.92|
00000a  f7fffffe          BL       TimerStop
;;;1525       RxSlot = 0;
00000e  2000              MOVS     r0,#0
000010  4913              LDR      r1,|L26.96|
000012  7008              STRB     r0,[r1,#0]
;;;1526   
;;;1527       if( LoRaMacDeviceClass == CLASS_C )
000014  4813              LDR      r0,|L26.100|
000016  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
000018  2802              CMP      r0,#2
00001a  d102              BNE      |L26.34|
;;;1528       {
;;;1529           Radio.Standby( );
00001c  4912              LDR      r1,|L26.104|
00001e  6b08              LDR      r0,[r1,#0x30]  ; Radio
000020  4780              BLX      r0
                  |L26.34|
;;;1530       }
;;;1531   
;;;1532   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;1533       datarate = ChannelsDatarate - Rx1DrOffset;
000022  4812              LDR      r0,|L26.108|
000024  7800              LDRB     r0,[r0,#0]  ; ChannelsDatarate
000026  4912              LDR      r1,|L26.112|
000028  7809              LDRB     r1,[r1,#0]  ; Rx1DrOffset
00002a  1a40              SUBS     r0,r0,r1
00002c  b244              SXTB     r4,r0
;;;1534       if( datarate < 0 )
00002e  2c00              CMP      r4,#0
000030  da00              BGE      |L26.52|
;;;1535       {
;;;1536           datarate = DR_0;
000032  2400              MOVS     r4,#0
                  |L26.52|
;;;1537       }
;;;1538   
;;;1539       // For higher datarates, we increase the number of symbols generating a Rx Timeout
;;;1540       if( datarate >= DR_3 )
000034  2c03              CMP      r4,#3
000036  db00              BLT      |L26.58|
;;;1541       { // DR_6, DR_5, DR_4, DR_3
;;;1542           symbTimeout = 8;
000038  2508              MOVS     r5,#8
                  |L26.58|
;;;1543       }
;;;1544       if( datarate == DR_6 )
00003a  2c06              CMP      r4,#6
00003c  d100              BNE      |L26.64|
;;;1545       {// LoRa 250 kHz
;;;1546           bandwidth  = 1;
00003e  2601              MOVS     r6,#1
                  |L26.64|
;;;1547       }
;;;1548   		DEBUG(3,"Channels[Channel] = %d\r\n",Channels[Channel]);
;;;1549       RxWindowSetup( (Channels[Channel].Frequency), datarate, bandwidth, symbTimeout, false );
000040  2000              MOVS     r0,#0
000042  490c              LDR      r1,|L26.116|
000044  9000              STR      r0,[sp,#0]
000046  7809              LDRB     r1,[r1,#0]  ; Channel
000048  00c9              LSLS     r1,r1,#3
00004a  4a0b              LDR      r2,|L26.120|
00004c  5850              LDR      r0,[r2,r1]
00004e  462b              MOV      r3,r5
000050  4632              MOV      r2,r6
000052  4621              MOV      r1,r4
000054  f7fffffe          BL       RxWindowSetup
;;;1550   
;;;1551   #elif ( defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID ) )
;;;1552       datarate = datarateOffsets[ChannelsDatarate][Rx1DrOffset];
;;;1553       if( datarate < 0 )
;;;1554       {
;;;1555           datarate = DR_0;
;;;1556       }
;;;1557       // For higher datarates, we increase the number of symbols generating a Rx Timeout
;;;1558       if( datarate > DR_0 )
;;;1559       { // DR_1, DR_2, DR_3, DR_4, DR_8, DR_9, DR_10, DR_11, DR_12, DR_13
;;;1560           symbTimeout = 8;
;;;1561       }
;;;1562       if( datarate >= DR_4 )
;;;1563       {// LoRa 500 kHz
;;;1564           bandwidth  = 2;
;;;1565       }
;;;1566       RxWindowSetup( 923.3e6 + ( Channel % 8 ) * 600e3, datarate, bandwidth, symbTimeout, false );
;;;1567   #else
;;;1568       #error "Please define a frequency band in the compiler options."
;;;1569   #endif
;;;1570   }
000058  bdf8              POP      {r3-r7,pc}
;;;1571   
                          ENDP

00005a  0000              DCW      0x0000
                  |L26.92|
                          DCD      RxWindowTimer1
                  |L26.96|
                          DCD      RxSlot
                  |L26.100|
                          DCD      LoRaMacDeviceClass
                  |L26.104|
                          DCD      Radio
                  |L26.108|
                          DCD      ChannelsDatarate
                  |L26.112|
                          DCD      Rx1DrOffset
                  |L26.116|
                          DCD      Channel
                  |L26.120|
                          DCD      Channels

                          AREA ||i.OnRxWindow2TimerEvent||, CODE, READONLY, ALIGN=2

                  OnRxWindow2TimerEvent PROC
;;;1571   
;;;1572   void OnRxWindow2TimerEvent( void )
000000  b538              PUSH     {r3-r5,lr}
;;;1573   {
;;;1574       uint16_t symbTimeout = 5; // DR_2, DR_1, DR_0
000002  2405              MOVS     r4,#5
;;;1575       uint32_t bandwidth = 0; // LoRa 125 kHz
000004  2500              MOVS     r5,#0
;;;1576   
;;;1577       TimerStop( &RxWindowTimer2 );
000006  4816              LDR      r0,|L27.96|
000008  f7fffffe          BL       TimerStop
;;;1578       RxSlot = 1;
00000c  2001              MOVS     r0,#1
00000e  4915              LDR      r1,|L27.100|
000010  7008              STRB     r0,[r1,#0]
;;;1579   
;;;1580   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;1581       // For higher datarates, we increase the number of symbols generating a Rx Timeout
;;;1582       if( Rx2Channel.Datarate >= DR_3 )
000012  4815              LDR      r0,|L27.104|
000014  7900              LDRB     r0,[r0,#4]  ; Rx2Channel
000016  2803              CMP      r0,#3
000018  db00              BLT      |L27.28|
;;;1583       { // DR_6, DR_5, DR_4, DR_3
;;;1584           symbTimeout = 8;
00001a  2408              MOVS     r4,#8
                  |L27.28|
;;;1585       }
;;;1586       if( Rx2Channel.Datarate == DR_6 )
00001c  4812              LDR      r0,|L27.104|
00001e  7900              LDRB     r0,[r0,#4]  ; Rx2Channel
000020  2806              CMP      r0,#6
000022  d100              BNE      |L27.38|
;;;1587       {// LoRa 250 kHz
;;;1588           bandwidth  = 1;
000024  2501              MOVS     r5,#1
                  |L27.38|
;;;1589       }
;;;1590   #elif ( defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID ) )
;;;1591       // For higher datarates, we increase the number of symbols generating a Rx Timeout
;;;1592       if( Rx2Channel.Datarate > DR_0 )
;;;1593       { // DR_1, DR_2, DR_3, DR_4, DR_8, DR_9, DR_10, DR_11, DR_12, DR_13
;;;1594           symbTimeout = 8;
;;;1595       }
;;;1596       if( Rx2Channel.Datarate >= DR_4 )
;;;1597       {// LoRa 500 kHz
;;;1598           bandwidth  = 2;
;;;1599       }
;;;1600   #else
;;;1601       #error "Please define a frequency band in the compiler options."
;;;1602   #endif
;;;1603       if( LoRaMacDeviceClass != CLASS_C )
000026  4811              LDR      r0,|L27.108|
000028  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
00002a  2802              CMP      r0,#2
00002c  d00b              BEQ      |L27.70|
;;;1604       {
;;;1605           RxWindowSetup( Rx2Channel.Frequency, Rx2Channel.Datarate, bandwidth, symbTimeout, false );
00002e  2000              MOVS     r0,#0
000030  4a0d              LDR      r2,|L27.104|
000032  9000              STR      r0,[sp,#0]
000034  7912              LDRB     r2,[r2,#4]  ; Rx2Channel
000036  b251              SXTB     r1,r2
000038  4a0b              LDR      r2,|L27.104|
00003a  4623              MOV      r3,r4
00003c  6810              LDR      r0,[r2,#0]  ; Rx2Channel
00003e  462a              MOV      r2,r5
000040  f7fffffe          BL       RxWindowSetup
000044  e00a              B        |L27.92|
                  |L27.70|
;;;1606       }
;;;1607       else
;;;1608       {
;;;1609           RxWindowSetup( Rx2Channel.Frequency, Rx2Channel.Datarate, bandwidth, symbTimeout, true );
000046  2001              MOVS     r0,#1
000048  4a07              LDR      r2,|L27.104|
00004a  9000              STR      r0,[sp,#0]
00004c  7912              LDRB     r2,[r2,#4]  ; Rx2Channel
00004e  b251              SXTB     r1,r2
000050  4a05              LDR      r2,|L27.104|
000052  4623              MOV      r3,r4
000054  6810              LDR      r0,[r2,#0]  ; Rx2Channel
000056  462a              MOV      r2,r5
000058  f7fffffe          BL       RxWindowSetup
                  |L27.92|
;;;1610       }
;;;1611   }
00005c  bd38              POP      {r3-r5,pc}
;;;1612   
                          ENDP

00005e  0000              DCW      0x0000
                  |L27.96|
                          DCD      RxWindowTimer2
                  |L27.100|
                          DCD      RxSlot
                  |L27.104|
                          DCD      Rx2Channel
                  |L27.108|
                          DCD      LoRaMacDeviceClass

                          AREA ||i.OnTxDelayedTimerEvent||, CODE, READONLY, ALIGN=2

                  OnTxDelayedTimerEvent PROC
;;;1492   
;;;1493   static void OnTxDelayedTimerEvent( void )
000000  b50e              PUSH     {r1-r3,lr}
;;;1494   {
;;;1495       LoRaMacHeader_t macHdr;
;;;1496       LoRaMacFrameCtrl_t fCtrl;   
;;;1497       TimerStop( &TxDelayedTimer );
000002  4819              LDR      r0,|L28.104|
000004  f7fffffe          BL       TimerStop
;;;1498       LoRaMacState &= ~MAC_TX_DELAYED;
000008  4818              LDR      r0,|L28.108|
00000a  6800              LDR      r0,[r0,#0]  ; LoRaMacState
00000c  2110              MOVS     r1,#0x10
00000e  4388              BICS     r0,r0,r1
000010  4916              LDR      r1,|L28.108|
000012  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;1499       DEBUG(3,"%s\r\n",__func__);
;;;1500       
;;;1501       if( ( LoRaMacFlags.Bits.MlmeReq == 1 ) && ( MlmeConfirm.MlmeRequest == MLME_JOIN ) )
000014  4816              LDR      r0,|L28.112|
000016  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000018  0740              LSLS     r0,r0,#29
00001a  0fc0              LSRS     r0,r0,#31
00001c  2800              CMP      r0,#0
00001e  d01f              BEQ      |L28.96|
000020  4814              LDR      r0,|L28.116|
000022  7800              LDRB     r0,[r0,#0]  ; MlmeConfirm
000024  2800              CMP      r0,#0
000026  d11b              BNE      |L28.96|
;;;1502       {
;;;1503           macHdr.Value = 0;
000028  2100              MOVS     r1,#0
00002a  9102              STR      r1,[sp,#8]
;;;1504           macHdr.Bits.MType = FRAME_TYPE_JOIN_REQ;
00002c  4668              MOV      r0,sp
00002e  7a00              LDRB     r0,[r0,#8]
000030  21e0              MOVS     r1,#0xe0
000032  4388              BICS     r0,r0,r1
000034  9002              STR      r0,[sp,#8]
;;;1505   
;;;1506           fCtrl.Value = 0;
000036  2100              MOVS     r1,#0
000038  9101              STR      r1,[sp,#4]
;;;1507           fCtrl.Bits.Adr = AdrCtrlOn;
00003a  4668              MOV      r0,sp
00003c  7900              LDRB     r0,[r0,#4]
00003e  2180              MOVS     r1,#0x80
000040  4388              BICS     r0,r0,r1
000042  490d              LDR      r1,|L28.120|
000044  7809              LDRB     r1,[r1,#0]  ; AdrCtrlOn
000046  01c9              LSLS     r1,r1,#7
000048  2280              MOVS     r2,#0x80
00004a  4011              ANDS     r1,r1,r2
00004c  4308              ORRS     r0,r0,r1
00004e  9001              STR      r0,[sp,#4]
;;;1508   
;;;1509           /* In case of a join request retransmission, the stack must prepare
;;;1510            * the frame again, because the network server keeps track of the random
;;;1511            * LoRaMacDevNonce values to prevent reply attacks. */
;;;1512           PrepareFrame( &macHdr, &fCtrl, 0, NULL, 0 );
000050  2000              MOVS     r0,#0
000052  4603              MOV      r3,r0
000054  4602              MOV      r2,r0
000056  a901              ADD      r1,sp,#4
000058  9000              STR      r0,[sp,#0]
00005a  a802              ADD      r0,sp,#8
00005c  f7fffffe          BL       PrepareFrame
                  |L28.96|
;;;1513       }
;;;1514   
;;;1515       ScheduleTx( );
000060  f7fffffe          BL       ScheduleTx
;;;1516   }
000064  bd0e              POP      {r1-r3,pc}
;;;1517   
                          ENDP

000066  0000              DCW      0x0000
                  |L28.104|
                          DCD      TxDelayedTimer
                  |L28.108|
                          DCD      LoRaMacState
                  |L28.112|
                          DCD      LoRaMacFlags
                  |L28.116|
                          DCD      MlmeConfirm
                  |L28.120|
                          DCD      AdrCtrlOn

                          AREA ||i.PrepareFrame||, CODE, READONLY, ALIGN=2

                  PrepareFrame PROC
;;;2477   
;;;2478   LoRaMacStatus_t PrepareFrame( LoRaMacHeader_t *macHdr, LoRaMacFrameCtrl_t *fCtrl, uint8_t fPort, void *fBuffer, uint16_t fBufferSize )
000000  b5ff              PUSH     {r0-r7,lr}
;;;2479   {
000002  b089              SUB      sp,sp,#0x24
000004  460d              MOV      r5,r1
000006  461e              MOV      r6,r3
000008  9f12              LDR      r7,[sp,#0x48]
;;;2480       uint16_t i;
;;;2481       uint8_t pktHeaderLen = 0;
00000a  2400              MOVS     r4,#0
;;;2482       uint32_t mic = 0;
00000c  2000              MOVS     r0,#0
00000e  9007              STR      r0,[sp,#0x1c]
;;;2483       const void* payload = fBuffer;
000010  9606              STR      r6,[sp,#0x18]
;;;2484       uint8_t payloadSize = fBufferSize;
000012  b2f8              UXTB     r0,r7
000014  9005              STR      r0,[sp,#0x14]
;;;2485       uint8_t framePort = fPort;
000016  980b              LDR      r0,[sp,#0x2c]
000018  9004              STR      r0,[sp,#0x10]
;;;2486   
;;;2487       LoRaMacBufferPktLen = 0;
00001a  2000              MOVS     r0,#0
00001c  49e2              LDR      r1,|L29.936|
00001e  8008              STRH     r0,[r1,#0]
;;;2488   
;;;2489       NodeAckRequested = false;
000020  49e2              LDR      r1,|L29.940|
000022  7008              STRB     r0,[r1,#0]
;;;2490   
;;;2491       if( fBuffer == NULL )
000024  2e00              CMP      r6,#0
000026  d100              BNE      |L29.42|
;;;2492       {
;;;2493           fBufferSize = 0;
000028  2700              MOVS     r7,#0
                  |L29.42|
;;;2494       }
;;;2495   
;;;2496       LoRaMacBuffer[pktHeaderLen++] = macHdr->Value;
00002a  9809              LDR      r0,[sp,#0x24]
00002c  7802              LDRB     r2,[r0,#0]
00002e  4620              MOV      r0,r4
000030  1c61              ADDS     r1,r4,#1
000032  b2cc              UXTB     r4,r1
000034  49de              LDR      r1,|L29.944|
000036  540a              STRB     r2,[r1,r0]
;;;2497   
;;;2498       switch( macHdr->Bits.MType )
000038  9809              LDR      r0,[sp,#0x24]
00003a  7800              LDRB     r0,[r0,#0]
00003c  0940              LSRS     r0,r0,#5
00003e  2800              CMP      r0,#0
000040  d006              BEQ      |L29.80|
000042  2802              CMP      r0,#2
000044  d079              BEQ      |L29.314|
000046  2804              CMP      r0,#4
000048  d07a              BEQ      |L29.320|
00004a  2807              CMP      r0,#7
00004c  d177              BNE      |L29.318|
00004e  e198              B        |L29.898|
                  |L29.80|
;;;2499       {
;;;2500           case FRAME_TYPE_JOIN_REQ:
;;;2501               RxWindow1Delay = JoinAcceptDelay1 - RADIO_WAKEUP_TIME;
000050  48d8              LDR      r0,|L29.948|
000052  6800              LDR      r0,[r0,#0]  ; JoinAcceptDelay1
000054  217d              MOVS     r1,#0x7d
000056  00c9              LSLS     r1,r1,#3
000058  1a40              SUBS     r0,r0,r1
00005a  49d7              LDR      r1,|L29.952|
00005c  6008              STR      r0,[r1,#0]  ; RxWindow1Delay
;;;2502               RxWindow2Delay = JoinAcceptDelay2 - RADIO_WAKEUP_TIME;
00005e  48d7              LDR      r0,|L29.956|
000060  6800              LDR      r0,[r0,#0]  ; JoinAcceptDelay2
000062  217d              MOVS     r1,#0x7d
000064  00c9              LSLS     r1,r1,#3
000066  1a40              SUBS     r0,r0,r1
000068  49d5              LDR      r1,|L29.960|
00006a  6008              STR      r0,[r1,#0]  ; RxWindow2Delay
;;;2503   
;;;2504               LoRaMacBufferPktLen = pktHeaderLen;
00006c  48ce              LDR      r0,|L29.936|
00006e  8004              STRH     r4,[r0,#0]
;;;2505   
;;;2506               memcpyr( LoRaMacBuffer + LoRaMacBufferPktLen, LoRaMacAppEui, 8 );
000070  49cf              LDR      r1,|L29.944|
000072  4602              MOV      r2,r0
000074  8812              LDRH     r2,[r2,#0]  ; LoRaMacBufferPktLen
000076  1888              ADDS     r0,r1,r2
000078  2208              MOVS     r2,#8
00007a  49d2              LDR      r1,|L29.964|
00007c  6809              LDR      r1,[r1,#0]  ; LoRaMacAppEui
00007e  f7fffffe          BL       memcpyr
;;;2507               LoRaMacBufferPktLen += 8;
000082  48c9              LDR      r0,|L29.936|
000084  8800              LDRH     r0,[r0,#0]  ; LoRaMacBufferPktLen
000086  3008              ADDS     r0,r0,#8
000088  49c7              LDR      r1,|L29.936|
00008a  8008              STRH     r0,[r1,#0]
;;;2508               memcpyr( LoRaMacBuffer + LoRaMacBufferPktLen, LoRaMacDevEui, 8 );
00008c  49c8              LDR      r1,|L29.944|
00008e  4ac6              LDR      r2,|L29.936|
000090  8812              LDRH     r2,[r2,#0]  ; LoRaMacBufferPktLen
000092  1888              ADDS     r0,r1,r2
000094  2208              MOVS     r2,#8
000096  49cc              LDR      r1,|L29.968|
000098  6809              LDR      r1,[r1,#0]  ; LoRaMacDevEui
00009a  f7fffffe          BL       memcpyr
;;;2509               LoRaMacBufferPktLen += 8;
00009e  48c2              LDR      r0,|L29.936|
0000a0  8800              LDRH     r0,[r0,#0]  ; LoRaMacBufferPktLen
0000a2  3008              ADDS     r0,r0,#8
0000a4  49c0              LDR      r1,|L29.936|
0000a6  8008              STRH     r0,[r1,#0]
;;;2510   
;;;2511               LoRaMacDevNonce = Radio.Random( );
0000a8  49c8              LDR      r1,|L29.972|
0000aa  6948              LDR      r0,[r1,#0x14]  ; Radio
0000ac  4780              BLX      r0
0000ae  49c8              LDR      r1,|L29.976|
0000b0  8008              STRH     r0,[r1,#0]
;;;2512   
;;;2513               LoRaMacBuffer[LoRaMacBufferPktLen++] = LoRaMacDevNonce & 0xFF;
0000b2  4608              MOV      r0,r1
0000b4  7801              LDRB     r1,[r0,#0]  ; LoRaMacDevNonce
0000b6  48bc              LDR      r0,|L29.936|
0000b8  8802              LDRH     r2,[r0,#0]  ; LoRaMacBufferPktLen
0000ba  8800              LDRH     r0,[r0,#0]  ; LoRaMacBufferPktLen
0000bc  1c40              ADDS     r0,r0,#1
0000be  4bba              LDR      r3,|L29.936|
0000c0  8018              STRH     r0,[r3,#0]
0000c2  48bb              LDR      r0,|L29.944|
0000c4  5481              STRB     r1,[r0,r2]
;;;2514               LoRaMacBuffer[LoRaMacBufferPktLen++] = ( LoRaMacDevNonce >> 8 ) & 0xFF;
0000c6  48c2              LDR      r0,|L29.976|
0000c8  8800              LDRH     r0,[r0,#0]  ; LoRaMacDevNonce
0000ca  1200              ASRS     r0,r0,#8
0000cc  4619              MOV      r1,r3
0000ce  880a              LDRH     r2,[r1,#0]  ; LoRaMacBufferPktLen
0000d0  8809              LDRH     r1,[r1,#0]  ; LoRaMacBufferPktLen
0000d2  1c49              ADDS     r1,r1,#1
0000d4  8019              STRH     r1,[r3,#0]
0000d6  49b6              LDR      r1,|L29.944|
0000d8  5488              STRB     r0,[r1,r2]
;;;2515   
;;;2516               LoRaMacJoinComputeMic( LoRaMacBuffer, LoRaMacBufferPktLen & 0xFF, LoRaMacAppKey, &mic );
0000da  4618              MOV      r0,r3
0000dc  7801              LDRB     r1,[r0,#0]  ; LoRaMacBufferPktLen
0000de  ab07              ADD      r3,sp,#0x1c
0000e0  48bc              LDR      r0,|L29.980|
0000e2  6802              LDR      r2,[r0,#0]  ; LoRaMacAppKey
0000e4  48b2              LDR      r0,|L29.944|
0000e6  f7fffffe          BL       LoRaMacJoinComputeMic
;;;2517   
;;;2518               LoRaMacBuffer[LoRaMacBufferPktLen++] = mic & 0xFF;
0000ea  9807              LDR      r0,[sp,#0x1c]
0000ec  b2c1              UXTB     r1,r0
0000ee  48ae              LDR      r0,|L29.936|
0000f0  8802              LDRH     r2,[r0,#0]  ; LoRaMacBufferPktLen
0000f2  8800              LDRH     r0,[r0,#0]  ; LoRaMacBufferPktLen
0000f4  1c40              ADDS     r0,r0,#1
0000f6  4bac              LDR      r3,|L29.936|
0000f8  8018              STRH     r0,[r3,#0]
0000fa  48ad              LDR      r0,|L29.944|
0000fc  5481              STRB     r1,[r0,r2]
;;;2519               LoRaMacBuffer[LoRaMacBufferPktLen++] = ( mic >> 8 ) & 0xFF;
0000fe  9807              LDR      r0,[sp,#0x1c]
000100  0400              LSLS     r0,r0,#16
000102  0e01              LSRS     r1,r0,#24
000104  4618              MOV      r0,r3
000106  8802              LDRH     r2,[r0,#0]  ; LoRaMacBufferPktLen
000108  8800              LDRH     r0,[r0,#0]  ; LoRaMacBufferPktLen
00010a  1c40              ADDS     r0,r0,#1
00010c  8018              STRH     r0,[r3,#0]
00010e  48a8              LDR      r0,|L29.944|
000110  5481              STRB     r1,[r0,r2]
;;;2520               LoRaMacBuffer[LoRaMacBufferPktLen++] = ( mic >> 16 ) & 0xFF;
000112  9807              LDR      r0,[sp,#0x1c]
000114  0200              LSLS     r0,r0,#8
000116  0e01              LSRS     r1,r0,#24
000118  4618              MOV      r0,r3
00011a  8802              LDRH     r2,[r0,#0]  ; LoRaMacBufferPktLen
00011c  8800              LDRH     r0,[r0,#0]  ; LoRaMacBufferPktLen
00011e  1c40              ADDS     r0,r0,#1
000120  8018              STRH     r0,[r3,#0]
000122  48a3              LDR      r0,|L29.944|
000124  5481              STRB     r1,[r0,r2]
;;;2521               LoRaMacBuffer[LoRaMacBufferPktLen++] = ( mic >> 24 ) & 0xFF;
000126  9807              LDR      r0,[sp,#0x1c]
000128  0e00              LSRS     r0,r0,#24
00012a  4619              MOV      r1,r3
00012c  880a              LDRH     r2,[r1,#0]  ; LoRaMacBufferPktLen
00012e  8809              LDRH     r1,[r1,#0]  ; LoRaMacBufferPktLen
000130  1c49              ADDS     r1,r1,#1
000132  8019              STRH     r1,[r3,#0]
000134  499e              LDR      r1,|L29.944|
000136  5488              STRB     r0,[r1,r2]
;;;2522   
;;;2523               break;
000138  e133              B        |L29.930|
                  |L29.314|
00013a  e005              B        |L29.328|
00013c  e000              B        |L29.320|
                  |L29.318|
00013e  e12e              B        |L29.926|
                  |L29.320|
;;;2524           case FRAME_TYPE_DATA_CONFIRMED_UP:
;;;2525               NodeAckRequested = true;
000140  2001              MOVS     r0,#1
000142  499a              LDR      r1,|L29.940|
000144  7008              STRB     r0,[r1,#0]
;;;2526               //Intentional falltrough
;;;2527           case FRAME_TYPE_DATA_UNCONFIRMED_UP:
000146  bf00              NOP      
                  |L29.328|
;;;2528               if( IsLoRaMacNetworkJoined == false )
000148  48a3              LDR      r0,|L29.984|
00014a  7800              LDRB     r0,[r0,#0]  ; IsLoRaMacNetworkJoined
00014c  2800              CMP      r0,#0
00014e  d102              BNE      |L29.342|
;;;2529               {
;;;2530                   return LORAMAC_STATUS_NO_NETWORK_JOINED; // No network has been joined yet
000150  2007              MOVS     r0,#7
                  |L29.338|
;;;2531               }
;;;2532   
;;;2533               fCtrl->Bits.AdrAckReq = AdrNextDr( fCtrl->Bits.Adr, true, &ChannelsDatarate );
;;;2534   
;;;2535               if( ValidatePayloadLength( fBufferSize, ChannelsDatarate, MacCommandsBufferIndex ) == false )
;;;2536               {
;;;2537                   return LORAMAC_STATUS_LENGTH_ERROR;
;;;2538               }
;;;2539   
;;;2540               RxWindow1Delay = ReceiveDelay1 - RADIO_WAKEUP_TIME;
;;;2541               RxWindow2Delay = ReceiveDelay2 - RADIO_WAKEUP_TIME;
;;;2542   
;;;2543               if( SrvAckRequested == true )
;;;2544               {
;;;2545                   SrvAckRequested = false;
;;;2546                   fCtrl->Bits.Ack = 1;
;;;2547               }
;;;2548   
;;;2549               LoRaMacBuffer[pktHeaderLen++] = ( LoRaMacDevAddr ) & 0xFF;
;;;2550               LoRaMacBuffer[pktHeaderLen++] = ( LoRaMacDevAddr >> 8 ) & 0xFF;
;;;2551               LoRaMacBuffer[pktHeaderLen++] = ( LoRaMacDevAddr >> 16 ) & 0xFF;
;;;2552               LoRaMacBuffer[pktHeaderLen++] = ( LoRaMacDevAddr >> 24 ) & 0xFF;
;;;2553   
;;;2554               LoRaMacBuffer[pktHeaderLen++] = fCtrl->Value;
;;;2555   
;;;2556               LoRaMacBuffer[pktHeaderLen++] = UpLinkCounter & 0xFF;
;;;2557               LoRaMacBuffer[pktHeaderLen++] = ( UpLinkCounter >> 8 ) & 0xFF;
;;;2558   
;;;2559               if( ( payload != NULL ) && ( payloadSize > 0 ) )
;;;2560               {
;;;2561                   if( ( MacCommandsBufferIndex <= LORA_MAC_COMMAND_MAX_LENGTH ) && ( MacCommandsInNextTx == true ) )
;;;2562                   {
;;;2563                       fCtrl->Bits.FOptsLen += MacCommandsBufferIndex;
;;;2564   
;;;2565                       // Update FCtrl field with new value of OptionsLength
;;;2566                       LoRaMacBuffer[0x05] = fCtrl->Value;
;;;2567                       for( i = 0; i < MacCommandsBufferIndex; i++ )
;;;2568                       {
;;;2569                           LoRaMacBuffer[pktHeaderLen++] = MacCommandsBuffer[i];
;;;2570                       }
;;;2571                   }
;;;2572               }
;;;2573               else
;;;2574               {
;;;2575                   if( ( MacCommandsBufferIndex > 0 ) && ( MacCommandsInNextTx ) )
;;;2576                   {
;;;2577                       payloadSize = MacCommandsBufferIndex;
;;;2578                       payload = MacCommandsBuffer;
;;;2579                       framePort = 0;
;;;2580                   }
;;;2581               }
;;;2582               MacCommandsInNextTx = false;
;;;2583               MacCommandsBufferIndex = 0;
;;;2584   
;;;2585               if( ( payload != NULL ) && ( payloadSize > 0 ) )
;;;2586               {
;;;2587                   LoRaMacBuffer[pktHeaderLen++] = framePort;
;;;2588   
;;;2589                   if( framePort == 0 )
;;;2590                   {
;;;2591                       LoRaMacPayloadEncrypt( (uint8_t* ) payload, payloadSize, LoRaMacNwkSKey, LoRaMacDevAddr, UP_LINK, UpLinkCounter, LoRaMacPayload );
;;;2592                   }
;;;2593                   else
;;;2594                   {
;;;2595                       LoRaMacPayloadEncrypt( (uint8_t* ) payload, payloadSize, LoRaMacAppSKey, LoRaMacDevAddr, UP_LINK, UpLinkCounter, LoRaMacPayload );
;;;2596                   }
;;;2597                   memcpy1( LoRaMacBuffer + pktHeaderLen, LoRaMacPayload, payloadSize );
;;;2598               }
;;;2599               LoRaMacBufferPktLen = pktHeaderLen + payloadSize;
;;;2600   
;;;2601               LoRaMacComputeMic( LoRaMacBuffer, LoRaMacBufferPktLen, LoRaMacNwkSKey, LoRaMacDevAddr, UP_LINK, UpLinkCounter, &mic );
;;;2602   
;;;2603               LoRaMacBuffer[LoRaMacBufferPktLen + 0] = mic & 0xFF;
;;;2604               LoRaMacBuffer[LoRaMacBufferPktLen + 1] = ( mic >> 8 ) & 0xFF;
;;;2605               LoRaMacBuffer[LoRaMacBufferPktLen + 2] = ( mic >> 16 ) & 0xFF;
;;;2606               LoRaMacBuffer[LoRaMacBufferPktLen + 3] = ( mic >> 24 ) & 0xFF;
;;;2607   
;;;2608               LoRaMacBufferPktLen += LORAMAC_MFR_LEN;
;;;2609   
;;;2610               break;
;;;2611           case FRAME_TYPE_PROPRIETARY:
;;;2612               if( ( fBuffer != NULL ) && ( fBufferSize > 0 ) )
;;;2613               {
;;;2614                   memcpy1( LoRaMacBuffer + pktHeaderLen, ( uint8_t* ) fBuffer, fBufferSize );
;;;2615                   LoRaMacBufferPktLen = pktHeaderLen + fBufferSize;
;;;2616               }
;;;2617               break;
;;;2618           default:
;;;2619               return LORAMAC_STATUS_SERVICE_UNKNOWN;
;;;2620       }
;;;2621   
;;;2622       return LORAMAC_STATUS_OK;
;;;2623   }
000152  b00d              ADD      sp,sp,#0x34
000154  bdf0              POP      {r4-r7,pc}
                  |L29.342|
000156  7829              LDRB     r1,[r5,#0]            ;2533
000158  09c8              LSRS     r0,r1,#7              ;2533
00015a  4aa0              LDR      r2,|L29.988|
00015c  2101              MOVS     r1,#1                 ;2533
00015e  f7fffffe          BL       AdrNextDr
000162  0180              LSLS     r0,r0,#6              ;2533
000164  2140              MOVS     r1,#0x40              ;2533
000166  4008              ANDS     r0,r0,r1              ;2533
000168  9003              STR      r0,[sp,#0xc]          ;2533
00016a  7828              LDRB     r0,[r5,#0]            ;2533
00016c  4388              BICS     r0,r0,r1              ;2533
00016e  9903              LDR      r1,[sp,#0xc]          ;2533
000170  4308              ORRS     r0,r0,r1              ;2533
000172  7028              STRB     r0,[r5,#0]            ;2533
000174  b2f8              UXTB     r0,r7                 ;2535
000176  499a              LDR      r1,|L29.992|
000178  780a              LDRB     r2,[r1,#0]            ;2535  ; MacCommandsBufferIndex
00017a  4b98              LDR      r3,|L29.988|
00017c  2100              MOVS     r1,#0                 ;2535
00017e  5659              LDRSB    r1,[r3,r1]            ;2535  ; ChannelsDatarate
000180  f7fffffe          BL       ValidatePayloadLength
000184  2800              CMP      r0,#0                 ;2535
000186  d101              BNE      |L29.396|
000188  2008              MOVS     r0,#8                 ;2537
00018a  e7e2              B        |L29.338|
                  |L29.396|
00018c  4895              LDR      r0,|L29.996|
00018e  6800              LDR      r0,[r0,#0]            ;2540  ; ReceiveDelay1
000190  217d              MOVS     r1,#0x7d              ;2540
000192  00c9              LSLS     r1,r1,#3              ;2540
000194  1a40              SUBS     r0,r0,r1              ;2540
000196  4988              LDR      r1,|L29.952|
000198  6008              STR      r0,[r1,#0]            ;2540  ; RxWindow1Delay
00019a  4893              LDR      r0,|L29.1000|
00019c  6800              LDR      r0,[r0,#0]            ;2541  ; ReceiveDelay2
00019e  217d              MOVS     r1,#0x7d              ;2541
0001a0  00c9              LSLS     r1,r1,#3              ;2541
0001a2  1a40              SUBS     r0,r0,r1              ;2541
0001a4  4986              LDR      r1,|L29.960|
0001a6  6008              STR      r0,[r1,#0]            ;2541  ; RxWindow2Delay
0001a8  4890              LDR      r0,|L29.1004|
0001aa  7800              LDRB     r0,[r0,#0]            ;2543  ; SrvAckRequested
0001ac  2801              CMP      r0,#1                 ;2543
0001ae  d107              BNE      |L29.448|
0001b0  2000              MOVS     r0,#0                 ;2545
0001b2  498e              LDR      r1,|L29.1004|
0001b4  7008              STRB     r0,[r1,#0]            ;2545
0001b6  7828              LDRB     r0,[r5,#0]            ;2546
0001b8  2120              MOVS     r1,#0x20              ;2546
0001ba  4388              BICS     r0,r0,r1              ;2546
0001bc  3020              ADDS     r0,r0,#0x20           ;2546
0001be  7028              STRB     r0,[r5,#0]            ;2546
                  |L29.448|
0001c0  488b              LDR      r0,|L29.1008|
0001c2  7802              LDRB     r2,[r0,#0]            ;2549  ; LoRaMacDevAddr
0001c4  4620              MOV      r0,r4                 ;2549
0001c6  1c61              ADDS     r1,r4,#1              ;2549
0001c8  b2cc              UXTB     r4,r1                 ;2549
0001ca  4979              LDR      r1,|L29.944|
0001cc  540a              STRB     r2,[r1,r0]            ;2549
0001ce  4888              LDR      r0,|L29.1008|
0001d0  8800              LDRH     r0,[r0,#0]            ;2550  ; LoRaMacDevAddr
0001d2  0400              LSLS     r0,r0,#16             ;2550
0001d4  0e02              LSRS     r2,r0,#24             ;2550
0001d6  4620              MOV      r0,r4                 ;2550
0001d8  1c61              ADDS     r1,r4,#1              ;2550
0001da  b2cc              UXTB     r4,r1                 ;2550
0001dc  4974              LDR      r1,|L29.944|
0001de  540a              STRB     r2,[r1,r0]            ;2550
0001e0  4883              LDR      r0,|L29.1008|
0001e2  6800              LDR      r0,[r0,#0]            ;2551  ; LoRaMacDevAddr
0001e4  0200              LSLS     r0,r0,#8              ;2551
0001e6  0e02              LSRS     r2,r0,#24             ;2551
0001e8  4620              MOV      r0,r4                 ;2551
0001ea  1c61              ADDS     r1,r4,#1              ;2551
0001ec  b2cc              UXTB     r4,r1                 ;2551
0001ee  4970              LDR      r1,|L29.944|
0001f0  540a              STRB     r2,[r1,r0]            ;2551
0001f2  487f              LDR      r0,|L29.1008|
0001f4  6800              LDR      r0,[r0,#0]            ;2552  ; LoRaMacDevAddr
0001f6  0e00              LSRS     r0,r0,#24             ;2552
0001f8  4621              MOV      r1,r4                 ;2552
0001fa  1c62              ADDS     r2,r4,#1              ;2552
0001fc  b2d4              UXTB     r4,r2                 ;2552
0001fe  4a6c              LDR      r2,|L29.944|
000200  5450              STRB     r0,[r2,r1]            ;2552
000202  782a              LDRB     r2,[r5,#0]            ;2554
000204  4620              MOV      r0,r4                 ;2554
000206  1c61              ADDS     r1,r4,#1              ;2554
000208  b2cc              UXTB     r4,r1                 ;2554
00020a  4969              LDR      r1,|L29.944|
00020c  540a              STRB     r2,[r1,r0]            ;2554
00020e  4879              LDR      r0,|L29.1012|
000210  7802              LDRB     r2,[r0,#0]            ;2556  ; UpLinkCounter
000212  4620              MOV      r0,r4                 ;2556
000214  1c61              ADDS     r1,r4,#1              ;2556
000216  b2cc              UXTB     r4,r1                 ;2556
000218  4965              LDR      r1,|L29.944|
00021a  540a              STRB     r2,[r1,r0]            ;2556
00021c  4875              LDR      r0,|L29.1012|
00021e  8800              LDRH     r0,[r0,#0]            ;2557  ; UpLinkCounter
000220  0400              LSLS     r0,r0,#16             ;2557
000222  0e02              LSRS     r2,r0,#24             ;2557
000224  4620              MOV      r0,r4                 ;2557
000226  1c61              ADDS     r1,r4,#1              ;2557
000228  b2cc              UXTB     r4,r1                 ;2557
00022a  4961              LDR      r1,|L29.944|
00022c  540a              STRB     r2,[r1,r0]            ;2557
00022e  9806              LDR      r0,[sp,#0x18]         ;2559
000230  2800              CMP      r0,#0                 ;2559
000232  d02d              BEQ      |L29.656|
000234  9805              LDR      r0,[sp,#0x14]         ;2559
000236  2800              CMP      r0,#0                 ;2559
000238  dd2a              BLE      |L29.656|
00023a  4869              LDR      r0,|L29.992|
00023c  7800              LDRB     r0,[r0,#0]            ;2561  ; MacCommandsBufferIndex
00023e  280f              CMP      r0,#0xf               ;2561
000240  dc35              BGT      |L29.686|
000242  486d              LDR      r0,|L29.1016|
000244  7800              LDRB     r0,[r0,#0]            ;2561  ; MacCommandsInNextTx
000246  2801              CMP      r0,#1                 ;2561
000248  d131              BNE      |L29.686|
00024a  7828              LDRB     r0,[r5,#0]            ;2563
00024c  0900              LSRS     r0,r0,#4              ;2563
00024e  0100              LSLS     r0,r0,#4              ;2563
000250  7829              LDRB     r1,[r5,#0]            ;2563
000252  4a63              LDR      r2,|L29.992|
000254  7812              LDRB     r2,[r2,#0]            ;2563  ; MacCommandsBufferIndex
000256  1889              ADDS     r1,r1,r2              ;2563
000258  0709              LSLS     r1,r1,#28             ;2563
00025a  0f09              LSRS     r1,r1,#28             ;2563
00025c  4308              ORRS     r0,r0,r1              ;2563
00025e  7028              STRB     r0,[r5,#0]            ;2563
000260  7828              LDRB     r0,[r5,#0]            ;2566
000262  4953              LDR      r1,|L29.944|
000264  7148              STRB     r0,[r1,#5]            ;2566
000266  2000              MOVS     r0,#0                 ;2567
000268  9008              STR      r0,[sp,#0x20]         ;2567
00026a  e00b              B        |L29.644|
                  |L29.620|
00026c  4963              LDR      r1,|L29.1020|
00026e  9808              LDR      r0,[sp,#0x20]         ;2569
000270  5c0a              LDRB     r2,[r1,r0]            ;2569
000272  4620              MOV      r0,r4                 ;2569
000274  1c61              ADDS     r1,r4,#1              ;2569
000276  b2cc              UXTB     r4,r1                 ;2569
000278  494d              LDR      r1,|L29.944|
00027a  540a              STRB     r2,[r1,r0]            ;2569
00027c  9808              LDR      r0,[sp,#0x20]         ;2567
00027e  1c40              ADDS     r0,r0,#1              ;2567
000280  b280              UXTH     r0,r0                 ;2567
000282  9008              STR      r0,[sp,#0x20]         ;2567
                  |L29.644|
000284  4956              LDR      r1,|L29.992|
000286  7809              LDRB     r1,[r1,#0]            ;2567  ; MacCommandsBufferIndex
000288  9808              LDR      r0,[sp,#0x20]         ;2567
00028a  4288              CMP      r0,r1                 ;2567
00028c  dbee              BLT      |L29.620|
00028e  e00e              B        |L29.686|
                  |L29.656|
000290  4853              LDR      r0,|L29.992|
000292  7800              LDRB     r0,[r0,#0]            ;2575  ; MacCommandsBufferIndex
000294  2800              CMP      r0,#0                 ;2575
000296  dd0a              BLE      |L29.686|
000298  4857              LDR      r0,|L29.1016|
00029a  7800              LDRB     r0,[r0,#0]            ;2575  ; MacCommandsInNextTx
00029c  2800              CMP      r0,#0                 ;2575
00029e  d006              BEQ      |L29.686|
0002a0  484f              LDR      r0,|L29.992|
0002a2  7800              LDRB     r0,[r0,#0]            ;2577  ; MacCommandsBufferIndex
0002a4  9005              STR      r0,[sp,#0x14]         ;2577
0002a6  4855              LDR      r0,|L29.1020|
0002a8  9006              STR      r0,[sp,#0x18]         ;2578
0002aa  2000              MOVS     r0,#0                 ;2579
0002ac  9004              STR      r0,[sp,#0x10]         ;2579
                  |L29.686|
0002ae  2000              MOVS     r0,#0                 ;2582
0002b0  4951              LDR      r1,|L29.1016|
0002b2  7008              STRB     r0,[r1,#0]            ;2582
0002b4  494a              LDR      r1,|L29.992|
0002b6  7008              STRB     r0,[r1,#0]            ;2583
0002b8  9806              LDR      r0,[sp,#0x18]         ;2585
0002ba  2800              CMP      r0,#0                 ;2585
0002bc  d02e              BEQ      |L29.796|
0002be  9805              LDR      r0,[sp,#0x14]         ;2585
0002c0  2800              CMP      r0,#0                 ;2585
0002c2  dd2b              BLE      |L29.796|
0002c4  4621              MOV      r1,r4                 ;2587
0002c6  1c62              ADDS     r2,r4,#1              ;2587
0002c8  b2d4              UXTB     r4,r2                 ;2587
0002ca  4a39              LDR      r2,|L29.944|
0002cc  9804              LDR      r0,[sp,#0x10]         ;2587
0002ce  5450              STRB     r0,[r2,r1]            ;2587
0002d0  9804              LDR      r0,[sp,#0x10]         ;2589
0002d2  2800              CMP      r0,#0                 ;2589
0002d4  d10e              BNE      |L29.756|
0002d6  484a              LDR      r0,|L29.1024|
0002d8  4946              LDR      r1,|L29.1012|
0002da  6809              LDR      r1,[r1,#0]            ;2591  ; UpLinkCounter
0002dc  2200              MOVS     r2,#0                 ;2591
0002de  9200              STR      r2,[sp,#0]            ;2591
0002e0  9101              STR      r1,[sp,#4]            ;2591
0002e2  9002              STR      r0,[sp,#8]            ;2591
0002e4  4842              LDR      r0,|L29.1008|
0002e6  4a47              LDR      r2,|L29.1028|
0002e8  6803              LDR      r3,[r0,#0]            ;2591  ; LoRaMacDevAddr
0002ea  9905              LDR      r1,[sp,#0x14]         ;2591
0002ec  9806              LDR      r0,[sp,#0x18]         ;2591
0002ee  f7fffffe          BL       LoRaMacPayloadEncrypt
0002f2  e00d              B        |L29.784|
                  |L29.756|
0002f4  4842              LDR      r0,|L29.1024|
0002f6  493f              LDR      r1,|L29.1012|
0002f8  6809              LDR      r1,[r1,#0]            ;2595  ; UpLinkCounter
0002fa  2200              MOVS     r2,#0                 ;2595
0002fc  9200              STR      r2,[sp,#0]            ;2595
0002fe  9101              STR      r1,[sp,#4]            ;2595
000300  9002              STR      r0,[sp,#8]            ;2595
000302  483b              LDR      r0,|L29.1008|
000304  4a40              LDR      r2,|L29.1032|
000306  6803              LDR      r3,[r0,#0]            ;2595  ; LoRaMacDevAddr
000308  9905              LDR      r1,[sp,#0x14]         ;2595
00030a  9806              LDR      r0,[sp,#0x18]         ;2595
00030c  f7fffffe          BL       LoRaMacPayloadEncrypt
                  |L29.784|
000310  4927              LDR      r1,|L29.944|
000312  1908              ADDS     r0,r1,r4              ;2597
000314  493a              LDR      r1,|L29.1024|
000316  9a05              LDR      r2,[sp,#0x14]         ;2597
000318  f7fffffe          BL       memcpy1
                  |L29.796|
00031c  9805              LDR      r0,[sp,#0x14]         ;2599
00031e  1820              ADDS     r0,r4,r0              ;2599
000320  4921              LDR      r1,|L29.936|
000322  8008              STRH     r0,[r1,#0]            ;2599
000324  a807              ADD      r0,sp,#0x1c           ;2601
000326  4933              LDR      r1,|L29.1012|
000328  6809              LDR      r1,[r1,#0]            ;2601  ; UpLinkCounter
00032a  2200              MOVS     r2,#0                 ;2601
00032c  9200              STR      r2,[sp,#0]            ;2601
00032e  9101              STR      r1,[sp,#4]            ;2601
000330  9002              STR      r0,[sp,#8]            ;2601
000332  482f              LDR      r0,|L29.1008|
000334  4a33              LDR      r2,|L29.1028|
000336  6803              LDR      r3,[r0,#0]            ;2601  ; LoRaMacDevAddr
000338  481b              LDR      r0,|L29.936|
00033a  8801              LDRH     r1,[r0,#0]            ;2601  ; LoRaMacBufferPktLen
00033c  481c              LDR      r0,|L29.944|
00033e  f7fffffe          BL       LoRaMacComputeMic
000342  9807              LDR      r0,[sp,#0x1c]         ;2603
000344  b2c1              UXTB     r1,r0                 ;2603
000346  4a1a              LDR      r2,|L29.944|
000348  4817              LDR      r0,|L29.936|
00034a  8800              LDRH     r0,[r0,#0]            ;2603  ; LoRaMacBufferPktLen
00034c  5411              STRB     r1,[r2,r0]            ;2603
00034e  9807              LDR      r0,[sp,#0x1c]         ;2604
000350  0400              LSLS     r0,r0,#16             ;2604
000352  0e01              LSRS     r1,r0,#24             ;2604
000354  4814              LDR      r0,|L29.936|
000356  8800              LDRH     r0,[r0,#0]            ;2604  ; LoRaMacBufferPktLen
000358  1c40              ADDS     r0,r0,#1              ;2604
00035a  5411              STRB     r1,[r2,r0]            ;2604
00035c  9807              LDR      r0,[sp,#0x1c]         ;2605
00035e  0200              LSLS     r0,r0,#8              ;2605
000360  0e01              LSRS     r1,r0,#24             ;2605
000362  4811              LDR      r0,|L29.936|
000364  8800              LDRH     r0,[r0,#0]            ;2605  ; LoRaMacBufferPktLen
000366  1c80              ADDS     r0,r0,#2              ;2605
000368  5411              STRB     r1,[r2,r0]            ;2605
00036a  9807              LDR      r0,[sp,#0x1c]         ;2606
00036c  0e00              LSRS     r0,r0,#24             ;2606
00036e  490e              LDR      r1,|L29.936|
000370  8809              LDRH     r1,[r1,#0]            ;2606  ; LoRaMacBufferPktLen
000372  1cc9              ADDS     r1,r1,#3              ;2606
000374  5450              STRB     r0,[r2,r1]            ;2606
000376  480c              LDR      r0,|L29.936|
000378  8800              LDRH     r0,[r0,#0]            ;2608  ; LoRaMacBufferPktLen
00037a  1d00              ADDS     r0,r0,#4              ;2608
00037c  490a              LDR      r1,|L29.936|
00037e  8008              STRH     r0,[r1,#0]            ;2608
000380  e00f              B        |L29.930|
                  |L29.898|
000382  2e00              CMP      r6,#0                 ;2612
000384  d00a              BEQ      |L29.924|
000386  2f00              CMP      r7,#0                 ;2612
000388  dd08              BLE      |L29.924|
00038a  4909              LDR      r1,|L29.944|
00038c  1908              ADDS     r0,r1,r4              ;2614
00038e  463a              MOV      r2,r7                 ;2614
000390  4631              MOV      r1,r6                 ;2614
000392  f7fffffe          BL       memcpy1
000396  19e0              ADDS     r0,r4,r7              ;2615
000398  4903              LDR      r1,|L29.936|
00039a  8008              STRH     r0,[r1,#0]            ;2615
                  |L29.924|
00039c  e001              B        |L29.930|
                  |L29.926|
00039e  2002              MOVS     r0,#2                 ;2619
0003a0  e6d7              B        |L29.338|
                  |L29.930|
0003a2  bf00              NOP                            ;2523
0003a4  2000              MOVS     r0,#0                 ;2622
0003a6  e6d4              B        |L29.338|
;;;2624   
                          ENDP

                  |L29.936|
                          DCD      LoRaMacBufferPktLen
                  |L29.940|
                          DCD      NodeAckRequested
                  |L29.944|
                          DCD      LoRaMacBuffer
                  |L29.948|
                          DCD      JoinAcceptDelay1
                  |L29.952|
                          DCD      RxWindow1Delay
                  |L29.956|
                          DCD      JoinAcceptDelay2
                  |L29.960|
                          DCD      RxWindow2Delay
                  |L29.964|
                          DCD      LoRaMacAppEui
                  |L29.968|
                          DCD      LoRaMacDevEui
                  |L29.972|
                          DCD      Radio
                  |L29.976|
                          DCD      LoRaMacDevNonce
                  |L29.980|
                          DCD      LoRaMacAppKey
                  |L29.984|
                          DCD      IsLoRaMacNetworkJoined
                  |L29.988|
                          DCD      ChannelsDatarate
                  |L29.992|
                          DCD      MacCommandsBufferIndex
                  |L29.996|
                          DCD      ReceiveDelay1
                  |L29.1000|
                          DCD      ReceiveDelay2
                  |L29.1004|
                          DCD      SrvAckRequested
                  |L29.1008|
                          DCD      LoRaMacDevAddr
                  |L29.1012|
                          DCD      UpLinkCounter
                  |L29.1016|
                          DCD      MacCommandsInNextTx
                  |L29.1020|
                          DCD      MacCommandsBuffer
                  |L29.1024|
                          DCD      LoRaMacPayload
                  |L29.1028|
                          DCD      LoRaMacNwkSKey
                  |L29.1032|
                          DCD      LoRaMacAppSKey

                          AREA ||i.PrepareRxDoneAbort||, CODE, READONLY, ALIGN=2

                  PrepareRxDoneAbort PROC
;;;856    
;;;857    static void PrepareRxDoneAbort( void )
000000  b510              PUSH     {r4,lr}
;;;858    {
;;;859        LoRaMacState &= ~MAC_TX_RUNNING;
000002  4816              LDR      r0,|L30.92|
000004  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000006  0840              LSRS     r0,r0,#1
000008  0040              LSLS     r0,r0,#1
00000a  4914              LDR      r1,|L30.92|
00000c  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;860    
;;;861        if( NodeAckRequested )
00000e  4814              LDR      r0,|L30.96|
000010  7800              LDRB     r0,[r0,#0]  ; NodeAckRequested
000012  2800              CMP      r0,#0
000014  d001              BEQ      |L30.26|
;;;862        {
;;;863            OnAckTimeoutTimerEvent( );
000016  f7fffffe          BL       OnAckTimeoutTimerEvent
                  |L30.26|
;;;864        }
;;;865    
;;;866        if( ( RxSlot == 0 ) && ( LoRaMacDeviceClass == CLASS_C ) )
00001a  4812              LDR      r0,|L30.100|
00001c  7800              LDRB     r0,[r0,#0]  ; RxSlot
00001e  2800              CMP      r0,#0
000020  d105              BNE      |L30.46|
000022  4811              LDR      r0,|L30.104|
000024  7800              LDRB     r0,[r0,#0]  ; LoRaMacDeviceClass
000026  2802              CMP      r0,#2
000028  d101              BNE      |L30.46|
;;;867        {
;;;868            OnRxWindow2TimerEvent( );
00002a  f7fffffe          BL       OnRxWindow2TimerEvent
                  |L30.46|
;;;869        }
;;;870    
;;;871        LoRaMacFlags.Bits.McpsInd = 1;
00002e  480f              LDR      r0,|L30.108|
000030  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000032  2102              MOVS     r1,#2
000034  4388              BICS     r0,r0,r1
000036  1c80              ADDS     r0,r0,#2
000038  490c              LDR      r1,|L30.108|
00003a  7008              STRB     r0,[r1,#0]
;;;872        LoRaMacFlags.Bits.MacDone = 1;
00003c  4608              MOV      r0,r1
00003e  7800              LDRB     r0,[r0,#0]  ; LoRaMacFlags
000040  2108              MOVS     r1,#8
000042  4388              BICS     r0,r0,r1
000044  3008              ADDS     r0,r0,#8
000046  4909              LDR      r1,|L30.108|
000048  7008              STRB     r0,[r1,#0]
;;;873    
;;;874        // Trig OnMacCheckTimerEvent call as soon as possible
;;;875        TimerSetValue( &MacStateCheckTimer, 1000 );  //10ms
00004a  217d              MOVS     r1,#0x7d
00004c  00c9              LSLS     r1,r1,#3
00004e  4808              LDR      r0,|L30.112|
000050  f7fffffe          BL       TimerSetValue
;;;876        TimerStart( &MacStateCheckTimer );
000054  4806              LDR      r0,|L30.112|
000056  f7fffffe          BL       TimerStart
;;;877    }
00005a  bd10              POP      {r4,pc}
;;;878    
                          ENDP

                  |L30.92|
                          DCD      LoRaMacState
                  |L30.96|
                          DCD      NodeAckRequested
                  |L30.100|
                          DCD      RxSlot
                  |L30.104|
                          DCD      LoRaMacDeviceClass
                  |L30.108|
                          DCD      LoRaMacFlags
                  |L30.112|
                          DCD      MacStateCheckTimer

                          AREA ||i.ProcessMacCommands||, CODE, READONLY, ALIGN=2

                          REQUIRE _printf_percent
                          REQUIRE _printf_d
                          REQUIRE _printf_int_dec
                  ProcessMacCommands PROC
;;;2082   
;;;2083   static void ProcessMacCommands( uint8_t *payload, uint8_t macIndex, uint8_t commandsSize, uint8_t snr )
000000  b5ff              PUSH     {r0-r7,lr}
;;;2084   {
000002  b089              SUB      sp,sp,#0x24
000004  4605              MOV      r5,r0
000006  460c              MOV      r4,r1
;;;2085       while( macIndex < commandsSize )
000008  e22d              B        |L31.1126|
                  |L31.10|
;;;2086       {
;;;2087           // Decode Frame MAC commands
;;;2088           switch( payload[macIndex++] )
00000a  4620              MOV      r0,r4
00000c  1c61              ADDS     r1,r4,#1
00000e  b2cc              UXTB     r4,r1
000010  5c28              LDRB     r0,[r5,r0]
000012  1e80              SUBS     r0,r0,#2
000014  0003              MOVS     r3,r0
000016  f7fffffe          BL       __ARM_common_switch8
00001a  0705              DCB      0x07,0x05
00001c  15e1f8f6          DCB      0x15,0xe1,0xf8,0xf6
000020  f5f4f300          DCB      0xf5,0xf4,0xf3,0x00
;;;2089           {
;;;2090               case SRV_MAC_LINK_CHECK_ANS:
;;;2091                   MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_OK;
000024  2000              MOVS     r0,#0
000026  49f7              LDR      r1,|L31.1028|
000028  7048              STRB     r0,[r1,#1]
;;;2092                   MlmeConfirm.DemodMargin = payload[macIndex++];
00002a  4620              MOV      r0,r4
00002c  1c61              ADDS     r1,r4,#1
00002e  b2cc              UXTB     r4,r1
000030  5c28              LDRB     r0,[r5,r0]
000032  49f4              LDR      r1,|L31.1028|
000034  7408              STRB     r0,[r1,#0x10]
;;;2093                   MlmeConfirm.NbGateways = payload[macIndex++];
000036  4620              MOV      r0,r4
000038  1c61              ADDS     r1,r4,#1
00003a  b2cc              UXTB     r4,r1
00003c  5c28              LDRB     r0,[r5,r0]
00003e  49f1              LDR      r1,|L31.1028|
000040  7448              STRB     r0,[r1,#0x11]
;;;2094                   break;
000042  e20f              B        |L31.1124|
;;;2095               case SRV_MAC_LINK_ADR_REQ:
;;;2096                   {
;;;2097                       uint8_t i;
;;;2098                       uint8_t status = 0x07;
000044  2707              MOVS     r7,#7
;;;2099                       uint16_t chMask;
;;;2100                       int8_t txPower = 0;
000046  2000              MOVS     r0,#0
000048  9007              STR      r0,[sp,#0x1c]
;;;2101                       int8_t datarate = 0;
00004a  9006              STR      r0,[sp,#0x18]
;;;2102                       uint8_t nbRep = 0;
00004c  9005              STR      r0,[sp,#0x14]
;;;2103                       uint8_t chMaskCntl = 0;
00004e  9004              STR      r0,[sp,#0x10]
;;;2104                       uint16_t channelsMask[6] = { 0, 0, 0, 0, 0, 0 };
000050  9001              STR      r0,[sp,#4]
000052  9002              STR      r0,[sp,#8]
000054  9003              STR      r0,[sp,#0xc]
;;;2105   
;;;2106                       // Initialize local copy of the channels mask array
;;;2107                       for( i = 0; i < 6; i++ )
000056  2600              MOVS     r6,#0
000058  e007              B        |L31.106|
                  |L31.90|
;;;2108                       {
;;;2109                           channelsMask[i] = ChannelsMask[i];
00005a  0070              LSLS     r0,r6,#1
00005c  49ea              LDR      r1,|L31.1032|
00005e  5a08              LDRH     r0,[r1,r0]
000060  0071              LSLS     r1,r6,#1
000062  aa01              ADD      r2,sp,#4
000064  5250              STRH     r0,[r2,r1]
000066  1c70              ADDS     r0,r6,#1              ;2107
000068  b2c6              UXTB     r6,r0                 ;2107
                  |L31.106|
00006a  2e06              CMP      r6,#6                 ;2107
00006c  dbf5              BLT      |L31.90|
;;;2110                       }
;;;2111                       datarate = payload[macIndex++];
00006e  4620              MOV      r0,r4
000070  1c61              ADDS     r1,r4,#1
000072  b2cc              UXTB     r4,r1
000074  5c28              LDRB     r0,[r5,r0]
000076  b240              SXTB     r0,r0
000078  9006              STR      r0,[sp,#0x18]
;;;2112                       txPower = datarate & 0x0F;
00007a  9806              LDR      r0,[sp,#0x18]
00007c  0700              LSLS     r0,r0,#28
00007e  0f00              LSRS     r0,r0,#28
000080  9007              STR      r0,[sp,#0x1c]
;;;2113                       datarate = ( datarate >> 4 ) & 0x0F;
000082  9806              LDR      r0,[sp,#0x18]
000084  0600              LSLS     r0,r0,#24
000086  0f00              LSRS     r0,r0,#28
000088  9006              STR      r0,[sp,#0x18]
;;;2114   
;;;2115                       if( ( AdrCtrlOn == false ) &&
00008a  48e0              LDR      r0,|L31.1036|
00008c  7800              LDRB     r0,[r0,#0]  ; AdrCtrlOn
00008e  2800              CMP      r0,#0
000090  d113              BNE      |L31.186|
;;;2116                           ( ( ChannelsDatarate != datarate ) || ( ChannelsTxPower != txPower ) ) )
000092  48df              LDR      r0,|L31.1040|
000094  2100              MOVS     r1,#0
000096  5641              LDRSB    r1,[r0,r1]  ; ChannelsDatarate
000098  9806              LDR      r0,[sp,#0x18]
00009a  4281              CMP      r1,r0
00009c  d105              BNE      |L31.170|
00009e  48dd              LDR      r0,|L31.1044|
0000a0  2100              MOVS     r1,#0
0000a2  5641              LDRSB    r1,[r0,r1]  ; ChannelsTxPower
0000a4  9807              LDR      r0,[sp,#0x1c]
0000a6  4281              CMP      r1,r0
0000a8  d007              BEQ      |L31.186|
                  |L31.170|
;;;2117                       { // ADR disabled don't handle ADR requests if server tries to change datarate or txpower
;;;2118                           // Answer the server with fail status
;;;2119                           // Power ACK     = 0
;;;2120                           // Data rate ACK = 0
;;;2121                           // Channel mask  = 0
;;;2122                           AddMacCommand( MOTE_MAC_LINK_ADR_ANS, 0, 0 );
0000aa  2200              MOVS     r2,#0
0000ac  4611              MOV      r1,r2
0000ae  2003              MOVS     r0,#3
0000b0  f7fffffe          BL       AddMacCommand
;;;2123                           macIndex += 3;  // Skip over the remaining bytes of the request
0000b4  1ce0              ADDS     r0,r4,#3
0000b6  b2c4              UXTB     r4,r0
;;;2124                           break;
0000b8  e1d4              B        |L31.1124|
                  |L31.186|
;;;2125                       }
;;;2126                       chMask = ( uint16_t )payload[macIndex++];
0000ba  4620              MOV      r0,r4
0000bc  1c61              ADDS     r1,r4,#1
0000be  b2cc              UXTB     r4,r1
0000c0  5c28              LDRB     r0,[r5,r0]
0000c2  9008              STR      r0,[sp,#0x20]
;;;2127                       chMask |= ( uint16_t )payload[macIndex++] << 8;
0000c4  4620              MOV      r0,r4
0000c6  1c61              ADDS     r1,r4,#1
0000c8  b2cc              UXTB     r4,r1
0000ca  5c28              LDRB     r0,[r5,r0]
0000cc  0200              LSLS     r0,r0,#8
0000ce  9908              LDR      r1,[sp,#0x20]
0000d0  4308              ORRS     r0,r0,r1
0000d2  9008              STR      r0,[sp,#0x20]
;;;2128   
;;;2129                       nbRep = payload[macIndex++];
0000d4  4620              MOV      r0,r4
0000d6  1c61              ADDS     r1,r4,#1
0000d8  b2cc              UXTB     r4,r1
0000da  5c28              LDRB     r0,[r5,r0]
0000dc  9005              STR      r0,[sp,#0x14]
;;;2130                       chMaskCntl = ( nbRep >> 4 ) & 0x07;
0000de  9805              LDR      r0,[sp,#0x14]
0000e0  0640              LSLS     r0,r0,#25
0000e2  0f40              LSRS     r0,r0,#29
0000e4  9004              STR      r0,[sp,#0x10]
;;;2131                       nbRep &= 0x0F;
0000e6  9805              LDR      r0,[sp,#0x14]
0000e8  0700              LSLS     r0,r0,#28
0000ea  0f00              LSRS     r0,r0,#28
0000ec  9005              STR      r0,[sp,#0x14]
;;;2132                       if( nbRep == 0 )
0000ee  9805              LDR      r0,[sp,#0x14]
0000f0  2800              CMP      r0,#0
0000f2  d101              BNE      |L31.248|
;;;2133                       {
;;;2134                           nbRep = 1;
0000f4  2001              MOVS     r0,#1
0000f6  9005              STR      r0,[sp,#0x14]
                  |L31.248|
;;;2135                       }
;;;2136   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;2137                       if( ( chMaskCntl == 0 ) && ( chMask == 0 ) )
0000f8  9804              LDR      r0,[sp,#0x10]
0000fa  2800              CMP      r0,#0
0000fc  d105              BNE      |L31.266|
0000fe  9808              LDR      r0,[sp,#0x20]
000100  2800              CMP      r0,#0
000102  d102              BNE      |L31.266|
;;;2138                       {
;;;2139                           status &= 0xFE; // Channel mask KO
000104  20fe              MOVS     r0,#0xfe
000106  4007              ANDS     r7,r7,r0
000108  e030              B        |L31.364|
                  |L31.266|
;;;2140                       }
;;;2141                       else if( ( ( chMaskCntl >= 1 ) && ( chMaskCntl <= 5 )) ||
00010a  9804              LDR      r0,[sp,#0x10]
00010c  2801              CMP      r0,#1
00010e  db02              BLT      |L31.278|
000110  9804              LDR      r0,[sp,#0x10]
000112  2805              CMP      r0,#5
000114  dd02              BLE      |L31.284|
                  |L31.278|
;;;2142                                ( chMaskCntl >= 7 ) )
000116  9804              LDR      r0,[sp,#0x10]
000118  2807              CMP      r0,#7
00011a  db02              BLT      |L31.290|
                  |L31.284|
;;;2143                       {
;;;2144                           // RFU
;;;2145                           status &= 0xFE; // Channel mask KO
00011c  20fe              MOVS     r0,#0xfe
00011e  4007              ANDS     r7,r7,r0
000120  e024              B        |L31.364|
                  |L31.290|
;;;2146                       }
;;;2147                       else
;;;2148                       {
;;;2149                           for( i = 0; i < LORA_MAX_NB_CHANNELS; i++ )
000122  2600              MOVS     r6,#0
000124  e01d              B        |L31.354|
                  |L31.294|
;;;2150                           {
;;;2151                               if( chMaskCntl == 6 )
000126  9804              LDR      r0,[sp,#0x10]
000128  2806              CMP      r0,#6
00012a  d10b              BNE      |L31.324|
;;;2152                               {
;;;2153                                   if( Channels[i].Frequency != 0 )
00012c  00f0              LSLS     r0,r6,#3
00012e  49ba              LDR      r1,|L31.1048|
000130  5808              LDR      r0,[r1,r0]
000132  2800              CMP      r0,#0
000134  d013              BEQ      |L31.350|
;;;2154                                   {
;;;2155                                       chMask |= 1 << i;
000136  2001              MOVS     r0,#1
000138  40b0              LSLS     r0,r0,r6
00013a  9908              LDR      r1,[sp,#0x20]
00013c  4308              ORRS     r0,r0,r1
00013e  b280              UXTH     r0,r0
000140  9008              STR      r0,[sp,#0x20]
000142  e00c              B        |L31.350|
                  |L31.324|
;;;2156                                   }
;;;2157                               }
;;;2158                               else
;;;2159                               {
;;;2160                                   if( ( ( chMask & ( 1 << i ) ) != 0 ) &&
000144  2001              MOVS     r0,#1
000146  40b0              LSLS     r0,r0,r6
000148  9908              LDR      r1,[sp,#0x20]
00014a  4008              ANDS     r0,r0,r1
00014c  2800              CMP      r0,#0
00014e  d006              BEQ      |L31.350|
;;;2161                                       ( Channels[i].Frequency == 0 ) )
000150  00f0              LSLS     r0,r6,#3
000152  49b1              LDR      r1,|L31.1048|
000154  5808              LDR      r0,[r1,r0]
000156  2800              CMP      r0,#0
000158  d101              BNE      |L31.350|
;;;2162                                   {// Trying to enable an undefined channel
;;;2163                                       status &= 0xFE; // Channel mask KO
00015a  20fe              MOVS     r0,#0xfe
00015c  4007              ANDS     r7,r7,r0
                  |L31.350|
00015e  1c70              ADDS     r0,r6,#1              ;2149
000160  b2c6              UXTB     r6,r0                 ;2149
                  |L31.354|
000162  2e08              CMP      r6,#8                 ;2149
000164  dbdf              BLT      |L31.294|
;;;2164                                   }
;;;2165                               }
;;;2166                           }
;;;2167                           channelsMask[0] = chMask;
000166  4669              MOV      r1,sp
000168  9808              LDR      r0,[sp,#0x20]
00016a  8088              STRH     r0,[r1,#4]
                  |L31.364|
;;;2168                       }
;;;2169   #elif defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;2170                       if( chMaskCntl == 6 )
;;;2171                       {
;;;2172                           // Enable all 125 kHz channels
;;;2173                           for( uint8_t i = 0, k = 0; i < LORA_MAX_NB_CHANNELS - 8; i += 16, k++ )
;;;2174                           {
;;;2175                               for( uint8_t j = 0; j < 16; j++ )
;;;2176                               {
;;;2177                                   if( Channels[i + j].Frequency != 0 )
;;;2178                                   {
;;;2179                                       channelsMask[k] |= 1 << j;
;;;2180                                   }
;;;2181                               }
;;;2182                           }
;;;2183                       }
;;;2184                       else if( chMaskCntl == 7 )
;;;2185                       {
;;;2186                           // Disable all 125 kHz channels
;;;2187                           channelsMask[0] = 0x0000;
;;;2188                           channelsMask[1] = 0x0000;
;;;2189                           channelsMask[2] = 0x0000;
;;;2190                           channelsMask[3] = 0x0000;
;;;2191                       }
;;;2192                       else if( chMaskCntl == 5 )
;;;2193                       {
;;;2194                           // RFU
;;;2195                           status &= 0xFE; // Channel mask KO
;;;2196                       }
;;;2197                       else
;;;2198                       {
;;;2199                           for( uint8_t i = 0; i < 16; i++ )
;;;2200                           {
;;;2201                               if( ( ( chMask & ( 1 << i ) ) != 0 ) &&
;;;2202                                   ( Channels[chMaskCntl * 16 + i].Frequency == 0 ) )
;;;2203                               {// Trying to enable an undefined channel
;;;2204                                   status &= 0xFE; // Channel mask KO
;;;2205                               }
;;;2206                           }
;;;2207                           channelsMask[chMaskCntl] = chMask;
;;;2208   
;;;2209                           if( CountNbEnabled125kHzChannels( channelsMask ) < 6 )
;;;2210                           {
;;;2211                               status &= 0xFE; // Channel mask KO
;;;2212                           }
;;;2213                       }
;;;2214   #else
;;;2215       #error "Please define a frequency band in the compiler options."
;;;2216   #endif
;;;2217                       if( ValueInRange( datarate, LORAMAC_MIN_DATARATE, LORAMAC_MAX_DATARATE ) == false )
00016c  2200              MOVS     r2,#0
00016e  2105              MOVS     r1,#5
000170  9806              LDR      r0,[sp,#0x18]
000172  f7fffffe          BL       ValueInRange
000176  2800              CMP      r0,#0
000178  d101              BNE      |L31.382|
;;;2218                       {
;;;2219                           status &= 0xFD; // Datarate KO
00017a  20fd              MOVS     r0,#0xfd
00017c  4007              ANDS     r7,r7,r0
                  |L31.382|
;;;2220                       }
;;;2221   
;;;2222                       //
;;;2223                       // Remark MaxTxPower = 0 and MinTxPower = 5
;;;2224                       //
;;;2225                       if( ValueInRange( txPower, LORAMAC_MAX_TX_POWER, LORAMAC_MIN_TX_POWER ) == false )
00017e  2205              MOVS     r2,#5
000180  2100              MOVS     r1,#0
000182  9807              LDR      r0,[sp,#0x1c]
000184  f7fffffe          BL       ValueInRange
000188  2800              CMP      r0,#0
00018a  d101              BNE      |L31.400|
;;;2226                       {
;;;2227                           status &= 0xFB; // TxPower KO
00018c  20fb              MOVS     r0,#0xfb
00018e  4007              ANDS     r7,r7,r0
                  |L31.400|
;;;2228                       }
;;;2229                       if( ( status & 0x07 ) == 0x07 )
000190  0778              LSLS     r0,r7,#29
000192  0f40              LSRS     r0,r0,#29
000194  2807              CMP      r0,#7
000196  d11b              BNE      |L31.464|
;;;2230                       {
;;;2231                           ChannelsDatarate = datarate;
000198  499d              LDR      r1,|L31.1040|
00019a  9806              LDR      r0,[sp,#0x18]
00019c  7008              STRB     r0,[r1,#0]
;;;2232                           ChannelsTxPower = txPower;
00019e  499d              LDR      r1,|L31.1044|
0001a0  9807              LDR      r0,[sp,#0x1c]
0001a2  7008              STRB     r0,[r1,#0]
;;;2233   #if defined( USE_BAND_915_HYBRID )
;;;2234                           ChannelsMask[0] = channelsMask[0] & 0x00FF;
;;;2235                           ChannelsMask[1] = channelsMask[1] & 0x0000;
;;;2236                           ChannelsMask[2] = channelsMask[2] & 0x0000;
;;;2237                           ChannelsMask[3] = channelsMask[3] & 0x0000;
;;;2238                           ChannelsMask[4] = channelsMask[4] & 0x0001;
;;;2239                           ChannelsMask[5] = channelsMask[5] & 0x0000;
;;;2240   #else
;;;2241                           ChannelsMask[0] = channelsMask[0];
0001a4  4668              MOV      r0,sp
0001a6  8880              LDRH     r0,[r0,#4]
0001a8  4997              LDR      r1,|L31.1032|
0001aa  8008              STRH     r0,[r1,#0]
;;;2242                           ChannelsMask[1] = channelsMask[1];
0001ac  4668              MOV      r0,sp
0001ae  88c0              LDRH     r0,[r0,#6]
0001b0  8048              STRH     r0,[r1,#2]
;;;2243                           ChannelsMask[2] = channelsMask[2];
0001b2  4668              MOV      r0,sp
0001b4  8900              LDRH     r0,[r0,#8]
0001b6  8088              STRH     r0,[r1,#4]
;;;2244                           ChannelsMask[3] = channelsMask[3];
0001b8  4668              MOV      r0,sp
0001ba  8940              LDRH     r0,[r0,#0xa]
0001bc  80c8              STRH     r0,[r1,#6]
;;;2245                           ChannelsMask[4] = channelsMask[4];
0001be  4668              MOV      r0,sp
0001c0  8980              LDRH     r0,[r0,#0xc]
0001c2  8108              STRH     r0,[r1,#8]
;;;2246                           ChannelsMask[5] = channelsMask[5];
0001c4  4668              MOV      r0,sp
0001c6  89c0              LDRH     r0,[r0,#0xe]
0001c8  8148              STRH     r0,[r1,#0xa]
;;;2247   #endif
;;;2248                           ChannelsNbRep = nbRep;
0001ca  4994              LDR      r1,|L31.1052|
0001cc  9805              LDR      r0,[sp,#0x14]
0001ce  7008              STRB     r0,[r1,#0]
                  |L31.464|
;;;2249                       }
;;;2250                       AddMacCommand( MOTE_MAC_LINK_ADR_ANS, status, 0 );
0001d0  2200              MOVS     r2,#0
0001d2  4639              MOV      r1,r7
0001d4  2003              MOVS     r0,#3
0001d6  f7fffffe          BL       AddMacCommand
;;;2251                   }
;;;2252                   break;
0001da  e143              B        |L31.1124|
;;;2253               case SRV_MAC_DUTY_CYCLE_REQ:
;;;2254                   MaxDCycle = payload[macIndex++];
0001dc  4620              MOV      r0,r4
0001de  1c61              ADDS     r1,r4,#1
0001e0  b2cc              UXTB     r4,r1
0001e2  5c28              LDRB     r0,[r5,r0]
0001e4  498e              LDR      r1,|L31.1056|
0001e6  7008              STRB     r0,[r1,#0]
;;;2255                   AggregatedDCycle = 1 << MaxDCycle;
0001e8  4608              MOV      r0,r1
0001ea  7801              LDRB     r1,[r0,#0]  ; MaxDCycle
0001ec  2001              MOVS     r0,#1
0001ee  4088              LSLS     r0,r0,r1
0001f0  498c              LDR      r1,|L31.1060|
0001f2  8008              STRH     r0,[r1,#0]
;;;2256                   AddMacCommand( MOTE_MAC_DUTY_CYCLE_ANS, 0, 0 );
0001f4  2200              MOVS     r2,#0
0001f6  4611              MOV      r1,r2
0001f8  2004              MOVS     r0,#4
0001fa  f7fffffe          BL       AddMacCommand
;;;2257                   break;
0001fe  e131              B        |L31.1124|
000200  e0fd              B        |L31.1022|
000202  e0c8              B        |L31.918|
000204  e062              B        |L31.716|
000206  e04c              B        |L31.674|
000208  e7ff              B        |L31.522|
                  |L31.522|
;;;2258               case SRV_MAC_RX_PARAM_SETUP_REQ:
;;;2259                   {
;;;2260                       uint8_t status = 0x07;
00020a  2607              MOVS     r6,#7
;;;2261                       int8_t datarate = 0;
00020c  bf00              NOP      
;;;2262                       int8_t drOffset = 0;
00020e  bf00              NOP      
;;;2263                       uint32_t freq = 0;
000210  bf00              NOP      
;;;2264   
;;;2265                       drOffset = ( payload[macIndex] >> 4 ) & 0x07;
000212  5d28              LDRB     r0,[r5,r4]
000214  0640              LSLS     r0,r0,#25
000216  0f40              LSRS     r0,r0,#29
000218  9007              STR      r0,[sp,#0x1c]
;;;2266                       datarate = payload[macIndex] & 0x0F;
00021a  5d28              LDRB     r0,[r5,r4]
00021c  0700              LSLS     r0,r0,#28
00021e  0f00              LSRS     r0,r0,#28
000220  9008              STR      r0,[sp,#0x20]
;;;2267                       macIndex++;
000222  1c60              ADDS     r0,r4,#1
000224  b2c4              UXTB     r4,r0
;;;2268   
;;;2269                       freq =  ( uint32_t )payload[macIndex++];
000226  4620              MOV      r0,r4
000228  1c61              ADDS     r1,r4,#1
00022a  b2cc              UXTB     r4,r1
00022c  5c2f              LDRB     r7,[r5,r0]
;;;2270                       freq |= ( uint32_t )payload[macIndex++] << 8;
00022e  4620              MOV      r0,r4
000230  1c61              ADDS     r1,r4,#1
000232  b2cc              UXTB     r4,r1
000234  5c28              LDRB     r0,[r5,r0]
000236  0200              LSLS     r0,r0,#8
000238  4307              ORRS     r7,r7,r0
;;;2271                       freq |= ( uint32_t )payload[macIndex++] << 16;
00023a  4620              MOV      r0,r4
00023c  1c61              ADDS     r1,r4,#1
00023e  b2cc              UXTB     r4,r1
000240  5c28              LDRB     r0,[r5,r0]
000242  0400              LSLS     r0,r0,#16
000244  4307              ORRS     r7,r7,r0
;;;2272                       freq *= 100;
000246  2064              MOVS     r0,#0x64
000248  4347              MULS     r7,r0,r7
;;;2273   
;;;2274                       if( Radio.CheckRfFrequency( freq ) == false )
00024a  4877              LDR      r0,|L31.1064|
00024c  6a01              LDR      r1,[r0,#0x20]  ; Radio
00024e  4638              MOV      r0,r7
000250  4788              BLX      r1
000252  2800              CMP      r0,#0
000254  d101              BNE      |L31.602|
;;;2275                       {
;;;2276                           status &= 0xFE; // Channel frequency KO
000256  20fe              MOVS     r0,#0xfe
000258  4006              ANDS     r6,r6,r0
                  |L31.602|
;;;2277                       }
;;;2278   
;;;2279                       if( ValueInRange( datarate, LORAMAC_MIN_DATARATE, LORAMAC_MAX_DATARATE ) == false )
00025a  2200              MOVS     r2,#0
00025c  2105              MOVS     r1,#5
00025e  9808              LDR      r0,[sp,#0x20]
000260  f7fffffe          BL       ValueInRange
000264  2800              CMP      r0,#0
000266  d101              BNE      |L31.620|
;;;2280                       {
;;;2281                           status &= 0xFD; // Datarate KO
000268  20fd              MOVS     r0,#0xfd
00026a  4006              ANDS     r6,r6,r0
                  |L31.620|
;;;2282                       }
;;;2283   #if ( defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID ) )
;;;2284                       if( ( ValueInRange( datarate, DR_5, DR_7 ) == true ) ||
;;;2285                           ( datarate > DR_13 ) )
;;;2286                       {
;;;2287                           status &= 0xFD; // Datarate KO
;;;2288                       }
;;;2289   #endif
;;;2290                       if( ValueInRange( drOffset, LORAMAC_MIN_RX1_DR_OFFSET, LORAMAC_MAX_RX1_DR_OFFSET ) == false )
00026c  2205              MOVS     r2,#5
00026e  2100              MOVS     r1,#0
000270  9807              LDR      r0,[sp,#0x1c]
000272  f7fffffe          BL       ValueInRange
000276  2800              CMP      r0,#0
000278  d101              BNE      |L31.638|
;;;2291                       {
;;;2292                           status &= 0xFB; // Rx1DrOffset range KO
00027a  20fb              MOVS     r0,#0xfb
00027c  4006              ANDS     r6,r6,r0
                  |L31.638|
;;;2293                       }
;;;2294   
;;;2295                       if( ( status & 0x07 ) == 0x07 )
00027e  0770              LSLS     r0,r6,#29
000280  0f40              LSRS     r0,r0,#29
000282  2807              CMP      r0,#7
000284  d107              BNE      |L31.662|
;;;2296                       {
;;;2297                           Rx2Channel.Datarate = datarate;
000286  4969              LDR      r1,|L31.1068|
000288  9808              LDR      r0,[sp,#0x20]
00028a  7108              STRB     r0,[r1,#4]
;;;2298                           Rx2Channel.Frequency = freq;
00028c  4608              MOV      r0,r1
00028e  6007              STR      r7,[r0,#0]  ; Rx2Channel
;;;2299                           Rx1DrOffset = drOffset;
000290  4967              LDR      r1,|L31.1072|
000292  9807              LDR      r0,[sp,#0x1c]
000294  7008              STRB     r0,[r1,#0]
                  |L31.662|
;;;2300                       }
;;;2301                       AddMacCommand( MOTE_MAC_RX_PARAM_SETUP_ANS, status, 0 );
000296  2200              MOVS     r2,#0
000298  4631              MOV      r1,r6
00029a  2005              MOVS     r0,#5
00029c  f7fffffe          BL       AddMacCommand
;;;2302                   }
;;;2303                   break;
0002a0  e0e0              B        |L31.1124|
                  |L31.674|
;;;2304               case SRV_MAC_DEV_STATUS_REQ:
;;;2305                   {
;;;2306                       uint8_t batteryLevel = BAT_LEVEL_NO_MEASURE;
0002a2  26ff              MOVS     r6,#0xff
;;;2307                       if( ( LoRaMacCallbacks != NULL ) && ( LoRaMacCallbacks->GetBatteryLevel != NULL ) )
0002a4  4863              LDR      r0,|L31.1076|
0002a6  6800              LDR      r0,[r0,#0]  ; LoRaMacCallbacks
0002a8  2800              CMP      r0,#0
0002aa  d009              BEQ      |L31.704|
0002ac  4861              LDR      r0,|L31.1076|
0002ae  6800              LDR      r0,[r0,#0]  ; LoRaMacCallbacks
0002b0  6800              LDR      r0,[r0,#0]
0002b2  2800              CMP      r0,#0
0002b4  d004              BEQ      |L31.704|
;;;2308                       {
;;;2309                           batteryLevel = LoRaMacCallbacks->GetBatteryLevel( );
0002b6  495f              LDR      r1,|L31.1076|
0002b8  6809              LDR      r1,[r1,#0]  ; LoRaMacCallbacks
0002ba  6808              LDR      r0,[r1,#0]
0002bc  4780              BLX      r0
0002be  4606              MOV      r6,r0
                  |L31.704|
;;;2310                       }
;;;2311                       AddMacCommand( MOTE_MAC_DEV_STATUS_ANS, batteryLevel, snr );
0002c0  4631              MOV      r1,r6
0002c2  2006              MOVS     r0,#6
0002c4  9a0c              LDR      r2,[sp,#0x30]
0002c6  f7fffffe          BL       AddMacCommand
;;;2312                       break;
0002ca  e0cb              B        |L31.1124|
                  |L31.716|
;;;2313                   }
;;;2314               case SRV_MAC_NEW_CHANNEL_REQ:
;;;2315                   {
;;;2316                       uint8_t status = 0x03;
0002cc  2603              MOVS     r6,#3
;;;2317   
;;;2318   #if ( defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID ) )
;;;2319                       status &= 0xFC; // Channel frequency and datarate KO
;;;2320                       macIndex += 5;
;;;2321   #else
;;;2322                       int8_t channelIndex = 0;
0002ce  bf00              NOP      
;;;2323                       ChannelParams_t chParam;
;;;2324   
;;;2325                       channelIndex = payload[macIndex++];
0002d0  4620              MOV      r0,r4
0002d2  1c61              ADDS     r1,r4,#1
0002d4  b2cc              UXTB     r4,r1
0002d6  5c28              LDRB     r0,[r5,r0]
0002d8  b247              SXTB     r7,r0
;;;2326                       chParam.Frequency = ( uint32_t )payload[macIndex++];
0002da  4620              MOV      r0,r4
0002dc  1c61              ADDS     r1,r4,#1
0002de  b2cc              UXTB     r4,r1
0002e0  5c28              LDRB     r0,[r5,r0]
0002e2  9007              STR      r0,[sp,#0x1c]
;;;2327                       chParam.Frequency |= ( uint32_t )payload[macIndex++] << 8;
0002e4  4621              MOV      r1,r4
0002e6  1c62              ADDS     r2,r4,#1
0002e8  b2d4              UXTB     r4,r2
0002ea  5c69              LDRB     r1,[r5,r1]
0002ec  0209              LSLS     r1,r1,#8
0002ee  9807              LDR      r0,[sp,#0x1c]
0002f0  4308              ORRS     r0,r0,r1
0002f2  9007              STR      r0,[sp,#0x1c]
;;;2328                       chParam.Frequency |= ( uint32_t )payload[macIndex++] << 16;
0002f4  4621              MOV      r1,r4
0002f6  1c62              ADDS     r2,r4,#1
0002f8  b2d4              UXTB     r4,r2
0002fa  5c69              LDRB     r1,[r5,r1]
0002fc  0409              LSLS     r1,r1,#16
0002fe  9807              LDR      r0,[sp,#0x1c]
000300  4308              ORRS     r0,r0,r1
000302  9007              STR      r0,[sp,#0x1c]
;;;2329                       chParam.Frequency *= 100;
000304  2164              MOVS     r1,#0x64
000306  9807              LDR      r0,[sp,#0x1c]
000308  4348              MULS     r0,r1,r0
00030a  9007              STR      r0,[sp,#0x1c]
;;;2330                       chParam.DrRange.Value = payload[macIndex++];
00030c  4620              MOV      r0,r4
00030e  1c61              ADDS     r1,r4,#1
000310  b2cc              UXTB     r4,r1
000312  5c28              LDRB     r0,[r5,r0]
000314  b240              SXTB     r0,r0
000316  a908              ADD      r1,sp,#0x20
000318  7008              STRB     r0,[r1,#0]
;;;2331   
;;;2332                       LoRaMacState |= MAC_TX_CONFIG;
00031a  4847              LDR      r0,|L31.1080|
00031c  6800              LDR      r0,[r0,#0]  ; LoRaMacState
00031e  2120              MOVS     r1,#0x20
000320  4308              ORRS     r0,r0,r1
000322  4945              LDR      r1,|L31.1080|
000324  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;2333                       if( chParam.Frequency == 0 )
000326  9807              LDR      r0,[sp,#0x1c]
000328  2800              CMP      r0,#0
00032a  d10c              BNE      |L31.838|
;;;2334                       {
;;;2335                           if( channelIndex < 3 )
00032c  2f03              CMP      r7,#3
00032e  da02              BGE      |L31.822|
;;;2336                           {
;;;2337                               status &= 0xFC;
000330  20fc              MOVS     r0,#0xfc
000332  4006              ANDS     r6,r6,r0
000334  e023              B        |L31.894|
                  |L31.822|
;;;2338                           }
;;;2339                           else
;;;2340                           {
;;;2341                               if( LoRaMacChannelRemove( channelIndex ) != LORAMAC_STATUS_OK )
000336  b2f8              UXTB     r0,r7
000338  f7fffffe          BL       LoRaMacChannelRemove
00033c  2800              CMP      r0,#0
00033e  d01e              BEQ      |L31.894|
;;;2342                               {
;;;2343                                   status &= 0xFC;
000340  20fc              MOVS     r0,#0xfc
000342  4006              ANDS     r6,r6,r0
000344  e01b              B        |L31.894|
                  |L31.838|
;;;2344                               }
;;;2345                           }
;;;2346                       }
;;;2347                       else
;;;2348                       {
;;;2349                           switch( LoRaMacChannelAdd( channelIndex, chParam ) )
000346  b2f8              UXTB     r0,r7
000348  9a08              LDR      r2,[sp,#0x20]
00034a  9907              LDR      r1,[sp,#0x1c]
00034c  f7fffffe          BL       LoRaMacChannelAdd
000350  2800              CMP      r0,#0
000352  d006              BEQ      |L31.866|
000354  2804              CMP      r0,#4
000356  d005              BEQ      |L31.868|
000358  2805              CMP      r0,#5
00035a  d006              BEQ      |L31.874|
00035c  2806              CMP      r0,#6
00035e  d10a              BNE      |L31.886|
000360  e006              B        |L31.880|
                  |L31.866|
;;;2350                           {
;;;2351                               case LORAMAC_STATUS_OK:
;;;2352                               {
;;;2353                                   break;
000362  e00b              B        |L31.892|
                  |L31.868|
;;;2354                               }
;;;2355                               case LORAMAC_STATUS_FREQUENCY_INVALID:
;;;2356                               {
;;;2357                                   status &= 0xFE;
000364  20fe              MOVS     r0,#0xfe
000366  4006              ANDS     r6,r6,r0
;;;2358                                   break;
000368  e008              B        |L31.892|
                  |L31.874|
;;;2359                               }
;;;2360                               case LORAMAC_STATUS_DATARATE_INVALID:
;;;2361                               {
;;;2362                                   status &= 0xFD;
00036a  20fd              MOVS     r0,#0xfd
00036c  4006              ANDS     r6,r6,r0
;;;2363                                   break;
00036e  e005              B        |L31.892|
                  |L31.880|
;;;2364                               }
;;;2365                               case LORAMAC_STATUS_FREQ_AND_DR_INVALID:
;;;2366                               {
;;;2367                                   status &= 0xFC;
000370  20fc              MOVS     r0,#0xfc
000372  4006              ANDS     r6,r6,r0
;;;2368                                   break;
000374  e002              B        |L31.892|
                  |L31.886|
;;;2369                               }
;;;2370                               default:
;;;2371                               {
;;;2372                                   status &= 0xFC;
000376  20fc              MOVS     r0,#0xfc
000378  4006              ANDS     r6,r6,r0
;;;2373                                   break;
00037a  bf00              NOP      
                  |L31.892|
00037c  bf00              NOP                            ;2353
                  |L31.894|
;;;2374                               }
;;;2375                           }
;;;2376                       }
;;;2377                       LoRaMacState &= ~MAC_TX_CONFIG;
00037e  482e              LDR      r0,|L31.1080|
000380  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000382  2120              MOVS     r1,#0x20
000384  4388              BICS     r0,r0,r1
000386  492c              LDR      r1,|L31.1080|
000388  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;2378   #endif
;;;2379                       AddMacCommand( MOTE_MAC_NEW_CHANNEL_ANS, status, 0 );
00038a  2200              MOVS     r2,#0
00038c  4631              MOV      r1,r6
00038e  2007              MOVS     r0,#7
000390  f7fffffe          BL       AddMacCommand
;;;2380                   }
;;;2381                   break;
000394  e066              B        |L31.1124|
                  |L31.918|
;;;2382               case SRV_MAC_RX_TIMING_SETUP_REQ:
;;;2383                   {
;;;2384                       uint8_t delay = payload[macIndex++] & 0x0F;
000396  4620              MOV      r0,r4
000398  1c61              ADDS     r1,r4,#1
00039a  b2cc              UXTB     r4,r1
00039c  5c28              LDRB     r0,[r5,r0]
00039e  0706              LSLS     r6,r0,#28
0003a0  0f36              LSRS     r6,r6,#28
;;;2385   
;;;2386                       if( delay == 0 )
0003a2  2e00              CMP      r6,#0
0003a4  d101              BNE      |L31.938|
;;;2387                       {
;;;2388                           delay++;
0003a6  1c70              ADDS     r0,r6,#1
0003a8  b2c6              UXTB     r6,r0
                  |L31.938|
;;;2389                       }
;;;2390                       DEBUG(2,"line = %d delay = %d\r\n", __LINE__,delay);
0003aa  4632              MOV      r2,r6
0003ac  4923              LDR      r1,|L31.1084|
0003ae  a024              ADR      r0,|L31.1088|
0003b0  f7fffffe          BL       __2printf
;;;2391                       
;;;2392                       ReceiveDelay1 = delay * 1e6;
0003b4  4630              MOV      r0,r6
0003b6  f7fffffe          BL       __aeabi_ui2d
0003ba  2200              MOVS     r2,#0
0003bc  4b26              LDR      r3,|L31.1112|
0003be  9105              STR      r1,[sp,#0x14]
0003c0  9004              STR      r0,[sp,#0x10]
0003c2  f7fffffe          BL       __aeabi_dmul
0003c6  9107              STR      r1,[sp,#0x1c]
0003c8  9006              STR      r0,[sp,#0x18]
0003ca  f7fffffe          BL       __aeabi_d2uiz
0003ce  4923              LDR      r1,|L31.1116|
0003d0  6008              STR      r0,[r1,#0]  ; ReceiveDelay1
;;;2393                       ReceiveDelay2 = ReceiveDelay1 + 1e6;
0003d2  4608              MOV      r0,r1
0003d4  6800              LDR      r0,[r0,#0]  ; ReceiveDelay1
0003d6  f7fffffe          BL       __aeabi_ui2d
0003da  2200              MOVS     r2,#0
0003dc  4b1e              LDR      r3,|L31.1112|
0003de  9105              STR      r1,[sp,#0x14]
0003e0  9004              STR      r0,[sp,#0x10]
0003e2  f7fffffe          BL       __aeabi_dadd
0003e6  9107              STR      r1,[sp,#0x1c]
0003e8  9006              STR      r0,[sp,#0x18]
0003ea  f7fffffe          BL       __aeabi_d2uiz
0003ee  491c              LDR      r1,|L31.1120|
0003f0  6008              STR      r0,[r1,#0]  ; ReceiveDelay2
;;;2394                       AddMacCommand( MOTE_MAC_RX_TIMING_SETUP_ANS, 0, 0 );
0003f2  2200              MOVS     r2,#0
0003f4  4611              MOV      r1,r2
0003f6  2008              MOVS     r0,#8
0003f8  f7fffffe          BL       AddMacCommand
;;;2395                   }
;;;2396                   break;
0003fc  e032              B        |L31.1124|
                  |L31.1022|
;;;2397               default:
;;;2398                   // Unknown command. ABORT MAC commands processing
;;;2399                   return;
;;;2400           }
;;;2401       }
;;;2402   }
0003fe  b00d              ADD      sp,sp,#0x34
000400  bdf0              POP      {r4-r7,pc}
000402  0000              DCW      0x0000
                  |L31.1028|
                          DCD      MlmeConfirm
                  |L31.1032|
                          DCD      ChannelsMask
                  |L31.1036|
                          DCD      AdrCtrlOn
                  |L31.1040|
                          DCD      ChannelsDatarate
                  |L31.1044|
                          DCD      ChannelsTxPower
                  |L31.1048|
                          DCD      Channels
                  |L31.1052|
                          DCD      ChannelsNbRep
                  |L31.1056|
                          DCD      MaxDCycle
                  |L31.1060|
                          DCD      AggregatedDCycle
                  |L31.1064|
                          DCD      Radio
                  |L31.1068|
                          DCD      Rx2Channel
                  |L31.1072|
                          DCD      Rx1DrOffset
                  |L31.1076|
                          DCD      LoRaMacCallbacks
                  |L31.1080|
                          DCD      LoRaMacState
                  |L31.1084|
                          DCD      0x00000956
                  |L31.1088|
000440  6c696e65          DCB      "line = %d delay = %d\r\n",0
000444  203d2025
000448  64206465
00044c  6c617920
000450  3d202564
000454  0d0a00  
000457  00                DCB      0
                  |L31.1112|
                          DCD      0x412e8480
                  |L31.1116|
                          DCD      ReceiveDelay1
                  |L31.1120|
                          DCD      ReceiveDelay2
                  |L31.1124|
000464  bf00              NOP                            ;2094
                  |L31.1126|
000466  980b              LDR      r0,[sp,#0x2c]         ;2085
000468  4284              CMP      r4,r0                 ;2085
00046a  da00              BGE      |L31.1134|
00046c  e5cd              B        |L31.10|
                  |L31.1134|
00046e  bf00              NOP      
000470  b00d              ADD      sp,sp,#0x34
000472  bdf0              POP      {r4-r7,pc}
;;;2403   
                          ENDP


                          AREA ||i.RxWindowSetup||, CODE, READONLY, ALIGN=2

                  RxWindowSetup PROC
;;;1771   
;;;1772   static void RxWindowSetup( uint32_t freq, int8_t datarate, uint32_t bandwidth, uint16_t timeout, bool rxContinuous )
000000  b5ff              PUSH     {r0-r7,lr}
;;;1773   {
000002  b08d              SUB      sp,sp,#0x34
000004  460c              MOV      r4,r1
000006  461e              MOV      r6,r3
000008  9d16              LDR      r5,[sp,#0x58]
;;;1774       uint8_t downlinkDatarate = Datarates[datarate];
00000a  4842              LDR      r0,|L32.276|
00000c  5d00              LDRB     r0,[r0,r4]
00000e  900c              STR      r0,[sp,#0x30]
;;;1775       RadioModems_t modem;
;;;1776   
;;;1777       if( Radio.GetStatus( ) == RF_IDLE )
000010  4941              LDR      r1,|L32.280|
000012  6848              LDR      r0,[r1,#4]  ; Radio
000014  4780              BLX      r0
000016  2800              CMP      r0,#0
000018  d17a              BNE      |L32.272|
;;;1778       {
;;;1779           Radio.SetChannel( freq );
00001a  483f              LDR      r0,|L32.280|
00001c  68c1              LDR      r1,[r0,#0xc]  ; Radio
00001e  980d              LDR      r0,[sp,#0x34]
000020  4788              BLX      r1
;;;1780   				DEBUG(3,"freq = %d\r\n",freq);
;;;1781   
;;;1782           // Store downlink datarate
;;;1783           McpsIndication.RxDatarate = ( uint8_t ) datarate;
000022  493e              LDR      r1,|L32.284|
000024  710c              STRB     r4,[r1,#4]
;;;1784   
;;;1785   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;1786           if( datarate == DR_7 )
000026  2c07              CMP      r4,#7
000028  d126              BNE      |L32.120|
;;;1787           {
;;;1788               modem = MODEM_FSK;
00002a  2000              MOVS     r0,#0
00002c  900b              STR      r0,[sp,#0x2c]
;;;1789               Radio.SetRxConfig( modem, 50e3, downlinkDatarate * 1e3, 0, 83.333e3, 5, 0, false, 0, true, 0, 0, false, rxContinuous );
00002e  980c              LDR      r0,[sp,#0x30]
000030  f7fffffe          BL       __aeabi_ui2d
000034  2200              MOVS     r2,#0
000036  4b3a              LDR      r3,|L32.288|
000038  9107              STR      r1,[sp,#0x1c]
00003a  9006              STR      r0,[sp,#0x18]
00003c  f7fffffe          BL       __aeabi_dmul
000040  9109              STR      r1,[sp,#0x24]
000042  9008              STR      r0,[sp,#0x20]
000044  f7fffffe          BL       __aeabi_d2uiz
000048  900a              STR      r0,[sp,#0x28]
00004a  2000              MOVS     r0,#0
00004c  9006              STR      r0,[sp,#0x18]
00004e  9007              STR      r0,[sp,#0x1c]
000050  9509              STR      r5,[sp,#0x24]
000052  9008              STR      r0,[sp,#0x20]
000054  2001              MOVS     r0,#1
000056  2100              MOVS     r1,#0
000058  9102              STR      r1,[sp,#8]
00005a  9103              STR      r1,[sp,#0xc]
00005c  9104              STR      r1,[sp,#0x10]
00005e  9005              STR      r0,[sp,#0x14]
000060  2005              MOVS     r0,#5
000062  4930              LDR      r1,|L32.292|
000064  9100              STR      r1,[sp,#0]
000066  9001              STR      r0,[sp,#4]
000068  482b              LDR      r0,|L32.280|
00006a  2300              MOVS     r3,#0
00006c  6987              LDR      r7,[r0,#0x18]  ; Radio
00006e  492e              LDR      r1,|L32.296|
000070  9a0a              LDR      r2,[sp,#0x28]
000072  980b              LDR      r0,[sp,#0x2c]
000074  47b8              BLX      r7
000076  e02e              B        |L32.214|
                  |L32.120|
;;;1790           }
;;;1791           else
;;;1792           {
;;;1793               modem = MODEM_LORA;
000078  2001              MOVS     r0,#1
00007a  900b              STR      r0,[sp,#0x2c]
;;;1794   					
;;;1795   						if(LoRaCad.Iq_Invert) ///点对点
00007c  482b              LDR      r0,|L32.300|
00007e  78c0              LDRB     r0,[r0,#3]  ; LoRaCad
000080  2800              CMP      r0,#0
000082  d014              BEQ      |L32.174|
;;;1796   							 Radio.SetRxConfig( modem, bandwidth, downlinkDatarate, 1, 0, 10, timeout, false, 0, false, 0, 0, false, rxContinuous ); //false -- P2P
000084  2000              MOVS     r0,#0
000086  9006              STR      r0,[sp,#0x18]
000088  9007              STR      r0,[sp,#0x1c]
00008a  9008              STR      r0,[sp,#0x20]
00008c  9003              STR      r0,[sp,#0xc]
00008e  9004              STR      r0,[sp,#0x10]
000090  9602              STR      r6,[sp,#8]
000092  9509              STR      r5,[sp,#0x24]
000094  9005              STR      r0,[sp,#0x14]
000096  200a              MOVS     r0,#0xa
000098  2100              MOVS     r1,#0
00009a  9100              STR      r1,[sp,#0]
00009c  9001              STR      r0,[sp,#4]
00009e  481e              LDR      r0,|L32.280|
0000a0  2301              MOVS     r3,#1
0000a2  6987              LDR      r7,[r0,#0x18]  ; Radio
0000a4  9a0c              LDR      r2,[sp,#0x30]
0000a6  990f              LDR      r1,[sp,#0x3c]
0000a8  980b              LDR      r0,[sp,#0x2c]
0000aa  47b8              BLX      r7
0000ac  e013              B        |L32.214|
                  |L32.174|
;;;1797   						else
;;;1798               Radio.SetRxConfig( modem, bandwidth, downlinkDatarate, 1, 0, 10, timeout, false, 0, false, 0, 0, true, rxContinuous ); //true---GW
0000ae  2001              MOVS     r0,#1
0000b0  2100              MOVS     r1,#0
0000b2  9106              STR      r1,[sp,#0x18]
0000b4  9107              STR      r1,[sp,#0x1c]
0000b6  9103              STR      r1,[sp,#0xc]
0000b8  9104              STR      r1,[sp,#0x10]
0000ba  9602              STR      r6,[sp,#8]
0000bc  9509              STR      r5,[sp,#0x24]
0000be  9105              STR      r1,[sp,#0x14]
0000c0  9008              STR      r0,[sp,#0x20]
0000c2  200a              MOVS     r0,#0xa
0000c4  9100              STR      r1,[sp,#0]
0000c6  9001              STR      r0,[sp,#4]
0000c8  4813              LDR      r0,|L32.280|
0000ca  2301              MOVS     r3,#1
0000cc  6987              LDR      r7,[r0,#0x18]  ; Radio
0000ce  9a0c              LDR      r2,[sp,#0x30]
0000d0  990f              LDR      r1,[sp,#0x3c]
0000d2  980b              LDR      r0,[sp,#0x2c]
0000d4  47b8              BLX      r7
                  |L32.214|
;;;1799   
;;;1800   //            Radio.SetRxConfig( modem, bandwidth, downlinkDatarate, 1, 0, 8, timeout, false, 0, false, 0, 0, true, rxContinuous );
;;;1801           }
;;;1802   #elif defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;1803           modem = MODEM_LORA;
;;;1804           Radio.SetRxConfig( modem, bandwidth, downlinkDatarate, 1, 0, 8, timeout, false, 0, false, 0, 0, true, rxContinuous );
;;;1805   #endif
;;;1806   
;;;1807           if( RepeaterSupport == true )
0000d6  4816              LDR      r0,|L32.304|
0000d8  7800              LDRB     r0,[r0,#0]  ; RepeaterSupport
0000da  2801              CMP      r0,#1
0000dc  d106              BNE      |L32.236|
;;;1808           {
;;;1809               Radio.SetMaxPayloadLength( modem, MaxPayloadOfDatarateRepeater[datarate] );
0000de  4815              LDR      r0,|L32.308|
0000e0  5d01              LDRB     r1,[r0,r4]
0000e2  480d              LDR      r0,|L32.280|
0000e4  6d02              LDR      r2,[r0,#0x50]  ; Radio
0000e6  980b              LDR      r0,[sp,#0x2c]
0000e8  4790              BLX      r2
0000ea  e005              B        |L32.248|
                  |L32.236|
;;;1810           }
;;;1811           else
;;;1812           {
;;;1813               Radio.SetMaxPayloadLength( modem, MaxPayloadOfDatarate[datarate] );
0000ec  4812              LDR      r0,|L32.312|
0000ee  5d01              LDRB     r1,[r0,r4]
0000f0  4809              LDR      r0,|L32.280|
0000f2  6d02              LDR      r2,[r0,#0x50]  ; Radio
0000f4  980b              LDR      r0,[sp,#0x2c]
0000f6  4790              BLX      r2
                  |L32.248|
;;;1814           }
;;;1815   
;;;1816           if( rxContinuous == false )
0000f8  2d00              CMP      r5,#0
0000fa  d105              BNE      |L32.264|
;;;1817           {
;;;1818               Radio.Rx( MaxRxWindow );
0000fc  4806              LDR      r0,|L32.280|
0000fe  6b41              LDR      r1,[r0,#0x34]  ; Radio
000100  480e              LDR      r0,|L32.316|
000102  6800              LDR      r0,[r0,#0]  ; MaxRxWindow
000104  4788              BLX      r1
000106  e003              B        |L32.272|
                  |L32.264|
;;;1819           }
;;;1820           else
;;;1821           {
;;;1822               Radio.Rx( 0 ); // Continuous mode
000108  4803              LDR      r0,|L32.280|
00010a  6b41              LDR      r1,[r0,#0x34]  ; Radio
00010c  2000              MOVS     r0,#0
00010e  4788              BLX      r1
                  |L32.272|
;;;1823           }
;;;1824       }
;;;1825   }
000110  b011              ADD      sp,sp,#0x44
000112  bdf0              POP      {r4-r7,pc}
;;;1826   
                          ENDP

                  |L32.276|
                          DCD      Datarates
                  |L32.280|
                          DCD      Radio
                  |L32.284|
                          DCD      McpsIndication
                  |L32.288|
                          DCD      0x408f4000
                  |L32.292|
                          DCD      0x00014585
                  |L32.296|
                          DCD      0x0000c350
                  |L32.300|
                          DCD      LoRaCad
                  |L32.304|
                          DCD      RepeaterSupport
                  |L32.308|
                          DCD      MaxPayloadOfDatarateRepeater
                  |L32.312|
                          DCD      MaxPayloadOfDatarate
                  |L32.316|
                          DCD      MaxRxWindow

                          AREA ||i.ScheduleTx||, CODE, READONLY, ALIGN=2

                  ScheduleTx PROC
;;;2434   
;;;2435   static LoRaMacStatus_t ScheduleTx( )
000000  b51c              PUSH     {r2-r4,lr}
;;;2436   {
;;;2437       TimerTime_t dutyCycleTimeOff = 0;
000002  2100              MOVS     r1,#0
000004  9100              STR      r1,[sp,#0]
000006  9101              STR      r1,[sp,#4]
;;;2438   
;;;2439       // Check if the device is off
;;;2440       if( MaxDCycle == 255 )
000008  4828              LDR      r0,|L33.172|
00000a  7800              LDRB     r0,[r0,#0]  ; MaxDCycle
00000c  28ff              CMP      r0,#0xff
00000e  d101              BNE      |L33.20|
;;;2441       {
;;;2442           return LORAMAC_STATUS_DEVICE_OFF;
000010  200a              MOVS     r0,#0xa
                  |L33.18|
;;;2443       }
;;;2444       if( MaxDCycle == 0 )
;;;2445       {
;;;2446           AggregatedTimeOff = 0;
;;;2447       }
;;;2448   
;;;2449       // Select channel
;;;2450       while( SetNextChannel( &dutyCycleTimeOff ) == false )
;;;2451       {
;;;2452           // Set the default datarate
;;;2453           ChannelsDatarate = ChannelsDefaultDatarate;
;;;2454   
;;;2455   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;2456           // Re-enable default channels LC1, LC2, LC3
;;;2457           ChannelsMask[0] = ChannelsMask[0] | ( LC( 1 ) + LC( 2 ) + LC( 3 ) );
;;;2458   #endif
;;;2459       }
;;;2460   
;;;2461       // Schedule transmission of frame
;;;2462       if( dutyCycleTimeOff == 0 )
;;;2463       {
;;;2464           // Try to send now
;;;2465           return SendFrameOnChannel( Channels[Channel] );
;;;2466       }
;;;2467       else
;;;2468       {
;;;2469           // Send later - prepare timer
;;;2470           LoRaMacState |= MAC_TX_DELAYED;
;;;2471           TimerSetValue( &TxDelayedTimer, dutyCycleTimeOff );
;;;2472           TimerStart( &TxDelayedTimer );
;;;2473   
;;;2474           return LORAMAC_STATUS_OK;
;;;2475       }
;;;2476   }
000012  bd1c              POP      {r2-r4,pc}
                  |L33.20|
000014  4825              LDR      r0,|L33.172|
000016  7800              LDRB     r0,[r0,#0]            ;2444  ; MaxDCycle
000018  2800              CMP      r0,#0                 ;2444
00001a  d102              BNE      |L33.34|
00001c  4a24              LDR      r2,|L33.176|
00001e  6010              STR      r0,[r2,#0]            ;2446  ; AggregatedTimeOff
000020  6050              STR      r0,[r2,#4]            ;2446  ; AggregatedTimeOff
                  |L33.34|
000022  e00a              B        |L33.58|
                  |L33.36|
000024  4923              LDR      r1,|L33.180|
000026  2000              MOVS     r0,#0                 ;2453
000028  5608              LDRSB    r0,[r1,r0]            ;2453  ; ChannelsDefaultDatarate
00002a  4923              LDR      r1,|L33.184|
00002c  7008              STRB     r0,[r1,#0]            ;2453
00002e  4823              LDR      r0,|L33.188|
000030  8800              LDRH     r0,[r0,#0]            ;2457  ; ChannelsMask
000032  2107              MOVS     r1,#7                 ;2457
000034  4308              ORRS     r0,r0,r1              ;2457
000036  4921              LDR      r1,|L33.188|
000038  8008              STRH     r0,[r1,#0]            ;2457
                  |L33.58|
00003a  4668              MOV      r0,sp                 ;2450
00003c  f7fffffe          BL       SetNextChannel
000040  2800              CMP      r0,#0                 ;2450
000042  d0ef              BEQ      |L33.36|
000044  2300              MOVS     r3,#0                 ;2462
000046  9900              LDR      r1,[sp,#0]            ;2462
000048  4059              EORS     r1,r1,r3              ;2462
00004a  9801              LDR      r0,[sp,#4]            ;2462
00004c  4058              EORS     r0,r0,r3              ;2462
00004e  4301              ORRS     r1,r1,r0              ;2462
000050  d11d              BNE      |L33.142|
000052  481b              LDR      r0,|L33.192|
000054  7800              LDRB     r0,[r0,#0]            ;2465  ; Channel
000056  00c0              LSLS     r0,r0,#3              ;2465
000058  491a              LDR      r1,|L33.196|
00005a  1842              ADDS     r2,r0,r1              ;2465
00005c  7913              LDRB     r3,[r2,#4]            ;2465
00005e  4619              MOV      r1,r3                 ;2465
000060  7953              LDRB     r3,[r2,#5]            ;2465
000062  021b              LSLS     r3,r3,#8              ;2465
000064  4319              ORRS     r1,r1,r3              ;2465
000066  7993              LDRB     r3,[r2,#6]            ;2465
000068  041b              LSLS     r3,r3,#16             ;2465
00006a  4319              ORRS     r1,r1,r3              ;2465
00006c  79d0              LDRB     r0,[r2,#7]            ;2465
00006e  0600              LSLS     r0,r0,#24             ;2465
000070  4301              ORRS     r1,r1,r0              ;2465
000072  7814              LDRB     r4,[r2,#0]            ;2465
000074  4620              MOV      r0,r4                 ;2465
000076  7854              LDRB     r4,[r2,#1]            ;2465
000078  0224              LSLS     r4,r4,#8              ;2465
00007a  4320              ORRS     r0,r0,r4              ;2465
00007c  7894              LDRB     r4,[r2,#2]            ;2465
00007e  0424              LSLS     r4,r4,#16             ;2465
000080  4320              ORRS     r0,r0,r4              ;2465
000082  78d3              LDRB     r3,[r2,#3]            ;2465
000084  061b              LSLS     r3,r3,#24             ;2465
000086  4318              ORRS     r0,r0,r3              ;2465
000088  f7fffffe          BL       SendFrameOnChannel
00008c  e7c1              B        |L33.18|
                  |L33.142|
00008e  480e              LDR      r0,|L33.200|
000090  6800              LDR      r0,[r0,#0]            ;2470  ; LoRaMacState
000092  2110              MOVS     r1,#0x10              ;2470
000094  4308              ORRS     r0,r0,r1              ;2470
000096  490c              LDR      r1,|L33.200|
000098  6008              STR      r0,[r1,#0]            ;2470  ; LoRaMacState
00009a  480c              LDR      r0,|L33.204|
00009c  9900              LDR      r1,[sp,#0]            ;2471
00009e  f7fffffe          BL       TimerSetValue
0000a2  480a              LDR      r0,|L33.204|
0000a4  f7fffffe          BL       TimerStart
0000a8  2000              MOVS     r0,#0                 ;2474
0000aa  e7b2              B        |L33.18|
;;;2477   
                          ENDP

                  |L33.172|
                          DCD      MaxDCycle
                  |L33.176|
                          DCD      AggregatedTimeOff
                  |L33.180|
                          DCD      ChannelsDefaultDatarate
                  |L33.184|
                          DCD      ChannelsDatarate
                  |L33.188|
                          DCD      ChannelsMask
                  |L33.192|
                          DCD      Channel
                  |L33.196|
                          DCD      Channels
                  |L33.200|
                          DCD      LoRaMacState
                  |L33.204|
                          DCD      TxDelayedTimer

                          AREA ||i.Send||, CODE, READONLY, ALIGN=2

                  Send PROC
;;;2403   
;;;2404   LoRaMacStatus_t Send( LoRaMacHeader_t *macHdr, uint8_t fPort, void *fBuffer, uint16_t fBufferSize )
000000  b5ff              PUSH     {r0-r7,lr}
;;;2405   {
000002  b083              SUB      sp,sp,#0xc
000004  460c              MOV      r4,r1
000006  4615              MOV      r5,r2
000008  461e              MOV      r6,r3
;;;2406       LoRaMacFrameCtrl_t fCtrl;
;;;2407       LoRaMacStatus_t status = LORAMAC_STATUS_PARAMETER_INVALID;
00000a  2703              MOVS     r7,#3
;;;2408   
;;;2409       fCtrl.Value = 0;
00000c  2100              MOVS     r1,#0
00000e  9102              STR      r1,[sp,#8]
;;;2410       fCtrl.Bits.FOptsLen      = 0;
000010  4668              MOV      r0,sp
000012  7a00              LDRB     r0,[r0,#8]
000014  0901              LSRS     r1,r0,#4
000016  0109              LSLS     r1,r1,#4
000018  9102              STR      r1,[sp,#8]
;;;2411       fCtrl.Bits.FPending      = 0;
00001a  4668              MOV      r0,sp
00001c  7a00              LDRB     r0,[r0,#8]
00001e  2110              MOVS     r1,#0x10
000020  4388              BICS     r0,r0,r1
000022  9002              STR      r0,[sp,#8]
;;;2412       fCtrl.Bits.Ack           = false;
000024  4668              MOV      r0,sp
000026  7a00              LDRB     r0,[r0,#8]
000028  2120              MOVS     r1,#0x20
00002a  4388              BICS     r0,r0,r1
00002c  9002              STR      r0,[sp,#8]
;;;2413       fCtrl.Bits.AdrAckReq     = false;
00002e  4668              MOV      r0,sp
000030  7a00              LDRB     r0,[r0,#8]
000032  2140              MOVS     r1,#0x40
000034  4388              BICS     r0,r0,r1
000036  9002              STR      r0,[sp,#8]
;;;2414       fCtrl.Bits.Adr           = AdrCtrlOn;
000038  4668              MOV      r0,sp
00003a  7a00              LDRB     r0,[r0,#8]
00003c  2180              MOVS     r1,#0x80
00003e  4388              BICS     r0,r0,r1
000040  490f              LDR      r1,|L34.128|
000042  7809              LDRB     r1,[r1,#0]  ; AdrCtrlOn
000044  01c9              LSLS     r1,r1,#7
000046  2280              MOVS     r2,#0x80
000048  4011              ANDS     r1,r1,r2
00004a  4308              ORRS     r0,r0,r1
00004c  9002              STR      r0,[sp,#8]
;;;2415   
;;;2416       // Prepare the frame
;;;2417       status = PrepareFrame( macHdr, &fCtrl, fPort, fBuffer, fBufferSize );
00004e  462b              MOV      r3,r5
000050  4622              MOV      r2,r4
000052  a902              ADD      r1,sp,#8
000054  9600              STR      r6,[sp,#0]
000056  9803              LDR      r0,[sp,#0xc]
000058  f7fffffe          BL       PrepareFrame
00005c  4607              MOV      r7,r0
;;;2418   
;;;2419       // Validate status
;;;2420       if( status != LORAMAC_STATUS_OK )
00005e  2f00              CMP      r7,#0
000060  d002              BEQ      |L34.104|
;;;2421       {
;;;2422           return status;
000062  4638              MOV      r0,r7
                  |L34.100|
;;;2423       }
;;;2424   
;;;2425       // Reset confirm parameters
;;;2426       McpsConfirm.NbRetries = 0;
;;;2427       McpsConfirm.AckReceived = false;
;;;2428       McpsConfirm.UpLinkCounter = UpLinkCounter;
;;;2429   
;;;2430       status = ScheduleTx( );
;;;2431   
;;;2432       return status;
;;;2433   }
000064  b007              ADD      sp,sp,#0x1c
000066  bdf0              POP      {r4-r7,pc}
                  |L34.104|
000068  2000              MOVS     r0,#0                 ;2426
00006a  4906              LDR      r1,|L34.132|
00006c  7148              STRB     r0,[r1,#5]            ;2426
00006e  7108              STRB     r0,[r1,#4]            ;2427
000070  4805              LDR      r0,|L34.136|
000072  6800              LDR      r0,[r0,#0]            ;2428  ; UpLinkCounter
000074  6108              STR      r0,[r1,#0x10]         ;2428  ; McpsConfirm
000076  f7fffffe          BL       ScheduleTx
00007a  4607              MOV      r7,r0                 ;2430
00007c  4638              MOV      r0,r7                 ;2432
00007e  e7f1              B        |L34.100|
;;;2434   
                          ENDP

                  |L34.128|
                          DCD      AdrCtrlOn
                  |L34.132|
                          DCD      McpsConfirm
                  |L34.136|
                          DCD      UpLinkCounter

                          AREA ||i.SendFrameOnChannel||, CODE, READONLY, ALIGN=2

                  SendFrameOnChannel PROC
;;;2624   
;;;2625   LoRaMacStatus_t SendFrameOnChannel( ChannelParams_t channel )
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;2626   {
000002  b08b              SUB      sp,sp,#0x2c
;;;2627       int8_t datarate = Datarates[ChannelsDatarate];
000004  4862              LDR      r0,|L35.400|
000006  4963              LDR      r1,|L35.404|
000008  2200              MOVS     r2,#0
00000a  568a              LDRSB    r2,[r1,r2]  ; ChannelsDatarate
00000c  5c80              LDRB     r0,[r0,r2]
00000e  b244              SXTB     r4,r0
;;;2628       int8_t txPower = 0;
000010  2000              MOVS     r0,#0
000012  900a              STR      r0,[sp,#0x28]
;;;2629   
;;;2630       ChannelsTxPower = LimitTxPower( ChannelsTxPower );
000014  4960              LDR      r1,|L35.408|
000016  5608              LDRSB    r0,[r1,r0]  ; ChannelsTxPower
000018  f7fffffe          BL       LimitTxPower
00001c  495e              LDR      r1,|L35.408|
00001e  7008              STRB     r0,[r1,#0]
;;;2631       txPower = TxPowers[ChannelsTxPower];
000020  485e              LDR      r0,|L35.412|
000022  2200              MOVS     r2,#0
000024  568a              LDRSB    r2,[r1,r2]  ; ChannelsTxPower
000026  5680              LDRSB    r0,[r0,r2]
000028  900a              STR      r0,[sp,#0x28]
;;;2632   
;;;2633       MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
00002a  2001              MOVS     r0,#1
00002c  495c              LDR      r1,|L35.416|
00002e  7048              STRB     r0,[r1,#1]
;;;2634       McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
000030  495c              LDR      r1,|L35.420|
000032  7048              STRB     r0,[r1,#1]
;;;2635       McpsConfirm.Datarate = ChannelsDatarate;
000034  4857              LDR      r0,|L35.404|
000036  7800              LDRB     r0,[r0,#0]  ; ChannelsDatarate
000038  7088              STRB     r0,[r1,#2]
;;;2636       McpsConfirm.TxPower = ChannelsTxPower;
00003a  4957              LDR      r1,|L35.408|
00003c  2000              MOVS     r0,#0
00003e  5608              LDRSB    r0,[r1,r0]  ; ChannelsTxPower
000040  4958              LDR      r1,|L35.420|
000042  70c8              STRB     r0,[r1,#3]
;;;2637   
;;;2638       Radio.SetChannel( channel.Frequency );
000044  4a58              LDR      r2,|L35.424|
000046  980b              LDR      r0,[sp,#0x2c]
000048  68d1              LDR      r1,[r2,#0xc]  ; Radio
00004a  4788              BLX      r1
;;;2639   
;;;2640   #if defined( USE_BAND_433 ) || defined( USE_BAND_780 ) || defined( USE_BAND_868 )
;;;2641       if( ChannelsDatarate == DR_7 )
00004c  4851              LDR      r0,|L35.404|
00004e  7800              LDRB     r0,[r0,#0]  ; ChannelsDatarate
000050  2807              CMP      r0,#7
000052  d130              BNE      |L35.182|
;;;2642       { // High Speed FSK channel
;;;2643           Radio.SetMaxPayloadLength( MODEM_FSK, LoRaMacBufferPktLen );
000054  4855              LDR      r0,|L35.428|
000056  7801              LDRB     r1,[r0,#0]  ; LoRaMacBufferPktLen
000058  4853              LDR      r0,|L35.424|
00005a  6d02              LDR      r2,[r0,#0x50]  ; Radio
00005c  2000              MOVS     r0,#0
00005e  4790              BLX      r2
;;;2644           Radio.SetTxConfig( MODEM_FSK, txPower, 25e3, 0, datarate * 1e3, 0, 5, false, true, 0, 0, false, 3e6 );
000060  4620              MOV      r0,r4
000062  f7fffffe          BL       __aeabi_i2d
000066  4605              MOV      r5,r0
000068  2200              MOVS     r2,#0
00006a  4b51              LDR      r3,|L35.432|
00006c  f7fffffe          BL       __aeabi_dmul
000070  9109              STR      r1,[sp,#0x24]
000072  9008              STR      r0,[sp,#0x20]
000074  f7fffffe          BL       __aeabi_d2uiz
000078  4607              MOV      r7,r0
00007a  484e              LDR      r0,|L35.436|
00007c  2100              MOVS     r1,#0
00007e  9105              STR      r1,[sp,#0x14]
000080  9106              STR      r1,[sp,#0x18]
000082  9107              STR      r1,[sp,#0x1c]
000084  9008              STR      r0,[sp,#0x20]
000086  2001              MOVS     r0,#1
000088  2205              MOVS     r2,#5
00008a  9101              STR      r1,[sp,#4]
00008c  9700              STR      r7,[sp,#0]
00008e  9202              STR      r2,[sp,#8]
000090  9103              STR      r1,[sp,#0xc]
000092  9004              STR      r0,[sp,#0x10]
000094  4844              LDR      r0,|L35.424|
000096  460b              MOV      r3,r1
000098  4a47              LDR      r2,|L35.440|
00009a  69c5              LDR      r5,[r0,#0x1c]  ; Radio
00009c  2000              MOVS     r0,#0
00009e  990a              LDR      r1,[sp,#0x28]
0000a0  47a8              BLX      r5
;;;2645           TxTimeOnAir = Radio.TimeOnAir( MODEM_FSK, LoRaMacBufferPktLen );
0000a2  4842              LDR      r0,|L35.428|
0000a4  7801              LDRB     r1,[r0,#0]  ; LoRaMacBufferPktLen
0000a6  4840              LDR      r0,|L35.424|
0000a8  6a42              LDR      r2,[r0,#0x24]  ; Radio
0000aa  2000              MOVS     r0,#0
0000ac  4790              BLX      r2
0000ae  2100              MOVS     r1,#0
0000b0  4a42              LDR      r2,|L35.444|
0000b2  c203              STM      r2!,{r0,r1}
0000b4  e04a              B        |L35.332|
                  |L35.182|
;;;2646   
;;;2647       }
;;;2648       else if( ChannelsDatarate == DR_6 )
0000b6  4837              LDR      r0,|L35.404|
0000b8  7800              LDRB     r0,[r0,#0]  ; ChannelsDatarate
0000ba  2806              CMP      r0,#6
0000bc  d123              BNE      |L35.262|
;;;2649       { // High speed LoRa channel
;;;2650           Radio.SetMaxPayloadLength( MODEM_LORA, LoRaMacBufferPktLen );
0000be  483b              LDR      r0,|L35.428|
0000c0  7801              LDRB     r1,[r0,#0]  ; LoRaMacBufferPktLen
0000c2  4839              LDR      r0,|L35.424|
0000c4  6d02              LDR      r2,[r0,#0x50]  ; Radio
0000c6  2001              MOVS     r0,#1
0000c8  4790              BLX      r2
;;;2651           Radio.SetTxConfig( MODEM_LORA, txPower, 0, 1, datarate, 1, 8, false, true, 0, 0, false, 3e6 );
0000ca  483a              LDR      r0,|L35.436|
0000cc  2100              MOVS     r1,#0
0000ce  9105              STR      r1,[sp,#0x14]
0000d0  9106              STR      r1,[sp,#0x18]
0000d2  9107              STR      r1,[sp,#0x1c]
0000d4  9008              STR      r0,[sp,#0x20]
0000d6  2001              MOVS     r0,#1
0000d8  2208              MOVS     r2,#8
0000da  9001              STR      r0,[sp,#4]
0000dc  9400              STR      r4,[sp,#0]
0000de  9202              STR      r2,[sp,#8]
0000e0  9103              STR      r1,[sp,#0xc]
0000e2  9004              STR      r0,[sp,#0x10]
0000e4  4830              LDR      r0,|L35.424|
0000e6  2301              MOVS     r3,#1
0000e8  460a              MOV      r2,r1
0000ea  69c5              LDR      r5,[r0,#0x1c]  ; Radio
0000ec  4618              MOV      r0,r3
0000ee  990a              LDR      r1,[sp,#0x28]
0000f0  47a8              BLX      r5
;;;2652           TxTimeOnAir = Radio.TimeOnAir( MODEM_LORA, LoRaMacBufferPktLen );
0000f2  482e              LDR      r0,|L35.428|
0000f4  7801              LDRB     r1,[r0,#0]  ; LoRaMacBufferPktLen
0000f6  482c              LDR      r0,|L35.424|
0000f8  6a42              LDR      r2,[r0,#0x24]  ; Radio
0000fa  2001              MOVS     r0,#1
0000fc  4790              BLX      r2
0000fe  2100              MOVS     r1,#0
000100  4a2e              LDR      r2,|L35.444|
000102  c203              STM      r2!,{r0,r1}
000104  e022              B        |L35.332|
                  |L35.262|
;;;2653       }
;;;2654       else
;;;2655       { // Normal LoRa channel
;;;2656           Radio.SetMaxPayloadLength( MODEM_LORA, LoRaMacBufferPktLen );
000106  4829              LDR      r0,|L35.428|
000108  7801              LDRB     r1,[r0,#0]  ; LoRaMacBufferPktLen
00010a  4827              LDR      r0,|L35.424|
00010c  6d02              LDR      r2,[r0,#0x50]  ; Radio
00010e  2001              MOVS     r0,#1
000110  4790              BLX      r2
;;;2657           Radio.SetTxConfig( MODEM_LORA, txPower, 0, 0, datarate, 1, 8, false, true, 0, 0, false, 3e6 );
000112  4828              LDR      r0,|L35.436|
000114  2100              MOVS     r1,#0
000116  9105              STR      r1,[sp,#0x14]
000118  9106              STR      r1,[sp,#0x18]
00011a  9107              STR      r1,[sp,#0x1c]
00011c  9008              STR      r0,[sp,#0x20]
00011e  2001              MOVS     r0,#1
000120  2208              MOVS     r2,#8
000122  9001              STR      r0,[sp,#4]
000124  9400              STR      r4,[sp,#0]
000126  9202              STR      r2,[sp,#8]
000128  9103              STR      r1,[sp,#0xc]
00012a  9004              STR      r0,[sp,#0x10]
00012c  481e              LDR      r0,|L35.424|
00012e  460b              MOV      r3,r1
000130  460a              MOV      r2,r1
000132  69c5              LDR      r5,[r0,#0x1c]  ; Radio
000134  2001              MOVS     r0,#1
000136  990a              LDR      r1,[sp,#0x28]
000138  47a8              BLX      r5
;;;2658           TxTimeOnAir = Radio.TimeOnAir( MODEM_LORA, LoRaMacBufferPktLen );
00013a  481c              LDR      r0,|L35.428|
00013c  7801              LDRB     r1,[r0,#0]  ; LoRaMacBufferPktLen
00013e  481a              LDR      r0,|L35.424|
000140  6a42              LDR      r2,[r0,#0x24]  ; Radio
000142  2001              MOVS     r0,#1
000144  4790              BLX      r2
000146  2100              MOVS     r1,#0
000148  4a1c              LDR      r2,|L35.444|
00014a  c203              STM      r2!,{r0,r1}
                  |L35.332|
;;;2659       }
;;;2660   #elif defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;2661       Radio.SetMaxPayloadLength( MODEM_LORA, LoRaMacBufferPktLen );
;;;2662       if( ChannelsDatarate >= DR_4 )
;;;2663       { // High speed LoRa channel BW500 kHz
;;;2664           Radio.SetTxConfig( MODEM_LORA, txPower, 0, 2, datarate, 1, 8, false, true, 0, 0, false, 3e6 );
;;;2665           TxTimeOnAir = Radio.TimeOnAir( MODEM_LORA, LoRaMacBufferPktLen );
;;;2666       }
;;;2667       else
;;;2668       { // Normal LoRa channel
;;;2669           Radio.SetTxConfig( MODEM_LORA, txPower, 0, 0, datarate, 1, 8, false, true, 0, 0, false, 3e6 );
;;;2670           TxTimeOnAir = Radio.TimeOnAir( MODEM_LORA, LoRaMacBufferPktLen );
;;;2671       }
;;;2672   #else
;;;2673       #error "Please define a frequency band in the compiler options."
;;;2674   #endif
;;;2675   
;;;2676       // Store the time on air
;;;2677       McpsConfirm.TxTimeOnAir = TxTimeOnAir;
00014c  481b              LDR      r0,|L35.444|
00014e  6801              LDR      r1,[r0,#0]  ; TxTimeOnAir
000150  6840              LDR      r0,[r0,#4]  ; TxTimeOnAir
000152  4a14              LDR      r2,|L35.420|
000154  6091              STR      r1,[r2,#8]  ; McpsConfirm
000156  60d0              STR      r0,[r2,#0xc]  ; McpsConfirm
;;;2678       MlmeConfirm.TxTimeOnAir = TxTimeOnAir;
000158  4818              LDR      r0,|L35.444|
00015a  6801              LDR      r1,[r0,#0]  ; TxTimeOnAir
00015c  6840              LDR      r0,[r0,#4]  ; TxTimeOnAir
00015e  4a10              LDR      r2,|L35.416|
000160  6091              STR      r1,[r2,#8]  ; MlmeConfirm
000162  60d0              STR      r0,[r2,#0xc]  ; MlmeConfirm
;;;2679   
;;;2680       // Starts the MAC layer status check timer
;;;2681       TimerSetValue( &MacStateCheckTimer, MAC_STATE_CHECK_TIMEOUT );
000164  4916              LDR      r1,|L35.448|
000166  4817              LDR      r0,|L35.452|
000168  f7fffffe          BL       TimerSetValue
;;;2682       TimerStart( &MacStateCheckTimer );
00016c  4815              LDR      r0,|L35.452|
00016e  f7fffffe          BL       TimerStart
;;;2683   
;;;2684       // Send now
;;;2685       Radio.Send( LoRaMacBuffer, LoRaMacBufferPktLen );
000172  480e              LDR      r0,|L35.428|
000174  7801              LDRB     r1,[r0,#0]  ; LoRaMacBufferPktLen
000176  480c              LDR      r0,|L35.424|
000178  6a82              LDR      r2,[r0,#0x28]  ; Radio
00017a  4813              LDR      r0,|L35.456|
00017c  4790              BLX      r2
;;;2686   
;;;2687       LoRaMacState |= MAC_TX_RUNNING;
00017e  4813              LDR      r0,|L35.460|
000180  6800              LDR      r0,[r0,#0]  ; LoRaMacState
000182  2101              MOVS     r1,#1
000184  4308              ORRS     r0,r0,r1
000186  4911              LDR      r1,|L35.460|
000188  6008              STR      r0,[r1,#0]  ; LoRaMacState
;;;2688   
;;;2689       return LORAMAC_STATUS_OK;
00018a  2000              MOVS     r0,#0
;;;2690   }
00018c  b00d              ADD      sp,sp,#0x34
00018e  bdf0              POP      {r4-r7,pc}
;;;2691   
                          ENDP

                  |L35.400|
                          DCD      Datarates
                  |L35.404|
                          DCD      ChannelsDatarate
                  |L35.408|
                          DCD      ChannelsTxPower
                  |L35.412|
                          DCD      TxPowers
                  |L35.416|
                          DCD      MlmeConfirm
                  |L35.420|
                          DCD      McpsConfirm
                  |L35.424|
                          DCD      Radio
                  |L35.428|
                          DCD      LoRaMacBufferPktLen
                  |L35.432|
                          DCD      0x408f4000
                  |L35.436|
                          DCD      0x002dc6c0
                  |L35.440|
                          DCD      0x000061a8
                  |L35.444|
                          DCD      TxTimeOnAir
                  |L35.448|
                          DCD      0x000f4240
                  |L35.452|
                          DCD      MacStateCheckTimer
                  |L35.456|
                          DCD      LoRaMacBuffer
                  |L35.460|
                          DCD      LoRaMacState

                          AREA ||i.SetNextChannel||, CODE, READONLY, ALIGN=2

                  SetNextChannel PROC
;;;1627   
;;;1628   static bool SetNextChannel( TimerTime_t* time )
000000  b5f0              PUSH     {r4-r7,lr}
;;;1629   {
000002  b08b              SUB      sp,sp,#0x2c
000004  4604              MOV      r4,r0
;;;1630       uint8_t nbEnabledChannels = 0;
000006  2000              MOVS     r0,#0
000008  9009              STR      r0,[sp,#0x24]
;;;1631       uint8_t delayTx = 0;
00000a  9008              STR      r0,[sp,#0x20]
;;;1632       uint8_t enabledChannels[LORA_MAX_NB_CHANNELS];
;;;1633       TimerTime_t curTime = TimerGetCurrentTime( );
00000c  f7fffffe          BL       TimerGetCurrentTime
000010  9105              STR      r1,[sp,#0x14]
000012  9004              STR      r0,[sp,#0x10]
;;;1634       TimerTime_t nextTxDelay = ( TimerTime_t )( -1 );
000014  2100              MOVS     r1,#0
000016  43c9              MVNS     r1,r1
000018  9102              STR      r1,[sp,#8]
00001a  9103              STR      r1,[sp,#0xc]
;;;1635   
;;;1636       memset1( enabledChannels, 0, LORA_MAX_NB_CHANNELS );
00001c  2208              MOVS     r2,#8
00001e  2100              MOVS     r1,#0
000020  a806              ADD      r0,sp,#0x18
000022  f7fffffe          BL       memset1
;;;1637   
;;;1638   #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;1639       if( CountNbEnabled125kHzChannels( ChannelsMaskRemaining ) == 0 )
;;;1640       { // Restore default channels
;;;1641           memcpy1( ( uint8_t* ) ChannelsMaskRemaining, ( uint8_t* ) ChannelsMask, 8 );
;;;1642       }
;;;1643       if( ( ChannelsDatarate >= DR_4 ) && ( ( ChannelsMaskRemaining[4] & 0x00FF ) == 0 ) )
;;;1644       { // Make sure, that the channels are activated
;;;1645           ChannelsMaskRemaining[4] = ChannelsMask[4];
;;;1646       }
;;;1647   #else
;;;1648       uint8_t chanCnt = 0;
000026  2000              MOVS     r0,#0
000028  9001              STR      r0,[sp,#4]
;;;1649       for( uint8_t i = 0, k = 0; i < LORA_MAX_NB_CHANNELS; i += 16, k++ )
00002a  bf00              NOP      
00002c  2100              MOVS     r1,#0
00002e  e00e              B        |L36.78|
                  |L36.48|
;;;1650       {
;;;1651           if( ChannelsMask[k] != 0 )
000030  004a              LSLS     r2,r1,#1
000032  4b8b              LDR      r3,|L36.608|
000034  5a9a              LDRH     r2,[r3,r2]
000036  2a00              CMP      r2,#0
000038  d004              BEQ      |L36.68|
;;;1652           {
;;;1653               chanCnt++;
00003a  9a01              LDR      r2,[sp,#4]
00003c  1c52              ADDS     r2,r2,#1
00003e  b2d2              UXTB     r2,r2
000040  9201              STR      r2,[sp,#4]
;;;1654               break;
000042  e006              B        |L36.82|
                  |L36.68|
000044  4602              MOV      r2,r0                 ;1649
000046  3210              ADDS     r2,r2,#0x10           ;1649
000048  b2d0              UXTB     r0,r2                 ;1649
00004a  1c4a              ADDS     r2,r1,#1              ;1649
00004c  b2d1              UXTB     r1,r2                 ;1649
                  |L36.78|
00004e  2808              CMP      r0,#8                 ;1649
000050  dbee              BLT      |L36.48|
                  |L36.82|
000052  bf00              NOP      
;;;1655           }
;;;1656       }
;;;1657       if( chanCnt == 0 )
000054  9801              LDR      r0,[sp,#4]
000056  2800              CMP      r0,#0
000058  d105              BNE      |L36.102|
;;;1658       {
;;;1659           // Re-enable default channels, if no channel is enabled
;;;1660           ChannelsMask[0] = ChannelsMask[0] | ( LC( 1 ) + LC( 2 ) + LC( 3 ) );
00005a  4881              LDR      r0,|L36.608|
00005c  8800              LDRH     r0,[r0,#0]  ; ChannelsMask
00005e  2107              MOVS     r1,#7
000060  4308              ORRS     r0,r0,r1
000062  497f              LDR      r1,|L36.608|
000064  8008              STRH     r0,[r1,#0]
                  |L36.102|
;;;1661       }
;;;1662   #endif
;;;1663   
;;;1664       // Update Aggregated duty cycle
;;;1665       if( AggregatedTimeOff < ( curTime - AggregatedLastTxDoneTime ) )
000066  4a7f              LDR      r2,|L36.612|
000068  9905              LDR      r1,[sp,#0x14]
00006a  9804              LDR      r0,[sp,#0x10]
00006c  6813              LDR      r3,[r2,#0]  ; AggregatedLastTxDoneTime
00006e  6852              LDR      r2,[r2,#4]  ; AggregatedLastTxDoneTime
000070  1ac0              SUBS     r0,r0,r3
000072  4191              SBCS     r1,r1,r2
000074  4b7c              LDR      r3,|L36.616|
000076  cb0c              LDM      r3,{r2,r3}
000078  1a10              SUBS     r0,r2,r0
00007a  418b              SBCS     r3,r3,r1
00007c  d27d              BCS      |L36.378|
;;;1666       {
;;;1667           AggregatedTimeOff = 0;
00007e  2100              MOVS     r1,#0
000080  4a79              LDR      r2,|L36.616|
000082  6011              STR      r1,[r2,#0]  ; AggregatedTimeOff
000084  6051              STR      r1,[r2,#4]  ; AggregatedTimeOff
;;;1668   
;;;1669           // Update bands Time OFF
;;;1670           for( uint8_t i = 0; i < LORA_MAX_NB_BANDS; i++ )
000086  2200              MOVS     r2,#0
000088  e061              B        |L36.334|
                  |L36.138|
;;;1671           {
;;;1672               if( DutyCycleOn == true )
00008a  4878              LDR      r0,|L36.620|
00008c  7800              LDRB     r0,[r0,#0]  ; DutyCycleOn
00008e  2801              CMP      r0,#1
000090  d152              BNE      |L36.312|
;;;1673               {
;;;1674                   if( Bands[i].TimeOff < ( curTime - Bands[i].LastTxDoneTime ) )
000092  2018              MOVS     r0,#0x18
000094  4350              MULS     r0,r2,r0
000096  4976              LDR      r1,|L36.624|
000098  1840              ADDS     r0,r0,r1
00009a  6945              LDR      r5,[r0,#0x14]
00009c  6903              LDR      r3,[r0,#0x10]
00009e  2018              MOVS     r0,#0x18
0000a0  4350              MULS     r0,r2,r0
0000a2  1840              ADDS     r0,r0,r1
0000a4  68c7              LDR      r7,[r0,#0xc]
0000a6  6886              LDR      r6,[r0,#8]
0000a8  9905              LDR      r1,[sp,#0x14]
0000aa  9804              LDR      r0,[sp,#0x10]
0000ac  1b80              SUBS     r0,r0,r6
0000ae  41b9              SBCS     r1,r1,r7
0000b0  1a18              SUBS     r0,r3,r0
0000b2  418d              SBCS     r5,r5,r1
0000b4  d206              BCS      |L36.196|
;;;1675                   {
;;;1676                       Bands[i].TimeOff = 0;
0000b6  2100              MOVS     r1,#0
0000b8  2318              MOVS     r3,#0x18
0000ba  4353              MULS     r3,r2,r3
0000bc  4d6c              LDR      r5,|L36.624|
0000be  195b              ADDS     r3,r3,r5
0000c0  6119              STR      r1,[r3,#0x10]
0000c2  6159              STR      r1,[r3,#0x14]
                  |L36.196|
;;;1677                   }
;;;1678                   if( Bands[i].TimeOff != 0 )
0000c4  2018              MOVS     r0,#0x18
0000c6  4350              MULS     r0,r2,r0
0000c8  4969              LDR      r1,|L36.624|
0000ca  1840              ADDS     r0,r0,r1
0000cc  6901              LDR      r1,[r0,#0x10]
0000ce  6940              LDR      r0,[r0,#0x14]
0000d0  2300              MOVS     r3,#0
0000d2  4059              EORS     r1,r1,r3
0000d4  4058              EORS     r0,r0,r3
0000d6  4301              ORRS     r1,r1,r0
0000d8  d037              BEQ      |L36.330|
;;;1679                   {
;;;1680                       nextTxDelay = MIN( Bands[i].TimeOff -
0000da  2018              MOVS     r0,#0x18
0000dc  4350              MULS     r0,r2,r0
0000de  4964              LDR      r1,|L36.624|
0000e0  1840              ADDS     r0,r0,r1
0000e2  6945              LDR      r5,[r0,#0x14]
0000e4  6903              LDR      r3,[r0,#0x10]
0000e6  2018              MOVS     r0,#0x18
0000e8  4350              MULS     r0,r2,r0
0000ea  1840              ADDS     r0,r0,r1
0000ec  68c7              LDR      r7,[r0,#0xc]
0000ee  6886              LDR      r6,[r0,#8]
0000f0  9905              LDR      r1,[sp,#0x14]
0000f2  9804              LDR      r0,[sp,#0x10]
0000f4  1b80              SUBS     r0,r0,r6
0000f6  41b9              SBCS     r1,r1,r7
0000f8  1a1b              SUBS     r3,r3,r0
0000fa  418d              SBCS     r5,r5,r1
0000fc  9903              LDR      r1,[sp,#0xc]
0000fe  9802              LDR      r0,[sp,#8]
000100  1a18              SUBS     r0,r3,r0
000102  418d              SBCS     r5,r5,r1
000104  d213              BCS      |L36.302|
000106  2018              MOVS     r0,#0x18
000108  4350              MULS     r0,r2,r0
00010a  4959              LDR      r1,|L36.624|
00010c  1840              ADDS     r0,r0,r1
00010e  6945              LDR      r5,[r0,#0x14]
000110  6903              LDR      r3,[r0,#0x10]
000112  2018              MOVS     r0,#0x18
000114  4350              MULS     r0,r2,r0
000116  1840              ADDS     r0,r0,r1
000118  68c7              LDR      r7,[r0,#0xc]
00011a  6886              LDR      r6,[r0,#8]
00011c  9904              LDR      r1,[sp,#0x10]
00011e  9805              LDR      r0,[sp,#0x14]
000120  1b8e              SUBS     r6,r1,r6
000122  41b8              SBCS     r0,r0,r7
000124  4629              MOV      r1,r5
000126  4605              MOV      r5,r0
000128  1b98              SUBS     r0,r3,r6
00012a  41a9              SBCS     r1,r1,r5
00012c  e001              B        |L36.306|
                  |L36.302|
00012e  9903              LDR      r1,[sp,#0xc]
000130  9802              LDR      r0,[sp,#8]
                  |L36.306|
000132  9103              STR      r1,[sp,#0xc]
000134  9002              STR      r0,[sp,#8]
000136  e008              B        |L36.330|
                  |L36.312|
;;;1681                                          ( curTime - Bands[i].LastTxDoneTime ),
;;;1682                                          nextTxDelay );
;;;1683                   }
;;;1684               }
;;;1685               else
;;;1686               {
;;;1687                   nextTxDelay = 0;
000138  2100              MOVS     r1,#0
00013a  9102              STR      r1,[sp,#8]
00013c  9103              STR      r1,[sp,#0xc]
;;;1688                   Bands[i].TimeOff = 0;
00013e  2318              MOVS     r3,#0x18
000140  4353              MULS     r3,r2,r3
000142  4d4b              LDR      r5,|L36.624|
000144  195b              ADDS     r3,r3,r5
000146  6119              STR      r1,[r3,#0x10]
000148  6159              STR      r1,[r3,#0x14]
                  |L36.330|
00014a  1c50              ADDS     r0,r2,#1              ;1670
00014c  b2c2              UXTB     r2,r0                 ;1670
                  |L36.334|
00014e  2a01              CMP      r2,#1                 ;1670
000150  db9b              BLT      |L36.138|
;;;1689               }
;;;1690           }
;;;1691   
;;;1692           // Search how many channels are enabled
;;;1693           for( uint8_t i = 0, k = 0; i < LORA_MAX_NB_CHANNELS; i += 16, k++ )
000152  2100              MOVS     r1,#0
000154  2200              MOVS     r2,#0
000156  e056              B        |L36.518|
                  |L36.344|
;;;1694           {
;;;1695               for( uint8_t j = 0; j < 16; j++ )
000158  2000              MOVS     r0,#0
00015a  e04d              B        |L36.504|
                  |L36.348|
;;;1696               {
;;;1697   #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;1698                   if( ( ChannelsMaskRemaining[k] & ( 1 << j ) ) != 0 )
;;;1699   #else
;;;1700                   if( ( ChannelsMask[k] & ( 1 << j ) ) != 0 )
00015c  0053              LSLS     r3,r2,#1
00015e  4d40              LDR      r5,|L36.608|
000160  5aeb              LDRH     r3,[r5,r3]
000162  2501              MOVS     r5,#1
000164  4085              LSLS     r5,r5,r0
000166  402b              ANDS     r3,r3,r5
000168  2b00              CMP      r3,#0
00016a  d042              BEQ      |L36.498|
;;;1701   #endif
;;;1702                   {
;;;1703                       if( Channels[i + j].Frequency == 0 )
00016c  180b              ADDS     r3,r1,r0
00016e  00db              LSLS     r3,r3,#3
000170  4d40              LDR      r5,|L36.628|
000172  58eb              LDR      r3,[r5,r3]
000174  2b00              CMP      r3,#0
000176  d101              BNE      |L36.380|
;;;1704                       { // Check if the channel is enabled
;;;1705                           continue;
000178  e03c              B        |L36.500|
                  |L36.378|
00017a  e047              B        |L36.524|
                  |L36.380|
;;;1706                       }
;;;1707                       if( ( ( Channels[i + j].DrRange.Fields.Min <= ChannelsDatarate ) &&
00017c  180b              ADDS     r3,r1,r0
00017e  00db              LSLS     r3,r3,#3
000180  4d3c              LDR      r5,|L36.628|
000182  195b              ADDS     r3,r3,r5
000184  791b              LDRB     r3,[r3,#4]
000186  071b              LSLS     r3,r3,#28
000188  171b              ASRS     r3,r3,#28
00018a  4d3b              LDR      r5,|L36.632|
00018c  2600              MOVS     r6,#0
00018e  57ae              LDRSB    r6,[r5,r6]  ; ChannelsDatarate
000190  42b3              CMP      r3,r6
000192  dc0d              BGT      |L36.432|
;;;1708                             ( ChannelsDatarate <= Channels[i + j].DrRange.Fields.Max ) ) == false )
000194  180b              ADDS     r3,r1,r0
000196  00db              LSLS     r3,r3,#3
000198  4d36              LDR      r5,|L36.628|
00019a  195b              ADDS     r3,r3,r5
00019c  2504              MOVS     r5,#4
00019e  575d              LDRSB    r5,[r3,r5]
0001a0  112b              ASRS     r3,r5,#4
0001a2  4d35              LDR      r5,|L36.632|
0001a4  2600              MOVS     r6,#0
0001a6  57ae              LDRSB    r6,[r5,r6]  ; ChannelsDatarate
0001a8  42b3              CMP      r3,r6
0001aa  db01              BLT      |L36.432|
0001ac  2301              MOVS     r3,#1
0001ae  e000              B        |L36.434|
                  |L36.432|
0001b0  2300              MOVS     r3,#0
                  |L36.434|
0001b2  2b00              CMP      r3,#0
0001b4  d100              BNE      |L36.440|
;;;1709                       { // Check if the current channel selection supports the given datarate
;;;1710                        	  DEBUG(3,"continue \r\n");
;;;1711                           continue;
0001b6  e01d              B        |L36.500|
                  |L36.440|
;;;1712                       }
;;;1713                       if( Bands[Channels[i + j].Band].TimeOff > 0 )
0001b8  180b              ADDS     r3,r1,r0
0001ba  00db              LSLS     r3,r3,#3
0001bc  4d2d              LDR      r5,|L36.628|
0001be  195b              ADDS     r3,r3,r5
0001c0  795b              LDRB     r3,[r3,#5]
0001c2  2518              MOVS     r5,#0x18
0001c4  436b              MULS     r3,r5,r3
0001c6  4d2a              LDR      r5,|L36.624|
0001c8  195d              ADDS     r5,r3,r5
0001ca  692b              LDR      r3,[r5,#0x10]
0001cc  696d              LDR      r5,[r5,#0x14]
0001ce  2700              MOVS     r7,#0
0001d0  407b              EORS     r3,r3,r7
0001d2  407d              EORS     r5,r5,r7
0001d4  432b              ORRS     r3,r3,r5
0001d6  d004              BEQ      |L36.482|
;;;1714                       { // Check if the band is available for transmission
;;;1715                           delayTx++;
0001d8  9b08              LDR      r3,[sp,#0x20]
0001da  1c5b              ADDS     r3,r3,#1
0001dc  b2db              UXTB     r3,r3
0001de  9308              STR      r3,[sp,#0x20]
;;;1716                           continue;
0001e0  e008              B        |L36.500|
                  |L36.482|
;;;1717                       }
;;;1718                       enabledChannels[nbEnabledChannels++] = i + j;
0001e2  180b              ADDS     r3,r1,r0
0001e4  b2de              UXTB     r6,r3
0001e6  9b09              LDR      r3,[sp,#0x24]
0001e8  1c5d              ADDS     r5,r3,#1
0001ea  b2ed              UXTB     r5,r5
0001ec  9509              STR      r5,[sp,#0x24]
0001ee  ad06              ADD      r5,sp,#0x18
0001f0  54ee              STRB     r6,[r5,r3]
                  |L36.498|
0001f2  bf00              NOP                            ;1705
                  |L36.500|
0001f4  1c43              ADDS     r3,r0,#1              ;1695
0001f6  b2d8              UXTB     r0,r3                 ;1695
                  |L36.504|
0001f8  2810              CMP      r0,#0x10              ;1695
0001fa  dbaf              BLT      |L36.348|
0001fc  4608              MOV      r0,r1                 ;1693
0001fe  3010              ADDS     r0,r0,#0x10           ;1693
000200  b2c1              UXTB     r1,r0                 ;1693
000202  1c50              ADDS     r0,r2,#1              ;1693
000204  b2c2              UXTB     r2,r0                 ;1693
                  |L36.518|
000206  2908              CMP      r1,#8                 ;1693
000208  dba6              BLT      |L36.344|
00020a  e012              B        |L36.562|
                  |L36.524|
;;;1719                   }
;;;1720               }
;;;1721           }
;;;1722       }
;;;1723       else
;;;1724       {
;;;1725           delayTx++;
00020c  9808              LDR      r0,[sp,#0x20]
00020e  1c40              ADDS     r0,r0,#1
000210  b2c0              UXTB     r0,r0
000212  9008              STR      r0,[sp,#0x20]
;;;1726           nextTxDelay = AggregatedTimeOff - ( curTime - AggregatedLastTxDoneTime );
000214  4a13              LDR      r2,|L36.612|
000216  9905              LDR      r1,[sp,#0x14]
000218  9804              LDR      r0,[sp,#0x10]
00021a  6813              LDR      r3,[r2,#0]  ; AggregatedLastTxDoneTime
00021c  6852              LDR      r2,[r2,#4]  ; AggregatedLastTxDoneTime
00021e  1ac3              SUBS     r3,r0,r3
000220  4191              SBCS     r1,r1,r2
000222  4811              LDR      r0,|L36.616|
000224  6802              LDR      r2,[r0,#0]  ; AggregatedTimeOff
000226  6840              LDR      r0,[r0,#4]  ; AggregatedTimeOff
000228  460d              MOV      r5,r1
00022a  1ad1              SUBS     r1,r2,r3
00022c  41a8              SBCS     r0,r0,r5
00022e  9102              STR      r1,[sp,#8]
000230  9003              STR      r0,[sp,#0xc]
                  |L36.562|
;;;1727       }
;;;1728   
;;;1729       if( nbEnabledChannels > 0 )
000232  9809              LDR      r0,[sp,#0x24]
000234  2800              CMP      r0,#0
000236  dd05              BLE      |L36.580|
;;;1730       {
;;;1731   //        Channel = enabledChannels[randr( 0, nbEnabledChannels - 1 )];
;;;1732   				DEBUG(3,"Channel = %d \r\n",Channel);
;;;1733   #if defined( USE_BAND_915 ) || defined( USE_BAND_915_HYBRID )
;;;1734           if( Channel < ( LORA_MAX_NB_CHANNELS - 8 ) )
;;;1735           {
;;;1736               DisableChannelInMask( Channel, ChannelsMaskRemaining );
;;;1737           }
;;;1738   #endif
;;;1739           *time = 0;
000238  2100              MOVS     r1,#0
00023a  6021              STR      r1,[r4,#0]
00023c  6061              STR      r1,[r4,#4]
;;;1740           return true;
00023e  2001              MOVS     r0,#1
                  |L36.576|
;;;1741       }
;;;1742       else
;;;1743       {
;;;1744           if( delayTx > 0 )
;;;1745           {
;;;1746               // Delay transmission due to AggregatedTimeOff or to a band time off
;;;1747               *time = nextTxDelay;
;;;1748               return true;
;;;1749           }
;;;1750           // Datarate not supported by any channel
;;;1751           *time = 0;
;;;1752           return false;
;;;1753       }
;;;1754   }
000240  b00b              ADD      sp,sp,#0x2c
000242  bdf0              POP      {r4-r7,pc}
                  |L36.580|
000244  9808              LDR      r0,[sp,#0x20]         ;1744
000246  2800              CMP      r0,#0                 ;1744
000248  dd05              BLE      |L36.598|
00024a  9903              LDR      r1,[sp,#0xc]          ;1747
00024c  9802              LDR      r0,[sp,#8]            ;1747
00024e  6061              STR      r1,[r4,#4]            ;1747
000250  6020              STR      r0,[r4,#0]            ;1747
000252  2001              MOVS     r0,#1                 ;1748
000254  e7f4              B        |L36.576|
                  |L36.598|
000256  2000              MOVS     r0,#0                 ;1751
000258  6020              STR      r0,[r4,#0]            ;1751
00025a  6060              STR      r0,[r4,#4]            ;1751
00025c  bf00              NOP                            ;1752
00025e  e7ef              B        |L36.576|
;;;1755   
                          ENDP

                  |L36.608|
                          DCD      ChannelsMask
                  |L36.612|
                          DCD      AggregatedLastTxDoneTime
                  |L36.616|
                          DCD      AggregatedTimeOff
                  |L36.620|
                          DCD      DutyCycleOn
                  |L36.624|
                          DCD      Bands
                  |L36.628|
                          DCD      Channels
                  |L36.632|
                          DCD      ChannelsDatarate

                          AREA ||i.SetPublicNetwork||, CODE, READONLY, ALIGN=2

                  SetPublicNetwork PROC
;;;1755   
;;;1756   static void SetPublicNetwork( bool enable )
000000  b510              PUSH     {r4,lr}
;;;1757   {
000002  4604              MOV      r4,r0
;;;1758       PublicNetwork = enable;
000004  480a              LDR      r0,|L37.48|
000006  7004              STRB     r4,[r0,#0]
;;;1759       Radio.SetModem( MODEM_LORA );
000008  480a              LDR      r0,|L37.52|
00000a  6881              LDR      r1,[r0,#8]  ; Radio
00000c  2001              MOVS     r0,#1
00000e  4788              BLX      r1
;;;1760       if( PublicNetwork == true )
000010  4807              LDR      r0,|L37.48|
000012  7800              LDRB     r0,[r0,#0]  ; PublicNetwork
000014  2801              CMP      r0,#1
000016  d105              BNE      |L37.36|
;;;1761       {
;;;1762           // Change LoRa modem SyncWord
;;;1763           Radio.Write( REG_LR_SYNCWORD, LORA_MAC_PUBLIC_SYNCWORD );
000018  4806              LDR      r0,|L37.52|
00001a  2134              MOVS     r1,#0x34
00001c  6c02              LDR      r2,[r0,#0x40]  ; Radio
00001e  2039              MOVS     r0,#0x39
000020  4790              BLX      r2
000022  e004              B        |L37.46|
                  |L37.36|
;;;1764       }
;;;1765       else
;;;1766       {
;;;1767           // Change LoRa modem SyncWord
;;;1768           Radio.Write( REG_LR_SYNCWORD, LORA_MAC_PRIVATE_SYNCWORD );
000024  4803              LDR      r0,|L37.52|
000026  2112              MOVS     r1,#0x12
000028  6c02              LDR      r2,[r0,#0x40]  ; Radio
00002a  2039              MOVS     r0,#0x39
00002c  4790              BLX      r2
                  |L37.46|
;;;1769       }
;;;1770   }
00002e  bd10              POP      {r4,pc}
;;;1771   
                          ENDP

                  |L37.48|
                          DCD      PublicNetwork
                  |L37.52|
                          DCD      Radio

                          AREA ||i.ValidatePayloadLength||, CODE, READONLY, ALIGN=2

                  ValidatePayloadLength PROC
;;;1826   
;;;1827   static bool ValidatePayloadLength( uint8_t lenN, int8_t datarate, uint8_t fOptsLen )
000000  b570              PUSH     {r4-r6,lr}
;;;1828   {
000002  4603              MOV      r3,r0
;;;1829       uint16_t maxN = 0;
000004  2500              MOVS     r5,#0
;;;1830       uint16_t payloadSize = 0;
000006  2400              MOVS     r4,#0
;;;1831   
;;;1832       // Get the maximum payload length
;;;1833       if( RepeaterSupport == true )
000008  480a              LDR      r0,|L38.52|
00000a  7800              LDRB     r0,[r0,#0]  ; RepeaterSupport
00000c  2801              CMP      r0,#1
00000e  d104              BNE      |L38.26|
;;;1834       {
;;;1835           maxN = MaxPayloadOfDatarateRepeater[datarate];
000010  4809              LDR      r0,|L38.56|
000012  5c45              LDRB     r5,[r0,r1]
;;;1836   				RF_Send_Data.ADR_Datarate = datarate;
000014  4e09              LDR      r6,|L38.60|
000016  7471              STRB     r1,[r6,#0x11]
000018  e003              B        |L38.34|
                  |L38.26|
;;;1837       }
;;;1838       else
;;;1839       {
;;;1840           maxN = MaxPayloadOfDatarate[datarate];
00001a  4809              LDR      r0,|L38.64|
00001c  5c45              LDRB     r5,[r0,r1]
;;;1841   				RF_Send_Data.ADR_Datarate = datarate; ///datarate回调使用
00001e  4e07              LDR      r6,|L38.60|
000020  7471              STRB     r1,[r6,#0x11]
                  |L38.34|
;;;1842       }
;;;1843   
;;;1844       // Calculate the resulting payload size
;;;1845       payloadSize = ( lenN + fOptsLen );
000022  189c              ADDS     r4,r3,r2
;;;1846   
;;;1847       // Validation of the application payload size
;;;1848       if( ( payloadSize <= maxN ) && ( payloadSize <= LORAMAC_PHY_MAXPAYLOAD ) )
000024  42ac              CMP      r4,r5
000026  dc03              BGT      |L38.48|
000028  2cff              CMP      r4,#0xff
00002a  dc01              BGT      |L38.48|
;;;1849       {
;;;1850           return true;
00002c  2001              MOVS     r0,#1
                  |L38.46|
;;;1851       }
;;;1852       return false;
;;;1853   }
00002e  bd70              POP      {r4-r6,pc}
                  |L38.48|
000030  2000              MOVS     r0,#0                 ;1852
000032  e7fc              B        |L38.46|
;;;1854   
                          ENDP

                  |L38.52|
                          DCD      RepeaterSupport
                  |L38.56|
                          DCD      MaxPayloadOfDatarateRepeater
                  |L38.60|
                          DCD      RF_Send_Data
                  |L38.64|
                          DCD      MaxPayloadOfDatarate

                          AREA ||i.ValueInRange||, CODE, READONLY, ALIGN=1

                  ValueInRange PROC
;;;1894   
;;;1895   static bool ValueInRange( int8_t value, int8_t min, int8_t max )
000000  4603              MOV      r3,r0
;;;1896   {
;;;1897       if( ( value >= min ) && ( value <= max ) )
000002  428b              CMP      r3,r1
000004  db03              BLT      |L39.14|
000006  4293              CMP      r3,r2
000008  dc01              BGT      |L39.14|
;;;1898       {
;;;1899           return true;
00000a  2001              MOVS     r0,#1
                  |L39.12|
;;;1900       }
;;;1901       return false;
;;;1902   }
00000c  4770              BX       lr
                  |L39.14|
00000e  2000              MOVS     r0,#0                 ;1901
000010  e7fc              B        |L39.12|
;;;1903   
                          ENDP


                          AREA ||.bss||, DATA, NOINIT, ALIGN=3

                  LoRaMacNwkSKey
                          %        16
                  LoRaMacAppSKey
                          %        16
                  LoRaMacBuffer
                          %        255
                  LoRaMacPayload
                          %        255
                  LoRaMacRxPayload
                          %        255
                  MacCommandsBuffer
                          %        15
                  ChannelsMask
                          %        12
                  MacStateCheckTimer
                          %        20
                  RadioEvents
                          %        28
                  TxDelayedTimer
                          %        20
                  RxWindowTimer1
                          %        20
                  RxWindowTimer2
                          %        20
                  AckTimeoutTimer
                          %        20
                  McpsIndication
                          %        24
                  McpsConfirm
                          %        24
                  MlmeConfirm
                          %        24

                          AREA ||.constdata||, DATA, READONLY, ALIGN=0

                  Datarates
000000  0c0b0a09          DCB      0x0c,0x0b,0x0a,0x09
000004  08070732          DCB      0x08,0x07,0x07,0x32
                  MaxPayloadOfDatarate
000008  3b3b3b7b          DCB      0x3b,0x3b,0x3b,0x7b
00000c  fafafafa          DCB      0xfa,0xfa,0xfa,0xfa
                  MaxPayloadOfDatarateRepeater
000010  3b3b3b7b          DCB      0x3b,0x3b,0x3b,0x7b
000014  e6e6e6e6          DCB      0xe6,0xe6,0xe6,0xe6
                  TxPowers
000018  140e0b08          DCB      0x14,0x0e,0x0b,0x08
00001c  0502              DCB      0x05,0x02
                  __func__
00001e  4f6e              DCB      0x4f,0x6e
000020  52616469          DCB      0x52,0x61,0x64,0x69
000024  6f527844          DCB      0x6f,0x52,0x78,0x44
000028  6f6e6500          DCB      0x6f,0x6e,0x65,0x00
                  |symbol_number.151|
00002c  4f6e4d61          DCB      0x4f,0x6e,0x4d,0x61
000030  63537461          DCB      0x63,0x53,0x74,0x61
000034  74654368          DCB      0x74,0x65,0x43,0x68
000038  65636b54          DCB      0x65,0x63,0x6b,0x54
00003c  696d6572          DCB      0x69,0x6d,0x65,0x72
000040  4576656e          DCB      0x45,0x76,0x65,0x6e
000044  7400              DCB      0x74,0x00
                  |symbol_number.152|
000046  4f6e              DCB      0x4f,0x6e
000048  54784465          DCB      0x54,0x78,0x44,0x65
00004c  6c617965          DCB      0x6c,0x61,0x79,0x65
000050  6454696d          DCB      0x64,0x54,0x69,0x6d
000054  65724576          DCB      0x65,0x72,0x45,0x76
000058  656e7400          DCB      0x65,0x6e,0x74,0x00
                  |symbol_number.153|
00005c  4f6e4163          DCB      0x4f,0x6e,0x41,0x63
000060  6b54696d          DCB      0x6b,0x54,0x69,0x6d
000064  656f7574          DCB      0x65,0x6f,0x75,0x74
000068  54696d65          DCB      0x54,0x69,0x6d,0x65
00006c  72457665          DCB      0x72,0x45,0x76,0x65
000070  6e7400            DCB      0x6e,0x74,0x00

                          AREA ||.data||, DATA, ALIGN=3

                  LoRaMacDevEui
                          DCD      0x00000000
                  LoRaMacAppEui
                          DCD      0x00000000
                  LoRaMacAppKey
                          DCD      0x00000000
                  LoRaMacDevNonce
00000c  00000000          DCB      0x00,0x00,0x00,0x00
                  LoRaMacNetID
                          DCD      0x00000000
                  LoRaMacDevAddr
                          DCD      0x00000000
                  MulticastChannels
                          DCD      0x00000000
                  LoRaMacDeviceClass
00001c  00                DCB      0x00
                  PublicNetwork
00001d  00                DCB      0x00
                  RepeaterSupport
00001e  0000              DCB      0x00,0x00
                  LoRaMacBufferPktLen
000020  0000              DCW      0x0000
000022  0000              DCB      0x00,0x00
                  UpLinkCounter
                          DCD      0x00000001
                  DownLinkCounter
                          DCD      0x00000000
                  IsUpLinkCounterFixed
00002c  00                DCB      0x00
                  IsRxWindowsEnabled
00002d  01                DCB      0x01
                  IsLoRaMacNetworkJoined
00002e  00                DCB      0x00
                  AdrCtrlOn
00002f  00                DCB      0x00
                  AdrAckCounter
                          DCD      0x00000000
                  NodeAckRequested
000034  00                DCB      0x00
                  SrvAckRequested
000035  00                DCB      0x00
                  MacCommandsInNextTx
000036  00                DCB      0x00
                  MacCommandsBufferIndex
000037  00                DCB      0x00
                  Bands
000038  0064              DCW      0x0064
00003a  0000              DCB      0x00,0x00
                          DCD      0x00000000
000040  00000000          DCQ      0x0000000000000000
000044  00000000
000048  00000000          DCQ      0x0000000000000000
00004c  00000000
                  Channels
                          DCD      0x1c1a84e0
000054  50000000          DCB      0x50,0x00,0x00,0x00
                          DCD      0x1c1d9220
00005c  50000000          DCB      0x50,0x00,0x00,0x00
                          DCD      0x1c209f60
000064  50000000          DCB      0x50,0x00,0x00,0x00
                          DCD      0x1c23aca0
00006c  50000000          DCB      0x50,0x00,0x00,0x00
                          DCD      0x1c26b9e0
000074  50000000          DCB      0x50,0x00,0x00,0x00
                          DCD      0x1c29c720
00007c  60000000          DCB      0x60,0x00,0x00,0x00
                          DCD      0x1c2cd460
000084  50000000          DCB      0x50,0x00,0x00,0x00
                          DCD      0x1c2fe1a0
00008c  50000000          DCB      0x50,0x00,0x00,0x00
                  Rx2Channel
                          DCD      0x1c1777a0
000094  00000000          DCB      0x00,0x00,0x00,0x00
                  Rx1DrOffset
000098  00                DCB      0x00
                  ChannelsTxPower
000099  00                DCB      0x00
                  ChannelsDatarate
00009a  00                DCB      0x00
                  ChannelsDefaultDatarate
00009b  00                DCB      0x00
                  ChannelsNbRep
00009c  01                DCB      0x01
                  ChannelsNbRepCounter
00009d  00                DCB      0x00
                  MaxDCycle
00009e  0000              DCB      0x00,0x00
                  AggregatedDCycle
0000a0  00000000          DCB      0x00,0x00,0x00,0x00
                          DCD      0x00000000
                  AggregatedLastTxDoneTime
                          %        8
                  AggregatedTimeOff
                          %        8
                  DutyCycleOn
0000b8  00                DCB      0x00
                  Channel
0000b9  000000            DCB      0x00,0x00,0x00
                  LoRaMacState
                          DCD      0x00000000
                  LoRaMacPrimitives
                          DCD      0x00000000
                  LoRaMacCallbacks
                          DCD      0x00000000
                  ReceiveDelay1
                          DCD      0x00000000
                  ReceiveDelay2
                          DCD      0x00000000
                  JoinAcceptDelay1
                          DCD      0x00000000
                  JoinAcceptDelay2
                          DCD      0x00000000
                  RxWindow1Delay
                          DCD      0x00000000
                  RxWindow2Delay
                          DCD      0x00000000
                  MaxRxWindow
                          DCD      0x00000000
                  AckTimeoutRetries
0000e4  01                DCB      0x01
                  AckTimeoutRetriesCounter
0000e5  01                DCB      0x01
                  AckTimeoutRetry
0000e6  0000              DCB      0x00,0x00
                  TxTimeOnAir
0000e8  00000000          DCQ      0x0000000000000000
0000ec  00000000
                  RxSlot
0000f0  00                DCB      0x00
                  LoRaMacFlags
0000f1  00                DCB      0x00

                          AREA ||i.__ARM_common_switch8||, COMGROUP=__ARM_common_switch8, CODE, READONLY, ALIGN=1

                  __ARM_common_switch8 PROC
000000  b430              PUSH     {r4,r5}
000002  4674              MOV      r4,lr
000004  1e64              SUBS     r4,r4,#1
000006  7825              LDRB     r5,[r4,#0]
000008  1c64              ADDS     r4,r4,#1
00000a  42ab              CMP      r3,r5
00000c  d304              BCC      |L225.24|
                  |L225.14|
00000e  5d63              LDRB     r3,[r4,r5]
000010  005b              LSLS     r3,r3,#1
000012  18e3              ADDS     r3,r4,r3
000014  bc30              POP      {r4,r5}
000016  4718              BX       r3
                  |L225.24|
000018  461d              MOV      r5,r3
00001a  e7f8              B        |L225.14|
                          ENDP


;*** Start embedded assembler ***

#line 1 "..\\Lib\\LoRawan-node\\mac\\LoRaMac.c"
	AREA ||.rev16_text||, CODE
	THUMB
	EXPORT |__asm___9_LoRaMac_c_204f9266____REV16|
#line 388 "..\\CMSIS\\Include\\cmsis_armcc.h"
|__asm___9_LoRaMac_c_204f9266____REV16| PROC
#line 389

 rev16 r0, r0
 bx lr
	ENDP
	AREA ||.revsh_text||, CODE
	THUMB
	EXPORT |__asm___9_LoRaMac_c_204f9266____REVSH|
#line 402
|__asm___9_LoRaMac_c_204f9266____REVSH| PROC
#line 403

 revsh r0, r0
 bx lr
	ENDP

;*** End   embedded assembler ***
